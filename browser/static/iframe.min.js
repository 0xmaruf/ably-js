(function(){var w=function(){function a(){this.any=[];this.events={};this.anyOnce=[];this.eventsOnce={}}a.prototype.on=function(a,b){1==arguments.length&&"function"==typeof a?this.any.push(a):null===a?this.any.push(b):(this.events[a]=this.events[a]||[]).push(b)};a.prototype.off=function(a,b){if(0==arguments.length)this.any=[],this.events={},this.anyOnce=[],this.eventsOnce={};else{1==arguments.length&&"function"==typeof a&&(b=a,a=null);var d,e=-1;if(null===a)if(b){if(!(d=this.any)||-1==(e=p.arrIndexOf(d,
b)))if(d=this.anyOnce)e=p.arrIndexOf(d,b);-1<e&&d.splice(e,1)}else this.any=[],this.anyOnce=[];else if(b){e=-1;if(!(d=this.events[a])||-1==(e=p.arrIndexOf(d,b)))if(d=this.eventsOnce[a])e=p.arrIndexOf(d,b);-1<e&&d.splice(e,1)}else delete this.events[a],delete this.eventsOnce[a]}};a.prototype.listeners=function(a){if(a){var b=this.events[a]||[];this.eventsOnce[a]&&Array.prototype.push.apply(b,this.eventsOnce[a]);return b.length?b:null}return this.any.length?this.any:null};a.prototype.emit=function(a){function b(a){try{a.apply(e,
d)}catch(b){l.logAction(l.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+b+"; stack = "+b.stack)}}var d=Array.prototype.slice.call(arguments,1),e={event:a};if(this.anyOnce.length){var h=this.anyOnce;this.anyOnce=[];for(var f=0;f<h.length;f++)b(h[f])}for(f=0;f<this.any.length;f++)this.any[f].apply(e,d);if(h=this.eventsOnce[a])for(delete this.eventsOnce[a],f=0;f<h.length;f++)b(h[f]);if(h=this.events[a])for(f=0;f<h.length;f++)b(h[f])};a.prototype.once=function(a,b){1==arguments.length&&
"function"==typeof a?this.anyOnce.push(a):null===a?this.anyOnce.push(b):(this.eventsOnce[a]=this.eventsOnce[a]||[]).push(b)};return a}(),l=function(){function a(a){}var c=4,b=function(){};a.LOG_NONE=0;a.LOG_ERROR=1;a.LOG_MAJOR=2;a.LOG_MINOR=3;a.LOG_MICRO=4;a.LOG_DEFAULT=3;a.LOG_DEBUG=4;a.logAction=function(a,e,h){a<=c&&b("Ably: "+e+": "+h)};a.setLog=function(a,e){c=a||3;b=e||function(a){console.log(a)}};return a}(),y=function(){return function(a){a=a||[];var c=function(){for(var b=0;b<a.length;b++){var d=
a[b];try{d.apply(null,arguments)}catch(e){}}};c.push=function(){Array.prototype.push.apply(a,arguments)};return c}}(),p=function(){function a(){}var c="object"==typeof window;a.mixin=function(a,e){for(var b in e)a[b]=e[b];return a};a.copy=function(d){return a.mixin({},d)};a.isArray=function(a){return"[object Array]"==Object.prototype.toString.call(a)};a.isEmpty=function(a){for(var e in a)return!1;return!0};a.shallowClone=function(a){var e={},b;for(b in a)e[b]=a[b];return e};a.prototypicalClone=function(d,
b){function h(){}h.prototype=d;var f=new h;b&&a.mixin(f,b);return f};a.inherits="undefined"!==typeof require&&require("util").inherits||function(d,b){d.super_=b;d.prototype=a.prototypicalClone(b.prototype,{constructor:d})};a.containsValue=function(a,b){for(var h in a)if(a[h]==b)return!0;return!1};a.intersect=function(d,b){return a.isArray(b)?a.arrIntersect(d,b):a.arrIntersectOb(d,b)};a.isArray=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};a.arrIntersect=
function(d,b){for(var h=[],f=0;f<d.length;f++){var c=d[f];-1!=a.arrIndexOf(b,c)&&h.push(c)}return h};a.arrIntersectOb=function(a,b){for(var h=[],f=0;f<a.length;f++){var c=a[f];c in b&&h.push(c)}return h};a.arrSubtract=function(b,e){for(var h=[],c=0;c<b.length;c++){var l=b[c];-1==a.arrIndexOf(e,l)&&h.push(l)}return h};a.arrIndexOf=Array.prototype.indexOf?function(a,b,c){return a.indexOf(b,c)}:function(a,b,c){c=c||0;for(var f=a.length;c<f;c++)if(a[c]===b)return c;return-1};a.keysArray=function(a,b){var c=
[],f;for(f in a)b&&!a.hasOwnProperty(f)||c.push(f);return c.length?c:void 0};a.valuesArray=function(a,b){var c=[],f;for(f in a)b&&!a.hasOwnProperty(f)||c.push(a[f]);return c.length?c:void 0};a.nextTick=c?function(a){setTimeout(a,0)}:process.nextTick;var b={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};a.defaultGetHeaders=function(a){a=a||"json";return{accept:"json"===a?b.json:b[a]+","+b.json}};a.defaultPostHeaders=function(a){a=
a||"json";return{accept:"json"===a?b.json:b[a]+","+b.json,"content-type":"json"===a?b.json:b[a]}};a.arrRandomElement=function(a){return a.splice(Math.floor(Math.random()*a.length))};a.toQueryString=function(a){var b=[];if(a)for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.length?"?"+b.join("&"):""};a.parseQueryString=function(a){for(var b,c=/([^?&=]+)=?([^&]*)/g,f={};b=c.exec(a);)f[decodeURIComponent(b[1])]=decodeURIComponent(b[2]);return f};return a}(),r={protocolVersion:1,
HOST:"rest.ably.io",WS_HOST:"realtime.ably.io",FALLBACK_HOSTS:["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"],PORT:80,TLS_PORT:443,connectTimeout:15E3,disconnectTimeout:3E4,suspendedTimeout:12E4,recvTimeout:9E4,sendTimeout:1E4,connectionPersistTimeout:15E3,httpTransports:["xhr","iframe","jsonp"],transports:["web_socket","flash_socket","xhr","iframe","jsonp"],flashTransport:{swfLocation:("undefined"!==typeof window?window.location.protocol:
"https:")+"//cdn.ably.io/lib/swf/WebSocketMainInsecure-0.9.swf"},getHost:function(a,c,b){c=c||a.host||r.HOST;b&&(c=c==a.host&&(a.wsHost||c)||c==r.HOST&&(r.WS_HOST||c)||c);return c},getPort:function(a,c){return c||a.tls?a.tlsPort||r.TLS_PORT:a.port||r.PORT},getHosts:function(a){var c;a.host?(c=[a.host],a.fallbackHosts&&c.concat(a.fallbackHosts)):c=[r.HOST].concat(r.FALLBACK_HOSTS);return c}};"undefined"!==typeof exports&&this.exports!==exports&&(exports.defaults=r);var x=function(){function a(){}a.addListener=
function(a,b,d){a.addEventListener?a.addEventListener(b,d,!1):a.attachEvent("on"+b,d)};a.removeListener=function(a,b,d){a.removeEventListener?a.removeEventListener(b,d,!1):a.detachEvent("on"+b,d)};a.addMessageListener=function(c,b){a.addListener(c,"message",b)};a.removeMessageListener=function(c,b){a.removeListener(c,"message",b)};a.addUnloadListener=function(c){a.addListener(window,"unload",c)};return a}(),v=function(){function a(){for(var a in q)q[a].dispose()}function c(){return window.XMLHttpRequest&&
"withCredentials"in new XMLHttpRequest?g=!0:t&&document.domain&&"https:"==window.location.protocol?!0:!1}function b(a){var b={};a.getResponseHeader&&(a=a.getResponseHeader("Content-Type"))&&(b["Content-Type"]=a);return b}function d(a,b,c,g,d){w.call(this);c=c||{};c.rnd=String(Math.random()).substr(2);this.uri=a+p.toQueryString(c);this.headers=b||{};this.body=g;this.requestMode=d;this.requestComplete=!1;q[this.id=String(++f)]=this}function e(a,b,c,g,f){c.ua="xdr";d.call(this,a,b,c,g,f)}var h=function(){},
f=0,q={},t=window.XDomainRequest,g;p.inherits(d,w);d.isAvailable=c;var k=d.createRequest=function(a,b,c,f,k){return g?new d(a,b,c,f,k):new e(a,b,c,f,k)};d.prototype.complete=function(a,c){if(!this.requestComplete){this.requestComplete=!0;var g=this.xhr;c&&this.emit("data",c);this.emit("complete",a,c,g&&b(g));this.dispose()}};d.prototype.abort=function(){this.dispose()};d.prototype.exec=function(){function a(){n=e.responseText;for(var b=n.length-1,c,g;u<b&&-1<(c=n.indexOf("\n",u));){g=n.slice(u,c);
u=c+1;a:{try{g=JSON.parse(g)}catch(f){err=Error("Malformed response body from server: "+f.message);err.statusCode=400;k.complete(err);break a}k.emit("data",g)}}}function b(){a();k.streamComplete=!0;p.nextTick(function(){k.complete()})}var c=this.timer=setTimeout(function(){e.abort()},0==this.requestMode?r.sendTimeout:r.recvTimeout),g=this.body,d=g?"POST":"GET",f=this.headers,e=this.xhr=new XMLHttpRequest,k=this;f.accept=f.accept||"application/json";g&&("object"==typeof g&&(g=JSON.stringify(g)),f["content-type"]=
f["content-type"]||"application/json");e.open(d,this.uri,!0);e.withCredentials="true";for(var h in f)e.setRequestHeader(h,f[h]);var l=e.onerror=function(a){a.code=8E4;k.complete(a)};e.onabort=function(){var a=Error("Request cancelled");a.statusCode=400;l(a)};e.ontimeout=function(){var a=Error("Request timed out");a.statusCode=408;l(a)};var s,m,n,q,u=0;e.onreadystatechange=function(){var g=e.readyState;if(!(3>g)&&0!==e.status)if(void 0===m&&(m=e.status,1223===m&&(m=204),clearTimeout(c),q=400>m,204==
m?k.complete():s=3==k.requestMode&&q),3==g&&s)a();else if(4==g)if(s)b();else a:{try{n=e.responseText;if(!n||!n.length){204!=status&&(d=Error("Incomplete response body from server"),d.statusCode=400,k.complete(d));break a}n=JSON.parse(String(n))}catch(f){var d=Error("Malformed response body from server: "+f.message);d.statusCode=400;k.complete(d);break a}q?k.complete(null,n):(d=n.error,d||(d=Error("Error response received from server: "+m),d.statusCode=m),k.complete(d))}};e.send(g)};d.prototype.dispose=
function(){var a=this.xhr;if(a){a.onreadystatechange=a.onerror=a.onabort=a.ontimeout=h;this.xhr=null;var b=this.timer;b&&(clearTimeout(b),this.timer=null);this.requestComplete||a.abort()}delete q[this.id]};p.inherits(e,d);e.prototype.exec=function(){function a(){clearTimeout(g);if(m=e.responseText){var b=m.length-1;if("\n"==m[b]||(b=-1<m.indexOf("\n"))){var c=m.slice(0,b);try{var c=JSON.parse(c),d=c.error;if(d)s=d.statusCode||500,k.complete(d);else if(s=m?201:200,q=3==k.requestMode)n=b,p.isEmpty(c)||
k.emit("data",c)}catch(f){d=Error("Malformed response body from server: "+f.message),d.statusCode=400,k.complete(d)}}}}function b(){m=e.responseText;for(var a=m.length-1,c,g;n<a&&-1<(c=m.indexOf("\n",n));){g=m.slice(n,c);n=c+1;a:{try{g=JSON.parse(g)}catch(d){err=Error("Malformed response body from server: "+d.message);err.statusCode=400;k.complete(err);break a}k.emit("data",g)}}}function c(){b();k.streamComplete=!0;p.nextTick(function(){k.complete()})}var g=this.timer=setTimeout(function(){e.abort()},
0==this.requestMode?r.sendTimeout:r.recvTimeout),d=this.body,f=d?"POST":"GET",e=this.xhr=new XDomainRequest,k=this;d&&"object"==typeof d&&(d=JSON.stringify(d));var h=e.onerror=function(){l.logAction(l.LOG_ERROR,"Request.onerror()","");var a=Error("Error response");a.statusCode=400;a.code=8E4;k.complete(a)};e.onabort=function(){l.logAction(l.LOG_ERROR,"Request.onabort()","");var a=Error("Request cancelled");a.statusCode=400;h(a)};e.ontimeout=function(){l.logAction(l.LOG_ERROR,"Request.timeout()","");
var a=Error("Request timed out");a.statusCode=408;h(a)};var q,s,m,n=0;e.onprogress=function(){void 0===s?a():q&&b()};e.onload=function(){if(void 0===s&&(a(),k.requestComplete))return;if(q)c();else a:{try{m=e.responseText;if(!m||!m.length){204!=status&&(g=Error("Incomplete response body from server"),g.statusCode=400,k.complete(g));break a}m=JSON.parse(String(m))}catch(b){var g=Error("Malformed response body from server: "+b.message);g.statusCode=400;k.complete(g);break a}k.complete(null,m)}};try{e.open(f,
this.uri),e.send(d)}catch(t){l.logAction(l.LOG_ERROR,"Request.onStreamEnd()","Unexpected send exception; err = "+t),h(t)}};e.prototype.dispose=function(){var a=this.xhr;if(a){a.onprogress=a.onload=a.onerror=a.onabort=a.ontimeout=h;this.xhr=null;var b=this.timer;b&&(clearTimeout(b),this.timer=null);this.requestComplete||a.abort()}delete q[this.id]};if(c=d.isAvailable())x.addUnloadListener(a),"undefined"!==typeof Http&&(Http.supportsAuthHeaders=g,Http.Request=function(a,b,c,g,d,e){a=k(a,b,c,g,0);a.once("complete",
e);a.exec();return a});return d}();(function(){function a(a){"string"!=typeof a&&(a=JSON.stringify(a));return a}function c(a){"string"==typeof a&&(a=JSON.parse(a));return a}function b(){this.stream="stream"in e?e.stream:!0;this.baseUri=this.sendUri=this.recvUri=this.pendingItems=this.pendingCallback=this.recvRequest=this.sendRequest=null;var a=this;x.addMessageListener(window,function(b){a.onMessageEvent(b.data)})}var d=location.origin||location.protocol+"//"+location.hostname+(location.port?":"+
location.port:""),e=p.parseQueryString(window.location.search),h=e.origin;delete e.origin;var f="access_token"in e?{access_token:e.access_token}:{key_id:e.key_id,key_value:e.key_value},q=window.parent,r=ProtocolMessage.Action;b.prototype.connect=function(){var a=(this.baseUri=d+"/comet/")+"connect",b=this;l.logAction(l.LOG_MINOR,"IframeAgent.connect()","uri: "+a);a=this.recvRequest=v.createRequest(a,null,e,null,this.stream?3:1);a.on("data",function(a){null==b.sendUri&&b.checkConnectResponse(a);b.onData(a)});
a.on("complete",function(a){b.recvRequest=null;a&&b.postErrorEvent(a)});a.exec()};b.prototype.dispose=function(){this.recvRequest&&(this.recvRequest.abort(),this.recvRequest=null)};b.prototype.checkConnectResponse=function(a){try{var b=c(a);if(b&&b.length)for(a=0;a<b.length;a++){var d=b[a];if(d.action==r.CONNECTED){this.onConnect(d);break}}}catch(e){l.logAction(l.LOG_ERROR,"IframeAgent.checkConnectResponse()","Unexpected exception handing channel event: "+e)}};b.prototype.onConnect=function(a){a=
this.baseUri+a.connectionId;l.logAction(l.LOG_MICRO,"IframeAgent.onConnect()","baseUri = "+a);this.sendUri=a+"/send";this.recvUri=a+"/recv";var b=this;p.nextTick(function(){b.recv()})};b.prototype.onMessageEvent=function(a){var b=this;this.send(c(a),function(a,c){a?b.postErrorEvent(a):c&&b.postMessageEvent(c)})};b.prototype.send=function(a,b){l.logAction(l.LOG_MICRO,"IframeAgent.send()","msg = "+JSON.stringify(a));if(this.sendRequest)this.pendingItems=this.pendingItems||[],this.pendingItems.push(a),
this.pendingCallback=this.pendingCallback||y(),this.pendingCallback.push(b);else{var c=this.pendingItems||[];c.push(a);this.pendingItems=null;var d=this.pendingCallback;d&&(d.push(b),b=d,this.pendingCallback=null);this.sendItems(c,b)}};b.prototype.sendItems=function(b,c){var d=this.sendUri,e=this;d?(d=this.sendRequest=v.createRequest(d,null,f,a(b),0),d.on("complete",function(a,b){a&&l.logAction(l.LOG_ERROR,"IframeAgent.sendItems()","on complete: err = "+a);e.sendRequest=null;if(b)e.onData(b);var d=
e.pendingItems;if(d){e.pendingItems=null;var f=e.pendingCallback;e.pendingCallback=null;p.nextTick(function(){e.sendItems(d,f)})}c(a)}),d.exec()):c({message:"Unable to send; not connected",code:8E4,statusCode:400})};b.prototype.recv=function(){if(!this.recvRequest&&this.isConnected){var a=this,b=this.recvRequest=v.createRequest(this.recvUri,null,f,null,a.stream?3:2);b.on("data",function(b){a.onData(b)});b.on("complete",function(b){a.recvRequest=null;b?a.postErrorEvent(b):p.nextTick(function(){a.recv()})});
b.exec()}};b.prototype.onData=function(a){this.postMessageEvent(a)};b.prototype.postMessageEvent=function(b){q.postMessage(a(b),h)};b.prototype.postErrorEvent=function(a,b){var c=b;if(a){var d=new ProtocolMessage.fromValues({action:r.ERROR,error:a});c&&p.mixin(d,c);c=d}this.postMessageEvent([c])};(new b).connect()})()})();
