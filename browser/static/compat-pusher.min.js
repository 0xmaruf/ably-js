/*
 Copyright 2015, Ably

 Ably JavaScript Library v0.8.10
 https://github.com/ably/ably-js

 Ably Realtime Messaging
 https://www.ably.io

 Released under the Apache Licence v2.0
*/
(function(){var l=function(){function b(){this.any=[];this.events={};this.anyOnce=[];this.eventsOnce={}}function g(b,a,e){try{a.apply(b,e)}catch(c){Logger.logAction(Logger.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+c+"; stack = "+c.stack)}}b.prototype.on=function(b,a){1==arguments.length&&"function"==typeof b?this.any.push(b):null===b?this.any.push(a):(this.events[b]||(this.events[b]=[])).push(a)};b.prototype.off=function(b,a){if(0==arguments.length)this.any=[],this.events=
{},this.anyOnce=[],this.eventsOnce={};else{1==arguments.length&&"function"==typeof b&&(a=b,b=null);var e,c=-1;if(null===b)if(a){if(!(e=this.any)||-1==(c=k.arrIndexOf(e,a)))if(e=this.anyOnce)c=k.arrIndexOf(e,a);-1<c&&e.splice(c,1)}else this.any=[],this.anyOnce=[];else if(a){c=-1;if(!(e=this.events[b])||-1==(c=k.arrIndexOf(e,a)))if(e=this.eventsOnce[b])c=k.arrIndexOf(e,a);-1<c&&e.splice(c,1)}else delete this.events[b],delete this.eventsOnce[b]}};b.prototype.listeners=function(b){if(b){var a=this.events[b]||
[];this.eventsOnce[b]&&Array.prototype.push.apply(a,this.eventsOnce[b]);return a.length?a:null}return this.any.length?this.any:null};b.prototype.emit=function(b){var a=Array.prototype.slice.call(arguments,1),e={event:b};if(this.anyOnce.length){var c=this.anyOnce;this.anyOnce=[];for(var d=0;d<c.length;d++)g(e,c[d],a)}for(d=0;d<this.any.length;d++)this.any[d].apply(e,a);if(c=this.eventsOnce[b])for(delete this.eventsOnce[b],d=0;d<c.length;d++)g(e,c[d],a);if(c=this.events[b])for(d=0;d<c.length;d++)g(e,
c[d],a)};b.prototype.once=function(b,a){1==arguments.length&&"function"==typeof b?this.anyOnce.push(b):null===b?this.anyOnce.push(a):(this.eventsOnce[b]||(this.eventsOnce[b]=[])).push(a)};b.prototype.whenState=function(b,a,e){var c={event:b},d=Array.prototype.slice.call(arguments,3);if("string"!==typeof b||"string"!==typeof a)throw"whenState requires a valid event String argument";if("function"!==typeof e)throw"whenState requires a valid listener argument";if(b===a)g(c,e,d);else this.once(b,e)};return b}(),
k=function(){function b(){}var g="object"==typeof window;b.mixin=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a};b.copy=function(a){return b.mixin({},a)};b.isArray=function(a){return"[object Array]"==Object.prototype.toString.call(a)};b.isObject=function(a){return"[object Object]"==Object.prototype.toString.call(a)};b.isEmpty=function(a){for(var b in a)return!1;return!0};b.shallowClone=function(a){var b={},c;for(c in a)b[c]=a[c];return b};b.prototypicalClone=function(a,e){function c(){}
c.prototype=a;var d=new c;e&&b.mixin(d,e);return d};b.inherits="undefined"!==typeof require&&require("util").inherits||function(a,e){a.super_=e;a.prototype=b.prototypicalClone(e.prototype,{constructor:a})};b.containsValue=function(a,b){for(var c in a)if(a[c]==b)return!0;return!1};b.intersect=function(a,e){return b.isArray(e)?b.arrIntersect(a,e):b.arrIntersectOb(a,e)};b.isArray=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};b.arrIntersect=function(a,
e){for(var c=[],d=0;d<a.length;d++){var f=a[d];-1!=b.arrIndexOf(e,f)&&c.push(f)}return c};b.arrIntersectOb=function(a,b){for(var c=[],d=0;d<a.length;d++){var f=a[d];f in b&&c.push(f)}return c};b.arrSubtract=function(a,e){for(var c=[],d=0;d<a.length;d++){var f=a[d];-1==b.arrIndexOf(e,f)&&c.push(f)}return c};b.arrIndexOf=Array.prototype.indexOf?function(a,b,c){return a.indexOf(b,c)}:function(a,b,c){c=c||0;for(var d=a.length;c<d;c++)if(a[c]===b)return c;return-1};b.arrIn=function(a,e){return-1!==b.arrIndexOf(a,
e)};b.arrDeleteValue=function(a,e){var c=b.arrIndexOf(a,e),d=-1!=c;d&&a.splice(c,1);return d};b.keysArray=function(a,b){var c=[],d;for(d in a)b&&!a.hasOwnProperty(d)||c.push(d);return c.length?c:void 0};b.valuesArray=function(a,b){var c=[],d;for(d in a)b&&!a.hasOwnProperty(d)||c.push(a[d]);return c.length?c:void 0};b.nextTick=g?function(a){setTimeout(a,0)}:process.nextTick;var f={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};
b.defaultGetHeaders=function(a){a=a||"json";return{accept:"json"===a?f.json:f[a]+","+f.json,"X-Ably-Version":Defaults.apiVersion}};b.defaultPostHeaders=function(a){a=a||"json";return{accept:"json"===a?f.json:f[a]+","+f.json,"content-type":"json"===a?f.json:f[a],"X-Ably-Version":Defaults.apiVersion}};b.arrRandomElement=function(a){return a.splice(Math.floor(Math.random()*a.length))};b.toQueryString=function(a){var b=[];if(a)for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));
return b.length?"?"+b.join("&"):""};b.parseQueryString=function(b){for(var e,c=/([^?&=]+)=?([^&]*)/g,d={};e=c.exec(b);)d[decodeURIComponent(e[1])]=decodeURIComponent(e[2]);return d};b.inspect=function(b){return JSON.stringify(b)};b.inspectError=function(a){return a&&"ErrorInfo"==a.constructor.name?a.toString():b.inspect(a)};return b}();(function(){function b(b,a){var d=a.host||"",e=a.tlshost||"",h={key:b,tls:a.encrypted||!1,log:{level:4}};a.ablyClientId&&(h.clientId=a.ablyClientId);a.authEndpoint&&
(h.authUrl=a.authEndpoint);a.auth&&a.auth.params&&(h.authParams=a.auth.params);a.auth&&a.auth.headers&&(h.authHeaders=a.auth.headers);d&&0!=d.length&&(d=d.split(":"),h.realtimeHost=h.restHost=d[0],1<d.length&&(h.port=d[1]));e&&0!=e.length&&(d=e.split(":"),1<d.length&&(h.tlsPort=d[1]));e=this.ably=new (c||window.Ably).Realtime(h);this.clientId=h.clientId;this.connection=new g(e.connection);this.channels={}}function g(a){l.call(this);this.connection=a;var b=this;a.on(function(a){var c=m[a.previous],
d=b.state=m[a.current];b.emit(d);b.emit("state_change",{previous:c,current:d});a.retryIn&&b.emit("connecting_in",a.retryIn)})}function f(a,b){var c=this;this.active=!0;this.channel=a.ably.channels.get(b);this.name=b;if(this.isPresence=0==b.indexOf("presence-"))this.members=new e(this,a.clientId);this.channel.subscribe(function(a){JSON.stringify(this);JSON.stringify(a);c.channel.emit(a.name,a.data)});this.bindings={};this.bind_alls=[];if(this.isPresence){var d=this.channel.presence;this.entered=!1;
d.subscribe("enter",function(a){c.entered&&a.clientId!==c.members.myID&&(a=c.members.addMember(a.clientId,a.clientInfo))&&c.channel.emit("pusher:member_added",a)});d.subscribe("leave",function(a){c.entered&&(a=c.members.removeMember(a.clientId))&&c.channel.emit("pusher:member_removed",a)});d.enter(function(a){if(a=d.get())for(var b=0;b<a.length;b++)c.members.addMember(a[b].clientId,a[b].clientData);c.entered=!0;c._sendEvent("pusher:subscription_succeeded",c.members)})}this.channel.on(function(a){"attached"===
this.event&&c.isPresence||("undefined"===typeof a&&(a={}),c._sendEvent(q[this.event]||this.event,a))})}function a(a,b){this.id=a;this.info=b}function e(a,b,c){this.count=0;this.members={};b&&(this.myID=b,this.me=this.addMember(b,c))}if("undefined"!==typeof window)var c=window.Ably;else if("undefined"===typeof c){var c=require("../.."),d=require("fs"),p=require("path"),r=require("vm"),n=function(a){a=p.resolve(__dirname,a);return r.runInThisContext(d.readFileSync(a,"utf8"),a)};"undefined"===typeof k&&
n("../../common/lib/util/utils.js");"undefined"===typeof l&&n("../../common/lib/util/eventemitter.js")}var m={initialized:"initialized",connecting:"connecting",connected:"connected",disconnected:"disconnected",suspended:"unavailable",closed:"disconnected",failed:"failed"},q={attached:"pusher:subscription_succeeded",failed:"pusher:subscription_error"};b.prototype.disconnect=function(){this.ably.close();delete this.ably};b.prototype.channel=function(a){return this.channels[a]};b.prototype.subscribe=
function(a){return this.channels[a]=new f(this,a)};b.prototype.unsubscribe=function(a){var b=this.channels[a];b&&(b.channel.detach(),b.active=!1,delete this.channels[a])};k.inherits(g,l);g.prototype.bind=function(){this.on.apply(this,arguments)};g.prototype.unbind=function(){this.off.apply(this,arguments)};f.prototype._sendEvent=function(a,b){for(var c=0;c<this.bind_alls.length;c++)this.bind_alls[c](a,b);var d=this.bindings[a];if(d)for(c=0;c<d.length;c++)d[c](b)};f.prototype.bind_all=function(a){this.bind_alls.push(a)};
f.prototype.unbind=function(a,b){var c=this.bindings[a];if(c)for(var d=0;d<c.length;d++)if(c[d]===b){c.splice(d,1);0==c.length&&(this.channel.off(a,this.channelBindCallback),delete this.bindings[a]);break}};f.prototype.bind=function(a,b){this.bindings[a]?this.bindings[a].push(b):this.bindings[a]=[b]};f.prototype.trigger=function(a,b){JSON.stringify(b);if(!this.active)return!0;this.channel.publish(a,b);return!0};e.prototype.addMember=function(b,c){"undefined"===typeof c&&(c={});b in this.members?this.members[b]=
c:(this.members[b]=c,this.count++);return new a(b,c)};e.prototype.removeMember=function(b){if(b in this.members){var c=this.members[b];delete this.members[b];this.count--;return new a(b,c)}};e.prototype.each=function(b){for(var c in this.members)b(new a(c,this.members[c]))};e.prototype.get=function(a){return this.members[a]};"undefined"===typeof window?module.exports=b:window.Pusher=b})()})();
