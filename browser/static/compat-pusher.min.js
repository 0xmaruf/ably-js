(function(){var l=function(){function a(){this.any=[];this.events={};this.anyOnce=[];this.eventsOnce={}}a.prototype.on=function(a,d){1==arguments.length&&"function"==typeof a?this.any.push(a):null===a?this.any.push(d):(this.events[a]=this.events[a]||[]).push(d)};a.prototype.off=function(a,d){if(0==arguments.length)this.any=[],this.events={},this.anyOnce=[],this.eventsOnce={};else{1==arguments.length&&"function"==typeof a&&(d=a,a=null);var c,f=-1;if(null===a)if(d){if(!(c=this.any)||-1==(f=k.arrIndexOf(c,
d)))if(c=this.anyOnce)f=k.arrIndexOf(c,d);-1<f&&c.splice(f,1)}else this.any=[],this.anyOnce=[];else if(d){f=-1;if(!(c=this.events[a])||-1==(f=k.arrIndexOf(c,d)))if(c=this.eventsOnce[a])f=k.arrIndexOf(c,d);-1<f&&c.splice(f,1)}else delete this.events[a],delete this.eventsOnce[a]}};a.prototype.listeners=function(a){if(a){var d=this.events[a]||[];this.eventsOnce[a]&&Array.prototype.push.apply(d,this.eventsOnce[a]);return d.length?d:null}return this.any.length?this.any:null};a.prototype.emit=function(a){function d(a){try{a.apply(f,
c)}catch(b){Logger.logAction(Logger.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+b+"; stack = "+b.stack)}}var c=Array.prototype.slice.call(arguments,1),f={event:a};if(this.anyOnce.length){var b=this.anyOnce;this.anyOnce=[];for(var e=0;e<b.length;e++)d(b[e])}for(e=0;e<this.any.length;e++)this.any[e].apply(f,c);if(b=this.eventsOnce[a])for(delete this.eventsOnce[a],e=0;e<b.length;e++)d(b[e]);if(b=this.events[a])for(e=0;e<b.length;e++)d(b[e])};a.prototype.once=function(a,d){1==arguments.length&&
"function"==typeof a?this.anyOnce.push(a):null===a?this.anyOnce.push(d):(this.eventsOnce[a]=this.eventsOnce[a]||[]).push(d)};return a}(),k=function(){function a(){}var h="object"==typeof window;a.mixin=function(c,a){for(var b in a)c[b]=a[b];return c};a.copy=function(c){return a.mixin({},c)};a.isArray=function(c){return"[object Array]"==Object.prototype.toString.call(c)};a.isEmpty=function(c){for(var a in c)return!1;return!0};a.shallowClone=function(c){var a={},b;for(b in c)a[b]=c[b];return a};a.prototypicalClone=
function(c,f){function b(){}b.prototype=c;var e=new b;f&&a.mixin(e,f);return e};a.inherits="undefined"!==typeof require&&require("util").inherits||function(c,f){c.super_=f;c.prototype=a.prototypicalClone(f.prototype,{constructor:c})};a.containsValue=function(c,a){for(var b in c)if(c[b]==a)return!0;return!1};a.intersect=function(c,f){return a.isArray(f)?a.arrIntersect(c,f):a.arrIntersectOb(c,f)};a.isArray=Array.isArray?Array.isArray:function(c){return"[object Array]"===Object.prototype.toString.call(c)};
a.arrIntersect=function(c,f){for(var b=[],e=0;e<c.length;e++){var d=c[e];-1!=a.arrIndexOf(f,d)&&b.push(d)}return b};a.arrIntersectOb=function(c,a){for(var b=[],e=0;e<c.length;e++){var d=c[e];d in a&&b.push(d)}return b};a.arrSubtract=function(c,f){for(var b=[],e=0;e<c.length;e++){var d=c[e];-1==a.arrIndexOf(f,d)&&b.push(d)}return b};a.arrIndexOf=Array.prototype.indexOf?function(c,a,b){return c.indexOf(a,b)}:function(a,d,b){b=b||0;for(var e=a.length;b<e;b++)if(a[b]===d)return b;return-1};a.keysArray=
function(a,d){var b=[],e;for(e in a)d&&!a.hasOwnProperty(e)||b.push(e);return b.length?b:void 0};a.valuesArray=function(a,d){var b=[],e;for(e in a)d&&!a.hasOwnProperty(e)||b.push(a[e]);return b.length?b:void 0};a.nextTick=h?function(a){setTimeout(a,0)}:process.nextTick;var d={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};a.defaultGetHeaders=function(a){a=a||"json";return{accept:"json"===a?d.json:d[a]+","+d.json}};a.defaultPostHeaders=
function(a){a=a||"json";return{accept:"json"===a?d.json:d[a]+","+d.json,"content-type":"json"===a?d.json:d[a]}};a.arrRandomElement=function(a){return a.splice(Math.floor(Math.random()*a.length))};a.toQueryString=function(a){var d=[];if(a)for(var b in a)d.push(encodeURIComponent(b)+"="+encodeURIComponent(a[b]));return d.length?"?"+d.join("&"):""};a.parseQueryString=function(a){for(var d,b=/([^?&=]+)=?([^&]*)/g,e={};d=b.exec(a);)e[decodeURIComponent(d[1])]=decodeURIComponent(d[2]);return e};return a}();
(function(){function a(a){r&&console.log(a)}function h(a,b){var c=b.host||"",f=b.tlshost||"",g={key:a,tls:b.encrypted||!1};b.ablyClientId&&(g.clientId=b.ablyClientId);b.authEndpoint&&(g.authUrl=b.authEndpoint);b.auth&&b.auth.params&&(g.authParams=b.auth.params);b.auth&&b.auth.headers&&(g.authHeaders=b.auth.headers);c&&0!=c.length&&(c=c.split(":"),g.host=g.wsHost=c[0],1<c.length&&(g.port=c[1]));f&&0!=f.length&&(c=f.split(":"),1<c.length&&(g.tlsPort=c[1]));f=this.ably=new e.Realtime(g);this.clientId=
g.clientId;this.connection=new d(f.connection);this.channels={}}function d(a){l.call(this);this.connection=a;var b=this;a.on(function(a){var c=m[a.previous],d=b.state=m[a.current];b.emit(d);b.emit("state_change",{previous:c,current:d});a.retryIn&&b.emit("connecting_in",a.retryIn)})}function c(c,d){var e=this;this.active=!0;this.channel=c.ably.channels.get(d);this.name=d;if(this.isPresence=0==d.indexOf("presence-"))this.members=new b(this,c.clientId);this.channel.subscribe(function(b){a("PusherChannel::message callback: Event object "+
JSON.stringify(this)+", message "+JSON.stringify(b));e.channel.emit(b.name,JSON.parse(b.data))});this.bindings={};this.bind_alls=[];if(this.isPresence){var f=this.channel.presence;this.entered=!1;f.on("enter",function(a){e.entered&&a.clientId!==e.members.myID&&(a=e.members.addMember(a.clientId,a.clientInfo))&&e.channel.emit("pusher:member_added",a)});f.on("leave",function(a){e.entered&&(a=e.members.removeMember(a.clientId))&&e.channel.emit("pusher:member_removed",a)});f.enter(function(a){if(a=f.get())for(var b=
0;b<a.length;b++)e.members.addMember(a[b].clientId,a[b].clientData);e.entered=!0;e._sendEvent("pusher:subscription_succeeded",e.members)})}this.channel.on(function(a){"attached"===this.event&&e.isPresence||("undefined"===typeof a&&(a={}),e._sendEvent(s[this.event]||this.event,a))})}function f(a,b){this.id=a;this.info=b}function b(a,b,c){this.count=0;this.members={};b&&(this.myID=b,this.me=this.addMember(b,c))}if("undefined"!==typeof window)var e=window.Ably;else if("undefined"===typeof e){var e=require("../.."),
p=require("fs"),q=require("path"),t=require("vm"),n=function(a){a=q.resolve(__dirname,a);return t.runInThisContext(p.readFileSync(a,"utf8"),a)};"undefined"===typeof k&&n("../../common/lib/util/utils.js");"undefined"===typeof l&&n("../../common/lib/util/eventemitter.js")}var r=!1,m={initialized:"initialized",connecting:"connecting",connected:"connected",disconnected:"disconnected",suspended:"unavailable",closed:"disconnected",failed:"failed"},s={attached:"pusher:subscription_succeeded",failed:"pusher:subscription_error"};
h.prototype.disconnect=function(){this.ably.close();delete this.ably};h.prototype.channel=function(a){return this.channels[a]};h.prototype.subscribe=function(a){return this.channels[a]=new c(this,a)};h.prototype.unsubscribe=function(a){var b=this.channels[a];b&&(b.channel.detach(),b.active=!1,delete this.channels[a])};k.inherits(d,l);d.prototype.bind=function(){this.on.apply(this,arguments)};d.prototype.unbind=function(){this.off.apply(this,arguments)};c.prototype._sendEvent=function(a,b){for(var c=
0;c<this.bind_alls.length;c++)this.bind_alls[c](a,b);var d=this.bindings[a];if(d)for(c=0;c<d.length;c++)d[c](b)};c.prototype.bind_all=function(a){this.bind_alls.push(a)};c.prototype.unbind=function(b,c){var d=this.bindings[b];a("PusherChannel::unbind: Unbinding callback from event "+b);if(d)for(var e=0;e<d.length;e++)if(d[e]===c){a("PusherChannel::unbind: Found callback record to remove");d.splice(e,1);0==d.length&&(a("PusherChannel::unbind: All bindings for this event have been removed"),this.channel.off(b,
this.channelBindCallback),delete this.bindings[b]);break}};c.prototype.bind=function(a,b){this.bindings[a]?this.bindings[a].push(b):this.bindings[a]=[b]};c.prototype.trigger=function(b,c){c=JSON.stringify(c);a("PusherChannel::trigger: Event "+b+", data "+c);if(!this.active)return a("PusherChannel::trigger: Inactive"),!0;this.channel.publish(b,c);return!0};b.prototype.addMember=function(a,b){"undefined"===typeof b&&(b={});a in this.members?this.members[a]=b:(this.members[a]=b,this.count++);return new f(a,
b)};b.prototype.removeMember=function(a){if(a in this.members){var b=this.members[a];delete this.members[a];this.count--;return new f(a,b)}};b.prototype.each=function(a){for(var b in this.members)a(new f(b,this.members[b]))};b.prototype.get=function(a){return this.members[a]};"undefined"===typeof window?module.exports=h:window.Pusher=h})()})();
