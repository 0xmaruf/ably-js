/*
 Copyright 2015, Ably

 Ably JavaScript Library v0.8.8
 https://github.com/ably/ably-js

 Ably Realtime Messaging
 https://www.ably.io

 Released under the Apache Licence v2.0
*/
(function(){var k=function(){function a(){this.any=[];this.events={};this.anyOnce=[];this.eventsOnce={}}a.prototype.on=function(a,d){1==arguments.length&&"function"==typeof a?this.any.push(a):null===a?this.any.push(d):(this.events[a]||(this.events[a]=[])).push(d)};a.prototype.off=function(a,d){if(0==arguments.length)this.any=[],this.events={},this.anyOnce=[],this.eventsOnce={};else{1==arguments.length&&"function"==typeof a&&(d=a,a=null);var b,e=-1;if(null===a)if(d){if(!(b=this.any)||-1==(e=g.arrIndexOf(b,
d)))if(b=this.anyOnce)e=g.arrIndexOf(b,d);-1<e&&b.splice(e,1)}else this.any=[],this.anyOnce=[];else if(d){e=-1;if(!(b=this.events[a])||-1==(e=g.arrIndexOf(b,d)))if(b=this.eventsOnce[a])e=g.arrIndexOf(b,d);-1<e&&b.splice(e,1)}else delete this.events[a],delete this.eventsOnce[a]}};a.prototype.listeners=function(a){if(a){var d=this.events[a]||[];this.eventsOnce[a]&&Array.prototype.push.apply(d,this.eventsOnce[a]);return d.length?d:null}return this.any.length?this.any:null};a.prototype.emit=function(a){function d(a){try{a.apply(e,
b)}catch(c){throw Logger.logAction(Logger.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+c+"; stack = "+c.stack),c;}}var b=Array.prototype.slice.call(arguments,1),e={event:a};if(this.anyOnce.length){var c=this.anyOnce;this.anyOnce=[];for(var f=0;f<c.length;f++)d(c[f])}for(f=0;f<this.any.length;f++)this.any[f].apply(e,b);if(c=this.eventsOnce[a])for(delete this.eventsOnce[a],f=0;f<c.length;f++)d(c[f]);if(c=this.events[a])for(f=0;f<c.length;f++)d(c[f])};a.prototype.once=function(a,
d){1==arguments.length&&"function"==typeof a?this.anyOnce.push(a):null===a?this.anyOnce.push(d):(this.eventsOnce[a]||(this.eventsOnce[a]=[])).push(d)};return a}(),g=function(){function a(){}var g="object"==typeof window;a.mixin=function(b,a){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b};a.copy=function(b){return a.mixin({},b)};a.isArray=function(b){return"[object Array]"==Object.prototype.toString.call(b)};a.isObject=function(b){return"[object Object]"==Object.prototype.toString.call(b)};
a.isEmpty=function(b){for(var a in b)return!1;return!0};a.shallowClone=function(b){var a={},c;for(c in b)a[c]=b[c];return a};a.prototypicalClone=function(b,e){function c(){}c.prototype=b;var f=new c;e&&a.mixin(f,e);return f};a.inherits="undefined"!==typeof require&&require("util").inherits||function(b,e){b.super_=e;b.prototype=a.prototypicalClone(e.prototype,{constructor:b})};a.containsValue=function(b,a){for(var c in b)if(b[c]==a)return!0;return!1};a.intersect=function(b,e){return a.isArray(e)?a.arrIntersect(b,
e):a.arrIntersectOb(b,e)};a.isArray=Array.isArray?Array.isArray:function(b){return"[object Array]"===Object.prototype.toString.call(b)};a.arrIntersect=function(b,e){for(var c=[],f=0;f<b.length;f++){var d=b[f];-1!=a.arrIndexOf(e,d)&&c.push(d)}return c};a.arrIntersectOb=function(b,a){for(var c=[],f=0;f<b.length;f++){var d=b[f];d in a&&c.push(d)}return c};a.arrSubtract=function(b,e){for(var c=[],f=0;f<b.length;f++){var d=b[f];-1==a.arrIndexOf(e,d)&&c.push(d)}return c};a.arrIndexOf=Array.prototype.indexOf?
function(b,a,c){return b.indexOf(a,c)}:function(b,a,c){c=c||0;for(var f=b.length;c<f;c++)if(b[c]===a)return c;return-1};a.arrIn=function(b,e){return-1!==a.arrIndexOf(b,e)};a.arrDeleteValue=function(b,e){var c=a.arrIndexOf(b,e),f=-1!=c;f&&b.splice(c,1);return f};a.keysArray=function(a,e){var c=[],f;for(f in a)e&&!a.hasOwnProperty(f)||c.push(f);return c.length?c:void 0};a.valuesArray=function(a,e){var c=[],f;for(f in a)e&&!a.hasOwnProperty(f)||c.push(a[f]);return c.length?c:void 0};a.nextTick=g?function(a){setTimeout(a,
0)}:process.nextTick;var d={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};a.defaultGetHeaders=function(a){a=a||"json";return{accept:"json"===a?d.json:d[a]+","+d.json}};a.defaultPostHeaders=function(a){a=a||"json";return{accept:"json"===a?d.json:d[a]+","+d.json,"content-type":"json"===a?d.json:d[a]}};a.arrRandomElement=function(a){return a.splice(Math.floor(Math.random()*a.length))};a.toQueryString=function(a){var e=[];
if(a)for(var c in a)e.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return e.length?"?"+e.join("&"):""};a.parseQueryString=function(a){for(var e,c=/([^?&=]+)=?([^&]*)/g,f={};e=c.exec(a);)f[decodeURIComponent(e[1])]=decodeURIComponent(e[2]);return f};a.inspect=function(a){return JSON.stringify(a)};a.inspectError=function(b){return b&&"ErrorInfo"==b.constructor.name?b.toString():a.inspect(b)};return a}();(function(){function a(a,b){var e=b.host||"",f=b.tlshost||"",d={key:a,tls:b.encrypted||
!1,log:{level:4}};b.ablyClientId&&(d.clientId=b.ablyClientId);b.authEndpoint&&(d.authUrl=b.authEndpoint);b.auth&&b.auth.params&&(d.authParams=b.auth.params);b.auth&&b.auth.headers&&(d.authHeaders=b.auth.headers);e&&0!=e.length&&(e=e.split(":"),d.host=d.wsHost=e[0],1<e.length&&(d.port=e[1]));f&&0!=f.length&&(e=f.split(":"),1<e.length&&(d.tlsPort=e[1]));f=this.ably=new (c||window.Ably).Realtime(d);this.clientId=d.clientId;this.connection=new h(f.connection);this.channels={}}function h(a){k.call(this);
this.connection=a;var b=this;a.on(function(a){var c=l[a.previous],e=b.state=l[a.current];b.emit(e);b.emit("state_change",{previous:c,current:e});a.retryIn&&b.emit("connecting_in",a.retryIn)})}function d(a,b){var c=this;this.active=!0;this.channel=a.ably.channels.get(b);this.name=b;if(this.isPresence=0==b.indexOf("presence-"))this.members=new e(this,a.clientId);this.channel.subscribe(function(a){JSON.stringify(this);JSON.stringify(a);c.channel.emit(a.name,a.data)});this.bindings={};this.bind_alls=
[];if(this.isPresence){var d=this.channel.presence;this.entered=!1;d.on("enter",function(a){c.entered&&a.clientId!==c.members.myID&&(a=c.members.addMember(a.clientId,a.clientInfo))&&c.channel.emit("pusher:member_added",a)});d.on("leave",function(a){c.entered&&(a=c.members.removeMember(a.clientId))&&c.channel.emit("pusher:member_removed",a)});d.enter(function(a){if(a=d.get())for(var b=0;b<a.length;b++)c.members.addMember(a[b].clientId,a[b].clientData);c.entered=!0;c._sendEvent("pusher:subscription_succeeded",
c.members)})}this.channel.on(function(a){"attached"===this.event&&c.isPresence||("undefined"===typeof a&&(a={}),c._sendEvent(q[this.event]||this.event,a))})}function b(a,b){this.id=a;this.info=b}function e(a,b,c){this.count=0;this.members={};b&&(this.myID=b,this.me=this.addMember(b,c))}if("undefined"!==typeof window)var c=window.Ably;else if("undefined"===typeof c){var c=require("../.."),f=require("fs"),n=require("path"),p=require("vm"),m=function(a){a=n.resolve(__dirname,a);return p.runInThisContext(f.readFileSync(a,
"utf8"),a)};"undefined"===typeof g&&m("../../common/lib/util/utils.js");"undefined"===typeof k&&m("../../common/lib/util/eventemitter.js")}var l={initialized:"initialized",connecting:"connecting",connected:"connected",disconnected:"disconnected",suspended:"unavailable",closed:"disconnected",failed:"failed"},q={attached:"pusher:subscription_succeeded",failed:"pusher:subscription_error"};a.prototype.disconnect=function(){this.ably.close();delete this.ably};a.prototype.channel=function(a){return this.channels[a]};
a.prototype.subscribe=function(a){return this.channels[a]=new d(this,a)};a.prototype.unsubscribe=function(a){var b=this.channels[a];b&&(b.channel.detach(),b.active=!1,delete this.channels[a])};g.inherits(h,k);h.prototype.bind=function(){this.on.apply(this,arguments)};h.prototype.unbind=function(){this.off.apply(this,arguments)};d.prototype._sendEvent=function(a,b){for(var c=0;c<this.bind_alls.length;c++)this.bind_alls[c](a,b);var d=this.bindings[a];if(d)for(c=0;c<d.length;c++)d[c](b)};d.prototype.bind_all=
function(a){this.bind_alls.push(a)};d.prototype.unbind=function(a,b){var c=this.bindings[a];if(c)for(var d=0;d<c.length;d++)if(c[d]===b){c.splice(d,1);0==c.length&&(this.channel.off(a,this.channelBindCallback),delete this.bindings[a]);break}};d.prototype.bind=function(a,b){this.bindings[a]?this.bindings[a].push(b):this.bindings[a]=[b]};d.prototype.trigger=function(a,b){JSON.stringify(b);if(!this.active)return!0;this.channel.publish(a,b);return!0};e.prototype.addMember=function(a,c){"undefined"===
typeof c&&(c={});a in this.members?this.members[a]=c:(this.members[a]=c,this.count++);return new b(a,c)};e.prototype.removeMember=function(a){if(a in this.members){var c=this.members[a];delete this.members[a];this.count--;return new b(a,c)}};e.prototype.each=function(a){for(var c in this.members)a(new b(c,this.members[c]))};e.prototype.get=function(a){return this.members[a]};"undefined"===typeof window?module.exports=a:window.Pusher=a})()})();
