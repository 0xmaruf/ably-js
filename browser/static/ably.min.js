(function(){window.Ably={};var y={disconnected:{statusCode:408,code:80003,message:"Connection to server temporarily unavailable"},suspended:{statusCode:408,code:80002,message:"Connection to server unavailable"},failed:{statusCode:408,code:8E4,message:"Connection failed or disconnected by server"},unknownConnectionErr:{statusCode:500,code:50002,message:"Internal connection error"},unknownChannelErr:{statusCode:500,code:50001,message:"Internal channel error"}};this.Cookie=function(){function a(){}"object"==
typeof window&&(a.create=function(a,d,c){var b="";c&&(b=new Date,b.setTime(b.getTime()+c),b="; expires="+b.toGMTString());document.cookie=a+"="+d+b+"; path=/"},a.read=function(a){a+="=";for(var d=document.cookie.split(";"),c=0;c<d.length;c++){for(var b=d[c];" "==b.charAt(0);)b=b.substring(1,b.length);if(0==b.indexOf(a))return b.substring(a.length,b.length)}return null},a.erase=function(a){createCookie(a,"",-36E5)});return a}();var p={protocolVersion:1,HOST:"rest.ably.io",WS_HOST:"realtime.ably.io",
FALLBACK_HOSTS:["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"],PORT:80,TLS_PORT:443,connectTimeout:15E3,disconnectTimeout:3E4,suspendedTimeout:12E4,recvTimeout:9E4,sendTimeout:1E4,connectionPersistTimeout:15E3,httpTransports:["xhr","iframe","jsonp"],transports:["web_socket","flash_socket","xhr","iframe","jsonp"],flashTransport:{swfLocation:("undefined"!==typeof window?window.location.protocol:"https:")+"//cdn.ably.io/lib/swf/WebSocketMainInsecure-0.9.swf"},
getHost:function(a,e,d){e=e||a.host||p.HOST;d&&(e=e==a.host&&(a.wsHost||e)||e==p.HOST&&(p.WS_HOST||e)||e);return e},getPort:function(a,e){return e||a.tls?a.tlsPort||p.TLS_PORT:a.port||p.PORT},getHosts:function(a){var e;a.host?(e=[a.host],a.fallbackHosts&&e.concat(a.fallbackHosts)):e=[p.HOST].concat(p.FALLBACK_HOSTS);return e}};"undefined"!==typeof exports&&this.exports!==exports&&(exports.defaults=p);var r=function(){function a(){}var e=function(){};a.get=function(d,c,b,f,g){g=g||e;var h="function"==
typeof c?c:function(b){return d.baseUri(b)+c},k,n=d.connection;k=n&&"connected"==n.state?[n.connectionManager.host]:p.getHosts(d.options);1==k.length?a.getUri(d,h(k[0]),b,f,g):a.getUri(d,h(k.shift()),b,f,function(c){if(c){var n=c.code;if("ENETUNREACH"==n||"EHOSTUNREACH"==n||"EHOSTDOWN"==n){a.getUri(d,h(k.shift()),b,f,g);return}}g.apply(null,arguments)})};a.getUri=function(d,c,b,f,g){g=g||e;a.Request(c,b,f,null,b&&"application/json"!=b.accept,g)};a.post=function(d,c,b,f,g,h){h=h||e;var k="function"==
typeof c?c:function(b){return d.baseUri(b)+c},n,q=d.connection;n=q&&"connected"==q.state?[q.connectionManager.host]:p.getHosts(d.options);1==n.length?a.postUri(d,k(n[0]),b,f,g,h):a.postUri(d,k(n.shift()),b,f,g,function(c){if(c){var e=c.code;if("ENETUNREACH"==e||"EHOSTUNREACH"==e||"EHOSTDOWN"==e){a.postUri(d,k(n.shift()),b,f,g,h);return}}h.apply(null,arguments)})};a.postUri=function(d,c,b,f,g,h){h=h||e;a.Request(c,b,g,f,b&&"application/json"!=b.accept,h)};a.supportsAuthHeaders=!1;a.supportsLinkHeaders=
!1;return a}(),A=Ably.Crypto=window.CryptoJS&&function(){function a(){}function l(){this.iv=this.key=this.algorithm=null}function d(b){var c=this.algorithm=b.algorithm.toUpperCase().replace(/-\d+$/,""),h=this.key=b.key;b=this.iv=b.iv;this.encryptCipher=CryptoJS.algo[c].createEncryptor(h,{iv:b});this.blockLengthWords=b.words.length}var c;if(window.Uint32Array&&window.crypto&&window.crypto.getRandomValues){var b=new Uint32Array(4);c=function(c,h){var d=c/4,a=4==d?b:new Uint32Array(d);window.crypto.getRandomValues(a);
for(var f=Array(d),e=0;e<d;e++)f[e]=a[e];h(null,CryptoJS.lib.WordArray.create(f))}}else c=function(b,c){console.log("Ably.Crypto.generateRandom(): WARNING: using insecure Math.random() to generate key or iv; see http://ably.io/documentation for how to fix this");for(var h=b/4,d=Array(h),a=0;a<h;a++)d[a]=Math.floor(4294967296*Math.random());c(null,CryptoJS.lib.WordArray.create(d))};var f=CryptoJS.lib.WordArray.create([0,0,0,0]),g=[CryptoJS.lib.WordArray.create([269488144,269488144,269488144,269488144],
16),CryptoJS.lib.WordArray.create([16777216],1),CryptoJS.lib.WordArray.create([33685504],2),CryptoJS.lib.WordArray.create([50529024],3),CryptoJS.lib.WordArray.create([67372036],4),CryptoJS.lib.WordArray.create([84215045,83886080],5),CryptoJS.lib.WordArray.create([101058054,101056512],6),CryptoJS.lib.WordArray.create([117901063,117901056],7),CryptoJS.lib.WordArray.create([134744072,134744072],8),CryptoJS.lib.WordArray.create([151587081,151587081,150994944],9),CryptoJS.lib.WordArray.create([168430090,
168430090,168427520],10),CryptoJS.lib.WordArray.create([185273099,185273099,185273088],11),CryptoJS.lib.WordArray.create([202116108,202116108,202116108],12),CryptoJS.lib.WordArray.create([218959117,218959117,218959117,218103808],13),CryptoJS.lib.WordArray.create([235802126,235802126,235802126,235798528],14),CryptoJS.lib.WordArray.create([252645135,252645135,252645135,252645135],15),CryptoJS.lib.WordArray.create([269488144,269488144,269488144,269488144],16)];a.generateRandom=c;a.CipherParams=l;a.getDefaultParams=
function(b,h){1==arguments.length&&"function"==typeof b&&(h=b,b=void 0);if(b){"string"===typeof b?b=CryptoJS.enc.Hex.parse(b):b.words||(b=CryptoJS.lib.WordArray.create(b));var d=new l;d.algorithm="aes-"+String(32*b.words.length);d.key=b;c(16,function(b,c){d.iv=c;h(null,d)})}else c(16,function(b,c){b?h(b):a.getDefaultParams(c,h)})};a.CipherData=function(b,c){this.cipherData=b;this.type=c};a.getCipher=function(b,c){var h=b&&b.cipherParams;h?h instanceof l?c(null,new d(h)):c(Error("ChannelOptions not supported")):
a.getDefaultParams(function(b,k){b?c(b):c(null,new d(k))})};d.prototype.encrypt=function(b){e.logAction(e.LOG_MICRO,"CBCCipher.encrypt()","");var c=b.sigBytes,h=c+16&-16,d=this.getIv().clone();b=this.encryptCipher.process(b.concat(g[h-c]));return d.concat(b)};d.prototype.decrypt=function(b){e.logAction(e.LOG_MICRO,"CBCCipher.decrypt()","");var c=this.blockLengthWords,h=b.words;b=CryptoJS.lib.WordArray.create(h.slice(0,c));h=CryptoJS.lib.WordArray.create(h.slice(c));c=CryptoJS.algo[this.algorithm].createDecryptor(this.key,
{iv:b});b=c.process(h);h=c.finalize();c.reset();h&&h.sigBytes&&b.concat(h);return b};d.prototype.getIv=function(){if(!this.iv)return this.encryptCipher.process(f);var b=this.iv;this.iv=null;return b};var h=a.Data={};h.asBase64=function(b){return CryptoJS.enc.Base64.stringify(b)};h.fromBase64=function(b){return CryptoJS.enc.Base64.parse(b)};h.utf8Encode=function(b){return CryptoJS.enc.Utf8.stringify(b)};h.utf8Decode=function(b){return CryptoJS.enc.Utf8.parse(b)};return a}(),D=function(){function a(){}
a.addListener=function(a,d,c){a.addEventListener?a.addEventListener(d,c,!1):a.attachEvent("on"+d,c)};a.removeListener=function(a,d,c){a.removeEventListener?a.removeEventListener(d,c,!1):a.detachEvent("on"+d,c)};a.addMessageListener=function(e,d){a.addListener(e,"message",d)};a.removeMessageListener=function(e,d){a.removeListener(e,"message",d)};a.addUnloadListener=function(e){a.addListener(window,"unload",e)};return a}();("function"===typeof define?function(a){define("msgpack-js",a)}:"object"===typeof exports?
function(a){module.exports=a()}:function(a){this.msgpack=a()})(function(){function a(b,c,d){for(var a=0,f=d.length;a<f;a++){var e=d.charCodeAt(a);if(128>e)b.setUint8(c++,e>>>0&127|0);else if(2048>e)b.setUint8(c++,e>>>6&31|192),b.setUint8(c++,e>>>0&63|128);else if(65536>e)b.setUint8(c++,e>>>12&15|224),b.setUint8(c++,e>>>6&63|128),b.setUint8(c++,e>>>0&63|128);else if(1114112>e)b.setUint8(c++,e>>>18&7|240),b.setUint8(c++,e>>>12&63|128),b.setUint8(c++,e>>>6&63|128),b.setUint8(c++,e>>>0&63|128);else throw Error("bad codepoint "+
e);}}function e(b,c,d){var a="",f=c;for(c+=d;f<c;f++)if(d=b.getUint8(f),0===(d&128))a+=String.fromCharCode(d);else if(192===(d&224))a+=String.fromCharCode((d&15)<<6|b.getUint8(++f)&63);else if(224===(d&240))a+=String.fromCharCode((d&15)<<12|(b.getUint8(++f)&63)<<6|(b.getUint8(++f)&63)<<0);else if(240===(d&248))a+=String.fromCharCode((d&7)<<18|(b.getUint8(++f)&63)<<12|(b.getUint8(++f)&63)<<6|(b.getUint8(++f)&63)<<0);else throw Error("Invalid byte "+d.toString(16));return a}function d(b){for(var c=
0,d=0,a=b.length;d<a;d++){var f=b.charCodeAt(d);if(128>f)c+=1;else if(2048>f)c+=2;else if(65536>f)c+=3;else if(1114112>f)c+=4;else throw Error("bad codepoint "+f);}return c}function c(b,c){this.offset=c||0;this.view=b}function b(c,k,f){var e=typeof c;if("string"===e){var g=d(c);if(32>g)return k.setUint8(f,g|160),a(k,f+1,c),1+g;if(65536>g)return k.setUint8(f,218),k.setUint16(f+1,g),a(k,f+3,c),3+g;if(4294967296>g)return k.setUint8(f,219),k.setUint32(f+1,g),a(k,f+5,c),5+g}if(c instanceof ArrayBuffer){g=
c.byteLength;if(65536>g)return k.setUint8(f,216),k.setUint16(f+1,g),(new Uint8Array(k.buffer)).set(new Uint8Array(c),f+3),3+g;if(4294967296>g)return k.setUint8(f,217),k.setUint32(f+1,g),(new Uint8Array(k.buffer)).set(new Uint8Array(c),f+5),5+g}if("number"===e){if(c<<0!==c)return k.setUint8(f,203),k.setFloat64(f+1,c),9;if(0<=c){if(128>c)return k.setUint8(f,c),1;if(256>c)return k.setUint8(f,204),k.setUint8(f+1,c),2;if(65536>c)return k.setUint8(f,205),k.setUint16(f+1,c),3;if(4294967296>c)return k.setUint8(f,
206),k.setUint32(f+1,c),5;throw Error("Number too big 0x"+c.toString(16));}if(-32<=c)return k.setInt8(f,c),1;if(-128<=c)return k.setUint8(f,208),k.setInt8(f+1,c),2;if(-32768<=c)return k.setUint8(f,209),k.setInt16(f+1,c),3;if(-2147483648<=c)return k.setUint8(f,210),k.setInt32(f+1,c),5;throw Error("Number too small -0x"+(-c).toString(16).substr(1));}if("undefined"===e)return k.setUint8(f,196),1;if(null===c)return k.setUint8(f,192),1;if("boolean"===e)return k.setUint8(f,c?195:194),1;if("object"===e){var e=
0,l=Array.isArray(c);if(l)g=c.length;else var z=Object.keys(c),g=z.length;16>g?(k.setUint8(f,g|(l?144:128)),e=1):65536>g?(k.setUint8(f,l?220:222),k.setUint16(f+1,g),e=3):4294967296>g&&(k.setUint8(f,l?221:223),k.setUint32(f+1,g),e=5);if(l)for(l=0;l<g;l++)e+=b(c[l],k,f+e);else for(l=0;l<g;l++)var m=z[l],e=e+b(m,k,f+e),e=e+b(c[m],k,f+e);return e}throw Error("Unknown type "+e);}function f(b){var c=typeof b;if("string"===c){var a=d(b);if(32>a)return 1+a;if(65536>a)return 3+a;if(4294967296>a)return 5+a}if(b instanceof
ArrayBuffer){a=b.byteLength;if(65536>a)return 3+a;if(4294967296>a)return 5+a}if("number"===c){if(b<<0!==b)return 9;if(0<=b){if(128>b)return 1;if(256>b)return 2;if(65536>b)return 3;if(4294967296>b)return 5;if(1.8446744073709552E19>b)return 9;throw Error("Number too big 0x"+b.toString(16));}if(-32<=b)return 1;if(-128<=b)return 2;if(-32768<=b)return 3;if(-2147483648<=b)return 5;if(-9223372036854775E3<=b)return 9;throw Error("Number too small -0x"+b.toString(16).substr(1));}if("boolean"===c||"undefined"===
c||null===b)return 1;if("object"===c){c=0;if(Array.isArray(b))for(var a=b.length,e=0;e<a;e++)c+=f(b[e]);else for(var g=Object.keys(b),a=g.length,e=0;e<a;e++)var l=g[e],c=c+(f(l)+f(b[l]));if(16>a)return 1+c;if(65536>a)return 3+c;if(4294967296>a)return 5+c;throw Error("Array or object too long 0x"+a.toString(16));}throw Error("Unknown type "+c);}var g={inspect:function(b){if(void 0===b)return"undefined";var c,d;b instanceof ArrayBuffer?(d="ArrayBuffer",c=new DataView(b)):b instanceof DataView&&(d="DataView",
c=b);if(!c)return JSON.stringify(b);for(var f=[],a=0;a<b.byteLength;a++){if(20<a){f.push("...");break}var e=c.getUint8(a).toString(16);1===e.length&&(e="0"+e);f.push(e)}return"<"+d+" "+f.join(" ")+">"}};g.utf8Write=a;g.utf8Read=e;g.utf8ByteCount=d;g.encode=function(c){var d=new ArrayBuffer(f(c)),a=new DataView(d);b(c,a,0);return d};g.decode=function(b){var d=new DataView(b),d=new c(d),f=d.parse();if(d.offset!==b.byteLength)throw Error(b.byteLength-d.offset+" trailing bytes");return f};c.prototype.map=
function(b){for(var c={},d=0;d<b;d++){var f=this.parse();c[f]=this.parse()}return c};c.prototype.buf=function(b){var c=new ArrayBuffer(b);(new Uint8Array(c)).set(new Uint8Array(this.view.buffer,this.offset,b),0);this.offset+=b;return c};c.prototype.raw=function(b){var c=e(this.view,this.offset,b);this.offset+=b;return c};c.prototype.array=function(b){for(var c=Array(b),d=0;d<b;d++)c[d]=this.parse();return c};c.prototype.parse=function(){var b=this.view.getUint8(this.offset);if(160===(b&224))return this.offset++,
this.raw(b&31);if(128===(b&240))return this.offset++,this.map(b&15);if(144===(b&240))return this.offset++,this.array(b&15);if(0===(b&128))return this.offset++,b;if(224===(b&224))return b=this.view.getInt8(this.offset),this.offset++,b;switch(b){case 218:return b=this.view.getUint16(this.offset+1),this.offset+=3,this.raw(b);case 219:return b=this.view.getUint32(this.offset+1),this.offset+=5,this.raw(b);case 192:return this.offset++,null;case 194:return this.offset++,!1;case 195:return this.offset++,
!0;case 196:this.offset++;return;case 204:return b=this.view.getUint8(this.offset+1),this.offset+=2,b;case 205:return b=this.view.getUint16(this.offset+1),this.offset+=3,b;case 206:return b=this.view.getUint32(this.offset+1),this.offset+=5,b;case 208:return b=this.view.getInt8(this.offset+1),this.offset+=2,b;case 209:return b=this.view.getInt16(this.offset+1),this.offset+=3,b;case 210:return b=this.view.getInt32(this.offset+1),this.offset+=5,b;case 222:return b=this.view.getUint16(this.offset+1),
this.offset+=3,this.map(b);case 223:return b=this.view.getUint32(this.offset+1),this.offset+=5,this.map(b);case 220:return b=this.view.getUint16(this.offset+1),this.offset+=3,this.array(b);case 221:return b=this.view.getUint32(this.offset+1),this.offset+=5,this.array(b);case 216:return b=this.view.getUint16(this.offset+1),this.offset+=3,this.buf(b);case 217:return b=this.view.getUint32(this.offset+1),this.offset+=5,this.buf(b);case 202:return b=this.view.getFloat32(this.offset+1),this.offset+=5,b;
case 203:return b=this.view.getFloat64(this.offset+1),this.offset+=9,b}throw Error("Unknown type 0x"+b.toString(16));};return g});var t=function(){function a(){this.any=[];this.events={};this.anyOnce=[];this.eventsOnce={}}a.prototype.on=function(a,d){1==arguments.length&&"function"==typeof a?this.any.push(a):null===a?this.any.push(d):(this.events[a]=this.events[a]||[]).push(d)};a.prototype.off=function(a,d){if(0==arguments.length)this.any=[],this.events={},this.anyOnce=[],this.eventsOnce={};else{1==
arguments.length&&"function"==typeof a&&(d=a,a=null);var c,b=-1;if(null===a)if(d){if(!(c=this.any)||-1==(b=m.arrIndexOf(c,d)))if(c=this.anyOnce)b=m.arrIndexOf(c,d);-1<b&&c.splice(b,1)}else this.any=[],this.anyOnce=[];else if(d){b=-1;if(!(c=this.events[a])||-1==(b=m.arrIndexOf(c,d)))if(c=this.eventsOnce[a])b=m.arrIndexOf(c,d);-1<b&&c.splice(b,1)}else delete this.events[a],delete this.eventsOnce[a]}};a.prototype.listeners=function(a){if(a){var d=this.events[a]||[];this.eventsOnce[a]&&Array.prototype.push.apply(d,
this.eventsOnce[a]);return d.length?d:null}return this.any.length?this.any:null};a.prototype.emit=function(a){function d(d){try{d.apply(b,c)}catch(a){e.logAction(e.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+a+"; stack = "+a.stack)}}var c=Array.prototype.slice.call(arguments,1),b={event:a};if(this.anyOnce.length){var f=this.anyOnce;this.anyOnce=[];for(var g=0;g<f.length;g++)d(f[g])}for(g=0;g<this.any.length;g++)this.any[g].apply(b,c);if(f=this.eventsOnce[a])for(delete this.eventsOnce[a],
g=0;g<f.length;g++)d(f[g]);if(f=this.events[a])for(g=0;g<f.length;g++)d(f[g])};a.prototype.once=function(a,d){1==arguments.length&&"function"==typeof a?this.anyOnce.push(a):null===a?this.anyOnce.push(d):(this.eventsOnce[a]=this.eventsOnce[a]||[]).push(d)};return a}(),e=function(){function a(c){}var e=4,d=function(){};a.LOG_NONE=0;a.LOG_ERROR=1;a.LOG_MAJOR=2;a.LOG_MINOR=3;a.LOG_MICRO=4;a.LOG_DEFAULT=3;a.LOG_DEBUG=4;a.logAction=function(c,b,a){c<=e&&d("Ably: "+b+": "+a)};a.setLog=function(c,b){e=c||
3;d=b||function(b){console.log(b)}};return a}(),m=function(){function a(){}var e="object"==typeof window;a.mixin=function(c,b){for(var a in b)c[a]=b[a];return c};a.copy=function(c){return a.mixin({},c)};a.isArray=function(c){return"[object Array]"==Object.prototype.toString.call(c)};a.isEmpty=function(c){for(var b in c)return!1;return!0};a.shallowClone=function(c){var b={},a;for(a in c)b[a]=c[a];return b};a.prototypicalClone=function(c,b){function d(){}d.prototype=c;var e=new d;b&&a.mixin(e,b);return e};
a.inherits="undefined"!==typeof require&&require("util").inherits||function(c,b){c.super_=b;c.prototype=a.prototypicalClone(b.prototype,{constructor:c})};a.containsValue=function(c,b){for(var a in c)if(c[a]==b)return!0;return!1};a.intersect=function(c,b){return a.isArray(b)?a.arrIntersect(c,b):a.arrIntersectOb(c,b)};a.isArray=Array.isArray?Array.isArray:function(c){return"[object Array]"===Object.prototype.toString.call(c)};a.arrIntersect=function(c,b){for(var d=[],e=0;e<c.length;e++){var h=c[e];
-1!=a.arrIndexOf(b,h)&&d.push(h)}return d};a.arrIntersectOb=function(c,b){for(var a=[],d=0;d<c.length;d++){var e=c[d];e in b&&a.push(e)}return a};a.arrSubtract=function(c,b){for(var d=[],e=0;e<c.length;e++){var h=c[e];-1==a.arrIndexOf(b,h)&&d.push(h)}return d};a.arrIndexOf=Array.prototype.indexOf?function(c,b,a){return c.indexOf(b,a)}:function(c,b,a){a=a||0;for(var d=c.length;a<d;a++)if(c[a]===b)return a;return-1};a.keysArray=function(c,b){var a=[],d;for(d in c)b&&!c.hasOwnProperty(d)||a.push(d);
return a.length?a:void 0};a.valuesArray=function(c,b){var a=[],d;for(d in c)b&&!c.hasOwnProperty(d)||a.push(c[d]);return a.length?a:void 0};a.nextTick=e?function(c){setTimeout(c,0)}:process.nextTick;var d={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};a.defaultGetHeaders=function(c){c=c||"json";return{accept:"json"===c?d.json:d[c]+","+d.json}};a.defaultPostHeaders=function(c){c=c||"json";return{accept:"json"===c?d.json:
d[c]+","+d.json,"content-type":"json"===c?d.json:d[c]}};a.arrRandomElement=function(c){return c.splice(Math.floor(Math.random()*c.length))};a.toQueryString=function(c){var b=[];if(c)for(var a in c)b.push(encodeURIComponent(a)+"="+encodeURIComponent(c[a]));return b.length?"?"+b.join("&"):""};a.parseQueryString=function(c){for(var b,a=/([^?&=]+)=?([^&]*)/g,d={};b=a.exec(c);)d[decodeURIComponent(b[1])]=decodeURIComponent(b[2]);return d};return a}(),H=function(){return function(a){a=a||[];var e=function(){for(var d=
0;d<a.length;d++){var c=a[d];try{c.apply(null,arguments)}catch(b){}}};e.push=function(){Array.prototype.push.apply(a,arguments)};return e}}(),v=function(){function a(b,c,a,d,e){this.options=b;this.host=c;this.mode=a;this.connectionId=d;this.connectionSerial=e;this.format=b.useBinaryProtocol?"msgpack":"json";b.transportParams&&void 0!==b.transportParams.stream&&(this.stream=b.transportParams.stream)}function l(b,c){this.msg=b;var a=b.action;this.ackRequired=a==f.MESSAGE||a==f.PRESENCE;this.callback=
c;this.merged=!1}function d(c,a){t.call(this);this.realtime=c;this.options=a;this.state=h.initialized;this.error=null;this.queuedMessages=[];this.pendingMessages=[];this.msgSerial=0;this.connectionSerial=this.connectionId=void 0;this.httpTransports=m.intersect(a.transports||p.httpTransports,d.httpTransports);this.transports=m.intersect(a.transports||p.transports,d.transports);this.upgradeTransports=m.arrSubtract(this.transports,this.httpTransports);this.httpHosts=p.getHosts(a);this.host=this.pendingTransport=
this.transport=null;e.logAction(e.LOG_MINOR,"Realtime.ConnectionManager()","started");e.logAction(e.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(a.transports||p.transports)+"]");e.logAction(e.LOG_MICRO,"Realtime.ConnectionManager()","available http transports = ["+this.httpTransports+"]");e.logAction(e.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]");e.logAction(e.LOG_MICRO,"Realtime.ConnectionManager()","http hosts = ["+this.httpHosts+
"]");if(!this.transports.length)throw e.logAction(e.LOG_ERROR,"realtime.ConnectionManager()","no requested transports available"),Error("no requested transports available");b&&!0===a.recover&&window.addEventListener&&window.addEventListener("beforeunload",this.persistConnection.bind(this))}var c="undefined"!==typeof Cookie&&Cookie.read,b="undefined"!==typeof Cookie&&Cookie.create,f=w.Action,g=function(){},h={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1},connecting:{state:"connecting",
terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:p.connectTimeout,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:p.disconnectTimeout},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:p.suspendedTimeout},closed:{state:"closed",terminal:!1,queueEvents:!1,sendEvents:!1},failed:{state:"failed",terminal:!0,queueEvents:!1,
sendEvents:!1}};a.prototype.getConnectParams=function(b){b=b?m.prototypicalClone(b):{};var a=this.options;switch(this.mode){case "upgrade":b.upgrade=this.connectionId;void 0!==this.connectionSerial&&(b.connection_serial=this.connectionSerial);break;case "resume":b.resume=this.connectionId;void 0!==this.connectionSerial&&(b.connection_serial=this.connectionSerial);break;case "recover":if(!0===a.recover){var d=c("ably-connection-id"),e=c("ably-connection-serial");null!==d&&null!==e&&(b.recover=d,b.connection_serial=
e)}else if(d=a.recover.match(/^(\w+):(\w+)$/))b.recover=d[1],b.connection_serial=d[2]}!1===a.echoMessages&&(b.echo="false");b.format=this.format;void 0!==this.stream&&(b.stream=this.stream);return b};m.inherits(d,t);d.httpTransports={};d.transports={};d.prototype.chooseTransport=function(b){e.logAction(e.LOG_MAJOR,"ConnectionManager.chooseTransport()","");if(this.transport)e.logAction(e.LOG_MINOR,"ConnectionManager.chooseTransport()","Transport already established"),b(null,this.transport);else{var c=
this.connectionId?"resume":this.options.recover?"recover":"clean",d=new a(this.options,null,c,this.connectionId,this.connectionSerial);e.logAction(e.LOG_MINOR,"ConnectionManager.chooseTransport()","Transport recovery mode = "+c+("clean"==c?"":"; connectionId = "+this.connectionId+"; connectionSerial = "+this.connectionSerial));var f=this;this.httpTransports.length?this.chooseHttpTransport(d,function(c,h){if(c)e.logAction(e.LOG_ERROR,"ConnectionManager.chooseTransport()","Unexpected error establishing transport; err = "+
c),b(c);else if(e.logAction(e.LOG_MINOR,"ConnectionManager.chooseTransport()","Establishing http transport: "+h),b(null,h),f.upgradeTransports.length)h.once("connected",function(b,c){m.nextTick(function(){e.logAction(e.LOG_MAJOR,"ConnectionManager.chooseTransport()","upgrading ... connectionId = "+c);d=new a(f.options,d.host,"upgrade",c);f.chooseTransportForHost(d,f.upgradeTransports.slice(),g)})})}):(d.host=this.httpHosts[0],e.logAction(e.LOG_MINOR,"ConnectionManager.chooseTransport()","No http transports available; ignoring fallback hosts"),
this.chooseTransportForHost(d,f.transports.slice(),b))}};d.prototype.chooseTransportForHost=function(b,c,a){var f=c.shift();if(f){var g=this;e.logAction(e.LOG_MICRO,"ConnectionManager.chooseTransportForHost()","trying "+f);d.transports[f].tryConnect(this,this.realtime.auth,b,function(d,h){d?g.chooseTransportForHost(b,c,a):(e.logAction(e.LOG_MICRO,"ConnectionManager.chooseTransport()","transport "+f+" connecting"),g.setTransportPending(h),a(null,h))})}else{var h=Error("Unable to connect (no available transport)");
h.statusCode=404;h.code=8E4;a(h)}};d.prototype.chooseHttpTransport=function(b,c){function a(){if(f.length)d.httpTransports[g.httpTransports[0]].checkConnectivity(function(d,e){d?c(d):e?(b.host=m.arrRandomElement(f),g.chooseTransportForHost(b,g.httpTransports.slice(),function(b,d){b?a():c(null,d)})):(d=Error("Unable to connect (network unreachable)"),d.statusCode=404,d.code=8E4,c(d))});else{var e=Error("Unable to connect (no available host)");e.statusCode=404;e.code=8E4;c(e)}}var f=this.httpHosts.slice(),
e=f.shift();if(e){b.host=e;var g=this;this.chooseTransportForHost(b,this.httpTransports.slice(),function(b,d){b?a():c(null,d)})}else e=Error("Unable to connect (no available host)"),e.statusCode=404,e.code=8E4,c(e)};d.prototype.setTransportPending=function(b){e.logAction(e.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+b);if(this.state==h.closed)b.close(!0);else{this.pendingTransport&&this.pendingTransport.close(!1);this.pendingTransport=b;for(var c=this,a=function(a){return function(d,
f,g){e.logAction(e.LOG_MINOR,"ConnectionManager.setTransportPending","on state = "+a);d&&d.message&&e.logAction(e.LOG_MICRO,"ConnectionManager.setTransportPending","reason =  "+d.message);f&&e.logAction(e.LOG_MICRO,"ConnectionManager.setTransportPending","connectionId =  "+f);void 0!==g&&e.logAction(e.LOG_MICRO,"ConnectionManager.setTransportPending","connectionSerial =  "+g);"connected"==a?(c.activateTransport(b,f,g),f=!0):f=c.deactivateTransport(b);f&&c.notifyState({state:a,error:d})}},d=["connected",
"disconnected","closed","failed"],f=0;f<d.length;f++){var g=d[f];b.on(g,a(g))}this.emit("transport.pending",b)}};d.prototype.activateTransport=function(c,a,d){e.logAction(e.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+c+"; connectionId = "+a+"; connectionSerial = "+d);if(this.state!=h.closed){var f=this.transport;f&&(this.transport=null,f.close(!1));if(f=this.pendingTransport)this.pendingTransport=null;this.transport=c;this.host=c.params.host;a&&this.connectionId!=a&&(this.realtime.connection.id=
this.connectionId=a,this.connectionSerial=void 0===d?-1:d,b&&!0===this.options.recover&&this.persistConnection(),this.msgSerial=0);var g=this;c.on("ack",function(b,c){e.logAction(e.LOG_MICRO,"ConnectionManager on(ack)","serial = "+b+"; count = "+c);g.ackMessage(b,c)});c.on("nack",function(b,c,a){e.logAction(e.LOG_ERROR,"ConnectionManager on(nack)","serial = "+b+"; count = "+c+"; err = "+a);a||(a=Error("Unknown error"),a.statusCode=500,a.code=50001,a.message="Unable to send message; channel not responding");
g.ackMessage(b,c,a)});this.emit("transport.active",c,a,c.params)}};d.prototype.deactivateTransport=function(b){var c=this.transport===b,a=null===this.transport&&this.pendingTransport===b;e.logAction(e.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+b);b.off("ack");b.off("nack");c?this.transport=this.host=null:a&&(this.pendingTransport=null);this.emit("transport.inactive",b);return c||a};d.prototype.persistConnection=function(){b&&this.connectionId&&void 0!==this.connectionSerial&&
(b("ably-connection-id",this.connectionId,p.connectionPersistTimeout),b("ably-connection-serial",this.connectionSerial,p.connectionPersistTimeout))};d.prototype.getStateError=function(){return y[this.state.state]};d.activeState=function(b){return b.queueEvents||b.sendEvents};d.prototype.enactStateChange=function(b){e.logAction(e.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+b.current+"; reason = "+(b.reason&&b.reason.message));this.state=h[b.current];this.state.terminal&&(this.error=
b.reason);this.emit("connectionstate",b,this.transport)};d.prototype.startConnectTimer=function(){var b=this;this.connectTimer=setTimeout(function(){b.connectTimer&&(e.logAction(e.LOG_MINOR,"ConnectionManager connect timer expired","requesting new state: "+h.connecting.failState),b.notifyState({state:h.connecting.failState}))},p.connectTimeout)};d.prototype.cancelConnectTimer=function(){this.connectTimer&&(clearTimeout(this.connectTimer),this.connectTimer=void 0)};d.prototype.startSuspendTimer=function(){var b=
this;this.suspendTimer||(this.suspendTimer=setTimeout(function(){b.suspendTimer&&(e.logAction(e.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),h.connecting.failState="suspended",h.connecting.queueEvents=!1,b.notifyState({state:"suspended"}))},p.suspendedTimeout))};d.prototype.cancelSuspendTimer=function(){h.connecting.failState="disconnected";h.connecting.queueEvents=!0;this.suspendTimer&&(clearTimeout(this.suspendTimer),delete this.suspendTimer)};d.prototype.startRetryTimer=
function(b){var c=this;this.retryTimer=setTimeout(function(){e.logAction(e.LOG_MINOR,"ConnectionManager retry timer expired","retrying");c.requestState({state:"connecting"})},b)};d.prototype.cancelRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),delete this.retryTimer)};d.prototype.notifyState=function(b){if(!this.state.terminal&&b.state!=this.state.state){e.logAction(e.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+b.state);var c=h[b.state];!c.sendEvents&&this.transport&&
(e.logAction(e.LOG_MINOR,"ConnectionManager.notifyState()","deleting transport "+this.transport),this.transport.dispose(),delete this.transport);this.cancelConnectTimer();this.cancelRetryTimer();"connected"==b.state&&this.cancelSuspendTimer();b=new J(this.state.state,c.state,c.retryDelay,b.error||y[c.state]);c.retryDelay&&this.startRetryTimer(c.retryDelay);this.enactStateChange(b);this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents?this.queuePendingMessages():this.realtime.channels.setSuspended(b.reason)}};
d.prototype.requestState=function(b){this.cancelConnectTimer();this.cancelRetryTimer();if(b.state!=this.state.state){if(this.state.terminal)throw Error(this.error.message);if("connecting"==b.state){if("connected"==this.state.state)return;this.connectImpl()}else this.pendingTransport&&(this.pendingTransport.close(!0),this.pendingTransport=null),"failed"==b.state?this.transport&&(this.transport.abort(b.reason),this.transport=null):(b.state="closed",this.cancelConnectTimer(),this.cancelRetryTimer(),
this.cancelSuspendTimer(),this.transport&&(this.transport.close(!0),this.transport=null));if(b.state!=this.state.state){var c=h[b.state];b=new J(this.state.state,c.state,c.retryIn,b.error||y[c.state]);this.enactStateChange(b)}}};d.prototype.connectImpl=function(){e.logAction(e.LOG_MINOR,"ConnectionManager.connectImpl()","starting connection");this.startSuspendTimer();this.startConnectTimer();var b=this,c=this.realtime.auth,a=function(d){e.logAction(e.LOG_ERROR,"ConnectionManager.connectImpl()",d);
401==d.statusCode&&-1!=d.message.indexOf("expire")&&"token"==c.method&&c.getToken(!0,function(c){c?a(c):b.connectImpl()});b.notifyState({state:h.connecting.failState,error:d})},d=function(){b.chooseTransport(function(b,c){b&&a(b)})};"basic"==c.method?d():c.authorise(null,null,function(b){b?a(b):d()})};d.prototype.send=function(b,c,a){a=a||g;var d=this.state;d.sendEvents?(e.logAction(e.LOG_MICRO,"ConnectionManager.send()","sending event"),this.sendImpl(new l(b,a))):d.queueEvents&&(c?this.queue(b,a):
(e.logAction(e.LOG_MICRO,"ConnectionManager.send()","rejecting event; state = "+d.state),console.log("send: "+Error().stack),a(this.error)))};d.prototype.sendImpl=function(b){var c=b.msg;b.ackRequired&&(c.msgSerial=this.msgSerial++,this.pendingMessages.push(b));try{this.transport.send(c,function(b){})}catch(a){e.logAction(e.LOG_ERROR,"ConnectionManager.sendQueuedMessages()","Unexpected exception in transport.send(): "+a)}};d.prototype.ackMessage=function(b,c,a){e.logAction(e.LOG_MICRO,"ConnectionManager.ackMessage()",
"serial = "+b+"; count = "+c);a=a||null;var d=this.pendingMessages,f=d[0];if(f&&(f=f.msg.msgSerial,b+=c,b>f))for(d=d.splice(0,b-f),b=0;b<d.length;b++)d[b].callback(a)};d.prototype.queue=function(b,c){e.logAction(e.LOG_MICRO,"ConnectionManager.queue()","queueing event");var a=this.queuedMessages[this.queuedMessages.length-1];a&&P.mergeTo(a.msg,b)?(a.merged||(a.callback=H([a.callback]),a.merged=!0),a.callback.push(c)):this.queuedMessages.push(new l(b,c))};d.prototype.sendQueuedMessages=function(){e.logAction(e.LOG_MICRO,
"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.length+" queued messages");for(var b;b=this.queuedMessages.shift();)this.sendImpl(b)};d.prototype.queuePendingMessages=function(){e.logAction(e.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+this.pendingMessages.length+" pending messages");this.queuedMessages=this.pendingMessages.concat(this.queuedMessages);this.pendingMessages=[]};d.prototype.onChannelMessage=function(b,c){if(c===this.transport){var a=b.connectionSerial;
void 0!==a&&(this.connectionSerial=a)}this.realtime.channels.onChannelMessage(b)};return d}(),x=function(){function a(c,b,a){t.call(this);this.connectionManager=c;this.auth=b;this.params=a;this.format=a.format;this.isConnected=!1}var l=w.Action,d=w.fromValues({action:l.CLOSE});m.inherits(a,t);a.prototype.connect=function(){};a.prototype.close=function(c){this.isConnected&&(this.isConnected=!1,this.sendClose(c));this.emit("closed",y.closed);this.dispose()};a.prototype.abort=function(c){this.isConnected&&
(this.isConnected=!1,this.sendClose(!0));this.emit("failed",c);this.dispose()};a.prototype.onChannelMessage=function(c){switch(c.action){case l.HEARTBEAT:e.logAction(e.LOG_MICRO,"Transport.onChannelMessage()","heartbeat; connectionId = "+this.connectionManager.connectionId);this.emit("heartbeat");break;case l.CONNECTED:this.onConnect(c);this.emit("connected",null,c.connectionId,c.connectionSerial);break;case l.CLOSED:case l.DISCONNECTED:this.isConnected=!1;this.onDisconnect();break;case l.ACK:this.emit("ack",
c.msgSerial,c.count);break;case l.NACK:this.emit("nack",c.msgSerial,c.count,c.error);break;case l.ERROR:var b=c.error;e.logAction(e.LOG_ERROR,"Transport.onChannelMessage()","error; connectionId = "+this.connectionManager.connectionId+"; err = "+JSON.stringify(b));if(!c.channel){this.abort({statusCode:b.statusCode,code:b.code,message:b.message});break}default:this.connectionManager.onChannelMessage(c,this)}};a.prototype.onConnect=function(c){this.connectionId=c.connectionId=c.connectionId.split("-").pop();
this.isConnected=!0};a.prototype.onDisconnect=function(){};a.prototype.onClose=function(c,b){if("closed"!=this.connectionManager.state.state){var a=c?"disconnected":"failed";this.isConnected=!1;var d=m.copy(y[a]);b&&(d.message=b);this.emit(a,d)}};a.prototype.sendClose=function(c){c&&this.send(d)};a.prototype.dispose=function(){this.off()};return a}();(function(){function a(a,c,b){x.call(this,a,c,b);this.wsHost=p.getHost(b.options,b.host,!0)}var l="object"==typeof window?window.WebSocket||window.MozWebSocket:
require("ws");m.inherits(a,x);a.isAvailable=function(){return!!l};a.isAvailable()&&(v.transports.web_socket=a);a.tryConnect=function(d,c,b,f){var g=new a(d,c,b),h=function(b){f(b)};g.on("wserror",h);g.on("wsopen",function(){e.logAction(e.LOG_MINOR,"WebSocketTransport.tryConnect()","viable transport "+g);g.off("wserror",h);f(null,g)});g.connect()};a.prototype.createWebSocket=function(a,c){var b=0;if(c)for(var f in c)a+=(b++?"&":"?")+f+"="+c[f];this.uri=a;return new l(a)};a.prototype.toString=function(){return"WebSocketTransport; uri="+
this.uri};a.prototype.connect=function(){e.logAction(e.LOG_MINOR,"WebSocketTransport.connect()","starting");x.prototype.connect.call(this);var a=this,c=this.params,b=c.options,f=(b.tls?"wss://":"ws://")+this.wsHost+":"+p.getPort(b)+"/";e.logAction(e.LOG_MINOR,"WebSocketTransport.connect()","uri: "+f);this.auth.getAuthParams(function(b,h){var k="",l;for(l in h)k+=" "+l+": "+h[l]+";";e.logAction(e.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+k);if(b)a.abort(b);else{k=c.getConnectParams(h);
try{var m=a.wsConnection=a.createWebSocket(f,k);m.binaryType="arraybuffer";m.onopen=function(){a.onWsOpen()};m.onclose=function(b,c){a.onWsClose(b,c)};m.onmessage=function(b){a.onWsData(b.data)};m.onerror=function(b){a.onWsError(b)}}catch(u){a.onWsError(u)}}})};a.prototype.send=function(a){this.wsConnection.send(w.encode(a,this.params.format))};a.prototype.onWsData=function(a){e.logAction(e.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+a.length+"; type = "+typeof a);try{this.onChannelMessage(w.decode(a,
this.format))}catch(c){e.logAction(e.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+c.stack)}};a.prototype.onWsOpen=function(){e.logAction(e.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket");this.emit("wsopen")};a.prototype.onWsClose=function(a,c){var b,f,g;"object"==typeof a?(b=a.wasClean,f=a.code,g=a.reason):(f=a,g=c||"",b=1E3==f);e.logAction(e.LOG_MINOR,"WebSocketTransport.onWsClose()","closed WebSocket; wasClean = "+b+"; code = "+f);delete this.wsConnection;
x.prototype.onClose.call(this,b,g)};a.prototype.onWsError=function(a){e.logAction(e.LOG_ERROR,"WebSocketTransport.onError()","Unexpected error from WebSocket: "+a);this.emit("wserror",a);this.abort()};a.prototype.dispose=function(){this.wsConnection&&(this.wsConnection.close(),delete this.wsConnection)};return a})();var E=function(){function a(a,d,c){c.format="json";x.call(this,a,d,c);this.stream="stream"in c?c.stream:!0;this.pendingItems=this.pendingCallback=this.recvRequest=this.sendRequest=null}
m.inherits(a,x);a.REQ_SEND=0;a.REQ_RECV=1;a.REQ_RECV_POLL=2;a.REQ_RECV_STREAM=3;a.prototype.connect=function(){e.logAction(e.LOG_MINOR,"CometTransport.connect()","starting");x.prototype.connect.call(this);var a=this,d=this.params,c=d.options,d=p.getHost(c,d.host),b=p.getPort(c);this.baseUri=(c.tls?"https://":"http://")+d+":"+b+"/comet/";var f=this.baseUri+"connect";e.logAction(e.LOG_MINOR,"CometTransport.connect()","uri: "+f);this.auth.getAuthParams(function(b,c){if(b)a.abort(b);else{a.authParams=
c;var d=a.params.getConnectParams(c);e.logAction(e.LOG_MINOR,"CometTransport.connect()","connectParams:"+m.toQueryString(d));var n=!1,d=a.recvRequest=a.createRequest(f,null,d,null,a.stream?3:1);d.on("data",function(b){n||(n=!0,a.emit("preconnect"));a.onData(b)});d.on("complete",function(b){a.recvRequest=null;b&&a.emit("error",b)});d.exec()}})};a.prototype.sendClose=function(a){var d=this.closeUri,c=this;d?(a=this.createRequest(d(a),null,this.authParams,null,0),a.on("complete",function(b){b&&c.emit("error",
b)}),a.exec()):callback({message:"Unable to close; not connected",code:8E4,statusCode:400})};a.prototype.dispose=function(){this.recvRequest&&(this.recvRequest.abort(),this.recvRequest=null)};a.prototype.onConnect=function(a){var d=a.connectionId;x.prototype.onConnect.call(this,a);var c=this.baseUri+d;e.logAction(e.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+c+"; connectionId = "+a.connectionId);this.sendUri=c+"/send";this.recvUri=c+"/recv";this.closeUri=function(b){return c+(b?"/close":"/disconnect")};
var b=this;m.nextTick(function(){b.recv()})};a.prototype.send=function(a,d){if(this.sendRequest)this.pendingItems=this.pendingItems||[],this.pendingItems.push(a),this.pendingCallback=this.pendingCallback||H(),this.pendingCallback.push(d);else{var c=this.pendingItems||[];c.push(a);this.pendingItems=null;var b=this.pendingCallback;b&&(b.push(d),d=b,this.pendingCallback=null);this.sendItems(c,d)}};a.prototype.sendItems=function(a,d){var c=this,b=this.sendRequest=c.createRequest(c.sendUri,null,c.authParams,
this.encodeRequest(a),0);b.on("complete",function(b,a){b&&e.logAction(e.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+b);c.sendRequest=null;if(a)c.onData(a);var h=c.pendingItems;if(h){c.pendingItems=null;var k=c.pendingCallback;c.pendingCallback=null;m.nextTick(function(){c.sendItems(h,k)})}d(b)});b.exec()};a.prototype.recv=function(){if(!this.recvRequest&&this.isConnected){var a=this,d=this.recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,a.stream?3:2);d.on("data",
function(c){a.onData(c)});d.on("complete",function(c){a.recvRequest=null;c?a.emit("error",c):m.nextTick(function(){a.recv()})});d.exec()}};a.prototype.onData=function(a){try{var d=this.decodeResponse(a);if(d&&d.length)for(a=0;a<d.length;a++)this.onChannelMessage(d[a])}catch(c){e.logAction(e.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+c.stack)}};a.prototype.encodeRequest=function(a){return JSON.stringify(a)};a.prototype.decodeResponse=function(a){"string"==typeof a&&
(a=JSON.parse(a));return a};return a}();this.Data=function(){function a(){}a.toData=function(a){return BufferUtils.isBuffer(a)?a:String(a)};a.fromEncoded=function(a,d){if("string"==typeof a){var c=d.xform,b;c&&(b=c.match(/((.+)\/)?(\w+)$/))&&"base64"==b[3]&&(a=BufferUtils.decodeBase64(a),d.xform=b[2])}return a};return a}();var B=function(){function a(){this.xform=this.data=this.clientId=this.timestamp=this.id=this.name=void 0}var e="object"==typeof window?window.msgpack:require("msgpack-js");a.prototype.toJSON=
function(){var a={name:this.name,clientId:this.clientId,timestamp:this.timestamp,xform:this.xform},c=this.data;if(0<arguments.length&&BufferUtils.isBuffer(c)){var b=this.xform;a.xform=b?b+"/base64":"base64";c=BufferUtils.base64Encode(c)}a.data=c;return a};a.encrypt=function(a,c){var b=a.data,e=a.xform;BufferUtils.isBuffer(b)||(b=A.Data.utf8Encode(String(b)),e=e?e+"/utf-8":"utf-8");a.data=c.cipher.encrypt(b);a.xform=e?e+"/cipher":"cipher"};a.encode=function(d,c){null!=c&&c.encrypted&&a.encrypt(d,c)};
a.toRequestBody=function(d,c,b){for(var f=0;f<d.length;f++)a.encode(d[f],c);return"msgpack"==b?e.encode(d,!0):JSON.stringify(d)};a.decode=function(a,c){var b=a.xform;if(b){var e=0,g=b.length,h=a.data;try{for(;0<=(e=g);){var g=b.lastIndexOf("/",e-1),k=b.substring(g+1,e);if("base64"==k)h=BufferUtils.base64Decode(String(h));else if("utf-8"==k)h=A.Data.utf8Decode(h);else if("cipher"==k&&null!=c&&c.encrypted)h=c.cipher.decrypt(h);else break}}finally{a.xform=0>=e?null:b.substring(0,e),a.data=h}}};a.fromResponseBody=
function(d,c,b){d="msgpack"==b?e.decode(d):JSON.parse(String(d));for(b=0;b<d.length;b++){var f=d[b]=a.fromDecoded(d[b]);a.decode(f,c)}};a.fromDecoded=function(d){return m.mixin(new a,d)};a.fromValues=function(d){d=m.mixin(new a,d);d.data=Data.toData(d.data);d.timestamp=d.timestamp||Date.now();return d};a.fromValuesArray=function(d){for(var c=d.length,b=Array(c),e=0;e<c;e++)b[e]=a.fromValues(d[e]);return b};return a}(),C=function(){function a(){this.inheritMemberId=this.memberId=this.xform=this.clientData=
this.clientId=this.timestamp=this.id=this.action=void 0}var e="object"==typeof window?window.msgpack:require("msgpack-js");a.Action={ENTER:0,LEAVE:1,UPDATE:2};a.prototype.toJSON=function(){var a={name:this.name,clientId:this.clientId,memberId:this.memberId,timestamp:this.timestamp,action:this.action,xform:this.xform},c=this.clientData;if(0<arguments.length&&BufferUtils.isBuffer(c)){var b=this.xform;a.xform=b?b+"/base64":"base64";c=c.toString("base64")}a.clientData=c;return a};a.encrypt=function(a,
c){var b=a.clientData,e=a.xform;BufferUtils.isBuffer(b)||(b=A.Data.utf8Encode(String(b)),e=e?e+"/utf-8":"utf-8");a.clientData=c.cipher.encrypt(b);a.xform=e?e+"/cipher":"cipher"};a.encode=function(d,c){null!=c&&c.encrypted&&a.encrypt(d,c)};a.decode=function(a,c){var b=a.xform;if(b){var e=0,g=b.length,h=a.clientData;try{for(;0<=(e=g);){var g=b.lastIndexOf("/",e-1),k=b.substring(g+1,e);if("base64"==k)h=BufferUtils.base64Decode(String(h));else if("utf-8"==k)h=A.Data.utf8Decode(h);else if("cipher"==k&&
null!=c&&c.encrypted)h=c.cipher.decrypt(h);else break}}finally{this.xform=0>=e?null:b.substring(0,e),this.clientData=h}}};a.fromResponseBody=function(d,c,b){d="msgpack"==b?e.decode(d):JSON.parse(String(d));for(b=0;b<d.length;b++){var f=d[b]=a.fromDecoded(d[b]);a.decode(f,c)}};a.fromDecoded=function(d){return m.mixin(new a,d)};a.fromValues=function(d){d=m.mixin(new a,d);d.clientData=Data.toData(d.clientData);d.timestamp=d.timestamp||Date.now();return d};a.fromValuesArray=function(d){for(var c=d.length,
b=Array(c),e=0;e<c;e++)b[e]=a.fromValues(d[e]);return b};return a}(),w=function(){function a(){this.presence=this.messages=this.msgSerial=this.channelSerial=this.channel=this.connectionSerial=this.connectionId=this.error=this.count=this.timestamp=this.id=this.action=void 0}var e="object"==typeof window?window.msgpack:require("msgpack-js");a.Action={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,
MESSAGE:15};a.encode=function(a,c){return"msgpack"==c?e.encode(a,!0):JSON.stringify(a)};a.decode=function(d,c){var b="msgpack"==c?e.decode(d):JSON.parse(String(d));return a.fromDecoded(b)};a.fromDecoded=function(d){var c=d.error;c&&(d.error=ErrorInfo.fromValues(c));var b=d.messages;if(b)for(c=0;c<b.length;c++)b[c]=B.fromDecoded(b[c]);if(b=d.presence)for(c=0;c<b.length;c++)b[c]=C.fromDecoded(b[c]);return m.mixin(new a,d)};a.fromValues=function(d){return m.mixin(new a,d)};return a}(),K=function(){function a(){}
function e(c,b,a,d,h){r.supportsAuthHeaders?c.auth.getAuthHeaders(function(c,e){c?d(c):h(m.mixin(e,b),a)}):c.auth.getAuthParams(function(c,e){c?d(c):h(b,m.mixin(e,a))})}function d(c){return function(b,a){if(b)c(b);else{var d=a.statusCode,e=a.response,k=a.headers;200>d||300<=d?(b=e&&e.error,b||(b=Error(String(a)),b.statusCode=d),c(b)):c(null,e,k)}}}a.get=function(c,b,a,g,h,k){function n(d,h){r.get(c,b,d,h,function(b,d,h){b&&40140==b.code?c.auth.authorise({force:!0},null,function(b){b?k(b):e(c,a,g,
k,n)}):k(b,d,h)})}h&&(k=k&&d(k),(g=g||{}).envelope="true");e(c,a,g,k,n)};a.post=function(c,b,a,g,h,k,n){function m(d,k){r.post(c,b,d,a,k,function(b,a,d){b&&40140==b.code?c.auth.authorise({force:!0},null,function(b){b?n(b):e(c,g,h,n,m)}):n(b,a,d)})}k&&(n=d(n),h.envelope="true");e(c,g,h,n,m)};return a}(),L=function(){function a(a,d,c,b,e,g){this.rest=a;this.path=d;this.headers=c;this.params=b;this.envelope=e;this.bodyHandler=g}a.prototype.get=function(a){var d=this;K.get(this.rest,this.path,this.headers,
this.params,this.envelope,function(c,b,f){if(c)e.logAction(e.LOG_ERROR,"PaginatedResource.get()","Unexpected error getting resource: err = "+JSON.stringify(c));else{var g,h,k;try{g=d.bodyHandler(b)}catch(n){a(n);return}if(f&&(h=f.Link||f.link)){c=h;"string"==typeof c&&(c=c.split(","));b={};for(f=0;f<c.length;f++)(h=c[f].match(/^\s*<(.+)>;\s*rel="(\w+)"$/))&&(k=(k=h[1].match(/^\.\/(\w+)\?(.*)$/))&&m.parseQueryString(k[2]))&&(b[h[2]]=k);k=b}a(null,g,k)}})};return a}(),S=function(){function a(){}function l(b){if(!b)return"";
"string"==typeof b&&(b=JSON.parse(b));var a={},c=m.keysArray(b,!0);if(!c)return"";c.sort();for(var d=0;d<c.length;d++)a[c[d]]=b[c[d]].sort();return JSON.stringify(a)}function d(b,a){this.rest=b;this.tokenParams={};if(a.keyValue){if(!a.clientId){e.logAction(e.LOG_MINOR,"Auth()","anonymous, using basic auth");this.method="basic";this.basicKey=g(a.key||a.keyId+":"+a.keyValue);this.keyId=a.keyId;this.keyValue=a.keyValue;return}if(!f){var c="client-side token request signing not supported";e.logAction(e.LOG_ERROR,
"Auth()",c);throw Error(c);}}this.method="token";a.authToken&&(this.token={id:a.authToken});if(a.authCallback)e.logAction(e.LOG_MINOR,"Auth()","using token auth with authCallback");else if(a.authUrl)e.logAction(e.LOG_MINOR,"Auth()","using token auth with authUrl");else if(a.keyValue)e.logAction(e.LOG_MINOR,"Auth()","using token auth with client-side signing");else if(this.token)e.logAction(e.LOG_MINOR,"Auth()","using token auth with supplied token only");else throw c="options must include valid authentication parameters",
e.logAction(e.LOG_ERROR,"Auth()",c),Error(c);}var c="object"==typeof window,b=c?null:require("crypto"),f,g=void 0;c?(g=Base64.encode,window.CryptoJS&&CryptoJS.HmacSHA256&&CryptoJS.enc.Base64&&(f=function(b,a){return CryptoJS.HmacSHA256(b,a).toString(CryptoJS.enc.Base64)})):(g=function(b){return(new Buffer(b,"ascii")).toString("base64")},f=function(a,c){var d=b.createHmac("SHA256",c);d.update(a);return d.digest("base64")});d.prototype.authorise=function(b,a,c){var d=this.token;if(d)if(void 0===d.expires||
d.expires>this.getTimestamp()){if(!b||!b.force){e.logAction(e.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+d.expires);c(null,d);return}}else e.logAction(e.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.token=null;var f=this;this.requestToken(b,a,function(b,a){b?c(b):c(null,f.token=a)})};d.prototype.requestToken=function(b,c,d){"function"!=typeof b||d?"function"!=typeof c||d||(d=c,c=b,b=null):(d=b,b=c=null);b=m.mixin(m.copy(this.rest.options),b);c=c||m.copy(this.tokenParams);
d=d||a;var f,g=this.rest;if(b.authCallback)e.logAction(e.LOG_MINOR,"Auth.requestToken()","using token auth with auth_callback"),f=b.authCallback;else if(b.authUrl)e.logAction(e.LOG_MINOR,"Auth.requestToken()","using token auth with auth_url"),f=function(a,c){var d=m.mixin({accept:"application/json"},b.authHeaders);r.getUri(g,b.authUrl,d||{},m.mixin(a,b.authParams),c)};else if(b.keyValue){var G=this;e.logAction(e.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing");f=function(a,
c){G.createTokenRequest(b,a,c)}}else throw Error("Auth.requestToken(): authOptions must include valid authentication parameters");"capability"in c&&(c.capability=l(c.capability));var g=this.rest,z=function(a,c){var d,e=function(b){return g.baseUri(b)+"/keys/"+a.id+"/requestToken"};r.post?(d=m.defaultPostHeaders(),b.requestHeaders&&m.mixin(d,b.requestHeaders),r.post(g,e,d,a,null,c)):(d=m.defaultGetHeaders(),b.requestHeaders&&m.mixin(d,b.requestHeaders),r.get(g,e,d,a,c))};f(c,function(b,a){b?(e.logAction(e.LOG_ERROR,
"Auth.requestToken()","token request signing call returned error; err = "+b),"code"in b||(b.code=40170),"statusCode"in b||(b.statusCode=401),d(b)):"issued_at"in a?d(null,a):z(a,function(b,a){b?(e.logAction(e.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+b),d(b)):("string"===typeof a&&(a=JSON.parse(a)),e.logAction(e.LOG_MINOR,"Auth.getToken()","token received"),d(null,a.access_token))})})};d.prototype.createTokenRequest=function(b,a,c){b=b||this.rest.options;a=a||
m.copy(this.tokenParams);var d=b.keyId,g=b.keyValue;if(d&&g){var l={id:d},z=a.client_id||"";z&&(l.client_id=z);var p=a.ttl||"";p&&(l.ttl=p);var I=a.capability||"";I&&(l.capability=I);var r=this.rest,R=this;(function(d){a.timestamp?d():b.queryTime?r.time(function(b,e){b?c(b):(a.timestamp=Math.floor(e/1E3),d())}):(a.timestamp=R.getTimestamp(),d())})(function(){var b=l.nonce=a.nonce||("000000"+Math.floor(1E16*Math.random())).slice(-16),d=l.timestamp=a.timestamp,b=l.id+"\n"+p+"\n"+I+"\n"+z+"\n"+d+"\n"+
b+"\n";l.mac=a.mac||f(b,g);e.logAction(e.LOG_MINOR,"Auth.getTokenRequest()","generated signed request");c(null,l)})}else c(Error("No key specified"))};d.prototype.getAuthParams=function(b){"basic"==this.method?b(null,{key_id:this.keyId,key_value:this.keyValue}):this.authorise(null,null,function(a,c){a?b(a):b(null,{access_token:c.id})})};d.prototype.getAuthHeaders=function(b){"basic"==this.method?b(null,{authorization:"Basic "+this.basicKey}):this.authorise(null,null,function(a,c){a?b(a):b(null,{authorization:"Bearer "+
g(c.id)})})};d.prototype.getTimestamp=function(){var b=Date.now()+(this.rest.serverTimeOffset||0);return Math.floor(b/1E3)};return d}(),N=function(){function a(a){if(!a){var b="no options provided";e.logAction(e.LOG_ERROR,"Rest()",b);throw Error(b);}"string"==typeof a&&(a={key:a});this.options=a;"undefined"===typeof this.options.useBinaryProtocol&&(this.options.useBinaryProtocol=BufferUtils.supportsBinary);if(a.key){b=a.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!b)throw b="invalid key parameter",e.logAction(e.LOG_ERROR,
"Rest()",b),Error(b);a.keyId=b[1];a.keyValue=b[2]}a.log&&e.setLog(a.log.level,a.log.handler);e.logAction(e.LOG_MINOR,"Rest()","started");this.clientId=a.clientId;"tls"in a||(a.tls=!0);this.serverTimeOffset=null;this.baseUri=this.authority=function(b){return"https://"+b+":"+(a.tlsPort||p.TLS_PORT)};this.auth=new S(this,a);this.channels=new l(this)}function l(a){this.rest=a;this.attached={}}var d=function(){};a.prototype.stats=function(a,b){void 0===b&&("function"==typeof a?(b=a,a=null):b=d);var e=
m.copy(m.defaultGetHeaders()),g=!r.supportsLinkHeaders;this.options.headers&&m.mixin(e,this.options.headers);(new L(this,"/stats",e,a,g,function(b){return"string"===typeof b?JSON.parse(b):b})).get(b)};a.prototype.time=function(a,b){void 0===b&&("function"==typeof a?(b=a,a=null):b=d);var e=m.copy(m.defaultGetHeaders());this.options.headers&&m.mixin(e,this.options.headers);var g=this;r.get(this,function(b){return g.authority(b)+"/time"},e,a,function(a,c){if(a)b(a);else{"string"===typeof c&&(c=JSON.parse(c));
var d=c[0];d?(g.serverTimeOffset=d-Date.now(),b(null,d)):(a=Error("Internal error (unexpected result type from GET /time)"),a.statusCode=500,b(a))}})};l.prototype.get=function(a){a=String(a);var b=this.attached[a];b||(this.attached[a]=b=new M(this.rest,a));return b};return a}(),O=function(){function a(a){e.logAction(e.LOG_MINOR,"Realtime()","");N.call(this,a);this.connection=new T(this,a);this.channels=new l(this);this.connection.connect()}function l(a){this.realtime=a;this.attached={};var c=this;
a.connection.connectionManager.on("transport.active",function(b){c.onTransportActive(b)})}m.inherits(a,N);a.prototype.close=function(){e.logAction(e.LOG_MINOR,"Realtime.close()","");this.connection.close()};l.prototype.onChannelMessage=function(a){var c=a.channel;if(c){var b=this.attached[c];if(b)b.onMessage(a);else e.logAction(e.LOG_ERROR,"ConnectionManager on(channelmessage)","received event for non-existent channel: "+c)}else e.logAction(e.LOG_ERROR,"ConnectionManager on(channelmessage)","received event unspecified channel: "+
c)};l.prototype.onTransportActive=function(){for(var a in this.attached)this.attached[a].checkPendingState()};l.prototype.setSuspended=function(a){for(var c in this.attached)this.attached[c].setSuspended(a)};l.prototype.get=function(a){a=String(a);var c=this.attached[a];c||(this.attached[a]=c=new P(this.realtime,a,this.realtime.options));return c};return a}(),J=function(){return function(a,e,d,c){this.previous=a;this.current=e;d&&(this.retryIn=d);c&&(this.reason=c)}}(),T=function(){function a(a,d){t.call(this);
this.ably=a;this.connectionManager=new v(a,d);this.state=this.connectionManager.state.state;this.id=void 0;var c=this;this.connectionManager.on("connectionstate",function(b){var a=c.state=b.current;m.nextTick(function(){c.emit(a,b)})})}m.inherits(a,t);a.prototype.on=function(a,d){t.prototype.on.apply(this,arguments);if(this.state==a&&d)try{d(new J(void 0,a))}catch(c){}};a.prototype.connect=function(){e.logAction(e.LOG_MAJOR,"Connection.connect()","");this.connectionManager.requestState({state:"connecting"})};
a.prototype.close=function(){e.logAction(e.LOG_MAJOR,"Connection.close()","connectionId = "+this.id);this.connectionManager.requestState({state:"closed"})};return a}(),M=function(){function a(){}function l(b,a,c){e.logAction(e.LOG_MINOR,"Channel()","started; name = "+a);t.call(this);this.rest=b;this.name=a;this.basePath="/channels/"+encodeURIComponent(a);this.presence=new d(this);this.setOptions(c)}function d(b){this.channel=b;this.basePath=b.basePath+"/presence"}var c={};m.inherits(l,t);l.prototype.setOptions=
function(b,d){d=d||a;b=this.options=m.prototypicalClone(c,b);b.encrypted?A.getCipher(b,function(a,c){b.cipher=c;d(null)}):d(null,b.cipher=null)};l.prototype.history=function(b,c){e.logAction(e.LOG_MICRO,"Channel.history()","channel = "+this.name);void 0===c&&("function"==typeof b?(c=b,b=null):c=a);var d=this.rest,h=!r.supportsLinkHeaders,k=d.options.useBinaryProtocol?"msgpack":"json",l=m.copy(m.defaultGetHeaders(k)),q=this.options;d.options.headers&&m.mixin(l,d.options.headers);(new L(d,this.basePath+
"/messages",l,b,h,function(b){return B.fromResponseBody(b,q,k)})).get(c)};l.prototype.publish=function(b,c,d){e.logAction(e.LOG_MICRO,"Channel.publish()","channel = "+this.name+"; name = "+b);d=d||a;var h=this.rest,k=h.options.useBinaryProtocol?"msgpack":"json";b=B.fromValues({name:b,data:c});b=B.toRequestBody([b],this.options,k);k=m.copy(m.defaultPostHeaders(k));h.options.headers&&m.mixin(k,h.options.headers);K.post(h,this.basePath+"/messages",b,k,null,!1,d)};d.prototype.get=function(b,c){e.logAction(e.LOG_MICRO,
"Channel.presence.get()","channel = "+this.channel.name);void 0===c&&("function"==typeof b?(c=b,b=null):c=a);var d=this.channel.rest,h=d.options.useBinaryProtocol?"msgpack":"json",k=m.copy(m.defaultGetHeaders(h)),l=this.channel.options;d.options.headers&&m.mixin(k,d.options.headers);K.get(d,this.basePath,k,b,!1,function(b,a){b?c(b):c(null,C.fromResponseBody(a,l,h))})};d.prototype.history=function(b,c){e.logAction(e.LOG_MICRO,"Channel.presence.history()","channel = "+this.channel.name);void 0===c&&
("function"==typeof b?(c=b,b=null):c=a);var d=this.channel.rest,h=!r.supportsLinkHeaders,k=d.options.useBinaryProtocol?"msgpack":"json",l=m.copy(m.defaultGetHeaders(k)),q=this.channel.options;d.options.headers&&m.mixin(l,d.options.headers);(new L(d,this.basePath+"/history",l,b,h,function(b){return C.fromResponseBody(b,q,k)})).get(c)};return l}(),P=function(){function a(b,a,c){e.logAction(e.LOG_MINOR,"RealtimeChannel()","started; name = "+a);M.call(this,b,a,c);this.presence=new U(this,c);this.connectionManager=
b.connection.connectionManager;this.state="initialized";this.subscriptions=new t;this.pendingEvents=[];this.setOptions(c)}var l=w.Action,d=function(){},c={queueEvents:!0};m.inherits(a,M);a.invalidStateError={statusCode:400,code:90001,message:"Channel operation failed (invalid channel state)"};a.channelDetachedErr={statusCode:409,code:90006,message:"Channel is detached"};a.prototype.setOptions=function(b,a){a=a||d;b=this.options=m.prototypicalClone(c,b);b.encrypted?A.getCipher(b,function(c,d){b.cipher=
d;a(null)}):a(null,b.cipher=null)};a.prototype.publish=function(){var b=arguments.length,a=arguments[0],c=arguments[b-1],e=this.options;"function"!==typeof c&&(c=d,++b);var k=this.connectionManager;if(v.activeState(k.state)){2==b?(m.isArray(a)||(a=[a]),a=B.fromValuesArray(a)):a=[B.fromValues({name:arguments[0],data:arguments[1]})];for(b=0;b<a.length;b++)B.encode(a[b],e);this._publish(a,c)}else c(k.getStateError())};a.prototype._publish=function(b,a){e.logAction(e.LOG_MICRO,"RealtimeChannel.publish()",
"message count = "+b.length);switch(this.state){case "attached":e.logAction(e.LOG_MICRO,"RealtimeChannel.publish()","sending message");var c=new w;c.action=l.MESSAGE;c.channel=this.name;c.messages=b;this.sendMessage(c,a);break;default:this.attach();case "attaching":e.logAction(e.LOG_MICRO,"RealtimeChannel.publish()","queueing message"),this.pendingEvents.push({messages:b,callback:a})}};a.prototype.onEvent=function(b){e.logAction(e.LOG_MICRO,"RealtimeChannel.onEvent()","received message");for(var a=
this.subscriptions,c=0;c<b.length;c++){var d=b[c];a.emit(d.name,d)}};a.prototype.attach=function(b){b=b||d;var a=this.connectionManager;v.activeState(a.state)?"attached"==this.state?b():"failed"==this.state?b(a.getStateError()):(this.once(function(c){switch(this.event){case "attached":b();break;case "detached":case "failed":b(c||a.getStateError())}}),this.setPendingState("attaching")):b(a.getStateError())};a.prototype.attachImpl=function(b){e.logAction(e.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message");
var a=w.fromValues({action:l.ATTACH,channel:this.name});this.sendMessage(a,b||d)};a.prototype.detach=function(b){b=b||d;var c=this.connectionManager;v.activeState(c.state)?"detached"==this.state?b():(this.once(function(a){switch(this.event){case "detached":b();break;case "attached":b(y.unknownChannelErr);break;case "failed":b(a||c.getStateError())}}),this.setPendingState("detaching"),this.setSuspended(a.channelDetachedErr,!0)):b(c.getStateError())};a.prototype.detachImpl=function(b){e.logAction(e.LOG_MICRO,
"RealtimeChannel.detach()","sending DETACH message");var a=w.fromValues({action:l.DETACH,channel:this.name});this.sendMessage(a,b||d)};a.prototype.subscribe=function(){var b=Array.prototype.slice.call(arguments);1==b.length&&"function"==typeof b[0]&&b.unshift(null);var a=b[0],c=b[1],b=b[2]||(b[2]=d),e=this.subscriptions;if(null!==a&&m.isArray(a))for(var k=0;k<a.length;k++)e.on(a[k],c);else e.on(a,c);this.attach(b)};a.prototype.unsubscribe=function(){var b=Array.prototype.slice.call(arguments);1==
b.length&&"function"==typeof b[0]&&b.unshift(null);var a=b[0],b=b[1],c=this.subscriptions;if(null!==a&&m.isArray(a))for(var d=0;d<a.length;d++)c.off(a[d],b);else c.off(a,b)};a.prototype.sendMessage=function(b,a){this.connectionManager.send(b,this.options.queueEvents,a)};a.prototype.sendPresence=function(b,a){var c=w.fromValues({action:l.PRESENCE,channel:this.name,presence:[C.fromValues(b)]});this.sendMessage(c,a)};a.prototype.onMessage=function(b){switch(b.action){case l.ATTACHED:this.setAttached(b);
break;case l.DETACHED:this.setDetached(b);break;case l.PRESENCE:var a=b.presence,c=b.id;b=b.timestamp;for(var d=this.options,k=0;k<a.length;k++){try{var m=a[k];C.decode(m,d)}catch(q){var u="Unexpected error decrypting message; err = "+q;e.logAction(e.LOG_ERROR,"RealtimeChannel.onMessage()",u);u=Error(u);this.emit("error",u)}m.id||(m.id=c+":"+k);m.timestamp||(m.timestamp=b)}this.presence.setPresence(a,!0);break;case l.MESSAGE:m=b.messages;c=b.id;b=b.timestamp;d=this.options;for(k=0;k<m.length;k++){try{a=
m[k],B.decode(a,d)}catch(G){u="Unexpected error decrypting message; err = "+G,e.logAction(e.LOG_ERROR,"RealtimeChannel.onMessage()",u),u=Error(u),this.emit("error",u)}a.id||(a.id=c+":"+k);a.timestamp||(a.timestamp=b)}this.onEvent(m);break;case l.ERROR:(u=b.error)&&80016==u.code?this.checkPendingState():this.setDetached(b);break;default:e.logAction(e.LOG_ERROR,"RealtimeChannel.onMessage()","Fatal protocol error: unrecognised action ("+b.action+")"),this.connectionManager.abort(y.unknownChannelErr)}};
a.mergeTo=function(b,a){var c=!1,d;if(b.channel==a.channel&&(d=b.action)==a.action)switch(d){case l.MESSAGE:for(c=0;c<a.messages.length;c++)b.messages.push(a.messages[c]);c=!0;break;case l.PRESENCE:for(c=0;c<a.presence.length;c++)b.presence.push(a.presence[c]);c=!0}return c};a.prototype.setAttached=function(b){e.logAction(e.LOG_MINOR,"RealtimeChannel.setAttached","activating channel; name = "+this.name);this.clearStateTimer();b.presence&&this.presence.setPresence(b.presence,!1);if("attaching"==this.state){this.state=
"attached";b=this.pendingEvents;var a=b.length;if(a){this.pendingEvents=[];var c=w.fromValues({action:l.MESSAGE,channel:this.name,messages:[]}),d=H();e.logAction(e.LOG_MICRO,"RealtimeChannel.setAttached","sending "+a+" queued messages");for(var k=0;k<a;k++){var m=b[k];Array.prototype.push.apply(c.messages,m.messages);d.push(m.callback)}this.sendMessage(c,d)}this.presence.setAttached();this.emit("attached")}};a.prototype.setDetached=function(b){this.clearStateTimer();(b=b.error)?(this.state="failed",
b={statusCode:b.statusCode,code:b.code,message:b.message},this.failPendingMessages(b),this.emit("failed",b)):(this.failPendingMessages({statusCode:404,code:90001,message:"Channel detached"}),"detached"!==this.state&&(this.state="detached",this.emit("detached")))};a.prototype.setSuspended=function(b,a){e.logAction(e.LOG_MINOR,"RealtimeChannel.setSuspended","deactivating channel; name = "+this.name+", err "+(b?b.message:"none"));this.clearStateTimer();this.failPendingMessages(b);this.presence.setSuspended(b);
a||this.emit("detached")};a.prototype.setPendingState=function(b){e.logAction(e.LOG_MINOR,"RealtimeChannel.setPendingState","name = "+this.name+", state = "+b);this.state=b;this.clearStateTimer();if("connected"!=this.connectionManager.state.state)e.logAction(e.LOG_MINOR,"RealtimeChannel.setPendingState","not connected");else{this.checkPendingState();var a=this;this.stateTimer=setTimeout(function(){e.logAction(e.LOG_MINOR,"RealtimeChannel.setPendingState","timer expired");a.stateTimer=null;a.checkPendingState()},
p.sendTimeout)}};a.prototype.checkPendingState=function(){var b=!1;switch(this.state){case "attaching":this.attachImpl();b=!0;break;case "detaching":this.detachImpl(),b=!0}return b};a.prototype.clearStateTimer=function(){var b=this.stateTimer;b&&(clearTimeout(b),this.stateTimer=null)};a.prototype.failPendingMessages=function(b){e.logAction(e.LOG_MINOR,"RealtimeChannel.failPendingMessages","channel; name = "+this.name+", err = "+b);for(var a=0;a<this.pendingEvents.length;a++)try{this.pendingEvents[a].callback(b)}catch(c){}this.pendingEvents=
[]};return a}(),U=function(){function a(a,b){t.call(this);this.channel=a;this.clientId=b.clientId;this.members={}}var l=C.Action,d=["enter","leave","update"];m.inherits(a,t);a.prototype.enter=function(a,b){b||"function"!==typeof a||(b=a,a="");if(!this.clientId)throw Error("clientId must be specified to enter a presence channel");this.enterClient(this.clientId,a,b)};a.prototype.enterClient=function(a,b,d){e.logAction(e.LOG_MICRO,"Presence.enterClient()","entering; channel = "+this.channel.name+", client = "+
a);a=C.fromValues({action:l.ENTER,clientId:a,clientData:Data.toData(b)});b=this.channel;switch(b.state){case "attached":b.sendPresence(a,d);break;case "initialized":b.attach();case "attaching":this.pendingPresence={presence:a,callback:d};break;default:a=Error("Unable to enter presence channel (incompatible state)"),a.code=90001,d(a)}};a.prototype.leave=function(a){if(!this.clientId)throw Error("clientId must have been specified to enter or leave a presence channel");this.leaveClient(this.clientId,
a)};a.prototype.leaveClient=function(a,b){e.logAction(e.LOG_MICRO,"Presence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+a);var d=C.fromValues({action:l.LEAVE,clientId:a}),g=this.channel;switch(g.state){case "attached":g.sendPresence(d,b);break;case "attaching":this.pendingPresence={presence:d,callback:b};break;case "initialized":this.pendingPresence=null;d=Error("Unable to enter presence channel (incompatible state)");d.code=90001;b(d);break;default:this.pendingPresence=null,
b(y.failed)}};a.prototype.get=function(a){return a?this.members[a]:m.valuesArray(this.members,!0)};a.prototype.setPresence=function(a,b){e.logAction(e.LOG_MICRO,"Presence.setPresence()","received presence for "+a.length+" participants");for(var f=0;f<a.length;f++){var g=a[f],h=g.clientId+":"+g.memberId;switch(g.action){case l.LEAVE:delete this.members[h];break;case l.UPDATE:g.inheritMemberId&&delete this.members[g.clientId+":"+g.inheritMemberId];case l.ENTER:this.members[h]=g}b&&this.emit(d[g.action],
g)}};a.prototype.setAttached=function(){var a=this.pendingPresence;if(a){var b=a.presence,a=a.callback;e.logAction(e.LOG_MICRO,"Presence.setAttached","sending queued presence; action = "+b.action);this.channel.sendPresence(b,a);this.pendingPresence=null}};a.prototype.setSuspended=function(a){var b=this.pendingPresence;b&&(b.callback(a),this.pendingPresence=null)};return a}();(function(){function a(a,b,c){c.stream=!1;E.call(this,a,b,c)}function l(a,c,d,e,f,g){t.call(this);void 0===a&&(a=b++);this.id=
a;this.uri=c;this.params=e||{};this.body=f;this.requestMode=g;this.requestComplete=!1}var d=function(){},c=window.Ably._=function(a){return c[a]||d},b=1,f=document.getElementsByTagName("head")[0];m.inherits(a,E);a.isAvailable=function(){return!0};v.httpTransports.jsonp=v.transports.jsonp=a;var g=null;a.checkConnectivity=function(a){g?g.push(a):(g=[a],k("http://internet-up.ably.io.s3-website-us-east-1.amazonaws.com/is-the-internet-up.js",null,null,null,!1,function(a,b){for(var c=!a&&b,d=0;d<g.length;d++)g[d](null,
c);g=null}))};a.tryConnect=function(b,c,d,f){var g=new a(b,c,d),h=function(a){f(a)};g.on("error",h);g.on("preconnect",function(){e.logAction(e.LOG_MINOR,"JSONPTransport.tryConnect()","viable transport "+g);g.off("error",h);f(null,g)});g.connect()};a.prototype.toString=function(){return"JSONPTransport; uri="+this.baseUri+"; isConnected="+this.isConnected};var h=a.prototype.createRequest=function(a,b,c,d,e){return new l(void 0,a,b,c,d,e)};m.inherits(l,t);l.prototype.exec=function(){var a=this.id,b=
this.body,d=this.uri,e=this.params,g=this;e.callback="Ably._("+a+")";b?e.body=encodeURIComponent(b):delete e.body;b=this.script=document.createElement("script");b.src=d+m.toQueryString(e);b.async=!0;b.type="text/javascript";b.charset="UTF-8";b.onerror=function(a){a.code=8E4;g.complete(a)};c[a]=function(a){g.complete(null,a)};this.timer=setTimeout(function(){g.abort()},this.requestMode==E.REQ_SEND?p.sendTimeout:p.recvTimeout);f.insertBefore(b,f.firstChild)};l.prototype.complete=function(a,b){this.requestComplete||
(this.requestComplete=!0,b&&this.emit("data",b),this.emit("complete",a,b),this.dispose())};l.prototype.abort=function(){this.dispose()};l.prototype.dispose=function(){var a=this.timer;a&&(clearTimeout(a),this.timer=null);a=this.script;a.parentNode&&a.parentNode.removeChild(a);delete c[this.id]};var k=r.Request=function(a,b,c,d,e,f){a=h(a,b,c,d,E.REQ_SEND);a.once("complete",f);a.exec();return a};return a})();var Q=function(){function a(){for(var a in h)h[a].dispose()}function l(){return window.XMLHttpRequest&&
"withCredentials"in new XMLHttpRequest?n=!0:k&&document.domain&&"https:"==window.location.protocol?!0:!1}function d(a){var b={};a.getResponseHeader&&(a=a.getResponseHeader("Content-Type"))&&(b["Content-Type"]=a);return b}function c(a,b,c,d,e){t.call(this);c=c||{};c.rnd=String(Math.random()).substr(2);this.uri=a+m.toQueryString(c);this.headers=b||{};this.body=d;this.requestMode=e;this.requestComplete=!1;h[this.id=String(++g)]=this}function b(a,b,d,e,f){d.ua="xdr";c.call(this,a,b,d,e,f)}var f=function(){},
g=0,h={},k=window.XDomainRequest,n;m.inherits(c,t);c.isAvailable=l;var q=c.createRequest=function(a,d,e,f,g){return n?new c(a,d,e,f,g):new b(a,d,e,f,g)};c.prototype.complete=function(a,b){if(!this.requestComplete){this.requestComplete=!0;var c=this.xhr;b&&this.emit("data",b);this.emit("complete",a,b,c&&d(c));this.dispose()}};c.prototype.abort=function(){this.dispose()};c.prototype.exec=function(){function a(){q=g.responseText;for(var b=q.length-1,c,d;F<b&&-1<(c=q.indexOf("\n",F));){d=q.slice(F,c);
F=c+1;a:{try{d=JSON.parse(d)}catch(e){err=Error("Malformed response body from server: "+e.message);err.statusCode=400;h.complete(err);break a}h.emit("data",d)}}}function b(){a();h.streamComplete=!0;m.nextTick(function(){h.complete()})}var c=this.timer=setTimeout(function(){g.abort()},0==this.requestMode?p.sendTimeout:p.recvTimeout),d=this.body,e=d?"POST":"GET",f=this.headers,g=this.xhr=new XMLHttpRequest,h=this;f.accept=f.accept||"application/json";d&&("object"==typeof d&&(d=JSON.stringify(d)),f["content-type"]=
f["content-type"]||"application/json");g.open(e,this.uri,!0);g.withCredentials="true";for(var k in f)g.setRequestHeader(k,f[k]);var l=g.onerror=function(a){a.code=8E4;h.complete(a)};g.onabort=function(){var a=Error("Request cancelled");a.statusCode=400;l(a)};g.ontimeout=function(){var a=Error("Request timed out");a.statusCode=408;l(a)};var n,s,q,r,F=0;g.onreadystatechange=function(){var d=g.readyState;if(!(3>d)&&0!==g.status)if(void 0===s&&(s=g.status,1223===s&&(s=204),clearTimeout(c),r=400>s,204==
s?h.complete():n=3==h.requestMode&&r),3==d&&n)a();else if(4==d)if(n)b();else a:{try{q=g.responseText;if(!q||!q.length){204!=status&&(f=Error("Incomplete response body from server"),f.statusCode=400,h.complete(f));break a}q=JSON.parse(String(q))}catch(e){var f=Error("Malformed response body from server: "+e.message);f.statusCode=400;h.complete(f);break a}r?h.complete(null,q):(f=q.error,f||(f=Error("Error response received from server: "+s),f.statusCode=s),h.complete(f))}};g.send(d)};c.prototype.dispose=
function(){var a=this.xhr;if(a){a.onreadystatechange=a.onerror=a.onabort=a.ontimeout=f;this.xhr=null;var b=this.timer;b&&(clearTimeout(b),this.timer=null);this.requestComplete||a.abort()}delete h[this.id]};m.inherits(b,c);b.prototype.exec=function(){function a(){clearTimeout(d);if(s=h.responseText){var b=s.length-1;if("\n"==s[b]||(b=-1<s.indexOf("\n"))){var c=s.slice(0,b);try{var c=JSON.parse(c),e=c.error;if(e)q=e.statusCode||500,k.complete(e);else if(q=s?201:200,n=3==k.requestMode)r=b,m.isEmpty(c)||
k.emit("data",c)}catch(f){e=Error("Malformed response body from server: "+f.message),e.statusCode=400,k.complete(e)}}}}function b(){s=h.responseText;for(var a=s.length-1,c,d;r<a&&-1<(c=s.indexOf("\n",r));){d=s.slice(r,c);r=c+1;a:{try{d=JSON.parse(d)}catch(e){err=Error("Malformed response body from server: "+e.message);err.statusCode=400;k.complete(err);break a}k.emit("data",d)}}}function c(){b();k.streamComplete=!0;m.nextTick(function(){k.complete()})}var d=this.timer=setTimeout(function(){h.abort()},
0==this.requestMode?p.sendTimeout:p.recvTimeout),f=this.body,g=f?"POST":"GET",h=this.xhr=new XDomainRequest,k=this;f&&"object"==typeof f&&(f=JSON.stringify(f));var l=h.onerror=function(){e.logAction(e.LOG_ERROR,"Request.onerror()","");var a=Error("Error response");a.statusCode=400;a.code=8E4;k.complete(a)};h.onabort=function(){e.logAction(e.LOG_ERROR,"Request.onabort()","");var a=Error("Request cancelled");a.statusCode=400;l(a)};h.ontimeout=function(){e.logAction(e.LOG_ERROR,"Request.timeout()","");
var a=Error("Request timed out");a.statusCode=408;l(a)};var n,q,s,r=0;h.onprogress=function(){void 0===q?a():n&&b()};h.onload=function(){if(void 0===q&&(a(),k.requestComplete))return;if(n)c();else a:{try{s=h.responseText;if(!s||!s.length){204!=status&&(d=Error("Incomplete response body from server"),d.statusCode=400,k.complete(d));break a}s=JSON.parse(String(s))}catch(b){var d=Error("Malformed response body from server: "+b.message);d.statusCode=400;k.complete(d);break a}k.complete(null,s)}};try{h.open(g,
this.uri),h.send(f)}catch(t){e.logAction(e.LOG_ERROR,"Request.onStreamEnd()","Unexpected send exception; err = "+t),l(t)}};b.prototype.dispose=function(){var a=this.xhr;if(a){a.onprogress=a.onload=a.onerror=a.onabort=a.ontimeout=f;this.xhr=null;var b=this.timer;b&&(clearTimeout(b),this.timer=null);this.requestComplete||a.abort()}delete h[this.id]};if(l=c.isAvailable())D.addUnloadListener(a),"undefined"!==typeof r&&(r.supportsAuthHeaders=n,r.Request=function(a,b,c,d,e,f){a=q(a,b,c,d,0);a.once("complete",
f);a.exec();return a});return c}();(function(){function a(a,d,c){E.call(this,a,d,c)}m.inherits(a,E);a.isAvailable=Q.isAvailable;a.checkConnectivity=function(a){r.request("http://internet-up.ably.io.s3-website-us-east-1.amazonaws.com/is-the-internet-up.txt",null,null,null,!1,function(d,c){a(null,!d&&"yes"==c)})};a.tryConnect=function(l,d,c,b){var f=new a(l,d,c),g=function(a){b(a)};f.on("error",g);f.on("preconnect",function(){e.logAction(e.LOG_MINOR,"XHRTransport.tryConnect()","viable transport "+f);
f.off("error",g);b(null,f)});f.connect()};a.prototype.toString=function(){return"XHRTransport; uri="+this.baseUri+"; isConnected="+this.isConnected};a.prototype.createRequest=Q.createRequest;"undefined"!==typeof v&&a.isAvailable()&&(v.httpTransports.xhr=v.transports.xhr=a);return a})();(function(){function a(a,c,b){b.binary=!1;x.call(this,a,c,b);this.destOrigin=this.destWindow=this.wrapWindow=this.wrapIframe=null}var l=location.origin||location.protocol+"//"+location.hostname+(location.port?":"+location.port:
"");m.inherits(a,x);a.isAvailable=function(){return void 0!==window.postMessage};a.isAvailable()&&(v.httpTransports.iframe=v.transports.iframe=a);a.tryConnect=function(d,c,b,f){var g=new a(d,c,b);g.on("iferror",f);g.on("ifopen",function(){e.logAction(e.LOG_MINOR,"IframeTransport.tryConnect()","viable transport "+g);g.off("iferror",f);f(null,g)});g.connect()};a.prototype.toString=function(){return"IframeTransport; uri="+this.uri};a.prototype.connect=function(){e.logAction(e.LOG_MINOR,"IframeTransport.connect()",
"starting");x.prototype.connect.call(this);var a=this;this.auth.getAuthParams(function(c,b){if(c)a.abort(c);else{var e=a.params.getConnectParams(b);e.origin=l;a.createIframe(e,function(b){b?a.emit("iferror",b):a.emit("ifopen")})}})};a.prototype.send=function(a){var c=this.destWindow;c&&c.postMessage(JSON.stringify(a),this.destOrigin)};a.prototype.createIframe=function(a,c){function b(){q.dispose()}function f(a){q.onData(a.data)}var g=this.wrapIframe=document.createElement("iframe"),h=this.params.options,
h=(this.destOrigin="https://"+p.getHost(h)+":"+p.getPort(h,!0))+"/static/iframe.html"+m.toQueryString(a),k=!1,l=null,q=this;e.logAction(e.LOG_MINOR,"IframeTransport.createIframe()","destUri: "+h);D.addUnloadListener(b);g.style.display="none";g.style.position="absolute";g.onerror=function(a){b();k||(k=!0,a=a||Error("Unknown error loading iframe"),c(a))};D.addListener(g,"load",q.onloadListener=function(){q.destWindow=l.destWindow;D.addMessageListener(l,q.messageListener=f);k=!0;c(null,g)});document.body.appendChild(g);
var l=q.wrapWindow=g.contentWindow,r=l.document;r.open();r.write('<!DOCTYPE html>\n<html>\n  <head>\n    <script type="text/javascript">\n    var destWindow;\n    function onIframeLoaded() {\n      destWindow = document.getElementById("dest").contentWindow;\n    }\n    \x3c/script>\n  </head>\n  <body>\n    <iframe id="dest" src="'+h+'" onload="onIframeLoaded();">\n    </iframe>\n  </body>\n</html>\n');r.close()};a.prototype.onData=function(a){e.logAction(e.LOG_MICRO,"IframeTransport.onData()","length = "+
a.length);try{var c=JSON.parse(String(a));if(c&&c.length)for(a=0;a<c.length;a++)this.onChannelMessage(c[a])}catch(b){e.logAction(e.LOG_ERROR,"IframeTransport.onData()","Unexpected exception handing channel event: "+b)}};a.prototype.dispose=function(){e.logAction(e.LOG_MICRO,"IframeTransport.dispose()","");var a=this.messageListener;a&&(D.removeMessageListener(this.wrapWindow,a),this.messageListener=null);var c=this.wrapIframe;c&&((a=this.onloadListener)&&D.removeListener(c,"load",a),this.wrapIframe=
c.onerror=null,setTimeout(function(){c.parentNode.removeChild(c)},0))};return a})();window.Ably.Realtime=O;O.ConnectionManager=v;O.Crypto=A;N.Crypto=A})();
