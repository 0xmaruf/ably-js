(function(){window.Ably={};for(var D={disconnected:{statusCode:408,code:80003,message:"Connection to server temporarily unavailable"},suspended:{statusCode:408,code:80002,message:"Connection to server unavailable"},failed:{statusCode:408,code:8E4,message:"Connection failed or disconnected by server"},unknownConnectionErr:{statusCode:500,code:50002,message:"Internal connection error"},unknownChannelErr:{statusCode:500,code:50001,message:"Internal channel error"}},F=function(a,c,b){function e(){}e.prototype=
c.prototype;a.prototype=new e;if(b)for(var f in b)a.prototype[f]=b[f]},Z=[],n=0;256>n;n++)Z[n]=(15<n?"":"0")+n.toString(16);var J=function(a,c){a instanceof Array?(this.buffer=a,this.offset=c||0):(this.buffer=this.buffer||Array(8),this.offset=0,this.setValue.apply(this,arguments))};J.MAX_INT=Math.pow(2,53);J.MIN_INT=-Math.pow(2,53);J.prototype={_2scomp:function(){for(var a=this.buffer,c=this.offset,b=1,e=c+7;e>=c;e--)b=(a[e]^255)+b,a[e]=b&255,b>>=8},setValue:function(a,c){var b=!1;if(1==arguments.length)if("number"==
typeof a){b=0>a;a=Math.abs(a);c=a%4294967296;a/=4294967296;if(4294967296<a)throw new RangeError(a+" is outside Int64 range");a|=0}else if("string"==typeof a)a=(a+"").replace(/^0x/,""),c=a.substr(-8),a=8<a.length?a.substr(0,a.length-8):"",a=parseInt(a,16),c=parseInt(c,16);else throw Error(a+" must be a Number or String");for(var e=this.buffer,f=this.offset,h=7;0<=h;h--)e[f+h]=c&255,c=4==h?a:c>>>8;b&&this._2scomp()},toNumber:function(a){for(var c=this.buffer,b=this.offset,e=c[0]&128,f=0,h=1,l=7,d=1;0<=
l;l--,d*=256){var q=c[b+l];e&&(q=(q^255)+h,h=q>>8,q&=255);f+=q*d}return!a&&f>=J.MAX_INT?e?-Infinity:Infinity:e?-f:f},valueOf:function(){return this.toNumber(!1)},toString:function(a){return this.valueOf().toString(a||10)},toOctetString:function(a){for(var c=Array(8),b=this.buffer,e=this.offset,f=0;8>f;f++)c[f]=Z[b[e+f]];return c.join(a||"")},inspect:function(){return"[Int64 value:"+this+" octets:"+this.toOctetString(" ")+"]"}};var d={Version:"0.8.0",Type:{STOP:0,VOID:1,BOOL:2,BYTE:3,I08:3,DOUBLE:4,
I16:6,I32:8,I64:10,STRING:11,UTF7:11,STRUCT:12,MAP:13,SET:14,LIST:15,UTF8:16,UTF16:17},MessageType:{CALL:1,REPLY:2,EXCEPTION:3},objectLength:function(a){var c=0,b;for(b in a)a.hasOwnProperty(b)&&c++;return c},inherits:function(a,c){function b(){}b.prototype=c.prototype;a.prototype=new b},TException:function(a){this.message=a}};d.inherits(d.TException,Error);d.TException.prototype.name="TException";d.TApplicationExceptionType={UNKNOWN:0,UNKNOWN_METHOD:1,INVALID_MESSAGE_TYPE:2,WRONG_METHOD_NAME:3,BAD_SEQUENCE_ID:4,
MISSING_RESULT:5,INTERNAL_ERROR:6,PROTOCOL_ERROR:7};d.TApplicationException=function(a,c){this.message=a;this.code=null===c?0:c};d.inherits(d.TApplicationException,d.TException);d.TApplicationException.prototype.name="TApplicationException";d.TApplicationException.prototype.read=function(a){for(;;){var c=a.readFieldBegin();if(c.ftype==d.Type.STOP)break;switch(c.fid){case 1:c.ftype==d.Type.STRING?(c=a.readString(),this.message=c.value):a.skip(c.ftype);break;case 2:c.ftype==d.Type.I32?(c=a.readI32(),
this.code=c.value):a.skip(c.ftype);break;default:a.skip(c.ftype)}a.readFieldEnd()}a.readStructEnd()};d.TApplicationException.prototype.write=function(a){a.writeStructBegin("TApplicationException");this.message&&(a.writeFieldBegin("message",d.Type.STRING,1),a.writeString(this.getMessage()),a.writeFieldEnd());this.code&&(a.writeFieldBegin("type",d.Type.I32,2),a.writeI32(this.code),a.writeFieldEnd());a.writeFieldStop();a.writeStructEnd()};d.TApplicationException.prototype.getCode=function(){return this.code};
d.TApplicationException.prototype.getMessage=function(){return this.message};d.TXHRTransport=function(a){this.url=a;this.rpos=this.wpos=0;this.recv_buf=this.send_buf=""};d.TXHRTransport.prototype={getXmlHttpRequestObject:function(){try{return new XMLHttpRequest}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(c){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(b){}throw"Your browser doesn't support the XmlHttpRequest object.";},flush:function(a){if(a||void 0===this.url||""===
this.url)return this.send_buf;a=this.getXmlHttpRequestObject();a.overrideMimeType&&a.overrideMimeType("application/json");a.open("POST",this.url,!1);a.send(this.send_buf);if(4!=a.readyState)throw"encountered an unknown ajax ready state: "+a.readyState;if(200!=a.status)throw"encountered a unknown request status: "+a.status;this.recv_buf=a.responseText;this.wpos=this.recv_buf_sz=this.recv_buf.length;this.rpos=0},jqRequest:function(a,c,b,e){if("undefined"===typeof jQuery||"undefined"===typeof jQuery.Deferred)throw"Thrift.js requires jQuery 1.5+ to use asynchronous requests";
var f=jQuery.Deferred(),h=jQuery._Deferred(),l=f.promise();l.success=l.done;l.error=l.fail;l.complete=h.done;c=jQuery.ajax({url:this.url,data:c,type:"POST",cache:!1,dataType:"text",context:this,success:this.jqResponse,error:function(b,c,h){f.rejectWith(a,jQuery.merge([h],b.tArgs))},complete:function(b,c){h.resolveWith(a,[b,c])}});f.done(jQuery.makeArray(b).pop());c.tArgs=b;c.tClient=a;c.tRecvFn=e;c.tDfd=f;return l},jqResponse:function(a,c,b){this.setRecvBuffer(a);try{var e=b.tRecvFn.call(b.tClient);
b.tDfd.resolveWith(b,jQuery.merge([e],b.tArgs))}catch(f){b.tDfd.rejectWith(b,jQuery.merge([f],b.tArgs))}},setRecvBuffer:function(a){this.recv_buf=a;this.wpos=this.recv_buf_sz=this.recv_buf.length;this.rpos=0},isOpen:function(){return!0},open:function(){},close:function(){},read:function(a){var c=this.wpos-this.rpos;if(0===c)return"";var b=a;c<a&&(b=c);a=this.read_buf.substr(this.rpos,b);this.rpos+=b;return a},readAll:function(){return this.recv_buf},write:function(a){this.send_buf=a},getSendBuffer:function(){return this.send_buf}};
d.TStringTransport=function(a,c){this.send_buf="";this.recv_buf=a||"";this.onFlush=c};d.TStringTransport.prototype={flush:function(){if(this.onFlush)this.onFlush(this.send_buf)},isOpen:function(){return!0},open:function(){},close:function(){},read:function(a){return this.recv_buf},readAll:function(){return this.recv_buf},write:function(a){this.send_buf=a}};d.Protocol=function(a){this.transport=a};d.Protocol.Type={};d.Protocol.Type[d.Type.BOOL]='"tf"';d.Protocol.Type[d.Type.BYTE]='"i8"';d.Protocol.Type[d.Type.I16]=
'"i16"';d.Protocol.Type[d.Type.I32]='"i32"';d.Protocol.Type[d.Type.I64]='"i64"';d.Protocol.Type[d.Type.DOUBLE]='"dbl"';d.Protocol.Type[d.Type.STRUCT]='"rec"';d.Protocol.Type[d.Type.STRING]='"str"';d.Protocol.Type[d.Type.MAP]='"map"';d.Protocol.Type[d.Type.LIST]='"lst"';d.Protocol.Type[d.Type.SET]='"set"';d.Protocol.RType={};d.Protocol.RType.tf=d.Type.BOOL;d.Protocol.RType.i8=d.Type.BYTE;d.Protocol.RType.i16=d.Type.I16;d.Protocol.RType.i32=d.Type.I32;d.Protocol.RType.i64=d.Type.I64;d.Protocol.RType.dbl=
d.Type.DOUBLE;d.Protocol.RType.rec=d.Type.STRUCT;d.Protocol.RType.str=d.Type.STRING;d.Protocol.RType.map=d.Type.MAP;d.Protocol.RType.lst=d.Type.LIST;d.Protocol.RType.set=d.Type.SET;d.Protocol.Version=1;d.Protocol.prototype={getTransport:function(){return this.transport},writeMessageBegin:function(a,c,b){this.tstack=[];this.tpos=[];this.tstack.push([d.Protocol.Version,'"'+a+'"',c,b])},writeMessageEnd:function(){var a=this.tstack.pop();this.wobj=this.tstack.pop();this.wobj.push(a);this.wbuf="["+this.wobj.join(",")+
"]";this.transport.write(this.wbuf)},writeStructBegin:function(a){this.tpos.push(this.tstack.length);this.tstack.push({})},writeStructEnd:function(){var a=this.tpos.pop(),c=this.tstack[a],b="{",e=!0,f;for(f in c)e?e=!1:b+=",",b+=f+":"+c[f];this.tstack[a]=b+"}"},writeFieldBegin:function(a,c,b){this.tpos.push(this.tstack.length);this.tstack.push({fieldId:'"'+b+'"',fieldType:d.Protocol.Type[c]})},writeFieldEnd:function(){var a=this.tstack.pop(),c=this.tstack.pop();this.tstack[this.tstack.length-1][c.fieldId]=
"{"+c.fieldType+":"+a+"}";this.tpos.pop()},writeFieldStop:function(){},writeMapBegin:function(a,c,b){this.tpos.push(this.tstack.length);this.tstack.push([d.Protocol.Type[a],d.Protocol.Type[c],0])},writeMapEnd:function(){var a=this.tpos.pop();if(a!=this.tstack.length){0!==(this.tstack.length-a-1)%2&&this.tstack.push("");this.tstack[a][this.tstack[a].length-1]=(this.tstack.length-a-1)/2;for(var c="}",b=!0;this.tstack.length>a+1;){var e=this.tstack.pop(),f=this.tstack.pop();b?b=!1:c=","+c;isNaN(f)||
(f='"'+f+'"');c=f+":"+e+c}this.tstack[a].push("{"+c);this.tstack[a]="["+this.tstack[a].join(",")+"]"}},writeListBegin:function(a,c){this.tpos.push(this.tstack.length);this.tstack.push([d.Protocol.Type[a],c])},writeListEnd:function(){for(var a=this.tpos.pop();this.tstack.length>a+1;){var c=this.tstack[a+1];this.tstack.splice(a+1,1);this.tstack[a].push(c)}this.tstack[a]="["+this.tstack[a].join(",")+"]"},writeSetBegin:function(a,c){this.tpos.push(this.tstack.length);this.tstack.push([d.Protocol.Type[a],
c])},writeSetEnd:function(){for(var a=this.tpos.pop();this.tstack.length>a+1;){var c=this.tstack[a+1];this.tstack.splice(a+1,1);this.tstack[a].push(c)}this.tstack[a]="["+this.tstack[a].join(",")+"]"},writeBool:function(a){this.tstack.push(a?1:0)},writeByte:function(a){this.tstack.push(a)},writeI16:function(a){this.tstack.push(a)},writeI32:function(a){this.tstack.push(a)},writeI64:function(a){this.tstack.push(a)},writeDouble:function(a){this.tstack.push(a)},writeString:function(a){if(null===a)this.tstack.push(null);
else{for(var c="",b=0;b<a.length;b++)var e=a.charAt(b),c='"'===e?c+'\\"':"\\"===e?c+"\\\\":"\b"===e?c+"\\b":"\f"===e?c+"\\f":"\n"===e?c+"\\n":"\r"===e?c+"\\r":"\t"===e?c+"\\t":c+e;this.tstack.push('"'+c+'"')}},writeBinary:function(a){this.writeString(a)},readMessageBegin:function(a,c,b){this.rstack=[];this.rpos=[];this.robj="undefined"!==typeof jQuery?jQuery.parseJSON(this.transport.readAll()):eval(this.transport.readAll());a={};c=this.robj.shift();if(c!=d.Protocol.Version)throw"Wrong thrift protocol version: "+
c;a.fname=this.robj.shift();a.mtype=this.robj.shift();a.rseqid=this.robj.shift();this.rstack.push(this.robj.shift());return a},readMessageEnd:function(){},readStructBegin:function(a){this.rstack[this.rstack.length-1]instanceof Array&&this.rstack.push(this.rstack[this.rstack.length-1].shift());return{fname:""}},readStructEnd:function(){this.rstack[this.rstack.length-2]instanceof Array&&this.rstack.pop()},readFieldBegin:function(){var a={},c=-1,b=d.Type.STOP,e;for(e in this.rstack[this.rstack.length-
1])if(null!==e){c=parseInt(e,10);this.rpos.push(this.rstack.length);e=this.rstack[this.rstack.length-1][c];delete this.rstack[this.rstack.length-1][c];this.rstack.push(e);break}if(-1!=c)for(var f in this.rstack[this.rstack.length-1])null!==d.Protocol.RType[f]&&(b=d.Protocol.RType[f],this.rstack[this.rstack.length-1]=this.rstack[this.rstack.length-1][f]);a.fname="";a.ftype=b;a.fid=c;return a},readFieldEnd:function(){for(var a=this.rpos.pop();this.rstack.length>a;)this.rstack.pop()},readMapBegin:function(a,
c,b){a=this.rstack.pop();c={};c.ktype=d.Protocol.RType[a.shift()];c.vtype=d.Protocol.RType[a.shift()];c.size=a.shift();this.rpos.push(this.rstack.length);this.rstack.push(a.shift());return c},readMapEnd:function(){this.readFieldEnd()},readListBegin:function(a,c){var b=this.rstack[this.rstack.length-1],e={};e.etype=d.Protocol.RType[b.shift()];e.size=b.shift();this.rpos.push(this.rstack.length);this.rstack.push(b);return e},readListEnd:function(){this.readFieldEnd()},readSetBegin:function(a,c){return this.readListBegin(a,
c)},readSetEnd:function(){return this.readListEnd()},readBool:function(){var a=this.readI32();a.value=null!==a&&"1"==a.value?!0:!1;return a},readByte:function(){return this.readI32()},readI16:function(){return this.readI32()},readI32:function(a){void 0===a&&(a=this.rstack[this.rstack.length-1]);var c={};if(a instanceof Array)c.value=0===a.length?void 0:a.shift();else if(a instanceof Object)for(var b in a){if(null!==b){this.rstack.push(a[b]);delete a[b];c.value=b;break}}else c.value=a,this.rstack.pop();
return c},readI64:function(){return this.readI32()},readDouble:function(){return this.readI32()},readString:function(){return this.readI32()},readBinary:function(){return this.readString()},skip:function(a){throw"skip not supported yet";}};d.TJSONProtocol=function(a){this.transport=a;this.reset()};d.TJSONProtocol.Type={};d.TJSONProtocol.Type[d.Type.BOOL]="tf";d.TJSONProtocol.Type[d.Type.BYTE]="i8";d.TJSONProtocol.Type[d.Type.I16]="i16";d.TJSONProtocol.Type[d.Type.I32]="i32";d.TJSONProtocol.Type[d.Type.I64]=
"i64";d.TJSONProtocol.Type[d.Type.DOUBLE]="dbl";d.TJSONProtocol.Type[d.Type.STRUCT]="rec";d.TJSONProtocol.Type[d.Type.STRING]="str";d.TJSONProtocol.Type[d.Type.MAP]="map";d.TJSONProtocol.Type[d.Type.LIST]="lst";d.TJSONProtocol.Type[d.Type.SET]="set";d.TJSONProtocol.getValueFromScope=function(a){var c=a.listvalue;return c?c.shift():a.value};d.TJSONProtocol.getScopeFromScope=function(a){var c=a.listvalue;c&&(a={value:c.shift()});return a};d.TJSONProtocol.prototype={reset:function(){this.elementStack=
[]},writeMessageBegin:function(a,c,b){throw Error("TJSONProtocol: Message not supported");},writeMessageEnd:function(){},writeStructBegin:function(a){this.elementStack.unshift({})},writeStructEnd:function(){var a=this.elementStack.shift();0==this.elementStack.length?this.transport.write(JSON.stringify(a)):this.elementStack[0].value.push(a)},writeFieldBegin:function(a,c,b){this.elementStack.unshift({name:a,fieldType:d.TJSONProtocol.Type[c],fieldId:b,value:[]})},writeFieldEnd:function(){var a=this.elementStack.shift(),
c={};c[a.fieldType]=a.value[0];this.elementStack[0][a.fieldId]=c},writeFieldStop:function(){},writeMapBegin:function(a,c,b){this.elementStack.unshift({value:[d.TJSONProtocol.Type[a],d.TJSONProtocol.Type[c],b]})},writeMapEnd:function(){var a=this.elementStack.shift();this.elementStack[0].value.push(a.value)},writeListBegin:function(a,c){this.elementStack.unshift({name:name,value:[d.TJSONProtocol.Type[a],c]})},writeListEnd:function(){var a=this.elementStack.shift();this.elementStack[0].value.push(a.value)},
writeSetBegin:function(a,c){this.elementStack.unshift({name:name,value:[d.TJSONProtocol.Type[a],c]})},writeSetEnd:function(){var a=this.elementStack.shift();this.elementStack[0].value.push(a.value)},writeBool:function(a){this.elementStack[0].value.push(a?1:0)},writeByte:function(a){this.elementStack[0].value.push(a)},writeI16:function(a){this.elementStack[0].value.push(a)},writeI32:function(a){this.elementStack[0].value.push(a)},writeI64:function(a){this.elementStack[0].value.push(a)},writeDouble:function(a){this.elementStack[0].value.push(a)},
writeString:function(a){this.elementStack[0].value.push(a)},writeBinary:function(a){this.elementStack[0].value.push(a)},readMessageBegin:function(a,c,b){throw Error("TJSONProtocol: Message not supported");},readMessageEnd:function(){},readStructBegin:function(a){a=0==this.elementStack.length?JSON.parse(this.transport.readAll()):d.TJSONProtocol.getValueFromScope(this.elementStack[0]);var c=[],b;for(b in a)c.push(b);this.elementStack.unshift({fields:c,value:a});return{fname:""}},readStructEnd:function(){this.elementStack.shift()},
readFieldBegin:function(){var a=this.elementStack[0],c=d.TJSONProtocol.getValueFromScope(a),a=a.fields.shift();if(!a)return{fname:"",ftype:d.Type.STOP};var c=c[a],b;for(b in c)return this.elementStack.unshift({value:c[b]}),{fname:"",fid:Number(a),ftype:d.Protocol.RType[b]};throw Error("TJSONProtocol: parse error reading field value");},readFieldEnd:function(){this.elementStack.shift()},readMapBegin:function(a,c,b){a=d.TJSONProtocol.getValueFromScope(this.elementStack[0]);c={ktype:d.Protocol.RType[a.shift()],
vtype:d.Protocol.RType[a.shift()],size:a.shift()};this.elementStack.unshift({listvalue:a});return c},readMapEnd:function(){this.elementStack.shift()},readListBegin:function(a,c){var b=d.TJSONProtocol.getValueFromScope(this.elementStack[0]),e={etype:d.Protocol.RType[b.shift()],size:b.shift()};this.elementStack.unshift({listvalue:b});return e},readListEnd:function(){this.elementStack.shift()},readSetBegin:function(a,c){var b=d.TJSONProtocol.getValueFromScope(this.elementStack[0]),e={etype:d.Protocol.RType[b.shift()],
size:b.shift()};this.elementStack.unshift({listvalue:b});return e},readSetEnd:function(){this.elementStack.shift()},readBool:function(){return!!d.TJSONProtocol.getValueFromScope(this.elementStack[0])},readByte:function(){return d.TJSONProtocol.getValueFromScope(this.elementStack[0])},readI16:function(){return d.TJSONProtocol.getValueFromScope(this.elementStack[0])},readI32:function(a){return d.TJSONProtocol.getValueFromScope(this.elementStack[0])},readI64:function(){return d.TJSONProtocol.getValueFromScope(this.elementStack[0])},
readDouble:function(){return d.TJSONProtocol.getValueFromScope(this.elementStack[0])},readString:function(){return d.TJSONProtocol.getValueFromScope(this.elementStack[0])},readBinary:function(){return d.TJSONProtocol.getValueFromScope(this.elementStack[0])},flush:function(){this.transport.flush()}};var Q={encode:function(a,c,b){for(var e=b,f=0;f<a.length;f++){var h=a.charCodeAt(f);128>h?c.setInt8(e++,h):(127<h&&2048>h?c.setInt8(e++,h>>6|192):(c.setInt8(e++,h>>12|224),c.setInt8(e++,h>>6&63|128)),c.setInt8(e++,
h&63|128))}return e-b},decode:function(a,c,b){var e="",f=c;b+=c;for(c=c1=c2=0;f<b;)c=a.getInt8(f++),128>c?e+=String.fromCharCode(c):191<c&&224>c?(c2=a.getInt8(f++),e+=String.fromCharCode((c&31)<<6|c2&63)):(c2=a.getInt8(f++),c3=a.getInt8(f++),e+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63));return e}},w=function(a){this.offset=0;if(this.length=a)a=this.buf=new ArrayBuffer(a),this.view=new DataView(a)};w.prototype={getArray:function(){this.array||(this.array=new Uint8Array(this.buf,this.offset,
this.length));return this.array},slice:function(a,c){a=a||0;c=c||this.length;var b=new w,e=b.length=c-a,f=b.offset=this.offset+a,h=b.buf=this.buf;b.view=new DataView(h,f,e);return b},getInt8:function(a){return this.view.getInt8(a)},getInt16:function(a){return this.view.getInt16(a,!1)},getInt32:function(a){return this.view.getInt32(a,!1)},getInt64:function(a){var c=this.view.getInt32(a,!1);a=this.view.getUint32(a+4,!1);return new J(c,a)},getFloat64:function(a){return this.view.getFloat64(a,!1)},getUtf8String:function(a,
c){return Q.decode(this.view,a,c)},setInt8:function(a,c){this.view.setInt8(a,c)},setInt16:function(a,c){this.view.setInt16(a,c,!1)},setInt32:function(a,c){this.view.setInt32(a,c,!1)},setInt64:function(a,c){this.getArray().set(c.buffer,a)},setFloat64:function(a,c){this.view.setFloat64(a,c,!1)},setBuffer:function(a,c){this.getArray().set(c.getArray(),a)},setUtf8String:function(a,c){return Q.encode(c,this.view,a)},inspect:function(){for(var a="length: "+this.length+"\n",c=0;c<this.length;){for(var b=
0;c<this.length&&32>b;b++)a+=this.view.getInt8(c++).toString(16)+" ";a+="\n"}return a}};n=d.CheckedBuffer=function(a){w.call(this,a)};F(n,w,{grow:function(a){a=this.length+Math.max(a||0,0.41*this.length);var c=getArray();this.buf=new ArrayBuffer(a);this.view=new DataView(this.buf);this.getArray().set(c);this.offset=0;this.length=a},checkAvailable:function(a,c){a+c>=this.length&&this.grow(c)},setInt8:function(a,c){this.checkAvailable(1);this.view.setInt8(a,c)},setInt16:function(a,c){this.checkAvailable(2);
this.view.setInt16(a,c,!1)},setInt32:function(a,c){this.checkAvailable(4);this.view.setInt32(a,c,!1)},setInt64:function(a,c){this.checkAvailable(8);this.getArray().set(c.buffer,a)},setFloat64:function(a,c){this.checkAvailable(8);this.view.setFloat64(a,c,!1)},setBuffer:function(a,c){this.checkAvailable(c.length);this.getArray().set(c.getArray(),a)},setUtf8String:function(a,c){for(;;)try{return Q.encode(c,this.view,a)}catch(b){this.grow()}}});var u=d.Type,R=function(a,c){Error.call(this,c);this.name=
"TProtocolException";this.type=a};F(R,Error);n=d.TBinaryProtocol=function(a,c,b){this.trans=a;this.strictRead=void 0!==c?c:!1;this.strictWrite=void 0!==b?b:!0};n.prototype.flush=function(){return this.trans.flush()};n.prototype.writeMessageBegin=function(a,c,b){this.strictWrite?(this.writeI32(-2147418112|c),this.writeString(a)):(this.writeString(a),this.writeByte(c));this.writeI32(b)};n.prototype.writeMessageEnd=function(){};n.prototype.writeStructBegin=function(a){};n.prototype.writeStructEnd=function(){};
n.prototype.writeFieldBegin=function(a,c,b){this.writeByte(c);this.writeI16(b)};n.prototype.writeFieldEnd=function(){};n.prototype.writeFieldStop=function(){this.writeByte(u.STOP)};n.prototype.writeMapBegin=function(a,c,b){this.writeByte(a);this.writeByte(c);this.writeI32(b)};n.prototype.writeMapEnd=function(){};n.prototype.writeListBegin=function(a,c){this.writeByte(a);this.writeI32(c)};n.prototype.writeListEnd=function(){};n.prototype.writeSetBegin=function(a,c){this.writeByte(a);this.writeI32(c)};
n.prototype.writeSetEnd=function(){};n.prototype.writeBool=function(a){this.writeByte(a?1:0)};n.prototype.writeByte=function(a){this.trans.writeByte(a)};n.prototype.writeI16=function(a){this.trans.writeI16(a)};n.prototype.writeI32=function(a){this.trans.writeI32(a)};n.prototype.writeI64=function(a){a.buffer?this.trans.writeI64(a):this.trans.writeI64(new J(a))};n.prototype.writeDouble=function(a){this.trans.writeDouble(a)};n.prototype.writeString=function(a){this.trans.writeWithLength(a)};n.prototype.writeBinary=
function(a){this.trans.writeWithLength(a)};n.prototype.readMessageBegin=function(){var a=this.readI32(),c,b;if(0>a){c=a&-65536;if(-2147418112!=c)throw console.log("BAD: "+c),R(4,"Bad version in readMessageBegin: "+a);a&=255;c=this.readString()}else{if(this.strictRead)throw R(4,"No protocol version header");c=this.trans.read(a);a=this.readByte()}b=this.readI32();return{fname:c,mtype:a,rseqid:b}};n.prototype.readMessageEnd=function(){};n.prototype.readStructBegin=function(){return{fname:""}};n.prototype.readStructEnd=
function(){};n.prototype.readFieldBegin=function(){var a=this.readByte();if(a==u.STOP)return{fname:null,ftype:a,fid:0};var c=this.readI16();return{fname:null,ftype:a,fid:c}};n.prototype.readFieldEnd=function(){};n.prototype.readMapBegin=function(){var a=this.readByte(),c=this.readByte(),b=this.readI32();return{ktype:a,vtype:c,size:b}};n.prototype.readMapEnd=function(){};n.prototype.readListBegin=function(){var a=this.readByte(),c=this.readI32();return{etype:a,size:c}};n.prototype.readListEnd=function(){};
n.prototype.readSetBegin=function(){var a=this.readByte(),c=this.readI32();return{etype:a,size:c}};n.prototype.readSetEnd=function(){};n.prototype.readBool=function(){return 0==this.readByte()?!1:!0};n.prototype.readByte=function(){return this.trans.readByte()};n.prototype.readI16=function(){return this.trans.readI16()};n.prototype.readI32=function(){return this.trans.readI32()};n.prototype.readI64=function(){return this.trans.readI64()};n.prototype.readDouble=function(){return this.trans.readDouble()};
n.prototype.readBinary=function(){var a=this.readI32();return this.trans.read(a)};n.prototype.readString=function(){var a=this.readI32();return this.trans.readString(a)};n.prototype.getTransport=function(){return this.trans};n.prototype.skip=function(a){switch(a){case u.STOP:break;case u.BOOL:this.readBool();break;case u.BYTE:this.readByte();break;case u.I16:this.readI16();break;case u.I32:this.readI32();break;case u.I64:this.readI64();break;case u.DOUBLE:this.readDouble();break;case u.STRING:this.readString();
break;case u.STRUCT:for(this.readStructBegin();;){a=this.readFieldBegin();if(a.ftype===u.STOP)break;this.skip(a.ftype);this.readFieldEnd()}this.readStructEnd();break;case u.MAP:a=this.readMapBegin();for(var c=0;c<a.size;++c)this.skip(a.ktype),this.skip(a.vtype);this.readMapEnd();break;case u.SET:a=this.readSetBegin();for(c=0;c<a.size;++c)this.skip(a.etype);this.readSetEnd();break;case u.LIST:a=this.readListBegin();for(c=0;c<a.size;++c)this.skip(a.etype);this.readListEnd();break;default:throw Error("Invalid type: "+
a);}};var ca=new w(0),K=d.TTransport=function(a,c){this.buf=a||ca;this.onFlush=c;this.reset()};K.receiver=function(a){return function(c){a(new K(c))}};K.prototype={commitPosition:function(){},rollbackPosition:function(){},reset:function(){this.pos=0},isOpen:function(){return!0},open:function(){},close:function(){},read:function(a){var c=this.pos+a;if(this.buf.length<c)throw Error("read("+a+") failed - not enough data");a=this.buf.slice(this.pos,c);this.pos=c;return a},readByte:function(){return this.buf.getInt8(this.pos++)},
readI16:function(){var a=this.buf.getInt16(this.pos);this.pos+=2;return a},readI32:function(){var a=this.buf.getInt32(this.pos);this.pos+=4;return a},readDouble:function(){var a=this.buf.getFloat64(this.pos);this.pos+=8;return a},readString:function(a){var c=this.buf.getUtf8String(this.pos,a);this.pos+=a;return c},readAll:function(){return this.buf},writeByte:function(a){this.buf.setInt8(this.pos++,a)},writeI16:function(a){this.buf.setInt16(this.pos,a);this.pos+=2},writeI32:function(a){this.buf.setInt32(this.pos,
a);this.pos+=4},writeI64:function(a){this.buf.setInt64(this.pos,a);this.pos+=8},writeDouble:function(a){this.buf.setFloat64(this.pos,a);this.pos+=8},write:function(a){"string"===typeof a?this.pos+=this.setUtf8String(this.pos,a):(this.setBuffer(this.pos,a),this.pos+=a.length)},writeWithLength:function(a){"string"===typeof a?a=this.buf.setUtf8String(this.pos+4,a):(this.setBuffer(this.pos+4,a),a=a.length);this.buf.setInt32(this.pos,a);this.pos+=a+4},flush:function(a){if(a=a||this.onFlush){var c=this.buf.slice(0,
this.pos);a(c)}}};var S=d.TFramedTransport=function(a,c){K.call(this,a,c)};S.receiver=function(a){var c=0,b=0,e=null,f=null;return function(h){if(f){var l=new w(h.length+f.length);f.copy(l,0,0);h.copy(l,f.length,0);f=null}for(;h.length;){if(0===c){if(4>h.length){console.log("Expecting > 4 bytes, found only "+h.length);f=h;break}c=binary.readI32(h,0);e=new w(c);b=0;h=h.slice(4,h.length)}h.length>=c?(h.copy(e,b,0,c),h=h.slice(c,h.length),c=0,a(new S(e))):h.length&&(h.copy(e,b,0,h.length),c-=h.length,
b+=h.length,h=h.slice(h.length,h.length))}}};F(S,K,{flush:function(){var a=this;K.prototype.flush.call(this,function(c){if(a.onFlush){var b=new w(c.length+4);binary.writeI32(b,c.length);c.copy(b,4,0,c.length);a.onFlush(b)}})}});var G,E,H,I,L;TAction={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15};TType={NONE:0,TRUE:1,FALSE:2,INT32:3,INT64:4,DOUBLE:5,STRING:6,BUFFER:7,JSONARRAY:8,
JSONOBJECT:9};TFlags={SYNC_TIME:0};TPresenceState={ENTER:0,LEAVE:1,UPDATE:2};G=function(a){this.message=this.code=this.statusCode=void 0;a&&(void 0!==a.statusCode&&(this.statusCode=a.statusCode),void 0!==a.code&&(this.code=a.code),void 0!==a.message&&(this.message=a.message))};G.prototype={};G.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:b==d.Type.I16?this.statusCode=a.readI16():a.skip(b);break;case 2:b==d.Type.I32?
this.code=a.readI32():a.skip(b);break;case 3:b==d.Type.STRING?this.message=a.readString():a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};G.prototype.write=function(a){a.writeStructBegin("TError");void 0!==this.statusCode&&(a.writeFieldBegin("statusCode",d.Type.I16,1),a.writeI16(this.statusCode),a.writeFieldEnd());void 0!==this.code&&(a.writeFieldBegin("code",d.Type.I32,2),a.writeI32(this.code),a.writeFieldEnd());void 0!==this.message&&(a.writeFieldBegin("message",d.Type.STRING,
3),a.writeString(this.message),a.writeFieldEnd());a.writeFieldStop();a.writeStructEnd()};E=function(a){this.cipherData=this.binaryData=this.stringData=this.doubleData=this.i64Data=this.i32Data=this.type=void 0;a&&(void 0!==a.type&&(this.type=a.type),void 0!==a.i32Data&&(this.i32Data=a.i32Data),void 0!==a.i64Data&&(this.i64Data=a.i64Data),void 0!==a.doubleData&&(this.doubleData=a.doubleData),void 0!==a.stringData&&(this.stringData=a.stringData),void 0!==a.binaryData&&(this.binaryData=a.binaryData),
void 0!==a.cipherData&&(this.cipherData=a.cipherData))};E.prototype={};E.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:b==d.Type.I32?this.type=a.readI32():a.skip(b);break;case 2:b==d.Type.I32?this.i32Data=a.readI32():a.skip(b);break;case 3:b==d.Type.I64?this.i64Data=a.readI64():a.skip(b);break;case 4:b==d.Type.DOUBLE?this.doubleData=a.readDouble():a.skip(b);break;case 5:b==d.Type.STRING?this.stringData=a.readString():
a.skip(b);break;case 6:b==d.Type.STRING?this.binaryData=a.readBinary():a.skip(b);break;case 7:b==d.Type.STRING?this.cipherData=a.readBinary():a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};E.prototype.write=function(a){a.writeStructBegin("TData");void 0!==this.type&&(a.writeFieldBegin("type",d.Type.I32,1),a.writeI32(this.type),a.writeFieldEnd());void 0!==this.i32Data&&(a.writeFieldBegin("i32Data",d.Type.I32,2),a.writeI32(this.i32Data),a.writeFieldEnd());void 0!==this.i64Data&&
(a.writeFieldBegin("i64Data",d.Type.I64,3),a.writeI64(this.i64Data),a.writeFieldEnd());void 0!==this.doubleData&&(a.writeFieldBegin("doubleData",d.Type.DOUBLE,4),a.writeDouble(this.doubleData),a.writeFieldEnd());void 0!==this.stringData&&(a.writeFieldBegin("stringData",d.Type.STRING,5),a.writeString(this.stringData),a.writeFieldEnd());void 0!==this.binaryData&&(a.writeFieldBegin("binaryData",d.Type.STRING,6),a.writeBinary(this.binaryData),a.writeFieldEnd());void 0!==this.cipherData&&(a.writeFieldBegin("cipherData",
d.Type.STRING,7),a.writeBinary(this.cipherData),a.writeFieldEnd());a.writeFieldStop();a.writeStructEnd()};H=function(a){this.instanceId=this.connectionId=this.inheritMemberId=this.memberId=this.clientData=this.clientId=this.state=void 0;a&&(void 0!==a.state&&(this.state=a.state),void 0!==a.clientId&&(this.clientId=a.clientId),void 0!==a.clientData&&(this.clientData=a.clientData),void 0!==a.memberId&&(this.memberId=a.memberId),void 0!==a.inheritMemberId&&(this.inheritMemberId=a.inheritMemberId),void 0!==
a.connectionId&&(this.connectionId=a.connectionId),void 0!==a.instanceId&&(this.instanceId=a.instanceId))};H.prototype={};H.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:b==d.Type.I32?this.state=a.readI32():a.skip(b);break;case 2:b==d.Type.STRING?this.clientId=a.readString():a.skip(b);break;case 3:b==d.Type.STRUCT?(this.clientData=new E,this.clientData.read(a)):a.skip(b);break;case 4:b==d.Type.STRING?this.memberId=
a.readString():a.skip(b);break;case 5:b==d.Type.STRING?this.inheritMemberId=a.readString():a.skip(b);break;case 6:b==d.Type.STRING?this.connectionId=a.readString():a.skip(b);break;case 7:b==d.Type.STRING?this.instanceId=a.readString():a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};H.prototype.write=function(a){a.writeStructBegin("TPresence");void 0!==this.state&&(a.writeFieldBegin("state",d.Type.I32,1),a.writeI32(this.state),a.writeFieldEnd());void 0!==this.clientId&&(a.writeFieldBegin("clientId",
d.Type.STRING,2),a.writeString(this.clientId),a.writeFieldEnd());void 0!==this.clientData&&(a.writeFieldBegin("clientData",d.Type.STRUCT,3),this.clientData.write(a),a.writeFieldEnd());void 0!==this.memberId&&(a.writeFieldBegin("memberId",d.Type.STRING,4),a.writeString(this.memberId),a.writeFieldEnd());void 0!==this.inheritMemberId&&(a.writeFieldBegin("inheritMemberId",d.Type.STRING,5),a.writeString(this.inheritMemberId),a.writeFieldEnd());void 0!==this.connectionId&&(a.writeFieldBegin("connectionId",
d.Type.STRING,6),a.writeString(this.connectionId),a.writeFieldEnd());void 0!==this.instanceId&&(a.writeFieldBegin("instanceId",d.Type.STRING,7),a.writeString(this.instanceId),a.writeFieldEnd());a.writeFieldStop();a.writeStructEnd()};TPresenceArray=function(a){this.items=void 0;a&&void 0!==a.items&&(this.items=a.items)};TPresenceArray.prototype={};TPresenceArray.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:if(b==
d.Type.LIST){c=0;this.items=[];c=a.readListBegin().size;for(b=0;b<c;++b){var e=null,e=new H;e.read(a);this.items.push(e)}a.readListEnd()}else a.skip(b);break;case 0:a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};TPresenceArray.prototype.write=function(a){a.writeStructBegin("TPresenceArray");if(void 0!==this.items){a.writeFieldBegin("items",d.Type.LIST,1);a.writeListBegin(d.Type.STRUCT,this.items.length);for(var c in this.items)this.items.hasOwnProperty(c)&&(c=this.items[c],
c.write(a));a.writeListEnd();a.writeFieldEnd()}a.writeFieldStop();a.writeStructEnd()};I=function(a){this.tags=this.data=this.timestamp=this.clientId=this.name=void 0;a&&(void 0!==a.name&&(this.name=a.name),void 0!==a.clientId&&(this.clientId=a.clientId),void 0!==a.timestamp&&(this.timestamp=a.timestamp),void 0!==a.data&&(this.data=a.data),void 0!==a.tags&&(this.tags=a.tags))};I.prototype={};I.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;
switch(c.fid){case 1:b==d.Type.STRING?this.name=a.readString():a.skip(b);break;case 2:b==d.Type.STRING?this.clientId=a.readString():a.skip(b);break;case 3:b==d.Type.I64?this.timestamp=a.readI64():a.skip(b);break;case 4:b==d.Type.STRUCT?(this.data=new E,this.data.read(a)):a.skip(b);break;case 5:if(b==d.Type.LIST){c=0;this.tags=[];c=a.readListBegin().size;for(b=0;b<c;++b){var e=null,e=a.readString();this.tags.push(e)}a.readListEnd()}else a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};
I.prototype.write=function(a){a.writeStructBegin("TMessage");void 0!==this.name&&(a.writeFieldBegin("name",d.Type.STRING,1),a.writeString(this.name),a.writeFieldEnd());void 0!==this.clientId&&(a.writeFieldBegin("clientId",d.Type.STRING,2),a.writeString(this.clientId),a.writeFieldEnd());void 0!==this.timestamp&&(a.writeFieldBegin("timestamp",d.Type.I64,3),a.writeI64(this.timestamp),a.writeFieldEnd());void 0!==this.data&&(a.writeFieldBegin("data",d.Type.STRUCT,4),this.data.write(a),a.writeFieldEnd());
if(void 0!==this.tags){a.writeFieldBegin("tags",d.Type.LIST,5);a.writeListBegin(d.Type.STRING,this.tags.length);for(var c in this.tags)this.tags.hasOwnProperty(c)&&(c=this.tags[c],a.writeString(c));a.writeListEnd();a.writeFieldEnd()}a.writeFieldStop();a.writeStructEnd()};TMessageArray=function(a){this.items=void 0;a&&void 0!==a.items&&(this.items=a.items)};TMessageArray.prototype={};TMessageArray.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;
switch(c.fid){case 1:if(b==d.Type.LIST){c=0;this.items=[];c=a.readListBegin().size;for(b=0;b<c;++b){var e=null,e=new I;e.read(a);this.items.push(e)}a.readListEnd()}else a.skip(b);break;case 0:a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};TMessageArray.prototype.write=function(a){a.writeStructBegin("TMessageArray");if(void 0!==this.items){a.writeFieldBegin("items",d.Type.LIST,1);a.writeListBegin(d.Type.STRUCT,this.items.length);for(var c in this.items)this.items.hasOwnProperty(c)&&
(c=this.items[c],c.write(a));a.writeListEnd();a.writeFieldEnd()}a.writeFieldStop();a.writeStructEnd()};L=function(a){this.presence=this.messages=this.timestamp=this.msgSerial=this.channelSerial=this.channel=this.connectionSerial=this.connectionId=this.applicationId=this.error=this.count=this.flags=this.action=void 0;a&&(void 0!==a.action&&(this.action=a.action),void 0!==a.flags&&(this.flags=a.flags),void 0!==a.count&&(this.count=a.count),void 0!==a.error&&(this.error=a.error),void 0!==a.applicationId&&
(this.applicationId=a.applicationId),void 0!==a.connectionId&&(this.connectionId=a.connectionId),void 0!==a.connectionSerial&&(this.connectionSerial=a.connectionSerial),void 0!==a.channel&&(this.channel=a.channel),void 0!==a.channelSerial&&(this.channelSerial=a.channelSerial),void 0!==a.msgSerial&&(this.msgSerial=a.msgSerial),void 0!==a.timestamp&&(this.timestamp=a.timestamp),void 0!==a.messages&&(this.messages=a.messages),void 0!==a.presence&&(this.presence=a.presence))};L.prototype={};L.prototype.read=
function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:b==d.Type.I32?this.action=a.readI32():a.skip(b);break;case 2:b==d.Type.BYTE?this.flags=a.readByte():a.skip(b);break;case 3:b==d.Type.I32?this.count=a.readI32():a.skip(b);break;case 4:b==d.Type.STRUCT?(this.error=new G,this.error.read(a)):a.skip(b);break;case 5:b==d.Type.STRING?this.applicationId=a.readString():a.skip(b);break;case 6:b==d.Type.STRING?this.connectionId=a.readString():
a.skip(b);break;case 7:b==d.Type.I64?this.connectionSerial=a.readI64():a.skip(b);break;case 8:b==d.Type.STRING?this.channel=a.readString():a.skip(b);break;case 9:b==d.Type.STRING?this.channelSerial=a.readString():a.skip(b);break;case 10:b==d.Type.I64?this.msgSerial=a.readI64():a.skip(b);break;case 11:b==d.Type.I64?this.timestamp=a.readI64():a.skip(b);break;case 12:if(b==d.Type.LIST){c=0;this.messages=[];c=a.readListBegin().size;for(b=0;b<c;++b){var e=null,e=new I;e.read(a);this.messages.push(e)}a.readListEnd()}else a.skip(b);
break;case 13:if(b==d.Type.LIST){c=0;this.presence=[];c=a.readListBegin().size;for(b=0;b<c;++b)e=null,e=new H,e.read(a),this.presence.push(e);a.readListEnd()}else a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};L.prototype.write=function(a){a.writeStructBegin("TProtocolMessage");void 0!==this.action&&(a.writeFieldBegin("action",d.Type.I32,1),a.writeI32(this.action),a.writeFieldEnd());void 0!==this.flags&&(a.writeFieldBegin("flags",d.Type.BYTE,2),a.writeByte(this.flags),a.writeFieldEnd());
void 0!==this.count&&(a.writeFieldBegin("count",d.Type.I32,3),a.writeI32(this.count),a.writeFieldEnd());void 0!==this.error&&(a.writeFieldBegin("error",d.Type.STRUCT,4),this.error.write(a),a.writeFieldEnd());void 0!==this.applicationId&&(a.writeFieldBegin("applicationId",d.Type.STRING,5),a.writeString(this.applicationId),a.writeFieldEnd());void 0!==this.connectionId&&(a.writeFieldBegin("connectionId",d.Type.STRING,6),a.writeString(this.connectionId),a.writeFieldEnd());void 0!==this.connectionSerial&&
(a.writeFieldBegin("connectionSerial",d.Type.I64,7),a.writeI64(this.connectionSerial),a.writeFieldEnd());void 0!==this.channel&&(a.writeFieldBegin("channel",d.Type.STRING,8),a.writeString(this.channel),a.writeFieldEnd());void 0!==this.channelSerial&&(a.writeFieldBegin("channelSerial",d.Type.STRING,9),a.writeString(this.channelSerial),a.writeFieldEnd());void 0!==this.msgSerial&&(a.writeFieldBegin("msgSerial",d.Type.I64,10),a.writeI64(this.msgSerial),a.writeFieldEnd());void 0!==this.timestamp&&(a.writeFieldBegin("timestamp",
d.Type.I64,11),a.writeI64(this.timestamp),a.writeFieldEnd());if(void 0!==this.messages){a.writeFieldBegin("messages",d.Type.LIST,12);a.writeListBegin(d.Type.STRUCT,this.messages.length);for(var c in this.messages)this.messages.hasOwnProperty(c)&&(c=this.messages[c],c.write(a));a.writeListEnd();a.writeFieldEnd()}if(void 0!==this.presence){a.writeFieldBegin("presence",d.Type.LIST,13);a.writeListBegin(d.Type.STRUCT,this.presence.length);for(var b in this.presence)this.presence.hasOwnProperty(b)&&(b=
this.presence[b],b.write(a));a.writeListEnd();a.writeFieldEnd()}a.writeFieldStop();a.writeStructEnd()};TMessageBundle=function(a){this.items=void 0;a&&void 0!==a.items&&(this.items=a.items)};TMessageBundle.prototype={};TMessageBundle.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:if(b==d.Type.LIST){c=0;this.items=[];c=a.readListBegin().size;for(b=0;b<c;++b){var e=null,e=new L;e.read(a);this.items.push(e)}a.readListEnd()}else a.skip(b);
break;case 0:a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};TMessageBundle.prototype.write=function(a){a.writeStructBegin("TMessageBundle");if(void 0!==this.items){a.writeFieldBegin("items",d.Type.LIST,1);a.writeListBegin(d.Type.STRUCT,this.items.length);for(var c in this.items)this.items.hasOwnProperty(c)&&(c=this.items[c],c.write(a));a.writeListEnd();a.writeFieldEnd()}a.writeFieldStop();a.writeStructEnd()};SMessageCount=function(a){this.data=this.count=void 0;a&&(void 0!==
a.count&&(this.count=a.count),void 0!==a.data&&(this.data=a.data))};SMessageCount.prototype={};SMessageCount.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:b==d.Type.DOUBLE?this.count=a.readDouble():a.skip(b);break;case 2:b==d.Type.DOUBLE?this.data=a.readDouble():a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};SMessageCount.prototype.write=function(a){a.writeStructBegin("SMessageCount");void 0!==
this.count&&(a.writeFieldBegin("count",d.Type.DOUBLE,1),a.writeDouble(this.count),a.writeFieldEnd());void 0!==this.data&&(a.writeFieldBegin("data",d.Type.DOUBLE,2),a.writeDouble(this.data),a.writeFieldEnd());a.writeFieldStop();a.writeStructEnd()};SMessageTypes=function(a){this.presence=this.messages=this.all=void 0;a&&(void 0!==a.all&&(this.all=a.all),void 0!==a.messages&&(this.messages=a.messages),void 0!==a.presence&&(this.presence=a.presence))};SMessageTypes.prototype={};SMessageTypes.prototype.read=
function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:b==d.Type.STRUCT?(this.all=new SMessageCount,this.all.read(a)):a.skip(b);break;case 2:b==d.Type.STRUCT?(this.messages=new SMessageCount,this.messages.read(a)):a.skip(b);break;case 3:b==d.Type.STRUCT?(this.presence=new SMessageCount,this.presence.read(a)):a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};SMessageTypes.prototype.write=function(a){a.writeStructBegin("SMessageTypes");
void 0!==this.all&&(a.writeFieldBegin("all",d.Type.STRUCT,1),this.all.write(a),a.writeFieldEnd());void 0!==this.messages&&(a.writeFieldBegin("messages",d.Type.STRUCT,2),this.messages.write(a),a.writeFieldEnd());void 0!==this.presence&&(a.writeFieldBegin("presence",d.Type.STRUCT,3),this.presence.write(a),a.writeFieldEnd());a.writeFieldStop();a.writeStructEnd()};SResourceCount=function(a){this.sample_sum=this.sample_count=this.refused=this.min=this.mean=this.peak=this.opened=void 0;a&&(void 0!==a.opened&&
(this.opened=a.opened),void 0!==a.peak&&(this.peak=a.peak),void 0!==a.mean&&(this.mean=a.mean),void 0!==a.min&&(this.min=a.min),void 0!==a.refused&&(this.refused=a.refused),void 0!==a.sample_count&&(this.sample_count=a.sample_count),void 0!==a.sample_sum&&(this.sample_sum=a.sample_sum))};SResourceCount.prototype={};SResourceCount.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:b==d.Type.DOUBLE?this.opened=a.readDouble():
a.skip(b);break;case 2:b==d.Type.DOUBLE?this.peak=a.readDouble():a.skip(b);break;case 3:b==d.Type.DOUBLE?this.mean=a.readDouble():a.skip(b);break;case 4:b==d.Type.DOUBLE?this.min=a.readDouble():a.skip(b);break;case 5:b==d.Type.DOUBLE?this.refused=a.readDouble():a.skip(b);break;case 10:b==d.Type.DOUBLE?this.sample_count=a.readDouble():a.skip(b);break;case 11:b==d.Type.DOUBLE?this.sample_sum=a.readDouble():a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};SResourceCount.prototype.write=
function(a){a.writeStructBegin("SResourceCount");void 0!==this.opened&&(a.writeFieldBegin("opened",d.Type.DOUBLE,1),a.writeDouble(this.opened),a.writeFieldEnd());void 0!==this.peak&&(a.writeFieldBegin("peak",d.Type.DOUBLE,2),a.writeDouble(this.peak),a.writeFieldEnd());void 0!==this.mean&&(a.writeFieldBegin("mean",d.Type.DOUBLE,3),a.writeDouble(this.mean),a.writeFieldEnd());void 0!==this.min&&(a.writeFieldBegin("min",d.Type.DOUBLE,4),a.writeDouble(this.min),a.writeFieldEnd());void 0!==this.refused&&
(a.writeFieldBegin("refused",d.Type.DOUBLE,5),a.writeDouble(this.refused),a.writeFieldEnd());void 0!==this.sample_count&&(a.writeFieldBegin("sample_count",d.Type.DOUBLE,10),a.writeDouble(this.sample_count),a.writeFieldEnd());void 0!==this.sample_sum&&(a.writeFieldBegin("sample_sum",d.Type.DOUBLE,11),a.writeDouble(this.sample_sum),a.writeFieldEnd());a.writeFieldStop();a.writeStructEnd()};SConnectionTypes=function(a){this.tls=this.plain=this.all=void 0;a&&(void 0!==a.all&&(this.all=a.all),void 0!==
a.plain&&(this.plain=a.plain),void 0!==a.tls&&(this.tls=a.tls))};SConnectionTypes.prototype={};SConnectionTypes.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:b==d.Type.STRUCT?(this.all=new SResourceCount,this.all.read(a)):a.skip(b);break;case 2:b==d.Type.STRUCT?(this.plain=new SResourceCount,this.plain.read(a)):a.skip(b);break;case 3:b==d.Type.STRUCT?(this.tls=new SResourceCount,this.tls.read(a)):a.skip(b);break;
default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};SConnectionTypes.prototype.write=function(a){a.writeStructBegin("SConnectionTypes");void 0!==this.all&&(a.writeFieldBegin("all",d.Type.STRUCT,1),this.all.write(a),a.writeFieldEnd());void 0!==this.plain&&(a.writeFieldBegin("plain",d.Type.STRUCT,2),this.plain.write(a),a.writeFieldEnd());void 0!==this.tls&&(a.writeFieldBegin("tls",d.Type.STRUCT,3),this.tls.write(a),a.writeFieldEnd());a.writeFieldStop();a.writeStructEnd()};SMessageTraffic=function(a){this.httpStream=
this.push=this.rest=this.realtime=this.all=void 0;a&&(void 0!==a.all&&(this.all=a.all),void 0!==a.realtime&&(this.realtime=a.realtime),void 0!==a.rest&&(this.rest=a.rest),void 0!==a.push&&(this.push=a.push),void 0!==a.httpStream&&(this.httpStream=a.httpStream))};SMessageTraffic.prototype={};SMessageTraffic.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:b==d.Type.STRUCT?(this.all=new SMessageTypes,this.all.read(a)):
a.skip(b);break;case 2:b==d.Type.STRUCT?(this.realtime=new SMessageTypes,this.realtime.read(a)):a.skip(b);break;case 3:b==d.Type.STRUCT?(this.rest=new SMessageTypes,this.rest.read(a)):a.skip(b);break;case 4:b==d.Type.STRUCT?(this.push=new SMessageTypes,this.push.read(a)):a.skip(b);break;case 5:b==d.Type.STRUCT?(this.httpStream=new SMessageTypes,this.httpStream.read(a)):a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};SMessageTraffic.prototype.write=function(a){a.writeStructBegin("SMessageTraffic");
void 0!==this.all&&(a.writeFieldBegin("all",d.Type.STRUCT,1),this.all.write(a),a.writeFieldEnd());void 0!==this.realtime&&(a.writeFieldBegin("realtime",d.Type.STRUCT,2),this.realtime.write(a),a.writeFieldEnd());void 0!==this.rest&&(a.writeFieldBegin("rest",d.Type.STRUCT,3),this.rest.write(a),a.writeFieldEnd());void 0!==this.push&&(a.writeFieldBegin("push",d.Type.STRUCT,4),this.push.write(a),a.writeFieldEnd());void 0!==this.httpStream&&(a.writeFieldBegin("httpStream",d.Type.STRUCT,5),this.httpStream.write(a),
a.writeFieldEnd());a.writeFieldStop();a.writeStructEnd()};SRequestCount=function(a){this.refused=this.failed=this.succeeded=void 0;a&&(void 0!==a.succeeded&&(this.succeeded=a.succeeded),void 0!==a.failed&&(this.failed=a.failed),void 0!==a.refused&&(this.refused=a.refused))};SRequestCount.prototype={};SRequestCount.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:b==d.Type.DOUBLE?this.succeeded=a.readDouble():a.skip(b);
break;case 2:b==d.Type.DOUBLE?this.failed=a.readDouble():a.skip(b);break;case 3:b==d.Type.DOUBLE?this.refused=a.readDouble():a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};SRequestCount.prototype.write=function(a){a.writeStructBegin("SRequestCount");void 0!==this.succeeded&&(a.writeFieldBegin("succeeded",d.Type.DOUBLE,1),a.writeDouble(this.succeeded),a.writeFieldEnd());void 0!==this.failed&&(a.writeFieldBegin("failed",d.Type.DOUBLE,2),a.writeDouble(this.failed),a.writeFieldEnd());
void 0!==this.refused&&(a.writeFieldBegin("refused",d.Type.DOUBLE,3),a.writeDouble(this.refused),a.writeFieldEnd());a.writeFieldStop();a.writeStructEnd()};SStats=function(a){this.count=this.inProgress=this.tokenRequests=this.apiRequests=this.channels=this.connections=this.persisted=this.outbound=this.inbound=this.all=void 0;a&&(void 0!==a.all&&(this.all=a.all),void 0!==a.inbound&&(this.inbound=a.inbound),void 0!==a.outbound&&(this.outbound=a.outbound),void 0!==a.persisted&&(this.persisted=a.persisted),
void 0!==a.connections&&(this.connections=a.connections),void 0!==a.channels&&(this.channels=a.channels),void 0!==a.apiRequests&&(this.apiRequests=a.apiRequests),void 0!==a.tokenRequests&&(this.tokenRequests=a.tokenRequests),void 0!==a.inProgress&&(this.inProgress=a.inProgress),void 0!==a.count&&(this.count=a.count))};SStats.prototype={};SStats.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:b==d.Type.STRUCT?(this.all=
new SMessageTypes,this.all.read(a)):a.skip(b);break;case 2:b==d.Type.STRUCT?(this.inbound=new SMessageTraffic,this.inbound.read(a)):a.skip(b);break;case 3:b==d.Type.STRUCT?(this.outbound=new SMessageTraffic,this.outbound.read(a)):a.skip(b);break;case 4:b==d.Type.STRUCT?(this.persisted=new SMessageTypes,this.persisted.read(a)):a.skip(b);break;case 5:b==d.Type.STRUCT?(this.connections=new SConnectionTypes,this.connections.read(a)):a.skip(b);break;case 6:b==d.Type.STRUCT?(this.channels=new SResourceCount,
this.channels.read(a)):a.skip(b);break;case 7:b==d.Type.STRUCT?(this.apiRequests=new SRequestCount,this.apiRequests.read(a)):a.skip(b);break;case 8:b==d.Type.STRUCT?(this.tokenRequests=new SRequestCount,this.tokenRequests.read(a)):a.skip(b);break;case 10:b==d.Type.STRING?this.inProgress=a.readString():a.skip(b);break;case 11:b==d.Type.I32?this.count=a.readI32():a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};SStats.prototype.write=function(a){a.writeStructBegin("SStats");void 0!==
this.all&&(a.writeFieldBegin("all",d.Type.STRUCT,1),this.all.write(a),a.writeFieldEnd());void 0!==this.inbound&&(a.writeFieldBegin("inbound",d.Type.STRUCT,2),this.inbound.write(a),a.writeFieldEnd());void 0!==this.outbound&&(a.writeFieldBegin("outbound",d.Type.STRUCT,3),this.outbound.write(a),a.writeFieldEnd());void 0!==this.persisted&&(a.writeFieldBegin("persisted",d.Type.STRUCT,4),this.persisted.write(a),a.writeFieldEnd());void 0!==this.connections&&(a.writeFieldBegin("connections",d.Type.STRUCT,
5),this.connections.write(a),a.writeFieldEnd());void 0!==this.channels&&(a.writeFieldBegin("channels",d.Type.STRUCT,6),this.channels.write(a),a.writeFieldEnd());void 0!==this.apiRequests&&(a.writeFieldBegin("apiRequests",d.Type.STRUCT,7),this.apiRequests.write(a),a.writeFieldEnd());void 0!==this.tokenRequests&&(a.writeFieldBegin("tokenRequests",d.Type.STRUCT,8),this.tokenRequests.write(a),a.writeFieldEnd());void 0!==this.inProgress&&(a.writeFieldBegin("inProgress",d.Type.STRING,10),a.writeString(this.inProgress),
a.writeFieldEnd());void 0!==this.count&&(a.writeFieldBegin("count",d.Type.I32,11),a.writeI32(this.count),a.writeFieldEnd());a.writeFieldStop();a.writeStructEnd()};SStatsArray=function(a){this.items=void 0;a&&void 0!==a.items&&(this.items=a.items)};SStatsArray.prototype={};SStatsArray.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:if(b==d.Type.LIST){c=0;this.items=[];c=a.readListBegin().size;for(b=0;b<c;++b){var e=
null,e=new SStats;e.read(a);this.items.push(e)}a.readListEnd()}else a.skip(b);break;case 0:a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};SStatsArray.prototype.write=function(a){a.writeStructBegin("SStatsArray");if(void 0!==this.items){a.writeFieldBegin("items",d.Type.LIST,1);a.writeListBegin(d.Type.STRUCT,this.items.length);for(var c in this.items)this.items.hasOwnProperty(c)&&(c=this.items[c],c.write(a));a.writeListEnd();a.writeFieldEnd()}a.writeFieldStop();a.writeStructEnd()};
WWebhookMessage=function(a){this.data=this.serial=this.timestamp=this.webhookId=this.name=void 0;a&&(void 0!==a.name&&(this.name=a.name),void 0!==a.webhookId&&(this.webhookId=a.webhookId),void 0!==a.timestamp&&(this.timestamp=a.timestamp),void 0!==a.serial&&(this.serial=a.serial),void 0!==a.data&&(this.data=a.data))};WWebhookMessage.prototype={};WWebhookMessage.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:b==
d.Type.STRING?this.name=a.readString():a.skip(b);break;case 2:b==d.Type.STRING?this.webhookId=a.readString():a.skip(b);break;case 3:b==d.Type.I64?this.timestamp=a.readI64():a.skip(b);break;case 4:b==d.Type.STRING?this.serial=a.readString():a.skip(b);break;case 5:b==d.Type.STRUCT?(this.data=new E,this.data.read(a)):a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};WWebhookMessage.prototype.write=function(a){a.writeStructBegin("WWebhookMessage");void 0!==this.name&&(a.writeFieldBegin("name",
d.Type.STRING,1),a.writeString(this.name),a.writeFieldEnd());void 0!==this.webhookId&&(a.writeFieldBegin("webhookId",d.Type.STRING,2),a.writeString(this.webhookId),a.writeFieldEnd());void 0!==this.timestamp&&(a.writeFieldBegin("timestamp",d.Type.I64,3),a.writeI64(this.timestamp),a.writeFieldEnd());void 0!==this.serial&&(a.writeFieldBegin("serial",d.Type.STRING,4),a.writeString(this.serial),a.writeFieldEnd());void 0!==this.data&&(a.writeFieldBegin("data",d.Type.STRUCT,5),this.data.write(a),a.writeFieldEnd());
a.writeFieldStop();a.writeStructEnd()};WWebhookEnvelope=function(a){this.items=this.error=void 0;a&&(void 0!==a.error&&(this.error=a.error),void 0!==a.items&&(this.items=a.items))};WWebhookEnvelope.prototype={};WWebhookEnvelope.prototype.read=function(a){for(a.readStructBegin();;){var c=a.readFieldBegin(),b=c.ftype;if(b==d.Type.STOP)break;switch(c.fid){case 1:b==d.Type.STRUCT?(this.error=new G,this.error.read(a)):a.skip(b);break;case 2:if(b==d.Type.LIST){c=0;this.items=[];c=a.readListBegin().size;
for(b=0;b<c;++b){var e=null,e=new WWebhookMessage;e.read(a);this.items.push(e)}a.readListEnd()}else a.skip(b);break;default:a.skip(b)}a.readFieldEnd()}a.readStructEnd()};WWebhookEnvelope.prototype.write=function(a){a.writeStructBegin("WWebhookEnvelope");void 0!==this.error&&(a.writeFieldBegin("error",d.Type.STRUCT,1),this.error.write(a),a.writeFieldEnd());if(void 0!==this.items){a.writeFieldBegin("items",d.Type.LIST,2);a.writeListBegin(d.Type.STRUCT,this.items.length);for(var c in this.items)this.items.hasOwnProperty(c)&&
(c=this.items[c],c.write(a));a.writeListEnd();a.writeFieldEnd()}a.writeFieldStop();a.writeStructEnd()};var v={TAction:TAction,TFlags:TFlags,TType:TType,TError:G,TData:E,TPresence:H,TMessage:I,TChannelMessage:void 0,TProtocolMessage:L,TPresenceState:TPresenceState,TMessageArray:TMessageArray};this.Cookie=function(){function a(){}"object"==typeof window&&(a.create=function(a,b,e){var f="";e&&(f=new Date,f.setTime(f.getTime()+e),f="; expires="+f.toGMTString());document.cookie=a+"="+b+f+"; path=/"},a.read=
function(a){a+="=";for(var b=document.cookie.split(";"),e=0;e<b.length;e++){for(var f=b[e];" "==f.charAt(0);)f=f.substring(1,f.length);if(0==f.indexOf(a))return f.substring(a.length,f.length)}return null},a.erase=function(a){createCookie(a,"",-36E5)});return a}();var r={protocolVersion:1,HOST:"rest.ably.io",WS_HOST:"realtime.ably.io",FALLBACK_HOSTS:["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"],PORT:80,TLS_PORT:443,connectTimeout:15E3,
disconnectTimeout:3E4,suspendedTimeout:12E4,recvTimeout:9E4,sendTimeout:1E4,connectionPersistTimeout:15E3,httpTransports:["xhr","iframe","jsonp"],transports:["web_socket","flash_socket","xhr","iframe","jsonp"],flashTransport:{swfLocation:("undefined"!==typeof window?window.location.protocol:"https:")+"//cdn.ably.io/lib/swf/WebSocketMainInsecure-0.9.swf"},getHost:function(a,c,b){c=c||a.host||r.HOST;b&&(c=c==a.host&&(a.wsHost||c)||c==r.HOST&&(r.WS_HOST||c)||c);return c},getPort:function(a,c){return c||
a.tls?a.tlsPort||r.TLS_PORT:a.port||r.PORT},getHosts:function(a){var c;a.host?(c=[a.host],a.fallbackHosts&&c.concat(a.fallbackHosts)):c=[r.HOST].concat(r.FALLBACK_HOSTS);return c}};"undefined"!==typeof exports&&this.exports!==exports&&(exports.defaults=r);var s=function(){function a(){}var c=function(){};a.get=function(b,e,f,h,l){l=l||c;var d="function"==typeof e?e:function(a){return b.baseUri(a)+e},q,p=b.connection;q=p&&"connected"==p.state?[p.connectionManager.host]:r.getHosts(b.options);1==q.length?
a.getUri(b,d(q[0]),f,h,l):a.getUri(b,d(q.shift()),f,h,function(c){if(c){var e=c.code;if("ENETUNREACH"==e||"EHOSTUNREACH"==e||"EHOSTDOWN"==e){a.getUri(b,d(q.shift()),f,h,l);return}}l.apply(null,arguments)})};a.getUri=function(b,e,f,h,d){d=d||c;a.Request(e,f,h,null,f&&"application/json"!=f.accept,d)};a.post=function(b,e,f,h,d,k){k=k||c;var q="function"==typeof e?e:function(a){return b.baseUri(a)+e},p,x=b.connection;p=x&&"connected"==x.state?[x.connectionManager.host]:r.getHosts(b.options);1==p.length?
a.postUri(b,q(p[0]),f,h,d,k):a.postUri(b,q(p.shift()),f,h,d,function(c){if(c){var e=c.code;if("ENETUNREACH"==e||"EHOSTUNREACH"==e||"EHOSTDOWN"==e){a.postUri(b,q(p.shift()),f,h,d,k);return}}k.apply(null,arguments)})};a.postUri=function(b,e,f,h,d,k){k=k||c;a.Request(e,f,d,h,f&&"application/json"!=f.accept,k)};a.supportsAuthHeaders=!1;a.supportsLinkHeaders=!1;return a}();this.ThriftUtil=function(){function a(a){a=a||0;if(h.length){var b=h.shift();if(b.length>=a)return b}return new w(a||f)}function c(){}
var b=new d.TTransport,e=new d.TBinaryProtocol(b),f=16384,h=[];c.encode=function(a,b){try{b(null,c.encodeSync(a))}catch(h){var e="Unexpected exception encoding Thrift; exception = "+h;g.logAction(g.LOG_ERROR,"ThriftUtil.encode()",e,h);e=Error(e);e.statusCode=400;b(e)}};c.encodeSync=function(c){var f=void 0;if(c){var d=a();b.reset(d,function(a){f=a});c.write(e);e.flush();h.unshift(d)}return f};c.decode=function(a,b,h){var e=c.decodeSync(a,b);e?h(e):h(null,a,b)};c.decodeSync=function(a,c){try{return b.reset(c),
a.read(e),a}catch(h){var f="Unexpected exception decoding thrift message; exception = "+h;g.logAction(g.LOG_ERROR,"ThriftUtil.decode()",f,h);f=Error(f);f.statusCode=400;throw f;}};return c}();var da=function(){function a(){this.buffer=[]}function c(a){this._input=a;this._index=-1;this._buffer=[]}function b(a){this._input=a;this._index=-1;this._buffer=[]}a.prototype.append=function(a){this.buffer.push(a);return this};a.prototype.toString=function(){return this.buffer.join("")};var e={codex:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
encode:function(b){var h=new a,d=e.codex;for(b=new c(b);b.moveNext();){var k=b.current;b.moveNext();var q=b.current;b.moveNext();var p=b.current,x=k>>2,k=(k&3)<<4|q>>4,g=(q&15)<<2|p>>6,B=p&63;isNaN(q)?g=B=64:isNaN(p)&&(B=64);h.append(d.charAt(x)+d.charAt(k)+d.charAt(g)+d.charAt(B))}return h.toString()},decode:function(c){var h=new a;for(c=new b(c);c.moveNext();){var e=c.current;if(128>e)h.append(String.fromCharCode(e));else if(191<e&&224>e){c.moveNext();var d=c.current;h.append(String.fromCharCode((e&
31)<<6|d&63))}else c.moveNext(),d=c.current,c.moveNext(),h.append(String.fromCharCode((e&15)<<12|(d&63)<<6|c.current&63))}return h.toString()}};c.prototype={current:Number.NaN,moveNext:function(){if(0<this._buffer.length)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return this.current=Number.NaN,!1;var a=this._input.charCodeAt(++this._index);13==a&&10==this._input.charCodeAt(this._index+1)&&(a=10,this._index+=2);128>a?this.current=a:(127<a&&2048>a?this.current=
a>>6|192:(this.current=a>>12|224,this._buffer.push(a>>6&63|128)),this._buffer.push(a&63|128));return!0}};b.prototype={current:64,moveNext:function(){if(0<this._buffer.length)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return this.current=64,!1;var a=e.codex.indexOf(this._input.charAt(++this._index)),b=e.codex.indexOf(this._input.charAt(++this._index)),c=e.codex.indexOf(this._input.charAt(++this._index)),d=e.codex.indexOf(this._input.charAt(++this._index)),q=(c&
3)<<6|d;this.current=a<<2|b>>4;64!=c&&this._buffer.push((b&15)<<4|c>>2);64!=d&&this._buffer.push(q);return!0}};return e}(),C=Ably.Crypto=window.CryptoJS&&function(){function a(){}function c(){this.iv=this.key=this.algorithm=null}function b(a){var b=this.algorithm=a.algorithm.toUpperCase().replace(/-\d+$/,""),c=this.key=a.key;a=this.iv=a.iv;this.encryptCipher=CryptoJS.algo[b].createEncryptor(c,{iv:a});this.blockLengthWords=a.words.length}var e=v.TData,f=v.TType,h;if(window.Uint32Array&&window.crypto&&
window.crypto.getRandomValues){var d=new Uint32Array(4);h=function(a,b){var c=a/4,e=4==c?d:new Uint32Array(c);window.crypto.getRandomValues(e);for(var h=Array(c),f=0;f<c;f++)h[f]=e[f];b(null,CryptoJS.lib.WordArray.create(h))}}else h=function(a,b){console.log("Ably.Crypto.generateRandom(): WARNING: using insecure Math.random() to generate key or iv; see http://ably.io/documentation for how to fix this");for(var c=a/4,e=Array(c),h=0;h<c;h++)e[h]=Math.floor(4294967296*Math.random());b(null,CryptoJS.lib.WordArray.create(e))};
var k=CryptoJS.lib.WordArray.create([0,0,0,0]),q=[CryptoJS.lib.WordArray.create([269488144,269488144,269488144,269488144],16),CryptoJS.lib.WordArray.create([16777216],1),CryptoJS.lib.WordArray.create([33685504],2),CryptoJS.lib.WordArray.create([50529024],3),CryptoJS.lib.WordArray.create([67372036],4),CryptoJS.lib.WordArray.create([84215045,83886080],5),CryptoJS.lib.WordArray.create([101058054,101056512],6),CryptoJS.lib.WordArray.create([117901063,117901056],7),CryptoJS.lib.WordArray.create([134744072,
134744072],8),CryptoJS.lib.WordArray.create([151587081,151587081,150994944],9),CryptoJS.lib.WordArray.create([168430090,168430090,168427520],10),CryptoJS.lib.WordArray.create([185273099,185273099,185273088],11),CryptoJS.lib.WordArray.create([202116108,202116108,202116108],12),CryptoJS.lib.WordArray.create([218959117,218959117,218959117,218103808],13),CryptoJS.lib.WordArray.create([235802126,235802126,235802126,235798528],14),CryptoJS.lib.WordArray.create([252645135,252645135,252645135,252645135],
15),CryptoJS.lib.WordArray.create([269488144,269488144,269488144,269488144],16)];a.generateRandom=h;a.CipherParams=c;a.getDefaultParams=function(b,e){1==arguments.length&&"function"==typeof b&&(e=b,b=void 0);if(b){"string"===typeof b?b=CryptoJS.enc.Hex.parse(b):b.words||(b=CryptoJS.lib.WordArray.create(b));var f=new c;f.algorithm="aes-"+String(32*b.words.length);f.key=b;h(16,function(a,b){f.iv=b;e(null,f)})}else h(16,function(b,c){b?e(b):a.getDefaultParams(c,e)})};a.CipherData=function(a,b){this.cipherData=
a;this.type=b};a.getCipher=function(e,h){var f=e&&e.cipherParams;f?f instanceof c?h(null,new b(f)):h(Error("ChannelOptions not supported")):a.getDefaultParams(function(a,c){a?h(a):h(null,new b(c))})};b.prototype.encrypt=function(a){g.logAction(g.LOG_MICRO,"CBCCipher.encrypt()","");var b=a.sigBytes,c=b+16&-16,e=this.getIv().clone();a=this.encryptCipher.process(a.concat(q[c-b]));return e.concat(a)};b.prototype.decrypt=function(a){g.logAction(g.LOG_MICRO,"CBCCipher.decrypt()","");var b=this.blockLengthWords,
c=a.words;a=CryptoJS.lib.WordArray.create(c.slice(0,b));c=CryptoJS.lib.WordArray.create(c.slice(b));b=CryptoJS.algo[this.algorithm].createDecryptor(this.key,{iv:a});a=b.process(c);c=b.finalize();b.reset();c&&c.sigBytes&&a.concat(c);return a};b.prototype.getIv=function(){if(!this.iv)return this.encryptCipher.process(k);var a=this.iv;this.iv=null;return a};var p=a.Data={};p.asPlaintext=function(a){var b;switch(a.type){case f.STRING:case f.JSONOBJECT:case f.JSONARRAY:b=CryptoJS.enc.Utf8.parse(a.stringData);
break;case f.INT32:b=CryptoJS.lib.WordArray.create([a.i32Data]);break;case f.INT64:b=CryptoJS.lib.WordArray.create([a.i64Data/4294967296,a.i64Data%4294967296]);break;case f.DOUBLE:a=a.doubleData;b=new ArrayBuffer(8);(new Float64Array(b))[0]=a;a=new Uint32Array(b);b=CryptoJS.lib.WordArray.create([a[0],a[1]]);break;case f.BUFFER:b=a.binaryData}return b};p.fromPlaintext=function(a,b){var c=new e;c.type=b;switch(b){case f.INT32:c.i32Data=a[0];break;case f.INT64:c.i64Data=4294967296*a[0]+a[1];break;case f.DOUBLE:var h;
h=new ArrayBuffer(8);var d=new Uint32Array(h);d[0]=a.words[0];d[1]=a.words[1];h=(new Float64Array(h))[0];c.doubleData=h;break;case f.JSONOBJECT:case f.JSONARRAY:case f.STRING:c.stringData=CryptoJS.enc.Utf8.stringify(a);break;case f.BUFFER:c.binaryData=a}return c};p.asBase64=function(a){return CryptoJS.enc.Base64.stringify(a)};p.fromBase64=function(a){return CryptoJS.enc.Base64.parse(a)};return a}(),M=function(){function a(){}a.addListener=function(a,b,e){a.addEventListener?a.addEventListener(b,e,
!1):a.attachEvent("on"+b,e)};a.removeListener=function(a,b,e){a.removeEventListener?a.removeEventListener(b,e,!1):a.detachEvent("on"+b,e)};a.addMessageListener=function(c,b){a.addListener(c,"message",b)};a.removeMessageListener=function(c,b){a.removeListener(c,"message",b)};a.addUnloadListener=function(c){a.addListener(window,"unload",c)};return a}(),t=function(){function a(){this.any=[];this.events={};this.anyOnce=[];this.eventsOnce={}}a.prototype.on=function(a,b){1==arguments.length&&"function"==
typeof a?this.any.push(a):null===a?this.any.push(b):(this.events[a]=this.events[a]||[]).push(b)};a.prototype.off=function(a,b){if(0==arguments.length)this.any=[],this.events={},this.anyOnce=[],this.eventsOnce={};else{1==arguments.length&&"function"==typeof a&&(b=a,a=null);var e,f=-1;if(null===a)if(b){if(!(e=this.any)||-1==(f=m.arrIndexOf(e,b)))if(e=this.anyOnce)f=m.arrIndexOf(e,b);-1<f&&e.splice(f,1)}else this.any=[],this.anyOnce=[];else if(b){f=-1;if(!(e=this.events[a])||-1==(f=m.arrIndexOf(e,b)))if(e=
this.eventsOnce[a])f=m.arrIndexOf(e,b);-1<f&&e.splice(f,1)}else delete this.events[a],delete this.eventsOnce[a]}};a.prototype.listeners=function(a){if(a){var b=this.events[a]||[];this.eventsOnce[a]&&Array.prototype.push.apply(b,this.eventsOnce[a]);return b.length?b:null}return this.any.length?this.any:null};a.prototype.emit=function(a){function b(a){try{a.apply(f,e)}catch(b){g.logAction(g.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+b+"; stack = "+b.stack)}}var e=Array.prototype.slice.call(arguments,
1),f={event:a};if(this.anyOnce.length){var h=this.anyOnce;this.anyOnce=[];for(var d=0;d<h.length;d++)b(h[d])}for(d=0;d<this.any.length;d++)this.any[d].apply(f,e);if(h=this.eventsOnce[a])for(delete this.eventsOnce[a],d=0;d<h.length;d++)b(h[d]);if(h=this.events[a])for(d=0;d<h.length;d++)b(h[d])};a.prototype.once=function(a,b){1==arguments.length&&"function"==typeof a?this.anyOnce.push(a):null===a?this.anyOnce.push(b):(this.eventsOnce[a]=this.eventsOnce[a]||[]).push(b)};return a}(),g=function(){function a(a){}
var c=4,b=function(){};a.LOG_NONE=0;a.LOG_ERROR=1;a.LOG_MAJOR=2;a.LOG_MINOR=3;a.LOG_MICRO=4;a.LOG_DEFAULT=3;a.LOG_DEBUG=4;a.logAction=function(a,f,h){a<=c&&b("Ably: "+f+": "+h)};a.setLog=function(a,f){c=a||3;b=f||function(a){console.log(a)}};return a}(),m=function(){function a(){}var c="object"==typeof window;a.addProperties=a.mixin=function(a,c){for(var f in c)a[f]=c[f];return a};a.copy=function(b){return a.mixin({},b)};a.isArray=function(a){return"[object Array]"==Object.prototype.toString.call(a)};
a.isEmpty=function(a){for(var c in a)return!1;return!0};a.shallowClone=function(a){var c={},f;for(f in a)c[f]=a[f];return c};a.prototypicalClone=function(b,c){function f(){}f.prototype=b;var h=new f;c&&a.mixin(h,c);return h};a.inherits="undefined"!==typeof require&&require("util").inherits||function(b,c){b.super_=c;b.prototype=a.prototypicalClone(c.prototype,{constructor:b})};a.containsValue=function(a,c){for(var f in a)if(a[f]==c)return!0;return!1};a.intersect=function(b,c){return a.isArray(c)?a.arrIntersect(b,
c):a.arrIntersectOb(b,c)};a.isArray=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};a.arrIntersect=function(b,c){for(var f=[],h=0;h<b.length;h++){var d=b[h];-1!=a.arrIndexOf(c,d)&&f.push(d)}return f};a.arrIntersectOb=function(a,c){for(var f=[],h=0;h<a.length;h++){var d=a[h];d in c&&f.push(d)}return f};a.arrSubtract=function(b,c){for(var f=[],h=0;h<b.length;h++){var d=b[h];-1==a.arrIndexOf(c,d)&&f.push(d)}return f};a.arrIndexOf=Array.prototype.indexOf?
function(a,c,f){return a.indexOf(c,f)}:function(a,c,f){f=f||0;for(var h=a.length;f<h;f++)if(a[f]===c)return f;return-1};a.keysArray=function(a,c){var f=[],h;for(h in a)c&&!a.hasOwnProperty(h)||f.push(h);return f.length?f:void 0};a.valuesArray=function(a,c){var f=[],h;for(h in a)c&&!a.hasOwnProperty(h)||f.push(a[h]);return f.length?f:void 0};a.nextTick=c?function(a){setTimeout(a,0)}:process.nextTick;a.defaultGetHeaders=function(a){return{accept:a?"application/x-thrift,application/json":"application/json"}};
a.defaultPostHeaders=function(a){return{accept:a?"application/x-thrift,application/json":"application/json","content-type":a?"application/x-thrift":"application/json"}};a.arrRandomElement=function(a){return a.splice(Math.floor(Math.random()*a.length))};a.toQueryString=function(a){var c=[];if(a)for(var f in a)c.push(encodeURIComponent(f)+"="+encodeURIComponent(a[f]));return c.length?"?"+c.join("&"):""};a.parseQueryString=function(a){for(var c,f=/([^?&=]+)=?([^&]*)/g,h={};c=f.exec(a);)h[decodeURIComponent(c[1])]=
decodeURIComponent(c[2]);return h};return a}(),T=function(){return function(a){a=a||[];var c=function(){for(var b=0;b<a.length;b++){var c=a[b];try{c.apply(null,arguments)}catch(f){}}};c.push=function(){Array.prototype.push.apply(a,arguments)};return c}}(),y=function(){function a(a,b,c,h,e){this.options=a;this.host=b;this.mode=c;this.connectionId=h;this.connectionSerial=e;this.binary=!a.useTextProtocol;a.transportParams&&void 0!==a.transportParams.stream&&(this.stream=a.transportParams.stream)}function c(a,
b){this.msg=a;var c=a.action;this.ackRequired=c==h.MESSAGE||c==h.PRESENCE;this.callback=b;this.merged=!1}function b(a,c){t.call(this);this.realtime=a;this.options=c;this.state=k.initialized;this.error=null;this.queuedMessages=[];this.pendingMessages=[];this.msgSerial=0;this.connectionSerial=this.connectionId=void 0;this.httpTransports=m.intersect(c.transports||r.httpTransports,b.httpTransports);this.transports=m.intersect(c.transports||r.transports,b.transports);this.upgradeTransports=m.arrSubtract(this.transports,
this.httpTransports);this.httpHosts=r.getHosts(c);this.host=this.pendingTransport=this.transport=null;g.logAction(g.LOG_MINOR,"Realtime.ConnectionManager()","started");g.logAction(g.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(c.transports||r.transports)+"]");g.logAction(g.LOG_MICRO,"Realtime.ConnectionManager()","available http transports = ["+this.httpTransports+"]");g.logAction(g.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]");g.logAction(g.LOG_MICRO,
"Realtime.ConnectionManager()","http hosts = ["+this.httpHosts+"]");if(!this.transports.length)throw g.logAction(g.LOG_ERROR,"realtime.ConnectionManager()","no requested transports available"),Error("no requested transports available");f&&!0===c.recover&&window.addEventListener&&window.addEventListener("beforeunload",this.persistConnection.bind(this))}var e="undefined"!==typeof Cookie&&Cookie.read,f="undefined"!==typeof Cookie&&Cookie.create,h=("object"==typeof v?v:require("../nodejs/lib/protocol/clientmessage_types")).TAction,
d=function(){},k={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:r.connectTimeout,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:r.disconnectTimeout},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:r.suspendedTimeout},
closed:{state:"closed",terminal:!1,queueEvents:!1,sendEvents:!1},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1}};a.prototype.getConnectParams=function(a){a=a?m.prototypicalClone(a):{};var b=this.options;switch(this.mode){case "upgrade":a.upgrade=this.connectionId;void 0!==this.connectionSerial&&(a.connection_serial=this.connectionSerial);break;case "resume":a.resume=this.connectionId;void 0!==this.connectionSerial&&(a.connection_serial=this.connectionSerial);break;case "recover":if(!0===
b.recover){var c=e("ably-connection-id"),h=e("ably-connection-serial");null!==c&&null!==h&&(a.recover=c,a.connection_serial=h)}else if(c=b.recover.match(/^(\w+):(\w+)$/))a.recover=c[1],a.connection_serial=c[2]}!1===b.echoMessages&&(a.echo="false");a.binary=this.binary;void 0!==this.stream&&(a.stream=this.stream);return a};m.inherits(b,t);b.httpTransports={};b.transports={};b.prototype.chooseTransport=function(b){g.logAction(g.LOG_MAJOR,"ConnectionManager.chooseTransport()","");if(this.transport)g.logAction(g.LOG_MINOR,
"ConnectionManager.chooseTransport()","Transport already established"),b(null,this.transport);else{var c=this.connectionId?"resume":this.options.recover?"recover":"clean",h=new a(this.options,null,c,this.connectionId,this.connectionSerial);g.logAction(g.LOG_MINOR,"ConnectionManager.chooseTransport()","Transport recovery mode = "+c+("clean"==c?"":"; connectionId = "+this.connectionId+"; connectionSerial = "+this.connectionSerial));var e=this;this.httpTransports.length?this.chooseHttpTransport(h,function(c,
f){if(c)g.logAction(g.LOG_ERROR,"ConnectionManager.chooseTransport()","Unexpected error establishing transport; err = "+c),b(c);else if(g.logAction(g.LOG_MINOR,"ConnectionManager.chooseTransport()","Establishing http transport: "+f),b(null,f),e.upgradeTransports.length)f.once("connected",function(b,c){m.nextTick(function(){g.logAction(g.LOG_MAJOR,"ConnectionManager.chooseTransport()","upgrading ... connectionId = "+c);h=new a(e.options,h.host,"upgrade",c);e.chooseTransportForHost(h,e.upgradeTransports.slice(),
d)})})}):(h.host=this.httpHosts[0],g.logAction(g.LOG_MINOR,"ConnectionManager.chooseTransport()","No http transports available; ignoring fallback hosts"),this.chooseTransportForHost(h,e.transports.slice(),b))}};b.prototype.chooseTransportForHost=function(a,c,h){var e=c.shift();if(e){var f=this;g.logAction(g.LOG_MICRO,"ConnectionManager.chooseTransportForHost()","trying "+e);b.transports[e].tryConnect(this,this.realtime.auth,a,function(b,d){b?f.chooseTransportForHost(a,c,h):(g.logAction(g.LOG_MICRO,
"ConnectionManager.chooseTransport()","transport "+e+" connecting"),f.setTransportPending(d),h(null,d))})}else{var d=Error("Unable to connect (no available transport)");d.statusCode=404;d.code=8E4;h(d)}};b.prototype.chooseHttpTransport=function(a,c){function h(){if(e.length)b.httpTransports[d.httpTransports[0]].checkConnectivity(function(b,f){b?c(b):f?(a.host=m.arrRandomElement(e),d.chooseTransportForHost(a,d.httpTransports.slice(),function(a,b){a?h():c(null,b)})):(b=Error("Unable to connect (network unreachable)"),
b.statusCode=404,b.code=8E4,c(b))});else{var f=Error("Unable to connect (no available host)");f.statusCode=404;f.code=8E4;c(f)}}var e=this.httpHosts.slice(),f=e.shift();if(f){a.host=f;var d=this;this.chooseTransportForHost(a,this.httpTransports.slice(),function(a,b){a?h():c(null,b)})}else f=Error("Unable to connect (no available host)"),f.statusCode=404,f.code=8E4,c(f)};b.prototype.setTransportPending=function(a){g.logAction(g.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+a);
if(this.state==k.closed)a.close(!0);else{this.pendingTransport&&this.pendingTransport.close(!1);this.pendingTransport=a;for(var b=this,c=function(c){return function(h,e,f){g.logAction(g.LOG_MINOR,"ConnectionManager.setTransportPending","on state = "+c);h&&h.message&&g.logAction(g.LOG_MICRO,"ConnectionManager.setTransportPending","reason =  "+h.message);e&&g.logAction(g.LOG_MICRO,"ConnectionManager.setTransportPending","connectionId =  "+e);void 0!==f&&g.logAction(g.LOG_MICRO,"ConnectionManager.setTransportPending",
"connectionSerial =  "+f);"connected"==c?(b.activateTransport(a,e,f),e=!0):e=b.deactivateTransport(a);e&&b.notifyState({state:c,error:h})}},h=["connected","disconnected","closed","failed"],e=0;e<h.length;e++){var f=h[e];a.on(f,c(f))}this.emit("transport.pending",a)}};b.prototype.activateTransport=function(a,b,c){g.logAction(g.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+a+"; connectionId = "+b+"; connectionSerial = "+c);if(this.state!=k.closed){var h=this.transport;h&&(this.transport=
null,h.close(!1));if(h=this.pendingTransport)this.pendingTransport=null;this.transport=a;this.host=a.params.host;b&&this.connectionId!=b&&(this.realtime.connection.id=this.connectionId=b,this.connectionSerial=void 0===c?-1:c,f&&!0===this.options.recover&&this.persistConnection(),this.msgSerial=0);var e=this;a.on("ack",function(a,b){g.logAction(g.LOG_MICRO,"ConnectionManager on(ack)","serial = "+a+"; count = "+b);e.ackMessage(a,b)});a.on("nack",function(a,b,c){g.logAction(g.LOG_ERROR,"ConnectionManager on(nack)",
"serial = "+a+"; count = "+b+"; err = "+c);c||(c=Error("Unknown error"),c.statusCode=500,c.code=50001,c.message="Unable to send message; channel not responding");e.ackMessage(a,b,c)});this.emit("transport.active",a,b,a.params)}};b.prototype.deactivateTransport=function(a){var b=this.transport===a,c=null===this.transport&&this.pendingTransport===a;g.logAction(g.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+a);a.off("ack");a.off("nack");b?this.transport=this.host=null:c&&(this.pendingTransport=
null);this.emit("transport.inactive",a);return b||c};b.prototype.persistConnection=function(){f&&this.connectionId&&void 0!==this.connectionSerial&&(f("ably-connection-id",this.connectionId,r.connectionPersistTimeout),f("ably-connection-serial",this.connectionSerial,r.connectionPersistTimeout))};b.prototype.getStateError=function(){return D[this.state.state]};b.activeState=function(a){return a.queueEvents||a.sendEvents};b.prototype.enactStateChange=function(a){g.logAction(g.LOG_MINOR,"ConnectionManager.enactStateChange",
"setting new state: "+a.current+"; reason = "+(a.reason&&a.reason.message));this.state=k[a.current];this.state.terminal&&(this.error=a.reason);this.emit("connectionstate",a,this.transport)};b.prototype.startConnectTimer=function(){var a=this;this.connectTimer=setTimeout(function(){a.connectTimer&&(g.logAction(g.LOG_MINOR,"ConnectionManager connect timer expired","requesting new state: "+k.connecting.failState),a.notifyState({state:k.connecting.failState}))},r.connectTimeout)};b.prototype.cancelConnectTimer=
function(){this.connectTimer&&(clearTimeout(this.connectTimer),this.connectTimer=void 0)};b.prototype.startSuspendTimer=function(){var a=this;this.suspendTimer||(this.suspendTimer=setTimeout(function(){a.suspendTimer&&(g.logAction(g.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),k.connecting.failState="suspended",k.connecting.queueEvents=!1,a.notifyState({state:"suspended"}))},r.suspendedTimeout))};b.prototype.cancelSuspendTimer=function(){k.connecting.failState=
"disconnected";k.connecting.queueEvents=!0;this.suspendTimer&&(clearTimeout(this.suspendTimer),delete this.suspendTimer)};b.prototype.startRetryTimer=function(a){var b=this;this.retryTimer=setTimeout(function(){g.logAction(g.LOG_MINOR,"ConnectionManager retry timer expired","retrying");b.requestState({state:"connecting"})},a)};b.prototype.cancelRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),delete this.retryTimer)};b.prototype.notifyState=function(a){if(!this.state.terminal&&
a.state!=this.state.state){g.logAction(g.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+a.state);var b=k[a.state];!b.sendEvents&&this.transport&&(g.logAction(g.LOG_MINOR,"ConnectionManager.notifyState()","deleting transport "+this.transport),this.transport.dispose(),delete this.transport);this.cancelConnectTimer();this.cancelRetryTimer();"connected"==a.state&&this.cancelSuspendTimer();a=new U(this.state.state,b.state,b.retryDelay,a.error||D[b.state]);b.retryDelay&&this.startRetryTimer(b.retryDelay);
this.enactStateChange(a);this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents?this.queuePendingMessages():this.realtime.channels.setSuspended(a.reason)}};b.prototype.requestState=function(a){this.cancelConnectTimer();this.cancelRetryTimer();if(a.state!=this.state.state){if(this.state.terminal)throw Error(this.error.message);if("connecting"==a.state){if("connected"==this.state.state)return;this.connectImpl()}else this.pendingTransport&&(this.pendingTransport.close(!0),this.pendingTransport=
null),"failed"==a.state?this.transport&&(this.transport.abort(a.reason),this.transport=null):(a.state="closed",this.cancelConnectTimer(),this.cancelRetryTimer(),this.cancelSuspendTimer(),this.transport&&(this.transport.close(!0),this.transport=null));if(a.state!=this.state.state){var b=k[a.state];a=new U(this.state.state,b.state,b.retryIn,a.error||D[b.state]);this.enactStateChange(a)}}};b.prototype.connectImpl=function(){g.logAction(g.LOG_MINOR,"ConnectionManager.connectImpl()","starting connection");
this.startSuspendTimer();this.startConnectTimer();var a=this,b=this.realtime.auth,c=function(h){g.logAction(g.LOG_ERROR,"ConnectionManager.connectImpl()",h);401==h.statusCode&&-1!=h.message.indexOf("expire")&&"token"==b.method&&b.getToken(!0,function(b){b?c(b):a.connectImpl()});a.notifyState({state:k.connecting.failState,error:h})},h=function(){a.chooseTransport(function(a,b){a&&c(a)})};"basic"==b.method?h():b.authorise(null,null,function(a){a?c(a):h()})};b.prototype.send=function(a,b,h){h=h||d;var e=
this.state;e.sendEvents?(g.logAction(g.LOG_MICRO,"ConnectionManager.send()","sending event"),this.sendImpl(new c(a,h))):e.queueEvents&&(b?this.queue(a,h):(g.logAction(g.LOG_MICRO,"ConnectionManager.send()","rejecting event"),h(this.error)))};b.prototype.sendImpl=function(a){var b=a.msg;a.ackRequired&&(b.msgSerial=this.msgSerial++,this.pendingMessages.push(a));try{this.transport.send(b,function(a){})}catch(c){g.logAction(g.LOG_ERROR,"ConnectionManager.sendQueuedMessages()","Unexpected exception in transport.send(): "+
c)}};b.prototype.ackMessage=function(a,b,c){g.logAction(g.LOG_MICRO,"ConnectionManager.ackMessage()","serial = "+a+"; count = "+b);c=c||null;var h=this.pendingMessages,e=h[0];if(e&&(e=e.msg.msgSerial,a+=b,a>e))for(h=h.splice(0,a-e),a=0;a<h.length;a++)h[a].callback(c)};b.prototype.queue=function(a,b){g.logAction(g.LOG_MICRO,"ConnectionManager.queue()","queueing event");var h=this.queuedMessages[this.queuedMessages.length-1];h&&$.mergeTo(h.msg,a)?(h.merged||(h.callback=T([h.callback]),h.merged=!0),
h.callback.push(b)):this.queuedMessages.push(new c(a,b))};b.prototype.sendQueuedMessages=function(){g.logAction(g.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.length+" queued messages");for(var a;a=this.queuedMessages.shift();)this.sendImpl(a)};b.prototype.queuePendingMessages=function(){g.logAction(g.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+this.pendingMessages.length+" pending messages");this.queuedMessages=this.pendingMessages.concat(this.queuedMessages);
this.pendingMessages=[]};b.prototype.onChannelMessage=function(a,b){if(b===this.transport){var c=a.connectionSerial;void 0!==c&&(this.connectionSerial=c)}this.realtime.channels.onChannelMessage(a)};return b}(),z=function(){function a(a,b,c){t.call(this);this.connectionManager=a;this.auth=b;this.params=c;this.isConnected=!1}var c="object"==typeof window?v:require("../nodejs/lib/protocol/clientmessage_types"),b=c.TAction,e=new c.TProtocolMessage({action:b.CLOSE});m.inherits(a,t);a.prototype.connect=
function(){};a.prototype.close=function(a){this.isConnected&&(this.isConnected=!1,this.sendClose(a));this.emit("closed",D.closed);this.dispose()};a.prototype.abort=function(a){this.isConnected&&(this.isConnected=!1,this.sendClose(!0));this.emit("failed",a);this.dispose()};a.prototype.onChannelMessage=function(a){switch(a.action){case b.HEARTBEAT:g.logAction(g.LOG_MICRO,"Transport.onChannelMessage()","heartbeat; connectionId = "+this.connectionManager.connectionId);this.emit("heartbeat");break;case b.CONNECTED:this.onConnect(a);
this.emit("connected",null,a.connectionId,a.connectionSerial);break;case b.CLOSED:case b.DISCONNECTED:this.isConnected=!1;this.onDisconnect();break;case b.ACK:this.emit("ack",a.msgSerial,a.count);break;case b.NACK:this.emit("nack",a.msgSerial,a.count,a.error);break;case b.ERROR:var c=a.error;g.logAction(g.LOG_ERROR,"Transport.onChannelMessage()","error; connectionId = "+this.connectionManager.connectionId+"; err = "+JSON.stringify(c));if(!a.channel){this.abort({statusCode:c.statusCode,code:c.code,
message:c.message});break}default:this.connectionManager.onChannelMessage(a,this)}};a.prototype.onConnect=function(a){this.connectionId=a.connectionId=a.connectionId.split("-").pop();this.isConnected=!0};a.prototype.onDisconnect=function(){};a.prototype.onClose=function(a,b){if("closed"!=this.connectionManager.state.state){var c=a?"disconnected":"failed";this.isConnected=!1;var e=m.copy(D[c]);b&&(e.message=b);this.emit(c,e)}};a.prototype.sendClose=function(a){a&&this.send(e)};a.prototype.dispose=
function(){this.off()};return a}();(function(){function a(a,b,c){c.binary=c.binary&&e;z.call(this,a,b,c);this.wsHost=r.getHost(c.options,c.host,!0)}var c="object"==typeof window;c||require("../nodejs/lib/protocol/clientmessage_types");var b=c?window.WebSocket||window.MozWebSocket:require("ws"),e=c?!1:!!w;m.inherits(a,z);a.isAvailable=function(){return!!b};a.isAvailable()&&(y.transports.web_socket=a);a.tryConnect=function(b,c,e,d){var q=new a(b,c,e),p=function(a){d(a)};q.on("wserror",p);q.on("wsopen",
function(){g.logAction(g.LOG_MINOR,"WebSocketTransport.tryConnect()","viable transport "+q);q.off("wserror",p);d(null,q)});q.connect()};a.prototype.createWebSocket=function(a,c){var e=0;if(c)for(var d in c)a+=(e++?"&":"?")+d+"="+c[d];this.uri=a;return new b(a)};a.prototype.toString=function(){return"WebSocketTransport; uri="+this.uri};a.prototype.connect=function(){g.logAction(g.LOG_MINOR,"WebSocketTransport.connect()","starting");z.prototype.connect.call(this);var a=this,b=this.params,c=b.options,
e=(c.tls?"wss://":"ws://")+this.wsHost+":"+r.getPort(c)+"/";g.logAction(g.LOG_MINOR,"WebSocketTransport.connect()","uri: "+e);this.auth.getAuthParams(function(c,d){var l="",A;for(A in d)l+=" "+A+": "+d[A]+";";g.logAction(g.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+l);if(c)a.abort(c);else{l=b.getConnectParams(d);try{var B=a.wsConnection=a.createWebSocket(e,l);B.binaryType="arraybuffer";B.onopen=function(){a.onWsOpen()};B.onclose=function(b,c){a.onWsClose(b,c)};B.onmessage=function(b){a.onWsData(b.data,
"string"!=typeof b.data)};B.onerror=function(b){a.onWsError(b)}}catch(m){a.onWsError(m)}}})};a.prototype.send=function(a){this.wsConnection.send(Serialize.TProtocolMessage.encode(a,this.params.binary))};a.prototype.onWsData=function(a,b){g.logAction(g.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+a.length+"; type = "+typeof a+"; binary = "+b);try{this.onChannelMessage(Serialize.TProtocolMessage.decode(a,b))}catch(c){g.logAction(g.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+
c.stack)}};a.prototype.onWsOpen=function(){g.logAction(g.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket");this.emit("wsopen")};a.prototype.onWsClose=function(a,b){var c,e,d;"object"==typeof a?(c=a.wasClean,e=a.code,d=a.reason):(e=a,d=b||"",c=1E3==e);g.logAction(g.LOG_MINOR,"WebSocketTransport.onWsClose()","closed WebSocket; wasClean = "+c+"; code = "+e);delete this.wsConnection;z.prototype.onClose.call(this,c,d)};a.prototype.onWsError=function(a){g.logAction(g.LOG_ERROR,"WebSocketTransport.onError()",
"Unexpected error from WebSocket: "+a);this.emit("wserror",a);this.abort()};a.prototype.dispose=function(){this.wsConnection&&(this.wsConnection.close(),delete this.wsConnection)};return a})();var N=function(){function a(a,b,e){z.call(this,a,b,e);this.stream="stream"in e?e.stream:!0;this.binary=e.binary=!1;this.pendingItems=this.pendingCallback=this.recvRequest=this.sendRequest=null}m.inherits(a,z);a.REQ_SEND=0;a.REQ_RECV=1;a.REQ_RECV_POLL=2;a.REQ_RECV_STREAM=3;a.prototype.connect=function(){g.logAction(g.LOG_MINOR,
"CometTransport.connect()","starting");z.prototype.connect.call(this);var a=this,b=this.params,e=b.options,b=r.getHost(e,b.host),d=r.getPort(e);this.baseUri=(e.tls?"https://":"http://")+b+":"+d+"/comet/";var h=this.baseUri+"connect";g.logAction(g.LOG_MINOR,"CometTransport.connect()","uri: "+h);this.auth.getAuthParams(function(b,e){if(b)a.abort(b);else{a.authParams=e;var d=a.params.getConnectParams(e);g.logAction(g.LOG_MINOR,"CometTransport.connect()","connectParams:"+m.toQueryString(d));var f=!1,
d=a.recvRequest=a.createRequest(h,null,d,null,a.stream?3:1);d.on("data",function(b){f||(f=!0,a.emit("preconnect"));a.onData(b)});d.on("complete",function(b){a.recvRequest=null;b&&a.emit("error",b)});d.exec()}})};a.prototype.sendClose=function(a){var b=this.closeUri,e=this;b?(a=this.createRequest(b(a),null,this.authParams,null,0),a.on("complete",function(a){a&&e.emit("error",a)}),a.exec()):callback({message:"Unable to close; not connected",code:8E4,statusCode:400})};a.prototype.dispose=function(){this.recvRequest&&
(this.recvRequest.abort(),this.recvRequest=null)};a.prototype.onConnect=function(a){var b=a.connectionId;z.prototype.onConnect.call(this,a);var e=this.baseUri+b;g.logAction(g.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+e+"; connectionId = "+a.connectionId);this.sendUri=e+"/send";this.recvUri=e+"/recv";this.closeUri=function(a){return e+(a?"/close":"/disconnect")};var d=this;m.nextTick(function(){d.recv()})};a.prototype.send=function(a,b){if(this.sendRequest)this.pendingItems=this.pendingItems||
[],this.pendingItems.push(a),this.pendingCallback=this.pendingCallback||T(),this.pendingCallback.push(b);else{var e=this.pendingItems||[];e.push(a);this.pendingItems=null;var d=this.pendingCallback;d&&(d.push(b),b=d,this.pendingCallback=null);this.sendItems(e,b)}};a.prototype.sendItems=function(a,b){var e=this,d=this.sendRequest=e.createRequest(e.sendUri,null,e.authParams,this.encodeRequest(a),0);d.on("complete",function(a,c){a&&g.logAction(g.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+
a);e.sendRequest=null;if(c)e.onData(c);var d=e.pendingItems;if(d){e.pendingItems=null;var f=e.pendingCallback;e.pendingCallback=null;m.nextTick(function(){e.sendItems(d,f)})}b(a)});d.exec()};a.prototype.recv=function(){if(!this.recvRequest&&this.isConnected){var a=this,b=this.recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,a.stream?3:2);b.on("data",function(b){a.onData(b)});b.on("complete",function(b){a.recvRequest=null;b?a.emit("error",b):m.nextTick(function(){a.recv()})});
b.exec()}};a.prototype.onData=function(a){try{var b=this.decodeResponse(a);if(b&&b.length)for(a=0;a<b.length;a++)this.onChannelMessage(b[a])}catch(e){g.logAction(g.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+e.stack)}};a.prototype.encodeRequest=function(a){return Serialize.TMessageBundle.encode(a,this.binary)};a.prototype.decodeResponse=function(a){return Serialize.TMessageBundle.decode(a,this.binary)};return a}();this.Data=function(){function a(){}var c="object"==
typeof v?v:require("../nodejs/lib/protocol/clientmessage_types"),b="object"===typeof window,e={"[object Null]":function(a,b){a.type=c.TType.NONE;return!0},"[object Buffer]":function(a,b){a.type=c.TType.BUFFER;a.binaryData=b;return!0},"[object ArrayBuffer]":function(a,b){a.type=c.TType.BUFFER;a.binaryData=b;return!0},"[object Array]":function(a,b){a.type=c.TType.JSONARRAY;a.stringData=JSON.stringify(b);return!0},"[object String]":function(a,b){a.type=c.TType.STRING;a.stringData=b.valueOf();return!0},
"[object Number]":function(a,b){a.type=c.TType.DOUBLE;a.doubleData=b.valueOf();return!0},"[object Boolean]":function(a,b){a.type=b.valueOf()?c.TType.TRUE:c.TType.FALSE;return!0},"[object Object]":function(a,e){!b&&w.isBuffer(e)?(a.type=c.TType.BUFFER,a.binaryData=e):(a.type=c.TType.JSONOBJECT,a.stringData=JSON.stringify(e));return!0},"[object Function]":function(a,b){a.type=c.TType.JSONOBJECT;a.stringData=JSON.stringify(b);return!0}},d={undefined:function(a,b){a.type=c.TType.NONE;return!0},"boolean":function(a,
b){a.type=b?c.TType.TRUE:c.TType.FALSE;return!0},string:function(a,b){a.type=c.TType.STRING;a.stringData=b;return!0},number:function(a,b){a.type=c.TType.DOUBLE;a.doubleData=b;return!0},object:function(a,b){var c=e[Object.prototype.toString.call(b)];return c&&c(a,b)}};a.isCipherData=function(a){return a.cipherData};a.fromTData=function(a){var b=void 0;if(a){if(a.cipherData)return new C.CipherData(a.cipherData,a.type);switch(a.type){case 1:b=!0;break;case 2:b=!1;break;case 3:b=a.i32Data;break;case 4:b=
a.i64Data;break;case 5:b=a.doubleData;break;case 6:b=a.stringData;break;case 7:b=a.binaryData;break;case 8:case 9:b=JSON.parse(a.stringData)}}return b};a.toTData=function(a){var b=new c.TData,e=d[typeof a];if(e&&e(b,a))return b;throw Error("Unsupported data type: "+Object.prototype.toString.call(a));};return a}();var O=function(){function a(a,c,d,h){this.channelSerial=a;this.timestamp=c;this.name=d;this.data=h}var c=("object"==typeof v?v:require("../nodejs/lib/protocol/clientmessage_types")).TData;
a.encrypt=function(a,e){var d=new c,h=a.data;d.cipherData=e.encrypt(C.Data.asPlaintext(h));d.type=h.type;a.data=d};a.decrypt=function(a,c){var d=a.data;d.cipherData&&(a.data=C.Data.fromPlaintext(c.decrypt(d.cipherData),d.type))};return a}(),aa=function(){return function(a,c,b){this.clientId=a;this.clientData=c;this.memberId=b}}();this.Serialize=function(){function a(){}var c="object"==typeof v?v:require("../nodejs/lib/protocol/clientmessage_types"),b=a.TData={},e=a.TMessage={},d=a.TPresence={},h=
a.TProtocolMessage={},g=a.TMessageArray={},k=a.TMessageBundle={},q=c.TType.BUFFER;c.TError.prototype.toString=function(){var a="["+this.constructor.name;this.message&&(a+=": "+this.message);this.statusCode&&(a+="; statusCode="+this.statusCode);this.code&&(a+="; code="+this.code);return a+"]"};c.TMessage.prototype.toJSON=function(){var a=this.data,b={name:this.name,clientId:this.clientId,timestamp:this.timestamp,tags:this.tags},c;(c=Data.isCipherData(a))?(b.encoding="cipher+base64",c=C.Data.asBase64(c),
b.type=a.type):(c=Data.fromTData(a),a.type==q&&(b.encoding="base64",c=c.toString("base64")));b.data=c;return b};c.TPresence.prototype.toJSON=function(){var a=this.clientData,b={name:this.name,clientId:this.clientId,memberId:this.memberId,timestamp:this.timestamp,state:this.state,tags:this.tags},c=Data.fromTData(a);a&&a.type==q&&(b.encoding="base64",c=c.toString("base64"));b.clientData=c;return b};b.fromREST=function(a,b){var e;switch(a.encoding){case "cipher+base64":e=new c.TData;e.type=a.type;e.cipherData=
C.Data.fromBase64(b);break;case "base64":e=new c.TData;e.type=q;e.binaryData=new w(b,"base64");break;default:e=Data.toTData(b)}return e};e.fromJSON=function(a){a.data=b.fromREST(a,a.data);return new c.TMessage(a)};d.fromJSON=function(a){a.clientData=b.fromREST(a,a.clientData);return new c.TPresence(a)};h.fromJSON=function(a){var b;if(b=a.messages)for(var h=b.length,g=a.messages=Array(h),k=0;k<h;k++)g[k]=e.fromJSON(b[k]);if(b=a.presence)for(h=b.length,g=a.presence=Array(h),k=0;k<h;k++)g[k]=d.fromJSON(b[k]);
return new c.TProtocolMessage(a)};h.decode=function(a,b){var e,d;if(b){if(d=ThriftUtil.decodeSync(e=new c.TProtocolMessage,a))throw d;}else e=h.fromJSON(JSON.parse(a));return e};k.decode=function(a,b){var e=null;if(a)if(b){var d;if(e=ThriftUtil.decodeSync(d=new c.TMessageBundle,a))throw e;e=d.items}else{m.isArray(a)||(a=JSON.parse(String(a)));d=a.length;for(var e=Array(d),f=0;f<d;f++)e[f]=h.fromJSON(a[f])}return e};h.encode=function(a,b){return b?ThriftUtil.encodeSync(a):JSON.stringify(a)};k.encode=
function(a,b){return b?ThriftUtil.encodeSync(new c.TMessageBundle({items:a})):JSON.stringify(a)};g.encode=function(a,b){return b?ThriftUtil.encodeSync(new c.TMessageArray({items:a.map(e.fromJSON)})):JSON.stringify(a)};g.decode=function(a,b){var d=null;if(a)if(b){var h;if(d=ThriftUtil.decodeSync(h=new c.TMessageArray,a))throw d;d=h.items}else{m.isArray(a)||(a=JSON.parse(String(a)));h=a.length;for(var d=Array(h),f=0;f<h;f++)d[f]=e.fromJSON(a[f])}return d};return a}();var V=function(){function a(){}
function c(a,b,c,d,g){s.supportsAuthHeaders?a.auth.getAuthHeaders(function(a,e){a?d(a):g(m.mixin(e,b),c)}):a.auth.getAuthParams(function(a,e){a?d(a):g(b,m.mixin(e,c))})}function b(a){return function(b,c){if(b)a(b);else{var d=c.statusCode,g=c.response,q=c.headers;200>d||300<=d?(b=g&&g.error,b||(b=Error(String(c)),b.statusCode=d),a(b)):a(null,g,q)}}}a.get=function(a,d,h,g,k,q){function p(b,k){s.get(a,d,b,k,function(b,d,f){b&&40140==b.code?a.auth.authorise({force:!0},null,function(b){b?q(b):c(a,h,g,
q,p)}):q(b,d,f)})}k&&(q=q&&b(q),(g=g||{}).envelope="true");c(a,h,g,q,p)};a.post=function(a,d,h,g,k,q,p){function x(b,q){s.post(a,d,b,h,q,function(b,d,h){b&&40140==b.code?a.auth.authorise({force:!0},null,function(b){b?p(b):c(a,g,k,p,x)}):p(b,d,h)})}q&&(p=b(p),k.envelope="true");c(a,g,k,p,x)};return a}(),W=function(){function a(a,b,e,d,h,g){this.rest=a;this.path=b;this.headers=e;this.params=d;this.envelope=h;this.bodyHandler=g}a.prototype.get=function(a){var b=this;V.get(this.rest,this.path,this.headers,
this.params,this.envelope,function(e,d,h){if(e)g.logAction(g.LOG_ERROR,"PaginatedResource.get()","Unexpected error getting resource: err = "+JSON.stringify(e));else{var l,k,q;try{l=b.bodyHandler(d)}catch(p){a(p);return}if(h&&(k=h.Link||h.link)){e=k;"string"==typeof e&&(e=e.split(","));d={};for(h=0;h<e.length;h++)(k=e[h].match(/^\s*<(.+)>;\s*rel="(\w+)"$/))&&(q=(q=k[1].match(/^\.\/(\w+)\?(.*)$/))&&m.parseQueryString(q[2]))&&(d[k[2]]=q);q=d}a(null,l,q)}})};return a}(),fa=function(){function a(){}function c(a){if(!a)return"";
"string"==typeof a&&(a=JSON.parse(a));var b={},c=m.keysArray(a,!0);if(!c)return"";c.sort();for(var d=0;d<c.length;d++)b[c[d]]=a[c[d]].sort();return JSON.stringify(b)}function b(a,b){this.rest=a;this.tokenParams={};if(b.keyValue){if(!b.clientId){g.logAction(g.LOG_MINOR,"Auth()","anonymous, using basic auth");this.method="basic";this.basicKey=l(b.key||b.keyId+":"+b.keyValue);this.keyId=b.keyId;this.keyValue=b.keyValue;return}if(!h){var c="client-side token request signing not supported";g.logAction(g.LOG_ERROR,
"Auth()",c);throw Error(c);}}this.method="token";b.authToken&&(this.token={id:b.authToken});if(b.authCallback)g.logAction(g.LOG_MINOR,"Auth()","using token auth with authCallback");else if(b.authUrl)g.logAction(g.LOG_MINOR,"Auth()","using token auth with authUrl");else if(b.keyValue)g.logAction(g.LOG_MINOR,"Auth()","using token auth with client-side signing");else if(this.token)g.logAction(g.LOG_MINOR,"Auth()","using token auth with supplied token only");else throw c="options must include valid authentication parameters",
g.logAction(g.LOG_ERROR,"Auth()",c),Error(c);}var d="object"==typeof window,f=d?null:require("crypto"),h,l=void 0;d?(l=da.encode,window.CryptoJS&&CryptoJS.HmacSHA256&&CryptoJS.enc.Base64&&(h=function(a,b){return CryptoJS.HmacSHA256(a,b).toString(CryptoJS.enc.Base64)})):(l=function(a){return(new w(a,"ascii")).toString("base64")},h=function(a,b){var c=f.createHmac("SHA256",b);c.update(a);return c.digest("base64")});b.prototype.authorise=function(a,b,c){var d=this.token;if(d)if(void 0===d.expires||d.expires>
this.getTimestamp()){if(!a||!a.force){g.logAction(g.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+d.expires);c(null,d);return}}else g.logAction(g.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.token=null;var e=this;this.requestToken(a,b,function(a,b){a?c(a):c(null,e.token=b)})};b.prototype.requestToken=function(b,d,e){"function"!=typeof b||e?"function"!=typeof d||e||(e=d,d=b,b=null):(e=b,b=d=null);b=m.mixin(m.copy(this.rest.options),b);d=d||m.copy(this.tokenParams);e=e||
a;var h,f=this.rest;if(b.authCallback)g.logAction(g.LOG_MINOR,"Auth.requestToken()","using token auth with auth_callback"),h=b.authCallback;else if(b.authUrl)g.logAction(g.LOG_MINOR,"Auth.requestToken()","using token auth with auth_url"),h=function(a,c){var d=m.mixin({accept:"application/json"},b.authHeaders);s.getUri(f,b.authUrl,d||{},m.mixin(a,b.authParams),c)};else if(b.keyValue){var l=this;g.logAction(g.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing");h=function(a,
c){l.createTokenRequest(b,a,c)}}else throw Error("Auth.requestToken(): authOptions must include valid authentication parameters");"capability"in d&&(d.capability=c(d.capability));var f=this.rest,n=function(a,c){var d,e=function(b){return f.baseUri(b)+"/keys/"+a.id+"/requestToken"};s.post?(d=m.defaultPostHeaders(),b.requestHeaders&&m.mixin(d,b.requestHeaders),s.post(f,e,d,a,null,c)):(d=m.defaultGetHeaders(),b.requestHeaders&&m.mixin(d,b.requestHeaders),s.get(f,e,d,a,c))};h(d,function(a,b){a?(g.logAction(g.LOG_ERROR,
"Auth.requestToken()","token request signing call returned error; err = "+a),"code"in a||(a.code=40170),"statusCode"in a||(a.statusCode=401),e(a)):"issued_at"in b?e(null,b):n(b,function(a,b){a?(g.logAction(g.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+a),e(a)):("string"===typeof b&&(b=JSON.parse(b)),g.logAction(g.LOG_MINOR,"Auth.getToken()","token received"),e(null,b.access_token))})})};b.prototype.createTokenRequest=function(a,b,c){a=a||this.rest.options;b=b||
m.copy(this.tokenParams);var d=a.keyId,e=a.keyValue;if(d&&e){var f={id:d},l=b.client_id||"";l&&(f.client_id=l);var n=b.ttl||"";n&&(f.ttl=n);var r=b.capability||"";r&&(f.capability=r);var s=this.rest,ea=this;(function(d){b.timestamp?d():a.queryTime?s.time(function(a,e){a?c(a):(b.timestamp=Math.floor(e/1E3),d())}):(b.timestamp=ea.getTimestamp(),d())})(function(){var a=f.nonce=b.nonce||("000000"+Math.floor(1E16*Math.random())).slice(-16),d=f.timestamp=b.timestamp,a=f.id+"\n"+n+"\n"+r+"\n"+l+"\n"+d+"\n"+
a+"\n";f.mac=b.mac||h(a,e);g.logAction(g.LOG_MINOR,"Auth.getTokenRequest()","generated signed request");c(null,f)})}else c(Error("No key specified"))};b.prototype.getAuthParams=function(a){"basic"==this.method?a(null,{key_id:this.keyId,key_value:this.keyValue}):this.authorise(null,null,function(b,c){b?a(b):a(null,{access_token:c.id})})};b.prototype.getAuthHeaders=function(a){"basic"==this.method?a(null,{authorization:"Basic "+this.basicKey}):this.authorise(null,null,function(b,c){b?a(b):a(null,{authorization:"Bearer "+
l(c.id)})})};b.prototype.getTimestamp=function(){var a=Date.now()+(this.rest.serverTimeOffset||0);return Math.floor(a/1E3)};return b}(),Y=function(){function a(a){if(!a){var b="no options provided";g.logAction(g.LOG_ERROR,"Rest()",b);throw Error(b);}"string"==typeof a&&(a={key:a});this.options=a;"undefined"===typeof this.options.useTextProtocol&&(this.options.useTextProtocol="object"===typeof window?!0:!1);if(a.key){b=a.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!b)throw b="invalid key parameter",g.logAction(g.LOG_ERROR,
"Rest()",b),Error(b);a.keyId=b[1];a.keyValue=b[2]}a.log&&g.setLog(a.log.level,a.log.handler);g.logAction(g.LOG_MINOR,"Rest()","started");this.clientId=a.clientId;"tls"in a||(a.tls=!0);this.serverTimeOffset=null;this.baseUri=this.authority=function(b){return"https://"+b+":"+(a.tlsPort||r.TLS_PORT)};this.auth=new fa(this,a);this.channels=new c(this)}function c(a){this.rest=a;this.attached={}}var b=function(){};a.prototype.stats=function(a,c){void 0===c&&("function"==typeof a?(c=a,a=null):c=b);var d=
m.copy(m.defaultGetHeaders()),g=!s.supportsLinkHeaders;this.options.headers&&m.mixin(d,this.options.headers);(new W(this,"/stats",d,a,g,function(a){return"string"===typeof a?JSON.parse(a):a})).get(c)};a.prototype.time=function(a,c){void 0===c&&("function"==typeof a?(c=a,a=null):c=b);var d=m.copy(m.defaultGetHeaders());this.options.headers&&m.mixin(d,this.options.headers);var g=this;s.get(this,function(a){return g.authority(a)+"/time"},d,a,function(a,b){if(a)c(a);else{"string"===typeof b&&(b=JSON.parse(b));
var d=b[0];d?(g.serverTimeOffset=d-Date.now(),c(null,d)):(a=Error("Internal error (unexpected result type from GET /time)"),a.statusCode=500,c(a))}})};c.prototype.get=function(a){a=String(a);var b=this.attached[a];b||(this.attached[a]=b=new X(this.rest,a));return b};return a}(),F=function(){function a(a){g.logAction(g.LOG_MINOR,"Realtime()","");Y.call(this,a);this.connection=new ga(this,a);this.channels=new c(this);this.connection.connect()}function c(a){this.realtime=a;this.attached={};var c=this;
a.connection.connectionManager.on("transport.active",function(a){c.onTransportActive(a)})}m.inherits(a,Y);a.prototype.close=function(){g.logAction(g.LOG_MINOR,"Realtime.close()","");this.connection.close()};c.prototype.onChannelMessage=function(a){var c=a.channel;if(c){var d=this.attached[c];if(d)d.onMessage(a);else g.logAction(g.LOG_ERROR,"ConnectionManager on(channelmessage)","received event for non-existent channel: "+c)}else g.logAction(g.LOG_ERROR,"ConnectionManager on(channelmessage)","received event unspecified channel: "+
c)};c.prototype.onTransportActive=function(){for(var a in this.attached)this.attached[a].checkPendingState()};c.prototype.setSuspended=function(a){for(var c in this.attached)this.attached[c].setSuspended(a)};c.prototype.get=function(a){a=String(a);var c=this.attached[a];c||(this.attached[a]=c=new $(this.realtime,a,this.realtime.options));return c};return a}(),U=function(){return function(a,c,b,d){this.previous=a;this.current=c;b&&(this.retryIn=b);d&&(this.reason=d)}}(),ga=function(){function a(a,
b){t.call(this);this.ably=a;this.connectionManager=new y(a,b);this.state=this.connectionManager.state.state;this.id=void 0;var d=this;this.connectionManager.on("connectionstate",function(a){var b=d.state=a.current;m.nextTick(function(){d.emit(b,a)})})}m.inherits(a,t);a.prototype.on=function(a,b){t.prototype.on.apply(this,arguments);if(this.state==a&&b)try{b(new U(void 0,a))}catch(d){}};a.prototype.connect=function(){g.logAction(g.LOG_MAJOR,"Connection.connect()","");this.connectionManager.requestState({state:"connecting"})};
a.prototype.close=function(){g.logAction(g.LOG_MAJOR,"Connection.close()","connectionId = "+this.id);this.connectionManager.requestState({state:"closed"})};return a}(),X=function(){function a(){}function c(a,c,d){g.logAction(g.LOG_MINOR,"Channel()","started; name = "+c);t.call(this);this.rest=a;this.name=c;this.basePath="/channels/"+encodeURIComponent(c);this.cipher=null;this.presence=new b(this)}function b(a){this.channel=a;this.basePath=a.basePath+"/presence"}m.inherits(c,t);c.prototype.setOptions=
function(b,c){c=c||a;if(b&&b.encrypted){var d=this;C.getCipher(b,function(a,b){d.cipher=b;c(null)})}else c(null,this.cipher=null)};c.prototype.history=function(b,c){g.logAction(g.LOG_MICRO,"Channel.history()","channel = "+this.name);void 0===c&&("function"==typeof b?(c=b,b=null):c=a);var d=this.rest,l=!s.supportsLinkHeaders,k=!(d.options.useTextProtocol||l),q=m.copy(m.defaultGetHeaders(k)),p=this.cipher;d.options.headers&&m.mixin(q,d.options.headers);(new W(d,this.basePath+"/messages",q,b,l,function(a){a=
Serialize.TMessageArray.decode(a,k);for(var b=0;b<a.length;b++)p&&O.decrypt(a[b],p),a[b].data=Data.fromTData(a[b].data);return a})).get(c)};c.prototype.publish=function(b,c,d){g.logAction(g.LOG_MICRO,"Channel.publish()","channel = "+this.name+"; name = "+b);d=d||a;var l=this.rest,k=!l.options.useTextProtocol;b={name:b,data:c,timestamp:Date.now()};(c=this.cipher)&&O.encrypt(b,c);b=Serialize.TMessageArray.encode([b],k);k=m.copy(m.defaultPostHeaders(k));l.options.headers&&m.mixin(k,l.options.headers);
V.post(l,this.basePath+"/messages",b,k,null,!1,d)};b.prototype.get=function(b,c){g.logAction(g.LOG_MICRO,"Channel.presence.get()","channel = "+this.channel.name);void 0===c&&("function"==typeof b?(c=b,b=null):c=a);var d=this.channel.rest,l=!d.options.useTextProtocol,k=m.copy(m.defaultGetHeaders(l));d.options.headers&&m.mixin(k,d.options.headers);V.get(d,this.basePath,k,b,!1,function(a,b){a?c(a):l?aa.decodeTPresenceArray(b,c):c(null,b)})};b.prototype.history=function(b,c){g.logAction(g.LOG_MICRO,"Channel.presence.history()",
"channel = "+this.channel.name);void 0===c&&("function"==typeof b?(c=b,b=null):c=a);var d=this.channel.rest,l=!s.supportsLinkHeaders,k=!(d.options.useTextProtocol||l),q=m.copy(m.defaultGetHeaders(k));d.options.headers&&m.mixin(q,d.options.headers);(new W(d,this.basePath+"/history",q,b,l,function(a){a=Serialize.TMessageArray.decode(a,k);for(var b=0;b<a.length;b++)a[b].data=Data.fromTData(a[b].data);return a})).get(c)};return c}(),$=function(){function a(a,b,c){g.logAction(g.LOG_MINOR,"RealtimeChannel()",
"started; name = "+b);X.call(this,a,b,c);this.presence=new ha(this,c);this.connectionManager=a.connection.connectionManager;this.options=m.prototypicalClone(f,c);this.state="initialized";this.subscriptions=new t;this.pendingEvents=[]}var c="object"==typeof v?v:require("../nodejs/lib/protocol/clientmessage_types"),b=c.TAction,d=function(){},f={queueEvents:!0};m.inherits(a,X);a.invalidStateError={statusCode:400,code:90001,message:"Channel operation failed (invalid channel state)"};a.channelDetachedErr=
{statusCode:409,code:90006,message:"Channel is detached"};a.prototype.setOptions=function(a,b){b=b||d;if(a&&a.encrypted){var c=this;C.getCipher(a,function(a,d){c.cipher=d;b(null)})}else b(null,this.cipher=null)};a.prototype.publish=function(){var a=arguments.length,b=arguments[0],f=arguments[a-1];"function"!==typeof f&&(f=d,++a);var g=this.connectionManager;if(y.activeState(g.state)){if(2==a){m.isArray(b)||(b=[b]);g=Array(b.length);for(a=0;a<b.length;a++){var p=b[a],n=g[a]=new c.TMessage;n.name=p.name;
n.data=Data.toTData(p.data)}b=g}else p=new c.TMessage,p.name=arguments[0],p.data=Data.toTData(arguments[1]),b=[p];if(g=this.cipher)for(a=0;a<b.length;a++)O.encrypt(b[a],g);this._publish(b,f)}else f(g.getStateError())};a.prototype._publish=function(a,b){g.logAction(g.LOG_MICRO,"RealtimeChannel.publish()","message count = "+a.length);switch(this.state){case "attached":g.logAction(g.LOG_MICRO,"RealtimeChannel.publish()","sending message");var d=new c.TProtocolMessage;d.action=c.TAction.MESSAGE;d.channel=
this.name;d.messages=a;this.sendMessage(d,b);break;default:this.attach();case "attaching":g.logAction(g.LOG_MICRO,"RealtimeChannel.publish()","queueing message"),this.pendingEvents.push({messages:a,callback:b})}};a.prototype.onEvent=function(a){g.logAction(g.LOG_MICRO,"RealtimeChannel.onEvent()","received message");for(var b=this.subscriptions,c=0;c<a.length;c++){var d=a[c];b.emit(d.name,d)}};a.prototype.attach=function(a){a=a||d;var b=this.connectionManager;y.activeState(b.state)?"attached"==this.state?
a():"failed"==this.state?a(b.getStateError()):(this.once(function(c){switch(this.event){case "attached":a();break;case "detached":case "failed":a(c||b.getStateError())}}),this.setPendingState("attaching")):a(b.getStateError())};a.prototype.attachImpl=function(a){g.logAction(g.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message");var b=new c.TProtocolMessage({action:c.TAction.ATTACH,channel:this.name});this.sendMessage(b,a||d)};a.prototype.detach=function(b){b=b||d;var c=this.connectionManager;
y.activeState(c.state)?"detached"==this.state?b():(this.once(function(a){switch(this.event){case "detached":b();break;case "attached":b(D.unknownChannelErr);break;case "failed":b(a||c.getStateError())}}),this.setPendingState("detaching"),this.setSuspended(a.channelDetachedErr,!0)):b(c.getStateError())};a.prototype.detachImpl=function(a){g.logAction(g.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message");var b=new c.TProtocolMessage({action:c.TAction.DETACH,channel:this.name});this.sendMessage(b,
a||d)};a.prototype.subscribe=function(){var a=Array.prototype.slice.call(arguments);1==a.length&&"function"==typeof a[0]&&a.unshift(null);var b=a[0],c=a[1],a=a[2]||(a[2]=d),f=this.subscriptions;if(null!==b&&m.isArray(b))for(var g=0;g<b.length;g++)f.on(b[g],c);else f.on(b,c);this.attach(a)};a.prototype.unsubscribe=function(){var a=Array.prototype.slice.call(arguments);1==a.length&&"function"==typeof a[0]&&a.unshift(null);var b=a[0],a=a[1],c=this.subscriptions;if(null!==b&&m.isArray(b))for(var d=0;d<
b.length;d++)c.off(b[d],a);else c.off(b,a)};a.prototype.sendMessage=function(a,b){this.connectionManager.send(a,this.options.queueEvents,b)};a.prototype.sendPresence=function(a,b){var d=new c.TProtocolMessage({action:c.TAction.PRESENCE,channel:this.name,presence:[a]});this.sendMessage(d,b)};a.prototype.onMessage=function(a){switch(a.action){case b.ATTACHED:this.setAttached(a);break;case b.DETACHED:this.setDetached(a);break;case b.PRESENCE:this.presence.setPresence(a.presence,!0);break;case b.MESSAGE:if(a=
a.messages){for(var c=Array(a.length),d=this.cipher,e=0;e<c.length;e++){var f=a[e];if(d)try{O.decrypt(f,d)}catch(m){var A="Unexpected error decrypting message; err = "+m;g.logAction(g.LOG_ERROR,"RealtimeChannel.onMessage()",A);A=Error(A);this.emit("error",A)}c[e]=new O(f.channelSerial,f.timestamp,f.name,Data.fromTData(f.data))}this.onEvent(c)}break;case b.ERROR:(A=a.error)&&80016==A.code?this.checkPendingState():this.setDetached(a);break;default:g.logAction(g.LOG_ERROR,"RealtimeChannel.onMessage()",
"Fatal protocol error: unrecognised action ("+a.action+")"),this.connectionManager.abort(D.unknownChannelErr)}};a.mergeTo=function(a,c){var d=!1,e;if(a.channel==c.channel&&(e=a.action)==c.action)switch(e){case b.MESSAGE:for(d=0;d<c.messages.length;d++)a.messages.push(c.messages[d]);d=!0;break;case b.PRESENCE:for(d=0;d<c.presence.length;d++)a.presence.push(c.presence[d]);d=!0}return d};a.prototype.setAttached=function(a){g.logAction(g.LOG_MINOR,"RealtimeChannel.setAttached","activating channel; name = "+
this.name);this.clearStateTimer();a.presence&&this.presence.setPresence(a.presence,!1);if("attaching"==this.state){this.state="attached";a=this.pendingEvents;var b=a.length;if(b){this.pendingEvents=[];var d=new c.TProtocolMessage({action:c.TAction.MESSAGE,channel:this.name,messages:[]}),e=T();g.logAction(g.LOG_MICRO,"RealtimeChannel.setAttached","sending "+b+" queued messages");for(var f=0;f<b;f++){var m=a[f];Array.prototype.push.apply(d.messages,m.messages);e.push(m.callback)}this.sendMessage(d,
e)}this.presence.setAttached();this.emit("attached")}};a.prototype.setDetached=function(a){this.clearStateTimer();(a=a.error)?(this.state="failed",a={statusCode:a.statusCode,code:a.code,message:a.message},this.failPendingMessages(a),this.emit("failed",a)):(this.failPendingMessages({statusCode:404,code:90001,message:"Channel detached"}),"detached"!==this.state&&(this.state="detached",this.emit("detached")))};a.prototype.setSuspended=function(a,b){g.logAction(g.LOG_MINOR,"RealtimeChannel.setSuspended",
"deactivating channel; name = "+this.name+", err "+(a?a.message:"none"));this.clearStateTimer();this.failPendingMessages(a);this.presence.setSuspended(a);b||this.emit("detached")};a.prototype.setPendingState=function(a){g.logAction(g.LOG_MINOR,"RealtimeChannel.setPendingState","name = "+this.name+", state = "+a);this.state=a;this.clearStateTimer();if("connected"!=this.connectionManager.state.state)g.logAction(g.LOG_MINOR,"RealtimeChannel.setPendingState","not connected");else{this.checkPendingState();
var b=this;this.stateTimer=setTimeout(function(){g.logAction(g.LOG_MINOR,"RealtimeChannel.setPendingState","timer expired");b.stateTimer=null;b.checkPendingState()},r.sendTimeout)}};a.prototype.checkPendingState=function(){var a=!1;switch(this.state){case "attaching":this.attachImpl();a=!0;break;case "detaching":this.detachImpl(),a=!0}return a};a.prototype.clearStateTimer=function(){var a=this.stateTimer;a&&(clearTimeout(a),this.stateTimer=null)};a.prototype.failPendingMessages=function(a){g.logAction(g.LOG_MINOR,
"RealtimeChannel.failPendingMessages","channel; name = "+this.name+", err = "+a);for(var b=0;b<this.pendingEvents.length;b++)try{this.pendingEvents[b].callback(a)}catch(c){}this.pendingEvents=[]};return a}(),ha=function(){function a(a,b){t.call(this);this.channel=a;this.clientId=b.clientId;this.members={}}var c="object"==typeof v?v:require("../nodejs/lib/protocol/clientmessage_types"),b=c.TPresenceState,d=["enter","leave","update"];m.inherits(a,t);a.prototype.enter=function(a,b){b||"function"!==typeof a||
(b=a,a="");if(!this.clientId)throw Error("clientId must be specified to enter a presence channel");this.enterClient(this.clientId,a,b)};a.prototype.enterClient=function(a,d,e){g.logAction(g.LOG_MICRO,"Presence.enterClient()","entering; channel = "+this.channel.name+", client = "+a);a=new c.TPresence({state:b.ENTER,clientId:a,clientData:Data.toTData(d)});d=this.channel;switch(d.state){case "attached":d.sendPresence(a,e);break;case "initialized":d.attach();case "attaching":this.pendingPresence={presence:a,
callback:e};break;default:a=Error("Unable to enter presence channel (incompatible state)"),a.code=90001,e(a)}};a.prototype.leave=function(a){if(!this.clientId)throw Error("clientId must have been specified to enter or leave a presence channel");this.leaveClient(this.clientId,a)};a.prototype.leaveClient=function(a,d){g.logAction(g.LOG_MICRO,"Presence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+a);var e=new c.TPresence({state:b.LEAVE,clientId:a}),k=this.channel;switch(k.state){case "attached":k.sendPresence(e,
d);break;case "attaching":this.pendingPresence={presence:e,callback:d};break;case "initialized":this.pendingPresence=null;e=Error("Unable to enter presence channel (incompatible state)");e.code=90001;d(e);break;default:this.pendingPresence=null,d(D.failed)}};a.prototype.get=function(a){return a?this.members[a]:m.valuesArray(this.members,!0)};a.prototype.setPresence=function(a,c){g.logAction(g.LOG_MICRO,"Presence.setPresence()","received presence for "+a.length+" participants");for(var l=0;l<a.length;l++){var k=
a[l],m=k.clientId+":"+k.memberId,p=new aa(k.clientId,Data.fromTData(k.clientData),k.memberId);switch(k.state){case b.LEAVE:delete this.members[m];break;case b.UPDATE:k.inheritMemberId&&delete this.members[k.clientId+":"+k.inheritMemberId];case b.ENTER:clientData=this.members[m]=p}c&&this.emit(d[k.state],p)}};a.prototype.setAttached=function(){this.pendingPresence&&(g.logAction(g.LOG_MICRO,"Presence.setAttached","sending queued presence; state = "+this.state),this.channel.sendPresence(this.pendingPresence.presence,
this.pendingPresence.callback),this.pendingPresence=null)};a.prototype.setSuspended=function(a){this.pendingPresence&&(this.pendingPresence.callback(a),this.pendingPresence=null)};return a}();(function(){function a(a,b,c){c.binary=c.stream=!1;N.call(this,a,b,c)}function c(a,b,c,d,e,g){t.call(this);void 0===a&&(a=f++);this.id=a;this.uri=b;this.params=d||{};this.body=e;this.requestMode=g;this.requestComplete=!1}var b=function(){},d=window.Ably._=function(a){return d[a]||b},f=1,h=document.getElementsByTagName("head")[0];
m.inherits(a,N);a.isAvailable=function(){return!0};y.httpTransports.jsonp=y.transports.jsonp=a;var l=null;a.checkConnectivity=function(a){l?l.push(a):(l=[a],q("http://internet-up.ably.io.s3-website-us-east-1.amazonaws.com/is-the-internet-up.js",null,null,null,!1,function(a,b){for(var c=!a&&b,d=0;d<l.length;d++)l[d](null,c);l=null}))};a.tryConnect=function(b,c,d,e){var f=new a(b,c,d),h=function(a){e(a)};f.on("error",h);f.on("preconnect",function(){g.logAction(g.LOG_MINOR,"JSONPTransport.tryConnect()",
"viable transport "+f);f.off("error",h);e(null,f)});f.connect()};a.prototype.toString=function(){return"JSONPTransport; uri="+this.baseUri+"; isConnected="+this.isConnected};var k=a.prototype.createRequest=function(a,b,d,e,f){return new c(void 0,a,b,d,e,f)};m.inherits(c,t);c.prototype.exec=function(){var a=this.id,b=this.body,c=this.uri,f=this.params,g=this;f.callback="Ably._("+a+")";b?f.body=encodeURIComponent(b):delete f.body;b=this.script=document.createElement("script");b.src=c+m.toQueryString(f);
b.async=!0;b.type="text/javascript";b.charset="UTF-8";b.onerror=function(a){a.code=8E4;g.complete(a)};d[a]=function(a){g.complete(null,a)};this.timer=setTimeout(function(){g.abort()},this.requestMode==N.REQ_SEND?r.sendTimeout:r.recvTimeout);h.insertBefore(b,h.firstChild)};c.prototype.complete=function(a,b){this.requestComplete||(this.requestComplete=!0,b&&this.emit("data",b),this.emit("complete",a,b),this.dispose())};c.prototype.abort=function(){this.dispose()};c.prototype.dispose=function(){var a=
this.timer;a&&(clearTimeout(a),this.timer=null);a=this.script;a.parentNode&&a.parentNode.removeChild(a);delete d[this.id]};var q=s.Request=function(a,b,c,d,e,f){a=k(a,b,c,d,N.REQ_SEND);a.once("complete",f);a.exec();return a};return a})();var ba=function(){function a(){for(var a in k)k[a].dispose()}function c(){return window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest?n=!0:q&&document.domain&&"https:"==window.location.protocol?!0:!1}function b(a){var b={};a.getResponseHeader&&(a=a.getResponseHeader("Content-Type"))&&
(b["Content-Type"]=a);return b}function d(a,b,c,e,f){t.call(this);c=c||{};c.rnd=String(Math.random()).substr(2);this.uri=a+m.toQueryString(c);this.headers=b||{};this.body=e;this.requestMode=f;this.requestComplete=!1;k[this.id=String(++l)]=this}function f(a,b,c,f,g){c.ua="xdr";d.call(this,a,b,c,f,g)}var h=function(){},l=0,k={},q=window.XDomainRequest,n;m.inherits(d,t);d.isAvailable=c;var x=d.createRequest=function(a,b,c,g,h){return n?new d(a,b,c,g,h):new f(a,b,c,g,h)};d.prototype.complete=function(a,
c){if(!this.requestComplete){this.requestComplete=!0;var d=this.xhr;c&&this.emit("data",c);this.emit("complete",a,c,d&&b(d));this.dispose()}};d.prototype.abort=function(){this.dispose()};d.prototype.exec=function(){function a(){p=g.responseText;for(var b=p.length-1,c,d;P<b&&-1<(c=p.indexOf("\n",P));){d=p.slice(P,c);P=c+1;a:{try{d=JSON.parse(d)}catch(e){err=Error("Malformed response body from server: "+e.message);err.statusCode=400;h.complete(err);break a}h.emit("data",d)}}}function b(){a();h.streamComplete=
!0;m.nextTick(function(){h.complete()})}var c=this.timer=setTimeout(function(){g.abort()},0==this.requestMode?r.sendTimeout:r.recvTimeout),d=this.body,e=d?"POST":"GET",f=this.headers,g=this.xhr=new XMLHttpRequest,h=this;f.accept=f.accept||"application/json";d&&("object"==typeof d&&(d=JSON.stringify(d)),f["content-type"]=f["content-type"]||"application/json");g.open(e,this.uri,!0);g.withCredentials="true";for(var k in f)g.setRequestHeader(k,f[k]);var l=g.onerror=function(a){a.code=8E4;h.complete(a)};
g.onabort=function(){var a=Error("Request cancelled");a.statusCode=400;l(a)};g.ontimeout=function(){var a=Error("Request timed out");a.statusCode=408;l(a)};var q,n,p,s,P=0;g.onreadystatechange=function(){var d=g.readyState;if(!(3>d)&&0!==g.status)if(void 0===n&&(n=g.status,1223===n&&(n=204),clearTimeout(c),s=400>n,204==n?h.complete():q=3==h.requestMode&&s),3==d&&q)a();else if(4==d)if(q)b();else a:{try{p=g.responseText;if(!p||!p.length){204!=status&&(f=Error("Incomplete response body from server"),
f.statusCode=400,h.complete(f));break a}p=JSON.parse(String(p))}catch(e){var f=Error("Malformed response body from server: "+e.message);f.statusCode=400;h.complete(f);break a}s?h.complete(null,p):(f=p.error,f||(f=Error("Error response received from server: "+n),f.statusCode=n),h.complete(f))}};g.send(d)};d.prototype.dispose=function(){var a=this.xhr;if(a){a.onreadystatechange=a.onerror=a.onabort=a.ontimeout=h;this.xhr=null;var b=this.timer;b&&(clearTimeout(b),this.timer=null);this.requestComplete||
a.abort()}delete k[this.id]};m.inherits(f,d);f.prototype.exec=function(){function a(){clearTimeout(d);if(p=h.responseText){var b=p.length-1;if("\n"==p[b]||(b=-1<p.indexOf("\n"))){var c=p.slice(0,b);try{var c=JSON.parse(c),e=c.error;if(e)q=e.statusCode||500,k.complete(e);else if(q=p?201:200,n=3==k.requestMode)s=b,m.isEmpty(c)||k.emit("data",c)}catch(f){e=Error("Malformed response body from server: "+f.message),e.statusCode=400,k.complete(e)}}}}function b(){p=h.responseText;for(var a=p.length-1,c,d;s<
a&&-1<(c=p.indexOf("\n",s));){d=p.slice(s,c);s=c+1;a:{try{d=JSON.parse(d)}catch(e){err=Error("Malformed response body from server: "+e.message);err.statusCode=400;k.complete(err);break a}k.emit("data",d)}}}function c(){b();k.streamComplete=!0;m.nextTick(function(){k.complete()})}var d=this.timer=setTimeout(function(){h.abort()},0==this.requestMode?r.sendTimeout:r.recvTimeout),e=this.body,f=e?"POST":"GET",h=this.xhr=new XDomainRequest,k=this;e&&"object"==typeof e&&(e=JSON.stringify(e));var l=h.onerror=
function(){g.logAction(g.LOG_ERROR,"Request.onerror()","");var a=Error("Error response");a.statusCode=400;a.code=8E4;k.complete(a)};h.onabort=function(){g.logAction(g.LOG_ERROR,"Request.onabort()","");var a=Error("Request cancelled");a.statusCode=400;l(a)};h.ontimeout=function(){g.logAction(g.LOG_ERROR,"Request.timeout()","");var a=Error("Request timed out");a.statusCode=408;l(a)};var n,q,p,s=0;h.onprogress=function(){void 0===q?a():n&&b()};h.onload=function(){if(void 0===q&&(a(),k.requestComplete))return;
if(n)c();else a:{try{p=h.responseText;if(!p||!p.length){204!=status&&(d=Error("Incomplete response body from server"),d.statusCode=400,k.complete(d));break a}p=JSON.parse(String(p))}catch(b){var d=Error("Malformed response body from server: "+b.message);d.statusCode=400;k.complete(d);break a}k.complete(null,p)}};try{h.open(f,this.uri),h.send(e)}catch(x){g.logAction(g.LOG_ERROR,"Request.onStreamEnd()","Unexpected send exception; err = "+x),l(x)}};f.prototype.dispose=function(){var a=this.xhr;if(a){a.onprogress=
a.onload=a.onerror=a.onabort=a.ontimeout=h;this.xhr=null;var b=this.timer;b&&(clearTimeout(b),this.timer=null);this.requestComplete||a.abort()}delete k[this.id]};if(c=d.isAvailable())M.addUnloadListener(a),"undefined"!==typeof s&&(s.supportsAuthHeaders=n,s.Request=function(a,b,c,d,e,f){a=x(a,b,c,d,0);a.once("complete",f);a.exec();return a});return d}();(function(){function a(a,b,d){d.binary=!1;N.call(this,a,b,d)}m.inherits(a,N);a.isAvailable=ba.isAvailable;a.checkConnectivity=function(a){s.request("http://internet-up.ably.io.s3-website-us-east-1.amazonaws.com/is-the-internet-up.txt",
null,null,null,!1,function(b,d){a(null,!b&&"yes"==d)})};a.tryConnect=function(c,b,d,f){var h=new a(c,b,d),l=function(a){f(a)};h.on("error",l);h.on("preconnect",function(){g.logAction(g.LOG_MINOR,"XHRTransport.tryConnect()","viable transport "+h);h.off("error",l);f(null,h)});h.connect()};a.prototype.toString=function(){return"XHRTransport; uri="+this.baseUri+"; isConnected="+this.isConnected};a.prototype.createRequest=ba.createRequest;"undefined"!==typeof y&&a.isAvailable()&&(y.httpTransports.xhr=
y.transports.xhr=a);return a})();(function(){function a(a,c,d){d.binary=!1;z.call(this,a,c,d);this.destOrigin=this.destWindow=this.wrapWindow=this.wrapIframe=null}var c=location.origin||location.protocol+"//"+location.hostname+(location.port?":"+location.port:"");m.inherits(a,z);a.isAvailable=function(){return void 0!==window.postMessage};a.isAvailable()&&(y.httpTransports.iframe=y.transports.iframe=a);a.tryConnect=function(b,c,d,h){var l=new a(b,c,d);l.on("iferror",h);l.on("ifopen",function(){g.logAction(g.LOG_MINOR,
"IframeTransport.tryConnect()","viable transport "+l);l.off("iferror",h);h(null,l)});l.connect()};a.prototype.toString=function(){return"IframeTransport; uri="+this.uri};a.prototype.connect=function(){g.logAction(g.LOG_MINOR,"IframeTransport.connect()","starting");z.prototype.connect.call(this);var a=this;this.auth.getAuthParams(function(d,f){if(d)a.abort(d);else{var g=a.params.getConnectParams(f);g.origin=c;a.createIframe(g,function(c){c?a.emit("iferror",c):a.emit("ifopen")})}})};a.prototype.send=
function(a){var c=this.destWindow;c&&c.postMessage(JSON.stringify(a),this.destOrigin)};a.prototype.createIframe=function(a,c){function d(){n.dispose()}function h(a){n.onData(a.data)}var l=this.wrapIframe=document.createElement("iframe"),k=this.params.options,k=(this.destOrigin="https://"+r.getHost(k)+":"+r.getPort(k,!0))+"/static/iframe.html"+m.toQueryString(a),q=!1,p=null,n=this;g.logAction(g.LOG_MINOR,"IframeTransport.createIframe()","destUri: "+k);M.addUnloadListener(d);l.style.display="none";
l.style.position="absolute";l.onerror=function(a){d();q||(q=!0,a=a||Error("Unknown error loading iframe"),c(a))};M.addListener(l,"load",n.onloadListener=function(){n.destWindow=p.destWindow;M.addMessageListener(p,n.messageListener=h);q=!0;c(null,l)});document.body.appendChild(l);var p=n.wrapWindow=l.contentWindow,s=p.document;s.open();s.write('<!DOCTYPE html>\n<html>\n  <head>\n    <script type="text/javascript">\n    var destWindow;\n    function onIframeLoaded() {\n      destWindow = document.getElementById("dest").contentWindow;\n    }\n    \x3c/script>\n  </head>\n  <body>\n    <iframe id="dest" src="'+
k+'" onload="onIframeLoaded();">\n    </iframe>\n  </body>\n</html>\n');s.close()};a.prototype.onData=function(a){g.logAction(g.LOG_MICRO,"IframeTransport.onData()","length = "+a.length);try{var c=Serialize.TMessageBundle.decode(a,!1);if(c&&c.length)for(a=0;a<c.length;a++)this.onChannelMessage(c[a])}catch(d){g.logAction(g.LOG_ERROR,"IframeTransport.onData()","Unexpected exception handing channel event: "+d)}};a.prototype.dispose=function(){g.logAction(g.LOG_MICRO,"IframeTransport.dispose()","");var a=
this.messageListener;a&&(M.removeMessageListener(this.wrapWindow,a),this.messageListener=null);var c=this.wrapIframe;c&&((a=this.onloadListener)&&M.removeListener(c,"load",a),this.wrapIframe=c.onerror=null,setTimeout(function(){c.parentNode.removeChild(c)},0))};return a})();window.Ably.Realtime=F;F.ConnectionManager=y;F.Crypto=C;Y.Crypto=C})();
