(function(){function m(c){for(var d="",a=0;a<c;a++)d+="abcdef0123456789".charAt(Math.floor(16*Math.random()));return d}function r(c){var d=p[c];d||(d=b.ably.channels.get(c),b.ablyCipherParams&&d.setOptions({encrypted:!0,cipherParams:b.ablyCipherParams}),p[c]=d);return d}function y(c,d){delete b.ablyCipherParamsPending;if(c)return h("Unable to set up encryption parameters for secure messaging");b.ablyCipherParams=d;for(var a in p)p[a].setOptions({encrypted:!0,cipherParams:b.ablyCipherParams});for(a=
0;a<q.length;a++){var e=q[a];b.publish({channel:e.channel,callback:e.callback,error:e.error,message:e.message})}q=[]}function s(c,d){for(var a in n){var b=n[a];"connect"==c?b.hasConnectedOnce?b.reconnect&&b.reconnect(a):(b.connect&&b.connect(a),b.hasConnectedOnce=!0):b[c]&&b[c](a)}}var g="undefined"===typeof document?null:document.getElementById("pubnub"),u,v,w;g&&g.getAttribute("publish_key");g&&g.getAttribute("subscribe_key");u=g&&g.getAttribute("origin")||"";v=g&&g.getAttribute("uuid")||"";w=g&&
"on"==g.getAttribute("ssl");var p={},n={},q=[],b={},k=function(){},h=window.console&&function(c){console.log(c)}||k;b.Ably="undefined"!==typeof window?window.Ably:"undefined"!==typeof Ably?Ably:require("../..");b.secure=function(c,d){return c.cipher_key?b.init(c,d):h("Missing cipher_key")};b.init=function(c,d){var a=c.ably_key,e=c.ssl||w,f=c.origin||u,l=c.tlsorigin||"",t=c.uuid||v;if(!a)return h("Missing ably_key");a={key:a,tls:e};t&&0!=t.length&&(a.clientId=t);f&&0!=f.length&&(f=f.split(":"),a.host=
a.wsHost=f[0],1<f.length&&(a.port=f[1]));l&&0!=l.length&&(f=l.split(":"),1<f.length&&(a.tlsPort=f[1]));b.ablyOptions=a;b.ably=new b.Ably.Realtime(a);c.cipher_key&&(b.ablyCipherParamsPending=!0,b.Ably.Realtime.Crypto.getDefaultParams(c.cipher_key,y));b.ably.connection.on(function(a){switch(a.current){case "connected":s("connect");break;case "disconnected":case "suspended":case "closed":s("disconnect",a.reason);break;case "failed":s("error",a.reason)}});return b};b.get_uuid=function(){return b.ablyOptions?
b.ablyOptions.clientId:null};b.shutdown=function(c){var d=b.ably.connection,a=function(b){d.off("closed",a);c(b.current)};b.ably.connection.on("closed",a);b.ably.close();delete b.ably;delete b.ablyOptions;delete b.ablyCipherParams;n={};p={};q=[]};b.history=function(c,b){b=c.callback||b;var a=c.count||100,e=c.channel,f=c.error||k,l=c.reverse||!1;if(!e)return h("Missing Channel");if(!b)return h("Missing Callback");e=r(e);a={direction:l?"backwards":"forwards",limit:a};c.start&&(a.start=Number(c.start)/
1E4);c.end&&(a.end=Number(c.end)/1E4);e.history(a,function(a,c){if(a)f(a);else{for(var e=[],l=null,h=null,k=0;k<c.length;k++){var x=c[k];l||(l=h=x.timestamp);e.push(x.data)}b([e,l,h])}})};b.time=function(c){b.ably.time(function(b,a){b?(h("PUBNUB.time: Error: "+b),c(0)):c(1E4*Number(a))})};b.publish=function(c,d){d=d||c.callback||k;var a=c.message,e=c.channel,f=c.error||k,l=Date.now();if(!a)return h("Missing Message");if(!e)return h("Missing Channel");b.ablyCipherParamsPending?q.push({channel:e,message:a,
error:f,callback:d}):r(e).publish("",a,function(a){a?f({error:a}):d([1,"Sent",(1E4*l).toString()])})};b.here_now=function(c,b){b=b||c.callback;var a=c.error||k,e=c.channel;if(e)if(b)if(e=n[e])if(e=e.ablyChannel.presence.get()){for(var a=Array(e.length),f=0;f<e.length;f++)a[f]=e[f].clientId;b({uuids:a,occupancy:a.length})}else a("Presence not available for channel");else a("Not subscribed to channel");else a("Missing callback");else a("Missing channel")};b.uuid=function(b){var d=m(8)+"-"+m(4)+"-"+
m(4)+"-"+m(4)+"-"+m(12);b&&b(d);return d};b.subscribe=function(c,d){d=d||c.callback||c.message;var a=c.channel;if(!a)return h("Missing Channel");if(!d)return h("Missing Callback");"[object Array]"!=Object.prototype.toString.call(a)&&(a=a.split(","));for(var e=function(a,c,d){if(n[a])return h("Already Connected");var e=function(a){c(a.data)},f=r(a),g=d.presence;if(g){var m=function(a){"update"!=a.action&&g({action:"enter"==a.action?"join":"leave",uuid:a.clientId,timestamp:1E4*Date.now(),occupancy:f.presence.get().length})};
f.presence.on("enter",function(a){a.action="enter";m(a)});f.presence.on("leave",function(a){a.action="leave";m(a)})}f.subscribe(e);d={callback:e,ablyChannel:f,error:d.error||k,connect:d.connect||k,reconnect:d.reconnect||k,disconnect:d.disconnect||k,presence:d.presence||k,hasConnectedOnce:!1};n[a]=d;"connected"==b.ably.connection.state&&(d.hasConnectedOnce=!0,d.connect&&d.connect(a));b.ablyOptions.clientId&&f.presence.enter(function(a){})},f=0;f<a.length;f++)e(a[f],d,c)};b.unsubscribe=function(b,d){d=
d||b.callback||k;var a=b.channel;if(a){"[object Array]"!=Object.prototype.toString.call(a)&&(a=a.split(","));for(var e=0;e<a.length;e++){var f=a[e],h=d,g=f&&n[f];g&&(g.ablyChannel.unsubscribe(g.callback),delete n[f],h({action:"leave"}))}}};"undefined"===typeof window?module.exports=b:window.PUBNUB=b})();
