<!DOCTYPE html>
<html>
<head>
<script type="text/javascript">

(function(){var y=window.Ably=this,z=function(){function a(){this.any=[];this.events={};this.anyOnce=[];this.eventsOnce={}}a.prototype.on=function(a,b){1==arguments.length&&"function"==typeof a?this.any.push(a):null===a?this.any.push(b):(this.events[a]||(this.events[a]=[])).push(b)};a.prototype.off=function(a,b){if(0==arguments.length)this.any=[],this.events={},this.anyOnce=[],this.eventsOnce={};else{1==arguments.length&&"function"==typeof a&&(b=a,a=null);var f,d=-1;if(null===a)if(b){if(!(f=this.any)||
-1==(d=m.arrIndexOf(f,b)))if(f=this.anyOnce)d=m.arrIndexOf(f,b);-1<d&&f.splice(d,1)}else this.any=[],this.anyOnce=[];else if(b){d=-1;if(!(f=this.events[a])||-1==(d=m.arrIndexOf(f,b)))if(f=this.eventsOnce[a])d=m.arrIndexOf(f,b);-1<d&&f.splice(d,1)}else delete this.events[a],delete this.eventsOnce[a]}};a.prototype.listeners=function(a){if(a){var b=this.events[a]||[];this.eventsOnce[a]&&Array.prototype.push.apply(b,this.eventsOnce[a]);return b.length?b:null}return this.any.length?this.any:null};a.prototype.emit=
function(a){function b(a){try{a.apply(d,f)}catch(b){throw k.logAction(k.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+b+"; stack = "+b.stack),b;}}var f=Array.prototype.slice.call(arguments,1),d={event:a};if(this.anyOnce.length){var g=this.anyOnce;this.anyOnce=[];for(var e=0;e<g.length;e++)b(g[e])}for(e=0;e<this.any.length;e++)this.any[e].apply(d,f);if(g=this.eventsOnce[a])for(delete this.eventsOnce[a],e=0;e<g.length;e++)b(g[e]);if(g=this.events[a])for(e=0;e<g.length;e++)b(g[e])};
a.prototype.once=function(a,b){1==arguments.length&&"function"==typeof a?this.anyOnce.push(a):null===a?this.anyOnce.push(b):(this.eventsOnce[a]||(this.eventsOnce[a]=[])).push(b)};return a}(),k=function(){function a(a){}var c=2,b=console&&function(){console.log.apply(console,arguments)};a.LOG_NONE=0;a.LOG_ERROR=1;a.LOG_MAJOR=2;a.LOG_MINOR=3;a.LOG_MICRO=4;a.LOG_DEFAULT=2;a.LOG_DEBUG=4;a.logAction=function(a,d,g){a<=c&&b("Ably: "+d+": "+g)};a.setLog=function(a,d){void 0!==a&&(c=a);void 0!==d&&(b=d)};
return a}(),C=function(){return function(a){a=a||[];var c=function(){for(var b=0;b<a.length;b++){var f=a[b];try{f.apply(null,arguments)}catch(d){}}};c.push=function(){Array.prototype.push.apply(a,arguments)};return c}}(),m=function(){function a(){}var c="object"==typeof window;a.mixin=function(a,b){for(var g in b)b.hasOwnProperty(g)&&(a[g]=b[g]);return a};a.copy=function(f){return a.mixin({},f)};a.isArray=function(a){return"[object Array]"==Object.prototype.toString.call(a)};a.isEmpty=function(a){for(var b in a)return!1;
return!0};a.shallowClone=function(a){var b={},g;for(g in a)b[g]=a[g];return b};a.prototypicalClone=function(f,b){function g(){}g.prototype=f;var c=new g;b&&a.mixin(c,b);return c};a.inherits=function(f,b){f.super_=b;f.prototype=a.prototypicalClone(b.prototype,{constructor:f})};a.containsValue=function(a,b){for(var g in a)if(a[g]==b)return!0;return!1};a.intersect=function(b,d){return a.isArray(d)?a.arrIntersect(b,d):a.arrIntersectOb(b,d)};a.isArray=Array.isArray?Array.isArray:function(a){return"[object Array]"===
Object.prototype.toString.call(a)};a.arrIntersect=function(b,d){for(var g=[],c=0;c<b.length;c++){var k=b[c];-1!=a.arrIndexOf(d,k)&&g.push(k)}return g};a.arrIntersectOb=function(a,b){for(var c=[],e=0;e<a.length;e++){var k=a[e];k in b&&c.push(k)}return c};a.arrSubtract=function(b,d){for(var c=[],e=0;e<b.length;e++){var k=b[e];-1==a.arrIndexOf(d,k)&&c.push(k)}return c};a.arrIndexOf=Array.prototype.indexOf?function(a,b,c){return a.indexOf(b,c)}:function(a,b,c){c=c||0;for(var e=a.length;c<e;c++)if(a[c]===
b)return c;return-1};a.keysArray=function(a,b){var c=[],e;for(e in a)b&&!a.hasOwnProperty(e)||c.push(e);return c.length?c:void 0};a.valuesArray=function(a,b){var c=[],e;for(e in a)b&&!a.hasOwnProperty(e)||c.push(a[e]);return c.length?c:void 0};a.nextTick=c?function(a){setTimeout(a,0)}:process.nextTick;var b={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};a.defaultGetHeaders=function(a){a=a||"json";return{accept:"json"===
a?b.json:b[a]+","+b.json}};a.defaultPostHeaders=function(a){a=a||"json";return{accept:"json"===a?b.json:b[a]+","+b.json,"content-type":"json"===a?b.json:b[a]}};a.arrRandomElement=function(a){return a.splice(Math.floor(Math.random()*a.length))};a.toQueryString=function(a){var b=[];if(a)for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.length?"?"+b.join("&"):""};a.parseQueryString=function(a){for(var b,c=/([^?&=]+)=?([^&]*)/g,e={};b=c.exec(a);)e[decodeURIComponent(b[1])]=
decodeURIComponent(b[2]);return e};return a}(),t=function(){function a(){this.presence=this.messages=this.msgSerial=this.channelSerial=this.channel=this.connectionSerial=this.connectionKey=this.connectionId=this.error=this.count=this.timestamp=this.id=this.flags=this.action=void 0}var c="object"==typeof window?window.Ably.msgpack:(void 0)("msgpack-js");a.Action={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,
PRESENCE:14,MESSAGE:15,SYNC:16};a.Flag={HAS_PRESENCE:0,HAS_BACKLOG:1};a.encode=function(a,f){return"msgpack"==f?c.encode(a,!0):JSON.stringify(a)};a.decode=function(b,f){var d="msgpack"==f?c.decode(b):JSON.parse(String(b));return a.fromDecoded(d)};a.fromDecoded=function(b){var c=b.error;c&&(b.error=ErrorInfo.fromValues(c));var d=b.messages;if(d)for(c=0;c<d.length;c++)d[c]=Message.fromDecoded(d[c]);if(d=b.presence)for(c=0;c<d.length;c++)d[c]=PresenceMessage.fromDecoded(d[c]);return m.mixin(new a,b)};
a.fromValues=function(b){return m.mixin(new a,b)};return a}(),n={protocolVersion:1,HOST:"rest.ably.io",WS_HOST:"realtime.ably.io",FALLBACK_HOSTS:["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"],PORT:80,TLS_PORT:443,connectTimeout:15E3,disconnectTimeout:3E4,suspendedTimeout:12E4,recvTimeout:9E4,sendTimeout:1E4,connectionPersistTimeout:15E3,httpTransports:["xhr","iframe","jsonp"],transports:["web_socket","xhr","iframe","jsonp"],version:"0.7.3",
minified:!function(){}.name,environmentHost:function(a,c){return a&&"production"!==String(a).toLowerCase()?[String(a).toLowerCase(),c].join("-"):c},getHost:function(a,c,b){var f=n.environmentHost(a.environment,n.HOST);c=c||a.host||f;b&&(c=c==a.host&&(a.wsHost||c)||c==f&&(n.environmentHost(a.environment,n.WS_HOST)||c)||c);return c},getPort:function(a,c){return c||a.tls?a.tlsPort||n.TLS_PORT:a.port||n.PORT},getHosts:function(a){var c;a=a||{};a.host?(c=[a.host],a.fallbackHosts&&c.concat(a.fallbackHosts)):
c=[n.environmentHost(a.environment,n.HOST)].concat(n.FALLBACK_HOSTS);return c}},A=function(){function a(){}a.addListener=function(a,b,f){a.addEventListener?a.addEventListener(b,f,!1):a.attachEvent("on"+b,function(){f.apply(a,arguments)})};a.removeListener=function(a,b,f){a.removeEventListener?a.removeEventListener(b,f,!1):a.detachEvent("on"+b,function(){f.apply(a,arguments)})};a.addMessageListener=function(c,b){a.addListener(c,"message",b)};a.removeMessageListener=function(c,b){a.removeListener(c,
"message",b)};a.addUnloadListener=function(c){a.addListener(window,"unload",c)};return a}(),x=function(){function a(){for(var a in e)e[a].dispose()}function c(){return window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest?q=!0:t&&document.domain&&"https:"==window.location.protocol?!0:!1}function b(a,b,c,h,d){z.call(this);c=c||{};c.rnd=String(Math.random()).substr(2);this.uri=a+m.toQueryString(c);this.headers=b||{};this.body=h;this.requestMode=d;this.requestComplete=!1;e[this.id=String(++g)]=
this}function f(a,c,h,d,e){h.ua="xdr";b.call(this,a,c,h,d,e)}var d=function(){},g=0,e={},t=window.XDomainRequest,q;m.inherits(b,z);b.isAvailable=c;var h=b.createRequest=function(a,c,h,d,e){return q?new b(a,c,h,d,e):new f(a,c,h,d,e)};b.prototype.complete=function(a,b,c,h){this.requestComplete||(this.requestComplete=!0,b&&this.emit("data",b),this.emit("complete",a,b,c,h),this.dispose())};b.prototype.abort=function(){this.dispose()};b.prototype.exec=function(){function a(){s=f.responseText;for(var b=
s.length-1,c,h;p<b&&-1<(c=s.indexOf("\n",p));){h=s.slice(p,c);p=c+1;a:{try{h=JSON.parse(h)}catch(d){h=Error("Malformed response body from server: "+d.message);h.statusCode=400;g.complete(h);break a}g.emit("data",h)}}}function b(){a();g.streamComplete=!0;m.nextTick(function(){g.complete()})}var c=this.timer=setTimeout(function(){f.abort()},0==this.requestMode?n.sendTimeout:n.recvTimeout),h=this.body,d=h?"POST":"GET",e=this.headers,f=this.xhr=new XMLHttpRequest,g=this,k=e.accept,q="text";k?"application/json"!=
k&&(q="arraybuffer"):e.accept="application/json";h&&"application/json"==(e["content-type"]||(e["content-type"]="application/json"))&&"string"!=typeof h&&(h=JSON.stringify(h));f.open(d,this.uri,!0);f.responseType=q;f.withCredentials="true";for(var v in e)f.setRequestHeader(v,e[v]);var l=f.onerror=function(a){a.code=8E4;g.complete(a)};f.onabort=function(){var a=Error("Request cancelled");a.statusCode=400;l(a)};f.ontimeout=function(){var a=Error("Request timed out");a.statusCode=408;l(a)};var u,r,s,
w,p=0,B=!1;f.onreadystatechange=function(){var h=f.readyState;if(!(3>h)&&0!==f.status)if(void 0===r&&(r=f.status,1223===r&&(r=204),clearTimeout(c),w=400>r,204==r?g.complete():u=3==g.requestMode&&w),3==h&&u)a();else if(4==h)if(u)b();else a:{try{var d=f.getResponseHeader&&f.getResponseHeader("Content-Type"),e=d?"application/json"==d:"text"==f.responseType;s=e?f.responseText:f.response;if(!s){204!=status&&(p=Error("Incomplete response body from server"),p.statusCode=400,g.complete(p));break a}e&&(s=
JSON.parse(String(s)),B=!0)}catch(k){var p=Error("Malformed response body from server: "+k.message);p.statusCode=400;g.complete(p);break a}w?g.complete(null,s,d&&{"Content-Type":d},B):(p=s.error,p||(p=Error("Error response received from server: "+r),p.statusCode=r),g.complete(p))}};f.send(h)};b.prototype.dispose=function(){var a=this.xhr;if(a){a.onreadystatechange=a.onerror=a.onabort=a.ontimeout=d;this.xhr=null;var b=this.timer;b&&(clearTimeout(b),this.timer=null);this.requestComplete||a.abort()}delete e[this.id]};
m.inherits(f,b);f.prototype.exec=function(){function a(){clearTimeout(h);if(l=e.responseText){var b=l.length-1;if("\n"==l[b]||(b=-1<l.indexOf("\n"))){var c=l.slice(0,b);try{var c=JSON.parse(c),d=c.error;if(d)v=d.statusCode||500,g.complete(d);else if(v=l?201:200,t=3==g.requestMode)u=b,m.isEmpty(c)||g.emit("data",c)}catch(f){d=Error("Malformed response body from server: "+f.message),d.statusCode=400,g.complete(d)}}}}function b(){l=e.responseText;for(var a=l.length-1,c,h;u<a&&-1<(c=l.indexOf("\n",u));){h=
l.slice(u,c);u=c+1;a:{try{h=JSON.parse(h)}catch(d){h=Error("Malformed response body from server: "+d.message);h.statusCode=400;g.complete(h);break a}g.emit("data",h)}}}function c(){b();g.streamComplete=!0;m.nextTick(function(){g.complete()})}var h=this.timer=setTimeout(function(){e.abort()},0==this.requestMode?n.sendTimeout:n.recvTimeout),d=this.body,f=d?"POST":"GET",e=this.xhr=new XDomainRequest,g=this;d&&"object"==typeof d&&(d=JSON.stringify(d));var q=e.onerror=function(){k.logAction(k.LOG_ERROR,
"Request.onerror()","");var a=Error("Error response");a.statusCode=400;a.code=8E4;g.complete(a)};e.onabort=function(){k.logAction(k.LOG_ERROR,"Request.onabort()","");var a=Error("Request cancelled");a.statusCode=400;q(a)};e.ontimeout=function(){k.logAction(k.LOG_ERROR,"Request.timeout()","");var a=Error("Request timed out");a.statusCode=408;q(a)};var t,v,l,u=0;e.onprogress=function(){void 0===v?a():t&&b()};e.onload=function(){if(void 0===v&&(a(),g.requestComplete))return;if(t)c();else a:{try{l=e.responseText;
if(!l||!l.length){204!=status&&(h=Error("Incomplete response body from server"),h.statusCode=400,g.complete(h));break a}l=JSON.parse(String(l))}catch(b){var h=Error("Malformed response body from server: "+b.message);h.statusCode=400;g.complete(h);break a}g.complete(null,l,{"Content-Type":"application/json"},!0)}};try{e.open(f,this.uri),e.send(d)}catch(r){k.logAction(k.LOG_ERROR,"Request.onStreamEnd()","Unexpected send exception; err = "+r),q(r)}};f.prototype.dispose=function(){var a=this.xhr;if(a){a.onprogress=
a.onload=a.onerror=a.onabort=a.ontimeout=d;this.xhr=null;var b=this.timer;b&&(clearTimeout(b),this.timer=null);this.requestComplete||a.abort()}delete e[this.id]};if(c=b.isAvailable())A.addUnloadListener(a),"undefined"!==typeof Http&&(Http.supportsAuthHeaders=q,Http.Request=function(a,b,c,d,e){a=h(a,b,c,d,0);a.once("complete",e);a.exec();return a});return b}();(function(){function a(a){"string"!=typeof a&&(a=JSON.stringify(a));return a}function c(a){"string"==typeof a&&(a=JSON.parse(a));return a}function b(){this.stream=
"stream"in d?d.stream:!0;this.baseUri=this.sendUri=this.recvUri=this.pendingItems=this.pendingCallback=this.recvRequest=this.sendRequest=null;var a=this;A.addMessageListener(window,function(b){a.onMessageEvent(b.data)})}var f=location.origin||location.protocol+"//"+location.hostname+(location.port?":"+location.port:""),d=m.parseQueryString(window.location.search),g=d.origin;delete d.origin;var e="access_token"in d?{access_token:d.access_token}:{key_id:d.key_id,key_value:d.key_value},n=window.parent,
q=t.Action;b.prototype.connect=function(){var a=(this.baseUri=f+"/comet/")+"connect",b=this;k.logAction(k.LOG_MINOR,"IframeAgent.connect()","uri: "+a);a=this.recvRequest=x.createRequest(a,null,d,null,this.stream?3:1);a.on("data",function(a){null==b.sendUri&&b.checkConnectResponse(a);b.onData(a)});a.on("complete",function(a){b.recvRequest=null;a&&b.postErrorEvent(a)});a.exec()};b.prototype.dispose=function(){this.recvRequest&&(this.recvRequest.abort(),this.recvRequest=null)};b.prototype.checkConnectResponse=
function(a){try{var b=c(a);if(b&&b.length)for(a=0;a<b.length;a++){var d=b[a];if(d.action==q.CONNECTED){this.onConnect(d);break}}}catch(e){k.logAction(k.LOG_ERROR,"IframeAgent.checkConnectResponse()","Unexpected exception handing channel event: "+e)}};b.prototype.onConnect=function(a){a=this.baseUri+a.connectionKey;k.logAction(k.LOG_MICRO,"IframeAgent.onConnect()","baseUri = "+a);this.sendUri=a+"/send";this.recvUri=a+"/recv";var b=this;m.nextTick(function(){b.recv()})};b.prototype.onMessageEvent=function(a){var b=
this;this.send(c(a),function(a,c){a?b.postErrorEvent(a):c&&b.postMessageEvent(c)})};b.prototype.send=function(a,b){k.logAction(k.LOG_MICRO,"IframeAgent.send()","msg = "+JSON.stringify(a));if(this.sendRequest)this.pendingItems=this.pendingItems||[],this.pendingItems.push(a),this.pendingCallback=this.pendingCallback||C(),this.pendingCallback.push(b);else{var c=this.pendingItems||[];c.push(a);this.pendingItems=null;var d=this.pendingCallback;d&&(d.push(b),b=d,this.pendingCallback=null);this.sendItems(c,
b)}};b.prototype.sendItems=function(b,c){var d=this.sendUri,f=this;d?(d=this.sendRequest=x.createRequest(d,null,e,a(b),0),d.on("complete",function(a,b){a&&k.logAction(k.LOG_ERROR,"IframeAgent.sendItems()","on complete: err = "+a);f.sendRequest=null;if(b)f.onData(b);var d=f.pendingItems;if(d){f.pendingItems=null;var e=f.pendingCallback;f.pendingCallback=null;m.nextTick(function(){f.sendItems(d,e)})}c(a)}),d.exec()):c({message:"Unable to send; not connected",code:8E4,statusCode:400})};b.prototype.recv=
function(){if(!this.recvRequest&&this.isConnected){var a=this,b=this.recvRequest=x.createRequest(this.recvUri,null,e,null,a.stream?3:2);b.on("data",function(b){a.onData(b)});b.on("complete",function(b){a.recvRequest=null;b?a.postErrorEvent(b):m.nextTick(function(){a.recv()})});b.exec()}};b.prototype.onData=function(a){this.postMessageEvent(a)};b.prototype.postMessageEvent=function(b){n.postMessage(a(b),g)};b.prototype.postErrorEvent=function(a,b){var c=b;if(a){var d=new t.fromValues({action:q.ERROR,
error:a});c&&m.mixin(d,c);c=d}this.postMessageEvent([c])};(new b).connect()})();"undefined"!==typeof Realtime&&(y.Rest=Rest,y.Realtime=Realtime,Realtime.ConnectionManager=ConnectionManager,Realtime.BufferUtils=Rest.BufferUtils=BufferUtils,"undefined"!==typeof Crypto&&(Realtime.Crypto=Rest.Crypto=Crypto),Realtime.Message=Rest.Message=Message,Realtime.PresenceMessage=Rest.PresenceMessage=PresenceMessage,Realtime.ProtocolMessage=Rest.ProtocolMessage=t)}).call({});

</script>
</head>
<body>
<h2>Ably cross-origin iframe</h2>
</body>
</html>
