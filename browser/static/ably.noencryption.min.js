(function(){var W=window.Ably=this,v=v||function(c,e){var a={},d=a.lib={},b=d.Base=function(){function f(){}return{extend:function(b){f.prototype=this;var g=new f;b&&g.mixIn(b);g.hasOwnProperty("init")||(g.init=function(){g.$super.init.apply(this,arguments)});g.init.prototype=g;g.$super=this;return g},create:function(){var f=this.extend();f.init.apply(f,arguments);return f},init:function(){},mixIn:function(f){for(var b in f)f.hasOwnProperty(b)&&(this[b]=f[b]);f.hasOwnProperty("toString")&&(this.toString=
f.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),g=d.WordArray=b.extend({init:function(f,b){f=this.words=f||[];this.sigBytes=b!=e?b:4*f.length},toString:function(f){return(f||k).stringify(this)},concat:function(f){var b=this.words,g=f.words,d=this.sigBytes;f=f.sigBytes;this.clamp();if(d%4)for(var a=0;a<f;a++)b[d+a>>>2]|=(g[a>>>2]>>>24-a%4*8&255)<<24-(d+a)%4*8;else if(65535<g.length)for(a=0;a<f;a+=4)b[d+a>>>2]=g[a>>>2];else b.push.apply(b,g);this.sigBytes+=f;return this},
clamp:function(){var f=this.words,b=this.sigBytes;f[b>>>2]&=4294967295<<32-b%4*8;f.length=c.ceil(b/4)},clone:function(){var f=b.clone.call(this);f.words=this.words.slice(0);return f},random:function(f){for(var b=[],a=function(f){var b=987654321;return function(){b=36969*(b&65535)+(b>>16)&4294967295;f=18E3*(f&65535)+(f>>16)&4294967295;var g=(b<<16)+f&4294967295,g=g/4294967296+.5;return g*(.5<c.random()?1:-1)}},d=0,p;d<f;d+=4){var h=a(4294967296*(p||c.random()));p=987654071*h();b.push(4294967296*h()|
0)}return new g.init(b,f)}}),h=a.enc={},k=h.Hex={stringify:function(f){var b=f.words;f=f.sigBytes;for(var g=[],a=0;a<f;a++){var d=b[a>>>2]>>>24-a%4*8&255;g.push((d>>>4).toString(16));g.push((d&15).toString(16))}return g.join("")},parse:function(f){for(var b=f.length,a=[],d=0;d<b;d+=2)a[d>>>3]|=parseInt(f.substr(d,2),16)<<24-d%8*4;return new g.init(a,b/2)}},n=h.Latin1={stringify:function(f){var b=f.words;f=f.sigBytes;for(var g=[],a=0;a<f;a++)g.push(String.fromCharCode(b[a>>>2]>>>24-a%4*8&255));return g.join("")},
parse:function(f){for(var b=f.length,a=[],d=0;d<b;d++)a[d>>>2]|=(f.charCodeAt(d)&255)<<24-d%4*8;return new g.init(a,b)}},f=h.Utf8={stringify:function(f){try{return decodeURIComponent(escape(n.stringify(f)))}catch(b){throw Error("Malformed UTF-8 data");}},parse:function(f){return n.parse(unescape(encodeURIComponent(f)))}},p=d.BufferedBlockAlgorithm=b.extend({reset:function(){this._data=new g.init;this._nDataBytes=0},_append:function(b){"string"==typeof b&&(b=f.parse(b));this._data.concat(b);this._nDataBytes+=
b.sigBytes},_process:function(f){var b=this._data,a=b.words,d=b.sigBytes,p=this.blockSize,h=d/(4*p),h=f?c.ceil(h):c.max((h|0)-this._minBufferSize,0);f=h*p;d=c.min(4*f,d);if(f){for(var n=0;n<f;n+=p)this._doProcessBlock(a,n);n=a.splice(0,f);b.sigBytes-=d}return new g.init(n,d)},clone:function(){var f=b.clone.call(this);f._data=this._data.clone();return f},_minBufferSize:0});d.Hasher=p.extend({cfg:b.extend(),init:function(f){this.cfg=this.cfg.extend(f);this.reset()},reset:function(){p.reset.call(this);
this._doReset()},update:function(f){this._append(f);this._process();return this},finalize:function(f){f&&this._append(f);return this._doFinalize()},blockSize:16,_createHelper:function(f){return function(b,a){return(new f.init(a)).finalize(b)}},_createHmacHelper:function(f){return function(b,a){return(new w.HMAC.init(f,a)).finalize(b)}}});var w=a.algo={};return a}(Math);(function(c){var e=v,a=e.lib,d=a.WordArray,b=a.Hasher,a=e.algo,g=[],h=[];(function(){function b(f){for(var a=c.sqrt(f),d=2;d<=a;d++)if(!(f%
d))return!1;return!0}function f(f){return 4294967296*(f-(f|0))|0}for(var a=2,d=0;64>d;)b(a)&&(8>d&&(g[d]=f(c.pow(a,.5))),h[d]=f(c.pow(a,1/3)),d++),a++})();var k=[],a=a.SHA256=b.extend({_doReset:function(){this._hash=new d.init(g.slice(0))},_doProcessBlock:function(b,f){for(var a=this._hash.words,d=a[0],g=a[1],c=a[2],e=a[3],l=a[4],m=a[5],F=a[6],q=a[7],A=0;64>A;A++){if(16>A)k[A]=b[f+A]|0;else{var G=k[A-15],t=k[A-2];k[A]=((G<<25|G>>>7)^(G<<14|G>>>18)^G>>>3)+k[A-7]+((t<<15|t>>>17)^(t<<13|t>>>19)^t>>>
10)+k[A-16]}G=q+((l<<26|l>>>6)^(l<<21|l>>>11)^(l<<7|l>>>25))+(l&m^~l&F)+h[A]+k[A];t=((d<<30|d>>>2)^(d<<19|d>>>13)^(d<<10|d>>>22))+(d&g^d&c^g&c);q=F;F=m;m=l;l=e+G|0;e=c;c=g;g=d;d=G+t|0}a[0]=a[0]+d|0;a[1]=a[1]+g|0;a[2]=a[2]+c|0;a[3]=a[3]+e|0;a[4]=a[4]+l|0;a[5]=a[5]+m|0;a[6]=a[6]+F|0;a[7]=a[7]+q|0},_doFinalize:function(){var b=this._data,f=b.words,a=8*this._nDataBytes,d=8*b.sigBytes;f[d>>>5]|=128<<24-d%32;f[(d+64>>>9<<4)+14]=c.floor(a/4294967296);f[(d+64>>>9<<4)+15]=a;b.sigBytes=4*f.length;this._process();
return this._hash},clone:function(){var a=b.clone.call(this);a._hash=this._hash.clone();return a}});e.SHA256=b._createHelper(a);e.HmacSHA256=b._createHmacHelper(a)})(Math);(function(){var c=v,e=c.enc.Utf8;c.algo.HMAC=c.lib.Base.extend({init:function(a,d){a=this._hasher=new a.init;"string"==typeof d&&(d=e.parse(d));var b=a.blockSize,g=4*b;d.sigBytes>g&&(d=a.finalize(d));d.clamp();for(var h=this._oKey=d.clone(),c=this._iKey=d.clone(),n=h.words,f=c.words,p=0;p<b;p++)n[p]^=1549556828,f[p]^=909522486;
h.sigBytes=c.sigBytes=g;this.reset()},reset:function(){var a=this._hasher;a.reset();a.update(this._iKey)},update:function(a){this._hasher.update(a);return this},finalize:function(a){var d=this._hasher;a=d.finalize(a);d.reset();return d.finalize(this._oKey.clone().concat(a))}})})();(function(){var c=v,e=c.lib.WordArray;c.enc.Base64={stringify:function(a){var d=a.words,b=a.sigBytes,g=this._map;a.clamp();a=[];for(var c=0;c<b;c+=3)for(var e=(d[c>>>2]>>>24-c%4*8&255)<<16|(d[c+1>>>2]>>>24-(c+1)%4*8&255)<<
8|d[c+2>>>2]>>>24-(c+2)%4*8&255,n=0;4>n&&c+.75*n<b;n++)a.push(g.charAt(e>>>6*(3-n)&63));if(d=g.charAt(64))for(;a.length%4;)a.push(d);return a.join("")},parse:function(a){var d=a.length,b=this._map,g=b.charAt(64);g&&(g=a.indexOf(g),-1!=g&&(d=g));for(var g=[],c=0,k=0;k<d;k++)if(k%4){var n=b.indexOf(a.charAt(k-1))<<k%4*2,f=b.indexOf(a.charAt(k))>>>6-k%4*2;g[c>>>2]|=(n|f)<<24-c%4*8;c++}return e.create(g,c)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}})();var x=function(){function c(){}
var e=v.lib.WordArray,a=window.ArrayBuffer;c.supportsBinary=!!window.TextDecoder;c.isBuffer=function(d){return d.constructor===a||void 0!==d.sigBytes};c.toWordArray=function(a){return void 0!==a.sigBytes?a:e.create(a)};c.base64Encode=function(d){if(d.constructor===a){var b="";d=new Uint8Array(d);for(var g=d.byteLength,c=g%3,g=g-c,e,n,f,p,w=0;w<g;w+=3)p=d[w]<<16|d[w+1]<<8|d[w+2],e=(p&16515072)>>18,n=(p&258048)>>12,f=(p&4032)>>6,p&=63,b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[e]+
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[n]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[f]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[p];1==c?(p=d[g],b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(p&252)>>2]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(p&3)<<4]+"=="):2==c&&(p=d[g]<<8|d[g+1],b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(p&64512)>>10]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(p&
1008)>>4]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(p&15)<<2]+"=");return b}if(void 0!==d.sigBytes)return v.enc.Base64.stringify(d)};c.base64Decode=function(d){if(a){d=window.atob(d);for(var b=d.length,g=new Uint8Array(b),c=0;c<b;c++){var e=d.charCodeAt(c);g[c]=e}return g.buffer}if(v)return v.enc.Base64.parse(d)};c.utf8Encode=function(a){if(v)return v.enc.Utf8.parse(a)};c.utf8Decode=function(a){if(v)return v.enc.Utf8.stringify(a)};c.bufferCompare=function(a,b){if(!a)return-1;
if(!b)return 1;a=c.toWordArray(a);b=c.toWordArray(b);a.clamp();b.clamp();var g=a.sigBytes-b.sigBytes;if(0!=g)return g;a=a.words;b=b.words;for(var h=0;h<a.length;h++)if(g=a[h]-b[h],0!=g)return g;return 0};return c}(),P=function(){function c(){}"object"==typeof window&&(c.create=function(c,a,d){var b="";d&&(b=new Date,b.setTime(b.getTime()+d),b="; expires="+b.toGMTString());document.cookie=c+"="+a+b+"; path=/"},c.read=function(c){c+="=";for(var a=document.cookie.split(";"),d=0;d<a.length;d++){for(var b=
a[d];" "==b.charAt(0);)b=b.substring(1,b.length);if(0==b.indexOf(c))return b.substring(c.length,b.length)}return null},c.erase=function(c){createCookie(c,"",-36E5)});return c}(),q={protocolVersion:1,HOST:"rest.ably.io",WS_HOST:"realtime.ably.io",FALLBACK_HOSTS:["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"],PORT:80,TLS_PORT:443,connectTimeout:15E3,disconnectTimeout:3E4,suspendedTimeout:12E4,recvTimeout:9E4,sendTimeout:1E4,connectionPersistTimeout:15E3,
httpTransports:["xhr","iframe","jsonp"],transports:["web_socket","xhr","iframe","jsonp"],environmentHost:function(c,e){return c&&"production"!==String(c).toLowerCase()?[String(c).toLowerCase(),e].join("-"):e},getHost:function(c,e,a){var d=q.environmentHost(c.environment,q.HOST);e=e||c.host||d;a&&(e=e==c.host&&(c.wsHost||e)||e==d&&(q.environmentHost(c.environment,q.WS_HOST)||e)||e);return e},getPort:function(c,e){return e||c.tls?c.tlsPort||q.TLS_PORT:c.port||q.PORT},getHosts:function(c){var e;c=c||
{};c.host?(e=[c.host],c.fallbackHosts&&e.concat(c.fallbackHosts)):e=[q.environmentHost(c.environment,q.HOST)].concat(q.FALLBACK_HOSTS);return e}},s=function(){function c(){}var e=function(){};c.get=function(a,d,b,g,h){h=h||e;var k="function"==typeof d?d:function(f){return a.baseUri(f)+d},n,f=a.connection;n=f&&"connected"==f.state?[f.connectionManager.host]:q.getHosts(a.options);1==n.length?c.getUri(a,k(n[0]),b,g,h):c.getUri(a,k(n.shift()),b,g,function(f){if(f){var d=f.code;if("ENETUNREACH"==d||"EHOSTUNREACH"==
d||"EHOSTDOWN"==d){c.getUri(a,k(n.shift()),b,g,h);return}}h.apply(null,arguments)})};c.getUri=function(a,d,b,g,h){c.Request(d,b,g,null,h||e)};c.post=function(a,d,b,g,h,k){k=k||e;var n="function"==typeof d?d:function(f){return a.baseUri(f)+d},f,p=a.connection;f=p&&"connected"==p.state?[p.connectionManager.host]:q.getHosts(a.options);1==f.length?c.postUri(a,n(f[0]),b,g,h,k):c.postUri(a,n(f.shift()),b,g,h,function(d){if(d){var p=d.code;if("ENETUNREACH"==p||"EHOSTUNREACH"==p||"EHOSTDOWN"==p){c.postUri(a,
n(f.shift()),b,g,h,k);return}}k.apply(null,arguments)})};c.postUri=function(a,d,b,g,h,k){c.Request(d,b,h,g,k||e)};c.supportsAuthHeaders=!1;c.supportsLinkHeaders=!1;return c}(),$=function(){function c(){this.buffer=[]}function e(b){this._input=b;this._index=-1;this._buffer=[]}function a(b){this._input=b;this._index=-1;this._buffer=[]}c.prototype.append=function(b){this.buffer.push(b);return this};c.prototype.toString=function(){return this.buffer.join("")};var d={codex:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
encode:function(b){var a=new c,h=d.codex;for(b=new e(b);b.moveNext();){var k=b.current;b.moveNext();var n=b.current;b.moveNext();var f=b.current,p=k>>2,k=(k&3)<<4|n>>4,w=(n&15)<<2|f>>6,R=f&63;isNaN(n)?w=R=64:isNaN(f)&&(R=64);a.append(h.charAt(p)+h.charAt(k)+h.charAt(w)+h.charAt(R))}return a.toString()},decode:function(b){var d=new c;for(b=new a(b);b.moveNext();){var h=b.current;if(128>h)d.append(String.fromCharCode(h));else if(191<h&&224>h){b.moveNext();var e=b.current;d.append(String.fromCharCode((h&
31)<<6|e&63))}else b.moveNext(),e=b.current,b.moveNext(),d.append(String.fromCharCode((h&15)<<12|(e&63)<<6|b.current&63))}return d.toString()}};e.prototype={current:Number.NaN,moveNext:function(){if(0<this._buffer.length)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return this.current=Number.NaN,!1;var b=this._input.charCodeAt(++this._index);13==b&&10==this._input.charCodeAt(this._index+1)&&(b=10,this._index+=2);128>b?this.current=b:(127<b&&2048>b?this.current=
b>>6|192:(this.current=b>>12|224,this._buffer.push(b>>6&63|128)),this._buffer.push(b&63|128));return!0}};a.prototype={current:64,moveNext:function(){if(0<this._buffer.length)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return this.current=64,!1;var b=d.codex.indexOf(this._input.charAt(++this._index)),a=d.codex.indexOf(this._input.charAt(++this._index)),c=d.codex.indexOf(this._input.charAt(++this._index)),e=d.codex.indexOf(this._input.charAt(++this._index)),n=(c&
3)<<6|e;this.current=b<<2|a>>4;64!=c&&this._buffer.push((a&15)<<4|c>>2);64!=e&&this._buffer.push(n);return!0}};return d}(),N=function(){function c(){}c.addListener=function(c,a,d){c.addEventListener?c.addEventListener(a,d,!1):c.attachEvent("on"+a,function(){d.apply(c,arguments)})};c.removeListener=function(c,a,d){c.removeEventListener?c.removeEventListener(a,d,!1):c.detachEvent("on"+a,function(){d.apply(c,arguments)})};c.addMessageListener=function(e,a){c.addListener(e,"message",a)};c.removeMessageListener=
function(e,a){c.removeListener(e,"message",a)};c.addUnloadListener=function(e){c.addListener(window,"unload",e)};return c}();(function(c){this.msgpack=c()}).call(this,function(){function c(f,b,a){for(var d=0,g=a.length;d<g;d++){var c=a.charCodeAt(d);if(128>c)f.setUint8(b++,c>>>0&127|0);else if(2048>c)f.setUint8(b++,c>>>6&31|192),f.setUint8(b++,c>>>0&63|128);else if(65536>c)f.setUint8(b++,c>>>12&15|224),f.setUint8(b++,c>>>6&63|128),f.setUint8(b++,c>>>0&63|128);else if(1114112>c)f.setUint8(b++,c>>>
18&7|240),f.setUint8(b++,c>>>12&63|128),f.setUint8(b++,c>>>6&63|128),f.setUint8(b++,c>>>0&63|128);else throw Error("bad codepoint "+c);}}function e(f,b,a){var d="",g=b;for(b+=a;g<b;g++)if(a=f.getUint8(g),0===(a&128))d+=String.fromCharCode(a);else if(192===(a&224))d+=String.fromCharCode((a&15)<<6|f.getUint8(++g)&63);else if(224===(a&240))d+=String.fromCharCode((a&15)<<12|(f.getUint8(++g)&63)<<6|(f.getUint8(++g)&63)<<0);else if(240===(a&248))d+=String.fromCharCode((a&7)<<18|(f.getUint8(++g)&63)<<12|
(f.getUint8(++g)&63)<<6|(f.getUint8(++g)&63)<<0);else throw Error("Invalid byte "+a.toString(16));return d}function a(f){for(var b=0,a=0,d=f.length;a<d;a++){var g=f.charCodeAt(a);if(128>g)b+=1;else if(2048>g)b+=2;else if(65536>g)b+=3;else if(1114112>g)b+=4;else throw Error("bad codepoint "+g);}return b}function d(f,b){this.offset=b||0;this.view=f}function b(f,b){return Object.keys(f).filter(function(a){a=f[a];return(!b||void 0!==a&&null!==a)&&("function"!==typeof a||!!a.toJSON)})}function g(f,d,e,
h){var k=typeof f;if("string"===k){var l=a(f);if(32>l)return d.setUint8(e,l|160),c(d,e+1,f),1+l;if(256>l)return d.setUint8(e,217),d.setUint8(e+1,l),c(d,e+2,f),2+l;if(65536>l)return d.setUint8(e,218),d.setUint16(e+1,l),c(d,e+3,f),3+l;if(4294967296>l)return d.setUint8(e,219),d.setUint32(e+1,l),c(d,e+5,f),5+l}if(f instanceof ArrayBuffer){l=f.byteLength;if(256>l)return d.setUint8(e,196),d.setUint8(e+1,l),(new Uint8Array(d.buffer)).set(new Uint8Array(f),e+2),2+l;if(65536>l)return d.setUint8(e,197),d.setUint16(e+
1,l),(new Uint8Array(d.buffer)).set(new Uint8Array(f),e+3),3+l;if(4294967296>l)return d.setUint8(e,198),d.setUint32(e+1,l),(new Uint8Array(d.buffer)).set(new Uint8Array(f),e+5),5+l}if("number"===k){if(Math.floor(f)!==f)return d.setUint8(e,203),d.setFloat64(e+1,f),9;if(0<=f){if(128>f)return d.setUint8(e,f),1;if(256>f)return d.setUint8(e,204),d.setUint8(e+1,f),2;if(65536>f)return d.setUint8(e,205),d.setUint16(e+1,f),3;if(4294967296>f)return d.setUint8(e,206),d.setUint32(e+1,f),5;if(1.8446744073709552E19>
f)return d.setUint8(e,207),e+=1,1.8446744073709552E19>f?(d.setUint32(e,Math.floor(f*n)),d.setInt32(e+4,f&-1)):(d.setUint32(e,4294967295),d.setUint32(e+4,4294967295)),9;throw Error("Number too big 0x"+f.toString(16));}if(-32<=f)return d.setInt8(e,f),1;if(-128<=f)return d.setUint8(e,208),d.setInt8(e+1,f),2;if(-32768<=f)return d.setUint8(e,209),d.setInt16(e+1,f),3;if(-2147483648<=f)return d.setUint8(e,210),d.setInt32(e+1,f),5;if(-9223372036854775808<=f)return d.setUint8(e,211),e+=1,0x7fffffffffffffff>
f?(d.setInt32(e,Math.floor(f*n)),d.setInt32(e+4,f&-1)):(d.setUint32(e,2147483647),d.setUint32(e+4,2147483647)),9;throw Error("Number too small -0x"+(-f).toString(16).substr(1));}if("undefined"===k){if(h)return 0;d.setUint8(e,212);d.setUint8(e+1,0);d.setUint8(e+2,0);return 3}if(null===f){if(h)return 0;d.setUint8(e,192);return 1}if("boolean"===k)return d.setUint8(e,f?195:194),1;if("function"===typeof f.toJSON)return g(f.toJSON(),d,e,h);if("object"===k){var k=0,m=Array.isArray(f);if(m)l=f.length;else var M=
b(f,h),l=M.length;16>l?(d.setUint8(e,l|(m?144:128)),k=1):65536>l?(d.setUint8(e,m?220:222),d.setUint16(e+1,l),k=3):4294967296>l&&(d.setUint8(e,m?221:223),d.setUint32(e+1,l),k=5);if(m)for(m=0;m<l;m++)k+=g(f[m],d,e+k,h);else for(m=0;m<l;m++)var F=M[m],k=k+g(F,d,e+k),k=k+g(f[F],d,e+k,h);return k}if("function"===k)return 0;throw Error("Unknown type "+k);}function h(f,d){var g=typeof f;if("string"===g){var c=a(f);if(32>c)return 1+c;if(256>c)return 2+c;if(65536>c)return 3+c;if(4294967296>c)return 5+c}if(f instanceof
ArrayBuffer){c=f.byteLength;if(256>c)return 2+c;if(65536>c)return 3+c;if(4294967296>c)return 5+c}if("number"===g){if(Math.floor(f)!==f)return 9;if(0<=f){if(128>f)return 1;if(256>f)return 2;if(65536>f)return 3;if(4294967296>f)return 5;if(1.8446744073709552E19>f)return 9;throw Error("Number too big 0x"+f.toString(16));}if(-32<=f)return 1;if(-128<=f)return 2;if(-32768<=f)return 3;if(-2147483648<=f)return 5;if(-9223372036854775808<=f)return 9;throw Error("Number too small -0x"+f.toString(16).substr(1));
}if("boolean"===g)return 1;if(null===f)return d?0:1;if(void 0===f)return d?0:3;if("function"===typeof f.toJSON)return h(f.toJSON(),d);if("object"===g){g=0;if(Array.isArray(f))for(var c=f.length,e=0;e<c;e++)g+=h(f[e],d);else for(var n=b(f,d),c=n.length,e=0;e<c;e++)var k=n[e],g=g+(h(k)+h(f[k],d));if(16>c)return 1+g;if(65536>c)return 3+g;if(4294967296>c)return 5+g;throw Error("Array or object too long 0x"+c.toString(16));}if("function"===g)return 0;throw Error("Unknown type "+g);}var k={inspect:function(f){if(void 0===
f)return"undefined";var d,b;f instanceof ArrayBuffer?(b="ArrayBuffer",d=new DataView(f)):f instanceof DataView&&(b="DataView",d=f);if(!d)return JSON.stringify(f);for(var a=[],g=0;g<f.byteLength;g++){if(20<g){a.push("...");break}var c=d.getUint8(g).toString(16);1===c.length&&(c="0"+c);a.push(c)}return"<"+b+" "+a.join(" ")+">"}};k.utf8Write=c;k.utf8Read=e;k.utf8ByteCount=a;k.encode=function(d,b){var a=h(d,b);if(0!=a){var a=new ArrayBuffer(a),c=new DataView(a);g(d,c,0,b);return a}};k.decode=function(b){var a=
new DataView(b),a=new d(a),g=a.parse();if(a.offset!==b.byteLength)throw Error(b.byteLength-a.offset+" trailing bytes");return g};var n=1/4294967296;d.prototype.map=function(b){for(var d={},a=0;a<b;a++){var g=this.parse();d[g]=this.parse()}return d};d.prototype.bin=d.prototype.buf=function(b){var d=new ArrayBuffer(b);(new Uint8Array(d)).set(new Uint8Array(this.view.buffer,this.offset,b),0);this.offset+=b;return d};d.prototype.str=function(b){var d=e(this.view,this.offset,b);this.offset+=b;return d};
d.prototype.array=function(b){for(var d=Array(b),a=0;a<b;a++)d[a]=this.parse();return d};d.prototype.ext=function(b){var d={};d.type=this.view.getInt8(this.offset);this.offset++;d.data=this.buf(b);this.offset+=b;return d};d.prototype.parse=function(){var b=this.view.getUint8(this.offset);if(0===(b&128))return this.offset++,b;if(128===(b&240))return this.offset++,this.map(b&15);if(144===(b&240))return this.offset++,this.array(b&15);if(160===(b&224))return this.offset++,this.str(b&31);if(224===(b&224))return b=
this.view.getInt8(this.offset),this.offset++,b;switch(b){case 192:return this.offset++,null;case 193:this.offset++;return;case 194:return this.offset++,!1;case 195:return this.offset++,!0;case 196:return b=this.view.getUint8(this.offset+1),this.offset+=2,this.bin(b);case 197:return b=this.view.getUint16(this.offset+1),this.offset+=3,this.bin(b);case 198:return b=this.view.getUint32(this.offset+1),this.offset+=5,this.bin(b);case 199:return b=this.view.getUint8(this.offset+1),this.offset+=2,this.ext(b);
case 200:return b=this.view.getUint16(this.offset+1),this.offset+=3,this.ext(b);case 201:return b=this.view.getUint32(this.offset+1),this.offset+=5,this.ext(b);case 202:return b=this.view.getFloat32(this.offset+1),this.offset+=5,b;case 203:return b=this.view.getFloat64(this.offset+1),this.offset+=9,b;case 204:return b=this.view.getUint8(this.offset+1),this.offset+=2,b;case 205:return b=this.view.getUint16(this.offset+1),this.offset+=3,b;case 206:return b=this.view.getUint32(this.offset+1),this.offset+=
5,b;case 207:var b=this.view,d=this.offset+1,d=d||0,b=4294967296*b.getUint32(d)+b.getUint32(d+4);this.offset+=9;return b;case 208:return b=this.view.getInt8(this.offset+1),this.offset+=2,b;case 209:return b=this.view.getInt16(this.offset+1),this.offset+=3,b;case 210:return b=this.view.getInt32(this.offset+1),this.offset+=5,b;case 211:return b=this.view,d=(d=this.offset+1)||0,b=4294967296*b.getInt32(d)+b.getUint32(d+4),this.offset+=9,b;case 212:return this.offset++,this.ext(1);case 213:return this.offset++,
this.ext(2);case 214:return this.offset++,this.ext(4);case 215:return this.offset++,this.ext(8);case 216:return this.offset++,this.ext(16);case 217:return b=this.view.getUint8(this.offset+1),this.offset+=2,this.str(b);case 218:return b=this.view.getUint16(this.offset+1),this.offset+=3,this.str(b);case 219:return b=this.view.getUint32(this.offset+1),this.offset+=5,this.str(b);case 220:return b=this.view.getUint16(this.offset+1),this.offset+=3,this.array(b);case 221:return b=this.view.getUint32(this.offset+
1),this.offset+=5,this.array(b);case 222:return b=this.view.getUint16(this.offset+1),this.offset+=3,this.map(b);case 223:return b=this.view.getUint32(this.offset+1),this.offset+=5,this.map(b)}throw Error("Unknown type 0x"+b.toString(16));};return k});var r=function(){function c(){this.any=[];this.events={};this.anyOnce=[];this.eventsOnce={}}c.prototype.on=function(c,a){1==arguments.length&&"function"==typeof c?this.any.push(c):null===c?this.any.push(a):(this.events[c]||(this.events[c]=[])).push(a)};
c.prototype.off=function(c,a){if(0==arguments.length)this.any=[],this.events={},this.anyOnce=[],this.eventsOnce={};else{1==arguments.length&&"function"==typeof c&&(a=c,c=null);var d,b=-1;if(null===c)if(a){if(!(d=this.any)||-1==(b=m.arrIndexOf(d,a)))if(d=this.anyOnce)b=m.arrIndexOf(d,a);-1<b&&d.splice(b,1)}else this.any=[],this.anyOnce=[];else if(a){b=-1;if(!(d=this.events[c])||-1==(b=m.arrIndexOf(d,a)))if(d=this.eventsOnce[c])b=m.arrIndexOf(d,a);-1<b&&d.splice(b,1)}else delete this.events[c],delete this.eventsOnce[c]}};
c.prototype.listeners=function(c){if(c){var a=this.events[c]||[];this.eventsOnce[c]&&Array.prototype.push.apply(a,this.eventsOnce[c]);return a.length?a:null}return this.any.length?this.any:null};c.prototype.emit=function(c){function a(a){try{a.apply(b,d)}catch(g){throw e.logAction(e.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+g+"; stack = "+g.stack),g;}}var d=Array.prototype.slice.call(arguments,1),b={event:c};if(this.anyOnce.length){var g=this.anyOnce;this.anyOnce=[];for(var h=
0;h<g.length;h++)a(g[h])}for(h=0;h<this.any.length;h++)this.any[h].apply(b,d);if(g=this.eventsOnce[c])for(delete this.eventsOnce[c],h=0;h<g.length;h++)a(g[h]);if(g=this.events[c])for(h=0;h<g.length;h++)a(g[h])};c.prototype.once=function(c,a){1==arguments.length&&"function"==typeof c?this.anyOnce.push(c):null===c?this.anyOnce.push(a):(this.eventsOnce[c]||(this.eventsOnce[c]=[])).push(a)};return c}(),e=function(){function c(d){}var e=2,a=console&&function(){console.log.apply(console,arguments)};c.LOG_NONE=
0;c.LOG_ERROR=1;c.LOG_MAJOR=2;c.LOG_MINOR=3;c.LOG_MICRO=4;c.LOG_DEFAULT=2;c.LOG_DEBUG=4;c.logAction=function(d,b,g){d<=e&&a("Ably: "+b+": "+g)};c.setLog=function(d,b){void 0!==d&&(e=d);void 0!==b&&(a=b)};return c}(),m=function(){function c(){}var e="object"==typeof window;c.mixin=function(d,b){for(var a in b)b.hasOwnProperty(a)&&(d[a]=b[a]);return d};c.copy=function(d){return c.mixin({},d)};c.isArray=function(d){return"[object Array]"==Object.prototype.toString.call(d)};c.isEmpty=function(d){for(var b in d)return!1;
return!0};c.shallowClone=function(d){var b={},a;for(a in d)b[a]=d[a];return b};c.prototypicalClone=function(d,b){function a(){}a.prototype=d;var e=new a;b&&c.mixin(e,b);return e};c.inherits=function(d,b){d.super_=b;d.prototype=c.prototypicalClone(b.prototype,{constructor:d})};c.containsValue=function(d,b){for(var a in d)if(d[a]==b)return!0;return!1};c.intersect=function(d,b){return c.isArray(b)?c.arrIntersect(d,b):c.arrIntersectOb(d,b)};c.isArray=Array.isArray?Array.isArray:function(d){return"[object Array]"===
Object.prototype.toString.call(d)};c.arrIntersect=function(d,b){for(var a=[],e=0;e<d.length;e++){var k=d[e];-1!=c.arrIndexOf(b,k)&&a.push(k)}return a};c.arrIntersectOb=function(d,b){for(var a=[],c=0;c<d.length;c++){var e=d[c];e in b&&a.push(e)}return a};c.arrSubtract=function(d,b){for(var a=[],e=0;e<d.length;e++){var k=d[e];-1==c.arrIndexOf(b,k)&&a.push(k)}return a};c.arrIndexOf=Array.prototype.indexOf?function(a,b,c){return a.indexOf(b,c)}:function(a,b,c){c=c||0;for(var e=a.length;c<e;c++)if(a[c]===
b)return c;return-1};c.keysArray=function(a,b){var c=[],e;for(e in a)b&&!a.hasOwnProperty(e)||c.push(e);return c.length?c:void 0};c.valuesArray=function(a,b){var c=[],e;for(e in a)b&&!a.hasOwnProperty(e)||c.push(a[e]);return c.length?c:void 0};c.nextTick=e?function(a){setTimeout(a,0)}:process.nextTick;var a={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};c.defaultGetHeaders=function(d){d=d||"json";return{accept:"json"===
d?a.json:a[d]+","+a.json}};c.defaultPostHeaders=function(d){d=d||"json";return{accept:"json"===d?a.json:a[d]+","+a.json,"content-type":"json"===d?a.json:a[d]}};c.arrRandomElement=function(a){return a.splice(Math.floor(Math.random()*a.length))};c.toQueryString=function(a){var b=[];if(a)for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.length?"?"+b.join("&"):""};c.parseQueryString=function(a){for(var b,c=/([^?&=]+)=?([^&]*)/g,e={};b=c.exec(a);)e[decodeURIComponent(b[1])]=
decodeURIComponent(b[2]);return e};return c}(),S=function(){return function(c){c=c||[];var e=function(){for(var a=0;a<c.length;a++){var d=c[a];try{d.apply(null,arguments)}catch(b){}}};e.push=function(){Array.prototype.push.apply(c,arguments)};return e}}(),H=function(){function c(c,a,d){this.message=c;this.code=a;this.statusCode=d}c.prototype.toString=function(){var c="["+this.constructor.name;this.message&&(c+=": "+this.message);this.statusCode&&(c+="; statusCode="+this.statusCode);this.code&&(c+=
"; code="+this.code);return c+"]"};c.fromValues=function(e){return m.mixin(new c,e)};return c}(),B=function(){function c(){this.encoding=this.data=this.connectionId=this.clientId=this.timestamp=this.id=this.name=void 0}var l="object"==typeof window?window.Ably.msgpack:(void 0)("msgpack-js");c.prototype.toJSON=function(){var a={name:this.name,clientId:this.clientId,connectionId:this.connectionId,timestamp:this.timestamp,encoding:this.encoding},d=this.data;if(0<arguments.length&&x.isBuffer(d)){var b=
this.encoding;a.encoding=b?b+"/base64":"base64";d=x.base64Encode(d)}a.data=d;return a};c.prototype.toString=function(){var a="[Message";this.name&&(a+="; name="+this.name);this.id&&(a+="; id="+this.id);this.timestamp&&(a+="; timestamp="+this.timestamp);this.clientId&&(a+="; clientId="+this.clientId);this.connectionId&&(a+="; connectionId="+this.connectionId);this.encoding&&(a+="; encoding="+this.encoding);this.data&&(a="string"==typeof data?a+("; data="+this.data):x.isBuffer(this.data)?a+("; data (buffer)="+
x.base64Encode(this.data)):a+("; data (json)="+JSON.stringify(this.data)));return a+"]"};c.encrypt=function(a,d){var b=a.data,c=a.encoding,e=d.cipher,c=c?c+"/":"";x.isBuffer(b)||(b=x.utf8Encode(String(b)),c+="utf-8/");a.data=e.encrypt(b);a.encoding=c+"cipher+"+e.algorithm};c.encode=function(a,d){var b=a.data,e;"string"==typeof b||x.isBuffer(b)||(a.data=JSON.stringify(b),a.encoding=(e=a.encoding)?e+"/json":"json");null!=d&&d.encrypted&&c.encrypt(a,d)};c.toRequestBody=function(a,d,b){for(var e=0;e<
a.length;e++)c.encode(a[e],d);return"msgpack"==b?l.encode(a,!0):JSON.stringify(a)};c.decode=function(a,d){var b=a.encoding;if(b){var b=b.split("/"),c,h=b.length,k=a.data;try{for(;0<(c=h);){var n=b[--h].match(/([\-\w]+)(\+([\w\-]+))?/);if(!n)break;switch(n[1]){case "base64":k=x.base64Decode(String(k));continue;case "utf-8":k=x.utf8Decode(k);continue;case "json":k=JSON.parse(k);continue;case "cipher":if(null!=d&&d.encrypted){var f=d.cipher;if(n[3]!=f.algorithm){e.logAction(e.LOG_ERROR,"Message.decode()",
"Unable to decrypt message with given cipher; incompatible cipher params");break}k=f.decrypt(k);continue}}break}}finally{a.encoding=0>=c?null:b.slice(0,c).join("/"),a.data=k}}};c.fromResponseBody=function(a,d,b){b&&(a="msgpack"==b?l.decode(a):JSON.parse(String(a)));for(b=0;b<a.length;b++){var e=a[b]=c.fromDecoded(a[b]);c.decode(e,d)}return a};c.fromDecoded=function(a){return m.mixin(new c,a)};c.fromValues=function(a){return m.mixin(new c,a)};c.fromValuesArray=function(a){for(var d=a.length,b=Array(d),
e=0;e<d;e++)b[e]=c.fromValues(a[e]);return b};return c}(),C=function(){function c(){this.encoding=this.data=this.connectionId=this.clientId=this.timestamp=this.id=this.action=void 0}var e="object"==typeof window?window.Ably.msgpack:(void 0)("msgpack-js");c.Action={ABSENT:0,PRESENT:1,ENTER:2,LEAVE:3,UPDATE:4};c.prototype.toJSON=function(){var a={name:this.name,clientId:this.clientId,connectionId:this.connectionId,timestamp:this.timestamp,action:this.action,encoding:this.encoding},d=this.data;if(0<
arguments.length&&x.isBuffer(d)){var b=this.encoding;a.encoding=b?b+"/base64":"base64";d=d.toString("base64")}a.data=d;return a};c.prototype.toString=function(){var a;a="[PresenceMessage; action="+this.action;this.id&&(a+="; id="+this.id);this.timestamp&&(a+="; timestamp="+this.timestamp);this.clientId&&(a+="; clientId="+this.clientId);this.encoding&&(a+="; encoding="+this.encoding);this.data&&(a="string"==typeof data?a+("; data="+this.data):x.isBuffer(this.data)?a+("; data (buffer)="+x.base64Encode(this.data)):
a+("; data (json)="+JSON.stringify(this.data)));return a+"]"};c.encode=B.encode;c.decode=B.decode;c.fromResponseBody=function(a,d,b){b&&(body="msgpack"==b?e.decode(body):JSON.parse(String(body)));for(a=0;a<body.length;a++)b=body[a]=c.fromDecoded(body[a]),c.decode(b,d);return body};c.fromDecoded=function(a){return m.mixin(new c,a)};c.fromValues=function(a){return m.mixin(new c,a)};c.fromValuesArray=function(a){for(var d=a.length,b=Array(d),e=0;e<d;e++)b[e]=c.fromValues(a[e]);return b};return c}(),
u=function(){function c(){this.presence=this.messages=this.msgSerial=this.channelSerial=this.channel=this.connectionSerial=this.connectionKey=this.connectionId=this.error=this.count=this.timestamp=this.id=this.flags=this.action=void 0}var e="object"==typeof window?window.Ably.msgpack:(void 0)("msgpack-js");c.Action={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16};c.Flag=
{HAS_PRESENCE:0,HAS_BACKLOG:1};c.encode=function(a,d){return"msgpack"==d?e.encode(a,!0):JSON.stringify(a)};c.decode=function(a,d){var b="msgpack"==d?e.decode(a):JSON.parse(String(a));return c.fromDecoded(b)};c.fromDecoded=function(a){var d=a.error;d&&(a.error=H.fromValues(d));var b=a.messages;if(b)for(d=0;d<b.length;d++)b[d]=B.fromDecoded(b[d]);if(b=a.presence)for(d=0;d<b.length;d++)b[d]=C.fromDecoded(b[d]);return m.mixin(new c,a)};c.fromValues=function(a){return m.mixin(new c,a)};return c}(),L={disconnected:{statusCode:408,
code:80003,message:"Connection to server temporarily unavailable"},suspended:{statusCode:408,code:80002,message:"Connection to server unavailable"},failed:{statusCode:408,code:8E4,message:"Connection failed or disconnected by server"},unknownConnectionErr:{statusCode:500,code:50002,message:"Internal connection error"},unknownChannelErr:{statusCode:500,code:50001,message:"Internal channel error"}},y=function(){function c(b,a,d,c,e){this.options=b;this.host=a;this.mode=d;this.connectionKey=c;this.connectionSerial=
e;this.format=b.useBinaryProtocol?"msgpack":"json";b.transportParams&&void 0!==b.transportParams.stream&&(this.stream=b.transportParams.stream)}function l(b,a){this.msg=b;var d=b.action;this.ackRequired=d==g.MESSAGE||d==g.PRESENCE;this.callback=a;this.merged=!1}function a(d,c){r.call(this);this.realtime=d;this.options=c;this.state=k.initialized;this.error=null;this.queuedMessages=[];this.pendingMessages=[];this.msgSerial=0;this.connectionSerial=this.connectionKey=void 0;this.httpTransports=m.intersect(c.transports||
q.httpTransports,a.httpTransports);this.transports=m.intersect(c.transports||q.transports,a.transports);this.upgradeTransports=m.arrSubtract(this.transports,this.httpTransports);this.httpHosts=q.getHosts(c);this.host=this.pendingTransport=this.transport=null;e.logAction(e.LOG_MINOR,"Realtime.ConnectionManager()","started");e.logAction(e.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(c.transports||q.transports)+"]");e.logAction(e.LOG_MICRO,"Realtime.ConnectionManager()","available http transports = ["+
this.httpTransports+"]");e.logAction(e.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]");e.logAction(e.LOG_MICRO,"Realtime.ConnectionManager()","http hosts = ["+this.httpHosts+"]");if(!this.transports.length)throw e.logAction(e.LOG_ERROR,"realtime.ConnectionManager()","no requested transports available"),Error("no requested transports available");b&&!0===c.recover&&window.addEventListener&&window.addEventListener("beforeunload",this.persistConnection.bind(this))}
var d="undefined"!==typeof P&&P.read,b="undefined"!==typeof P&&P.create,g=u.Action,h=function(){},k={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:q.connectTimeout,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:q.disconnectTimeout},
suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:q.suspendedTimeout},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:q.connectTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1}};c.prototype.getConnectParams=function(b){b=b?m.prototypicalClone(b):{};var a=this.options;switch(this.mode){case "upgrade":b.upgrade=this.connectionKey;void 0!==
this.connectionSerial&&(b.connection_serial=this.connectionSerial);break;case "resume":b.resume=this.connectionKey;void 0!==this.connectionSerial&&(b.connection_serial=this.connectionSerial);break;case "recover":if(!0===a.recover){var c=d("ably-connection-key"),e=d("ably-connection-serial");null!==c&&null!==e&&(b.recover=c,b.connection_serial=e)}else if(c=a.recover.match(/^(\w+):(\w+)$/))b.recover=c[1],b.connection_serial=c[2]}!1===a.echoMessages&&(b.echo="false");void 0!==this.format&&(b.format=
this.format);void 0!==this.stream&&(b.stream=this.stream);return b};m.inherits(a,r);a.httpTransports={};a.transports={};a.prototype.chooseTransport=function(b){e.logAction(e.LOG_MAJOR,"ConnectionManager.chooseTransport()","");if(this.transport)e.logAction(e.LOG_MINOR,"ConnectionManager.chooseTransport()","Transport already established"),b(null,this.transport);else{var a=this.connectionKey?"resume":this.options.recover?"recover":"clean",d=new c(this.options,null,a,this.connectionKey,this.connectionSerial);
e.logAction(e.LOG_MINOR,"ConnectionManager.chooseTransport()","Transport recovery mode = "+a+("clean"==a?"":"; connectionKey = "+this.connectionKey+"; connectionSerial = "+this.connectionSerial));var g=this;this.httpTransports.length?this.chooseHttpTransport(d,function(a,f){if(a)e.logAction(e.LOG_ERROR,"ConnectionManager.chooseTransport()","Unexpected error establishing transport; err = "+a),b(a);else if(e.logAction(e.LOG_MINOR,"ConnectionManager.chooseTransport()","Establishing http transport: "+
f),b(null,f),g.upgradeTransports.length)f.once("connected",function(b,a){m.nextTick(function(){e.logAction(e.LOG_MAJOR,"ConnectionManager.chooseTransport()","upgrading ... connectionKey = "+a);d=new c(g.options,d.host,"upgrade",a);g.chooseTransportForHost(d,g.upgradeTransports.slice(),h)})})}):(d.host=this.httpHosts[0],e.logAction(e.LOG_MINOR,"ConnectionManager.chooseTransport()","No http transports available; ignoring fallback hosts"),this.chooseTransportForHost(d,g.transports.slice(),b))}};a.prototype.chooseTransportForHost=
function(b,d,c){var g=d.shift();if(g){var h=this;e.logAction(e.LOG_MICRO,"ConnectionManager.chooseTransportForHost()","trying "+g);a.transports[g].tryConnect(this,this.realtime.auth,b,function(a,l){var m=h.state;m==k.closing||m==k.closed||m==k.failed?(e.logAction(e.LOG_MINOR,"ConnectionManager.chooseTransportForHost()","connection closing"),l&&(e.logAction(e.LOG_MINOR,"ConnectionManager.chooseTransportForHost()","closing transport = "+l),l.close()),a=new H("Connection already closed",400,80017),a.terminal=
!0,c(a)):a?h.chooseTransportForHost(b,d,c):(e.logAction(e.LOG_MICRO,"ConnectionManager.chooseTransport()","transport "+g+" connecting"),h.setTransportPending(l),c(null,l))})}else{var l=Error("Unable to connect (no available transport)");l.statusCode=404;l.code=8E4;c(l)}};a.prototype.chooseHttpTransport=function(b,d){function c(){if(e.length)a.httpTransports[h.httpTransports[0]].checkConnectivity(function(a,g){a?d(a):g?(b.host=m.arrRandomElement(e),h.chooseTransportForHost(b,h.httpTransports.slice(),
function(b,a){b?b.terminal||c():d(null,a)})):(a=Error("Unable to connect (network unreachable)"),a.statusCode=404,a.code=8E4,d(a))});else{var g=Error("Unable to connect (no available host)");g.statusCode=404;g.code=8E4;d(g)}}var e=this.httpHosts.slice(),g=e.shift();if(g){b.host=g;var h=this;this.chooseTransportForHost(b,this.httpTransports.slice(),function(b,a){b?b.terminal||c():d(null,a)})}else g=Error("Unable to connect (no available host)"),g.statusCode=404,g.code=8E4,d(g)};a.prototype.setTransportPending=
function(b){e.logAction(e.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+b);this.pendingTransport&&this.pendingTransport.disconnect();this.pendingTransport=b;for(var a=this,d=function(d){return function(c,g,h,k){e.logAction(e.LOG_MINOR,"ConnectionManager.setTransportPending","on state = "+d);c&&c.message&&e.logAction(e.LOG_MICRO,"ConnectionManager.setTransportPending","reason =  "+c.message);g&&e.logAction(e.LOG_MICRO,"ConnectionManager.setTransportPending","connectionKey =  "+
g);void 0!==h&&e.logAction(e.LOG_MICRO,"ConnectionManager.setTransportPending","connectionSerial =  "+h);k&&e.logAction(e.LOG_MICRO,"ConnectionManager.setTransportPending","connectionId =  "+k);"connected"==d?(a.activateTransport(b,g,h,k),g=!0):g=a.deactivateTransport(b);g&&a.notifyState({state:d,error:c})}},c=["connected","disconnected","closed","failed"],g=0;g<c.length;g++){var h=c[g];b.on(h,d(h))}this.emit("transport.pending",b)};a.prototype.activateTransport=function(a,d,c,g){e.logAction(e.LOG_MINOR,
"ConnectionManager.activateTransport()","transport = "+a+"; connectionKey = "+d+"; connectionSerial = "+c);if(this.state!=k.closing&&this.state!=k.closed){var h=this.transport;h&&(this.transport=null,h.disconnect());if(h=this.pendingTransport)this.pendingTransport=null,h!==a&&h.disconnect();this.transport=a;this.host=a.params.host;d&&this.connectionKey!=d&&(this.realtime.connection.id=g,this.realtime.connection.key=this.connectionKey=d,this.connectionSerial=void 0===c?-1:c,b&&!0===this.options.recover&&
this.persistConnection(),this.msgSerial=0);var l=this;a.on("ack",function(b,a){e.logAction(e.LOG_MICRO,"ConnectionManager on(ack)","serial = "+b+"; count = "+a);l.ackMessage(b,a)});a.on("nack",function(b,a,d){e.logAction(e.LOG_ERROR,"ConnectionManager on(nack)","serial = "+b+"; count = "+a+"; err = "+d);d||(d=Error("Unknown error"),d.statusCode=500,d.code=50001,d.message="Unable to send message; channel not responding");l.ackMessage(b,a,d)});this.emit("transport.active",a,d,a.params)}};a.prototype.deactivateTransport=
function(b){var a=this.transport===b,d=null===this.transport&&this.pendingTransport===b;e.logAction(e.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+b);b.off("ack");b.off("nack");a?this.transport=this.host=null:d&&(this.pendingTransport=null);this.emit("transport.inactive",b);return a||d};a.prototype.persistConnection=function(){b&&this.connectionKey&&void 0!==this.connectionSerial&&(b("ably-connection-key",this.connectionKey,q.connectionPersistTimeout),b("ably-connection-serial",
this.connectionSerial,q.connectionPersistTimeout))};a.prototype.getStateError=function(){return L[this.state.state]};a.activeState=function(b){return b.queueEvents||b.sendEvents};a.prototype.enactStateChange=function(b){e.logAction(e.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+b.current+"; reason = "+(b.reason&&b.reason.message));this.state=k[b.current];this.state.terminal&&(this.error=b.reason);this.emit("connectionstate",b,this.transport)};a.prototype.startTransitionTimer=
function(b){e.logAction(e.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+b);this.transitionTimer&&(e.logAction(e.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer));var a=this;this.transitionTimer=setTimeout(function(){a.transitionTimer&&(a.transitionTimer=null,e.logAction(e.LOG_MINOR,"ConnectionManager connect timer expired","requesting new state: "+k.connecting.failState),a.notifyState({state:b.failState}))},
q.connectTimeout)};a.prototype.cancelTransitionTimer=function(){e.logAction(e.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()","");this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=null)};a.prototype.startSuspendTimer=function(){var b=this;this.suspendTimer||(this.suspendTimer=setTimeout(function(){b.suspendTimer&&(b.suspendTimer=null,e.logAction(e.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),k.connecting.failState="suspended",
k.connecting.queueEvents=!1,b.notifyState({state:"suspended"}))},q.suspendedTimeout))};a.prototype.checkSuspendTimer=function(b){"disconnected"!==b&&"suspended"!==b&&this.cancelSuspendTimer()};a.prototype.cancelSuspendTimer=function(){k.connecting.failState="disconnected";k.connecting.queueEvents=!0;this.suspendTimer&&(clearTimeout(this.suspendTimer),this.suspendTimer=null)};a.prototype.startRetryTimer=function(b){var a=this;this.retryTimer=setTimeout(function(){e.logAction(e.LOG_MINOR,"ConnectionManager retry timer expired",
"retrying");a.retryTimer=null;a.requestState({state:"connecting"})},b)};a.prototype.cancelRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)};a.prototype.notifyState=function(b){var a=b.state;e.logAction(e.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+a);a!=this.state.state&&(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(),this.state.terminal||(a=k[b.state],b=new T(this.state.state,a.state,a.retryDelay,b.error||L[a.state]),
a.retryDelay&&this.startRetryTimer(a.retryDelay),this.enactStateChange(b),this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents?this.queuePendingMessages():this.realtime.channels.setSuspended(b.reason)))};a.prototype.requestState=function(b){var a=b.state,d=this;e.logAction(e.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+a);if(a!=this.state.state){this.cancelTransitionTimer();this.cancelRetryTimer();this.cancelSuspendTimer();if("connecting"==a){if("connected"==
this.state.state)return;m.nextTick(function(){d.connectImpl()})}else if("closing"==a){if("closed"==this.state.state)return;m.nextTick(function(){d.closeImpl()})}a=k[a];b=new T(this.state.state,a.state,a.retryIn,b.error||L[a.state]);this.enactStateChange(b)}};a.prototype.connectImpl=function(){e.logAction(e.LOG_MINOR,"ConnectionManager.connectImpl()","starting connection");this.startSuspendTimer();this.startTransitionTimer(k.connecting);var b=this,a=this.realtime.auth,d=function(c){e.logAction(e.LOG_ERROR,
"ConnectionManager.connectImpl()",c);var g=b.state;g!=k.closing&&g!=k.closed&&g!=k.failed&&(401==c.statusCode&&-1!=c.message.indexOf("expire")&&"token"==a.method&&a.getToken(!0,function(a){a?d(a):b.connectImpl()}),b.notifyState({state:k.connecting.failState,error:c}))},c=function(){b.chooseTransport(function(b,a){b&&d(b)})};"basic"==a.method?c():a.authorise(null,null,function(b){b?d(b):c()})};a.prototype.closeImpl=function(){function b(a){if(a)try{e.logAction(e.LOG_MINOR,"ConnectionManager.closeImpl()",
"closing transport: "+a),a.close()}catch(d){var c="Unexpected exception attempting to close transport; e = "+d;e.logAction(e.LOG_ERROR,"ConnectionManager.closeImpl()",c);c=new H(c,5E4,500);a.abort(c)}}e.logAction(e.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection");this.cancelSuspendTimer();this.startTransitionTimer(k.closing);b(this.pendingTransport);b(this.transport);this.notifyState({state:"closed"})};a.prototype.send=function(b,a,d){d=d||h;var c=this.state;c.sendEvents?(e.logAction(e.LOG_MICRO,
"ConnectionManager.send()","sending event"),this.sendImpl(new l(b,d))):c.queueEvents&&(a?this.queue(b,d):(e.logAction(e.LOG_MICRO,"ConnectionManager.send()","rejecting event; state = "+c.state),d(this.error)))};a.prototype.sendImpl=function(b){var a=b.msg;b.ackRequired&&(a.msgSerial=this.msgSerial++,this.pendingMessages.push(b));try{this.transport.send(a,function(b){})}catch(d){e.logAction(e.LOG_ERROR,"ConnectionManager.sendQueuedMessages()","Unexpected exception in transport.send(): "+d)}};a.prototype.ackMessage=
function(b,a,d){e.logAction(e.LOG_MICRO,"ConnectionManager.ackMessage()","serial = "+b+"; count = "+a);d=d||null;var c=this.pendingMessages,g=c[0];if(g&&(g=g.msg.msgSerial,b+=a,b>g))for(c=c.splice(0,b-g),b=0;b<c.length;b++)c[b].callback(d)};a.prototype.queue=function(b,a){e.logAction(e.LOG_MICRO,"ConnectionManager.queue()","queueing event");var d=this.queuedMessages[this.queuedMessages.length-1];d&&X.mergeTo(d.msg,b)?(d.merged||(d.callback=S([d.callback]),d.merged=!0),d.callback.push(a)):this.queuedMessages.push(new l(b,
a))};a.prototype.sendQueuedMessages=function(){e.logAction(e.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.length+" queued messages");for(var b;b=this.queuedMessages.shift();)this.sendImpl(b)};a.prototype.queuePendingMessages=function(){e.logAction(e.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+this.pendingMessages.length+" pending messages");this.queuedMessages=this.pendingMessages.concat(this.queuedMessages);this.pendingMessages=[]};a.prototype.onChannelMessage=
function(b,a){if(a===this.transport){var d=b.connectionSerial;void 0!==d&&(this.connectionSerial=d)}this.realtime.channels.onChannelMessage(b)};a.prototype.ping=function(b,a){e.logAction(e.LOG_MINOR,"ConnectionManager.ping()","transport = "+b);if(b){var d=function(){clearTimeout(c);a(null)},c=setTimeout(function(){b.off("heartbeat",d);a(new H("Timedout waiting for heartbeat response",5E4,500))},q.sendTimeout);b.once("heartbeat",d);b.ping()}else if("connected"!==this.state.state)a(new H("Unable to ping service; not connected",
4E4,400));else{var g=!1,h=this,k=function(){g||(g=!0,m.nextTick(function(){h.ping(null,a)}))};this.on("transport.active",k);this.ping(this.transport,function(b){h.off("transport.active",k);g||(g=!0,a(b))})}};return a}(),D=function(){function c(b,a,d){r.call(this);this.connectionManager=b;this.auth=a;this.params=d;this.format=d.format;this.isConnected=!1}var l=u.Action,a=u.fromValues({action:l.CLOSE}),d=function(){};m.inherits(c,r);c.prototype.connect=function(){};c.prototype.close=function(){this.isConnected&&
this.sendClose();this.emit("closed");this.dispose()};c.prototype.disconnect=function(){this.isConnected&&(this.isConnected=!1);this.emit("disconnected",L.disconnected);this.dispose()};c.prototype.abort=function(b){this.isConnected&&(this.isConnected=!1,this.sendClose());this.emit("failed",b);this.dispose()};c.prototype.onChannelMessage=function(b){switch(b.action){case l.HEARTBEAT:e.logAction(e.LOG_MICRO,"Transport.onChannelMessage()","heartbeat; connectionKey = "+this.connectionManager.connectionKey);
this.emit("heartbeat");break;case l.CONNECTED:this.onConnect(b);this.emit("connected",null,b.connectionKey,b.connectionSerial,b.connectionId);break;case l.CLOSED:this.isConnected=!1;this.onClose(b);break;case l.DISCONNECTED:this.isConnected=!1;this.onDisconnect();break;case l.ACK:this.emit("ack",b.msgSerial,b.count);break;case l.NACK:this.emit("nack",b.msgSerial,b.count,b.error);break;case l.ERROR:var a=b.error;e.logAction(e.LOG_ERROR,"Transport.onChannelMessage()","error; connectionKey = "+this.connectionManager.connectionKey+
"; err = "+JSON.stringify(a));if(!b.channel){this.abort({statusCode:a.statusCode,code:a.code,message:a.message});break}default:this.connectionManager.onChannelMessage(b,this)}};c.prototype.onConnect=function(b){var a=b.connectionKey=b.connectionKey.split("!").pop(),d=b.error,c=this.connectionManager;d&&b.connectionKey!==c.connectionKey&&c.realtime.channels.setSuspended(d);this.connectionKey=a;this.isConnected=!0};c.prototype.onDisconnect=function(b){this.isConnected=!1;b=b&&b.error;e.logAction(e.LOG_MINOR,
"Transport.onDisconnect()","err = "+b);this.emit("disconnected",b)};c.prototype.onClose=function(b){this.isConnected=!1;b=b&&b.error;e.logAction(e.LOG_MINOR,"Transport.onClose()","err = "+b);this.emit("closed",b)};c.prototype.sendClose=function(){e.logAction(e.LOG_MINOR,"Transport.sendClose()","");this.send(a)};c.prototype.ping=function(b){this.send(u.fromValues({action:u.Action.HEARTBEAT}),b||d)};c.prototype.dispose=function(){e.logAction(e.LOG_MINOR,"Transport.dispose()","");this.off()};return c}();
(function(){function c(a,d,b){D.call(this,a,d,b);this.wsHost=q.getHost(b.options,b.host,!0)}var l="object"==typeof window?window.WebSocket||window.MozWebSocket:(void 0)("ws");m.inherits(c,D);c.isAvailable=function(){return!!l};c.isAvailable()&&(y.transports.web_socket=c);c.tryConnect=function(a,d,b,g){var h=new c(a,d,b),k=function(b){g(b)};h.on("wserror",k);h.on("wsopen",function(){e.logAction(e.LOG_MINOR,"WebSocketTransport.tryConnect()","viable transport "+h);h.off("wserror",k);g(null,h)});h.connect()};
c.prototype.createWebSocket=function(a,d){var b=0;if(d)for(var c in d)a+=(b++?"&":"?")+c+"="+d[c];this.uri=a;return new l(a)};c.prototype.toString=function(){return"WebSocketTransport; uri="+this.uri};c.prototype.connect=function(){e.logAction(e.LOG_MINOR,"WebSocketTransport.connect()","starting");D.prototype.connect.call(this);var a=this,d=this.params,b=d.options,c=(b.tls?"wss://":"ws://")+this.wsHost+":"+q.getPort(b)+"/";e.logAction(e.LOG_MINOR,"WebSocketTransport.connect()","uri: "+c);this.auth.getAuthParams(function(b,
k){var l="",f;for(f in k)l+=" "+f+": "+k[f]+";";e.logAction(e.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+l);if(b)a.abort(b);else{l=d.getConnectParams(k);try{var p=a.wsConnection=a.createWebSocket(c,l);p.binaryType="arraybuffer";p.onopen=function(){a.onWsOpen()};p.onclose=function(b){a.onWsClose(b)};p.onmessage=function(b){a.onWsData(b.data)};p.onerror=function(b){a.onWsError(b)}}catch(m){a.onWsError(m)}}})};c.prototype.send=function(a){var d=this.wsConnection;d&&d.send(u.encode(a,this.params.format))};
c.prototype.onWsData=function(a){e.logAction(e.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+a.length+"; type = "+typeof a);try{this.onChannelMessage(u.decode(a,this.format))}catch(d){e.logAction(e.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+d.stack)}};c.prototype.onWsOpen=function(){e.logAction(e.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket");this.emit("wsopen")};c.prototype.onWsClose=function(a){var d;"object"==
typeof a?(d=a.wasClean,a=a.code):d=1E3==a;e.logAction(e.LOG_MINOR,"WebSocketTransport.onWsClose()","closed WebSocket; wasClean = "+d+"; code = "+a);delete this.wsConnection;d=d?null:new H("Unclean disconnection of websocket",80003);D.prototype.onDisconnect.call(this,d)};c.prototype.onWsError=function(a){e.logAction(e.LOG_ERROR,"WebSocketTransport.onError()","Unexpected error from WebSocket: "+a);this.emit("wserror",a);this.abort()};c.prototype.dispose=function(){e.logAction(e.LOG_MINOR,"WebSocketTransport.dispose()",
"");var a=this.wsConnection;a&&(delete this.wsConnection,m.nextTick(function(){e.logAction(e.LOG_MINOR,"WebSocketTransport.dispose()","closing websocket");a.close()}))};return c})();var O=function(){function c(c,a,d){d.format=void 0;D.call(this,c,a,d);this.stream="stream"in d?d.stream:!0;this.pendingItems=this.pendingCallback=this.recvRequest=this.sendRequest=null;this.disposed=!1}m.inherits(c,D);c.REQ_SEND=0;c.REQ_RECV=1;c.REQ_RECV_POLL=2;c.REQ_RECV_STREAM=3;c.prototype.connect=function(){e.logAction(e.LOG_MINOR,
"CometTransport.connect()","starting");D.prototype.connect.call(this);var c=this,a=this.params,d=a.options,a=q.getHost(d,a.host),b=q.getPort(d);this.baseUri=(d.tls?"https://":"http://")+a+":"+b+"/comet/";var g=this.baseUri+"connect";e.logAction(e.LOG_MINOR,"CometTransport.connect()","uri: "+g);this.auth.getAuthParams(function(b,a){if(b)c.abort(b);else{c.authParams=a;var d=c.params.getConnectParams(a);e.logAction(e.LOG_MINOR,"CometTransport.connect()","connectParams:"+m.toQueryString(d));var f=!1,
d=c.recvRequest=c.createRequest(g,null,d,null,c.stream?3:1);d.on("data",function(b){c.recvRequest&&(f||(f=!0,c.emit("preconnect")),c.onData(b))});d.on("complete",function(b){c.recvRequest||(b=b||new H("Request cancelled",400,80017));c.recvRequest=null;b&&c.emit("error",b)});d.exec()}})};c.prototype.disconnect=function(){e.logAction(e.LOG_MINOR,"CometTransport.disconnect()","");this.requestClose(!1);this.emit("disconnected");this.dispose()};c.prototype.close=function(){e.logAction(e.LOG_MINOR,"CometTransport.close()",
"");this.requestClose(!0);this.emit("closed");this.dispose()};c.prototype.abort=function(){e.logAction(e.LOG_MINOR,"CometTransport.abort()","");this.requestClose(!0);this.emit("failed");this.dispose()};c.prototype.requestClose=function(c){e.logAction(e.LOG_MINOR,"CometTransport.requestClose()","closing = "+c);var a=this.closeUri;if(a){var d=this;c=this.createRequest(a(c),null,this.authParams,null,0);c.on("complete",function(b){b&&d.emit("error",b)});c.exec()}};c.prototype.dispose=function(){e.logAction(e.LOG_MINOR,
"CometTransport.dispose()","");this.disposed||(this.disposed=!0,this.recvRequest&&(e.logAction(e.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null))};c.prototype.onConnect=function(c){if(!this.disposed){var a=c.connectionKey;D.prototype.onConnect.call(this,c);var d=this.baseUri+a;e.logAction(e.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+d+"; connectionKey = "+c.connectionKey);this.sendUri=d+"/send";this.recvUri=d+"/recv";this.closeUri=
function(b){return d+(b?"/close":"/disconnect")};var b=this;m.nextTick(function(){b.recv()})}};c.prototype.send=function(c,a){if(this.sendRequest)this.pendingItems=this.pendingItems||[],this.pendingItems.push(c),this.pendingCallback=this.pendingCallback||S(),this.pendingCallback.push(a);else{var d=this.pendingItems||[];d.push(c);this.pendingItems=null;var b=this.pendingCallback;b&&(b.push(a),a=b,this.pendingCallback=null);this.sendItems(d,a)}};c.prototype.sendItems=function(c,a){var d=this,b=this.sendRequest=
d.createRequest(d.sendUri,null,d.authParams,this.encodeRequest(c),0);b.on("complete",function(b,c){b&&e.logAction(e.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+JSON.stringify(b));d.sendRequest=null;if(c)d.onData(c);var k=d.pendingItems;if(k){d.pendingItems=null;var n=d.pendingCallback;d.pendingCallback=null;m.nextTick(function(){d.sendItems(k,n)})}a(b)});b.exec()};c.prototype.recv=function(){if(!this.recvRequest&&this.isConnected){var c=this,a=this.recvRequest=this.createRequest(this.recvUri,
null,this.authParams,null,c.stream?3:2);a.on("data",function(a){c.onData(a)});a.on("complete",function(a){c.recvRequest=null;a?c.emit("error",a):m.nextTick(function(){c.recv()})});a.exec()}};c.prototype.onData=function(c){try{var a=this.decodeResponse(c);if(a&&a.length)for(c=0;c<a.length;c++)this.onChannelMessage(a[c])}catch(d){e.logAction(e.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+d.stack)}};c.prototype.encodeRequest=function(c){return JSON.stringify(c)};
c.prototype.decodeResponse=function(c){"string"==typeof c&&(c=JSON.parse(c));return c};return c}(),Y=function(){function c(){}function e(b,a,d,c,n){s.supportsAuthHeaders?b.auth.getAuthHeaders(function(b,e){b?c(b):n(m.mixin(e,a),d)}):b.auth.getAuthParams(function(b,e){b?c(b):n(a,m.mixin(e,d))})}function a(b,a){return function(c,e,n,f){if(c)b(c);else{if(!f)try{e="msgpack"==a?d.decode(e):JSON.parse(e)}catch(p){b(p);return}f=e.statusCode;c=e.response;n=e.headers;200>f||300<=f?(c=c&&c.error,c||(c=Error(String(res)),
c.statusCode=f),b(c)):b(null,c,n,!0)}}}var d="object"==typeof window?window.Ably.msgpack:(void 0)("msgpack-js");c.get=function(b,d,c,k,n,f){function p(a,n){s.get(b,d,a,n,function(a,d,g,n){a&&40140==a.code?b.auth.authorise({force:!0},null,function(a){a?f(a):e(b,c,k,f,p)}):f(a,d,g,n)})}n&&(f=f&&a(f,n),(k=k||{}).envelope=n);e(b,c,k,f,p)};c.post=function(b,d,c,k,n,f,p){function m(a,f){s.post(b,d,a,c,f,function(a,d,c,g){a&&40140==a.code?b.auth.authorise({force:!0},null,function(a){a?p(a):e(b,k,n,p,m)}):
p(a,d,c,g)})}f&&(p=a(p,f),n.envelope=f);e(b,k,n,p,m)};return c}(),Q=function(){function c(c,a,d,b,e,h){this.rest=c;this.path=a;this.headers=d;this.params=b;this.envelope=e;this.bodyHandler=h}c.prototype.get=function(c){var a=this;Y.get(this.rest,this.path,this.headers,this.params,this.envelope,function(d,b,g,h){if(d)e.logAction(e.LOG_ERROR,"PaginatedResource.get()","Unexpected error getting resource: err = "+JSON.stringify(d));else{var k,n,f;try{k=a.bodyHandler(b,g,h)}catch(p){c(p);return}if(g&&(n=
g.Link||g.link)){d=n;"string"==typeof d&&(d=d.split(","));b={};for(g=0;g<d.length;g++)(h=d[g].match(/^\s*<(.+)>;\s*rel="(\w+)"$/))&&(n=(n=h[1].match(/^\.\/(\w+)\?(.*)$/))&&m.parseQueryString(n[2]))&&(b[h[2]]=n);f=b}c(null,k,f)}})};return c}(),aa=function(){function c(){}function l(b){if(!b)return"";"string"==typeof b&&(b=JSON.parse(b));var a={},c=m.keysArray(b,!0);if(!c)return"";c.sort();for(var d=0;d<c.length;d++)a[c[d]]=b[c[d]].sort();return JSON.stringify(a)}function a(b,a){this.rest=b;this.tokenParams=
{};if(a.keyValue){if(!a.clientId){e.logAction(e.LOG_MINOR,"Auth()","anonymous, using basic auth");this.method="basic";this.basicKey=k(a.key||a.keyId+":"+a.keyValue);this.keyId=a.keyId;this.keyValue=a.keyValue;return}if(!h){var c="client-side token request signing not supported";e.logAction(e.LOG_ERROR,"Auth()",c);throw Error(c);}}this.method="token";a.authToken&&(this.token={id:a.authToken});if(a.authCallback)e.logAction(e.LOG_MINOR,"Auth()","using token auth with authCallback");else if(a.authUrl)e.logAction(e.LOG_MINOR,
"Auth()","using token auth with authUrl");else if(a.keyValue)e.logAction(e.LOG_MINOR,"Auth()","using token auth with client-side signing");else if(this.token)e.logAction(e.LOG_MINOR,"Auth()","using token auth with supplied token only");else throw c="options must include valid authentication parameters",e.logAction(e.LOG_ERROR,"Auth()",c),Error(c);}var d="object"==typeof window,b=d?null:(void 0)("crypto"),g=d?window.Ably.msgpack:(void 0)("msgpack-js"),h,k;d?(k=$.encode,h=function(b,a){return v.HmacSHA256(b,
a).toString(v.enc.Base64)}):(k=function(b){return(new Buffer(b,"ascii")).toString("base64")},h=function(a,c){var d=b.createHmac("SHA256",c);d.update(a);return d.digest("base64")});a.prototype.authorise=function(b,a,c){var d=this.token;if(d)if(void 0===d.expires||d.expires>this.getTimestamp()){if(!b||!b.force){e.logAction(e.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+d.expires);c(null,d);return}}else e.logAction(e.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.token=null;
var g=this;this.requestToken(b,a,function(b,a){b?c(b):c(null,g.token=a)})};a.prototype.requestToken=function(b,a,d){"function"!=typeof b||d?"function"!=typeof a||d||(d=a,a=b,b=null):(d=b,b=a=null);b=m.mixin(m.copy(this.rest.options),b);a=a||m.copy(this.tokenParams);d=d||c;var h=b.format||"json",k,K=this.rest;if(b.authCallback)e.logAction(e.LOG_MINOR,"Auth.requestToken()","using token auth with auth_callback"),k=b.authCallback;else if(b.authUrl)e.logAction(e.LOG_MINOR,"Auth.requestToken()","using token auth with auth_url"),
k=function(a,d){var c=m.mixin({accept:"application/json"},b.authHeaders);s.getUri(K,b.authUrl,c||{},m.mixin(a,b.authParams),function(b,a,c,e){if(b)return d(b);e||(a=JSON.parse(a));d(null,a)})};else if(b.keyValue){var z=this;e.logAction(e.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing");k=function(a,d){z.createTokenRequest(b,a,d)}}else throw Error("Auth.requestToken(): authOptions must include valid authentication parameters");"capability"in a&&(a.capability=l(a.capability));
var K=this.rest,q=function(a,d){var c,e=a.id,f=function(b){return K.baseUri(b)+"/keys/"+e+"/requestToken"};s.post?(c=m.defaultPostHeaders(h),b.requestHeaders&&m.mixin(c,b.requestHeaders),a="msgpack"==h?g.encode(a,!0):JSON.stringify(a),s.post(K,f,c,a,null,d)):(c=m.defaultGetHeaders(),b.requestHeaders&&m.mixin(c,b.requestHeaders),s.get(K,f,c,a,d))};k(a,function(b,a){b?(e.logAction(e.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+b),"code"in b||(b.code=40170),"statusCode"in
b||(b.statusCode=401),d(b)):"issued_at"in a?d(null,a):q(a,function(b,a,c,f){b?(e.logAction(e.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+b),d(b)):(f||(a="msgpack"==h?g.decode(a):JSON.parse(a)),e.logAction(e.LOG_MINOR,"Auth.getToken()","token received"),d(null,a.access_token))})})};a.prototype.createTokenRequest=function(b,a,d){b=b||this.rest.options;a=a||m.copy(this.tokenParams);var c=b.keyId,g=b.keyValue;if(c&&g){var k={id:c},l=a.clientId||"";l&&(k.clientId=l);
var q=a.ttl||"";q&&(k.ttl=q);var M=a.capability||"";M&&(k.capability=M);var F=this.rest,r=this;(function(c){a.timestamp?c():b.queryTime?F.time(function(b,e){b?d(b):(a.timestamp=Math.floor(e/1E3),c())}):(a.timestamp=r.getTimestamp(),c())})(function(){var b=k.nonce=a.nonce||("000000"+Math.floor(1E16*Math.random())).slice(-16),c=k.timestamp=a.timestamp,b=k.id+"\n"+q+"\n"+M+"\n"+l+"\n"+c+"\n"+b+"\n";k.mac=a.mac||h(b,g);e.logAction(e.LOG_MINOR,"Auth.getTokenRequest()","generated signed request");d(null,
k)})}else d(Error("No key specified"))};a.prototype.getAuthParams=function(b){"basic"==this.method?b(null,{key_id:this.keyId,key_value:this.keyValue}):this.authorise(null,null,function(a,c){a?b(a):b(null,{access_token:c.id})})};a.prototype.getAuthHeaders=function(b){"basic"==this.method?b(null,{authorization:"Basic "+this.basicKey}):this.authorise(null,null,function(a,c){a?b(a):b(null,{authorization:"Bearer "+k(c.id)})})};a.prototype.getTimestamp=function(){var b=Date.now()+(this.rest.serverTimeOffset||
0);return Math.floor(b/1E3)};return a}(),I=function(){function c(a){if(!a){var b="no options provided";e.logAction(e.LOG_ERROR,"Rest()",b);throw Error(b);}"string"==typeof a&&(a=-1==a.indexOf(":")?{key:a}:{authToken:a});this.options=a;x.supportsBinary&&!0===this.options.useBinaryProtocol||(this.options.useBinaryProtocol=!1);if(a.key){b=a.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!b)throw b="invalid key parameter",e.logAction(e.LOG_ERROR,"Rest()",b),Error(b);a.keyId=b[1];a.keyValue=b[2]}a.log&&e.setLog(a.log.level,
a.log.handler);e.logAction(e.LOG_MINOR,"Rest()","started");this.clientId=a.clientId;"tls"in a||(a.tls=!0);this.serverTimeOffset=null;this.baseUri=this.authority=function(b){return"https://"+b+":"+(a.tlsPort||q.TLS_PORT)};this.auth=new aa(this,a);this.channels=new l(this)}function l(a){this.rest=a;this.attached={}}var a=function(){};c.prototype.stats=function(c,b){void 0===b&&("function"==typeof c?(b=c,c=null):b=a);var e=m.copy(m.defaultGetHeaders()),h=s.supportsLinkHeaders?void 0:"json";this.options.headers&&
m.mixin(e,this.options.headers);(new Q(this,"/stats",e,c,h,function(b,a,c){return c?b:JSON.parse(b)})).get(b)};c.prototype.time=function(c,b){void 0===b&&("function"==typeof c?(b=c,c=null):b=a);var e=m.copy(m.defaultGetHeaders());this.options.headers&&m.mixin(e,this.options.headers);var h=this;s.get(this,function(b){return h.authority(b)+"/time"},e,c,function(a,c,d,e){a?b(a):(e||(c=JSON.parse(c)),(a=c[0])?(h.serverTimeOffset=a-Date.now(),b(null,a)):(a=Error("Internal error (unexpected result type from GET /time)"),
a.statusCode=500,b(a)))})};l.prototype.get=function(a){a=String(a);var b=this.attached[a];b||(this.attached[a]=b=new U(this.rest,a));return b};return c}(),J=function(){function c(a){e.logAction(e.LOG_MINOR,"Realtime()","");I.call(this,a);this.connection=new ba(this,a);this.channels=new l(this);this.connection.connect()}function l(a){this.realtime=a;this.attached={};var c=this;a.connection.connectionManager.on("transport.active",function(b){c.onTransportActive(b)})}m.inherits(c,I);c.prototype.close=
function(){e.logAction(e.LOG_MINOR,"Realtime.close()","");this.connection.close()};l.prototype.onChannelMessage=function(a){var c=a.channel;if(c){var b=this.attached[c];if(b)b.onMessage(a);else e.logAction(e.LOG_ERROR,"Channels.onChannelMessage()","received event for non-existent channel: "+c)}else e.logAction(e.LOG_ERROR,"Channels.onChannelMessage()","received event unspecified channel, action = "+a.action)};l.prototype.onTransportActive=function(){for(var a in this.attached)this.attached[a].checkPendingState()};
l.prototype.setSuspended=function(a){for(var c in this.attached)this.attached[c].setSuspended(a)};l.prototype.get=function(a){a=String(a);var c=this.attached[a];c||(this.attached[a]=c=new X(this.realtime,a,this.realtime.options));return c};return c}(),T=function(){return function(c,e,a,d){this.previous=c;this.current=e;a&&(this.retryIn=a);d&&(this.reason=d)}}(),ba=function(){function c(c,a){r.call(this);this.ably=c;this.connectionManager=new y(c,a);this.state=this.connectionManager.state.state;this.id=
this.key=void 0;var d=this;this.connectionManager.on("connectionstate",function(b){var a=d.state=b.current;m.nextTick(function(){d.emit(a,b)})})}m.inherits(c,r);c.prototype.on=function(c,a){r.prototype.on.apply(this,arguments);if(this.state==c&&a)try{a(new T(void 0,c))}catch(d){}};c.prototype.connect=function(){e.logAction(e.LOG_MAJOR,"Connection.connect()","");this.connectionManager.requestState({state:"connecting"})};c.prototype.ping=function(c){e.logAction(e.LOG_MINOR,"Connection.ping()","");this.connectionManager.ping(null,
c)};c.prototype.close=function(){e.logAction(e.LOG_MAJOR,"Connection.close()","connectionKey = "+this.key);this.connectionManager.requestState({state:"closing"})};return c}(),U=function(){function c(){}function l(b,c,d){e.logAction(e.LOG_MINOR,"Channel()","started; name = "+c);r.call(this);this.rest=b;this.name=c;this.basePath="/channels/"+encodeURIComponent(c);this.presence=new a(this);this.setOptions(d)}function a(b){this.channel=b;this.basePath=b.basePath+"/presence"}var d={};m.inherits(l,r);l.prototype.setOptions=
function(b,a){a=a||c;b=this.options=m.prototypicalClone(d,b);if(b.encrypted){if(!Crypto)throw Error("Encryption not enabled; use ably.encryption.js instead");Crypto.getCipher(b,function(c,d){b.cipher=d;a(null)})}else a(null,b.cipher=null)};l.prototype.history=function(b,a){e.logAction(e.LOG_MICRO,"Channel.history()","channel = "+this.name);void 0===a&&("function"==typeof b?(a=b,b=null):a=c);var d=this.rest,k=d.options.useBinaryProtocol?"msgpack":"json",l=s.supportsLinkHeaders?void 0:k,f=m.copy(m.defaultGetHeaders(k)),
p=this.options;d.options.headers&&m.mixin(f,d.options.headers);(new Q(d,this.basePath+"/messages",f,b,l,function(b,a,c){return B.fromResponseBody(b,p,!c&&k)})).get(a)};l.prototype.publish=function(){var b=arguments.length,a=arguments[0],d=arguments[b-1];"function"!==typeof d&&(d=c,++b);2==b?(m.isArray(a)||(a=[a]),a=B.fromValuesArray(a)):a=[B.fromValues({name:arguments[0],data:arguments[1]})];var b=this.rest,e=b.options.useBinaryProtocol?"msgpack":"json",a=B.toRequestBody(a,this.options,e),e=m.copy(m.defaultPostHeaders(e));
b.options.headers&&m.mixin(e,b.options.headers);Y.post(b,this.basePath+"/messages",a,e,null,!1,d)};a.prototype.get=function(b,a){e.logAction(e.LOG_MICRO,"Channel.presence.get()","channel = "+this.channel.name);void 0===a&&("function"==typeof b?(a=b,b=null):a=c);var d=this.channel.rest,k=d.options.useBinaryProtocol?"msgpack":"json",l=s.supportsLinkHeaders?void 0:k,f=m.copy(m.defaultGetHeaders(k)),p=this.channel.options;d.options.headers&&m.mixin(f,d.options.headers);(new Q(d,this.basePath,f,b,l,function(b,
a,c){return C.fromResponseBody(b,p,!c&&k)})).get(a)};a.prototype.history=function(b,a){e.logAction(e.LOG_MICRO,"Channel.presence.history()","channel = "+this.channel.name);void 0===a&&("function"==typeof b?(a=b,b=null):a=c);var d=this.channel.rest,k=d.options.useBinaryProtocol?"msgpack":"json",l=s.supportsLinkHeaders?void 0:k,f=m.copy(m.defaultGetHeaders(k)),p=this.channel.options;d.options.headers&&m.mixin(f,d.options.headers);(new Q(d,this.basePath+"/history",f,b,l,function(b,a,c){return C.fromResponseBody(b,
p,!c&&k)})).get(a)};return l}(),X=function(){function c(b,a,c){e.logAction(e.LOG_MINOR,"RealtimeChannel()","started; name = "+a);U.call(this,b,a,c);this.presence=new ca(this,c);this.connectionManager=b.connection.connectionManager;this.state="initialized";this.subscriptions=new r;this.pendingEvents=[];this.syncChannelSerial=void 0;this.setOptions(c)}var l=u.Action,a=u.Flag,d=function(){},b={queueEvents:!0};m.inherits(c,U);c.invalidStateError={statusCode:400,code:90001,message:"Channel operation failed (invalid channel state)"};
c.channelDetachedErr={statusCode:409,code:90006,message:"Channel is detached"};c.prototype.setOptions=function(a,c){c=c||d;a=this.options=m.prototypicalClone(b,a);if(a.encrypted){if(!Crypto)throw Error("Encryption not enabled; use ably.encryption.js instead");Crypto.getCipher(a,function(b,d){a.cipher=d;c(null)})}else c(null,a.cipher=null)};c.prototype.publish=function(){var a=arguments.length,b=arguments[0],c=arguments[a-1],e=this.options;"function"!==typeof c&&(c=d,++a);var f=this.connectionManager;
if(y.activeState(f.state)){2==a?(m.isArray(b)||(b=[b]),b=B.fromValuesArray(b)):b=[B.fromValues({name:arguments[0],data:arguments[1]})];for(a=0;a<b.length;a++)B.encode(b[a],e);this._publish(b,c)}else c(f.getStateError())};c.prototype._publish=function(a,b){e.logAction(e.LOG_MICRO,"RealtimeChannel.publish()","message count = "+a.length);switch(this.state){case "attached":e.logAction(e.LOG_MICRO,"RealtimeChannel.publish()","sending message");var c=new u;c.action=l.MESSAGE;c.channel=this.name;c.messages=
a;this.sendMessage(c,b);break;default:this.attach();case "attaching":e.logAction(e.LOG_MICRO,"RealtimeChannel.publish()","queueing message"),this.pendingEvents.push({messages:a,callback:b})}};c.prototype.onEvent=function(a){e.logAction(e.LOG_MICRO,"RealtimeChannel.onEvent()","received message");for(var b=this.subscriptions,c=0;c<a.length;c++){var d=a[c];b.emit(d.name,d)}};c.prototype.attach=function(a){a=a||d;var b=this.connectionManager;y.activeState(b.state)?"attached"==this.state?a():"failed"==
this.state?a(b.getStateError()):(this.once(function(c){switch(this.event){case "attached":a();break;case "detached":case "failed":a(c||b.getStateError())}}),this.setPendingState("attaching")):a(b.getStateError())};c.prototype.attachImpl=function(a){e.logAction(e.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message");var b=u.fromValues({action:l.ATTACH,channel:this.name});this.sendMessage(b,a||d)};c.prototype.detach=function(a){a=a||d;var b=this.connectionManager;y.activeState(b.state)?
"detached"==this.state?a():(this.once(function(c){switch(this.event){case "detached":a();break;case "attached":a(L.unknownChannelErr);break;case "failed":a(c||b.getStateError())}}),this.setPendingState("detaching"),this.setSuspended(c.channelDetachedErr,!0)):a(b.getStateError())};c.prototype.detachImpl=function(a){e.logAction(e.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message");var b=u.fromValues({action:l.DETACH,channel:this.name});this.sendMessage(b,a||d)};c.prototype.subscribe=function(){var a=
Array.prototype.slice.call(arguments);1==a.length&&"function"==typeof a[0]&&a.unshift(null);var b=a[0],c=a[1],a=a[2]||(a[2]=d),e=this.subscriptions;if(null!==b&&m.isArray(b))for(var f=0;f<b.length;f++)e.on(b[f],c);else e.on(b,c);this.attach(a)};c.prototype.unsubscribe=function(){var a=Array.prototype.slice.call(arguments);1==a.length&&"function"==typeof a[0]&&a.unshift(null);var b=a[0],a=a[1],c=this.subscriptions;if(null!==b&&m.isArray(b))for(var d=0;d<b.length;d++)c.off(b[d],a);else c.off(b,a)};
c.prototype.sync=function(){switch(this.state){case "initialised":case "detaching":case "detached":throw new H("Unable to sync to channel; not attached",4E4);}var a=this.connectionManager;if(!y.activeState(a.state))throw a.getStateError();var b=u.fromValues({action:l.SYNC,channel:this.name});b.channelSerial=this.syncChannelSerial;a.send(b)};c.prototype.sendMessage=function(a,b){this.connectionManager.send(a,this.options.queueEvents,b)};c.prototype.sendPresence=function(a,b){var c=u.fromValues({action:l.PRESENCE,
channel:this.name,presence:[C.fromValues(a)]});this.sendMessage(c,b)};c.prototype.onMessage=function(a){var b;switch(a.action){case l.ATTACHED:this.setAttached(a);break;case l.DETACHED:this.setDetached(a);break;case l.SYNC:b=this.syncChannelSerial=a.channelSerial;case l.PRESENCE:var c=a.presence,d=a.id,f=a.connectionId;a=a.timestamp;for(var p=this.options,m=0;m<c.length;m++){try{var q=c[m];C.decode(q,p)}catch(K){var z="Unexpected error decrypting message; err = "+K;e.logAction(e.LOG_ERROR,"RealtimeChannel.onMessage()",
z);z=Error(z);this.emit("error",z)}q.connectionId||(q.connectionId=f);q.timestamp||(q.timestamp=a);q.id||(q.id=d+":"+m)}this.presence.setPresence(c,!0,b);break;case l.MESSAGE:b=a.messages;d=a.id;f=a.connectionId;a=a.timestamp;p=this.options;for(m=0;m<b.length;m++){try{c=b[m],B.decode(c,p)}catch(r){z="Unexpected error decrypting message; err = "+r,e.logAction(e.LOG_ERROR,"RealtimeChannel.onMessage()",z),z=Error(z),this.emit("error",z)}c.connectionId||(c.connectionId=f);c.timestamp||(c.timestamp=a);
c.id||(c.id=d+":"+m)}this.onEvent(b);break;case l.ERROR:(z=a.error)&&80016==z.code?this.checkPendingState():this.setDetached(a);break;default:e.logAction(e.LOG_ERROR,"RealtimeChannel.onMessage()","Fatal protocol error: unrecognised action ("+a.action+")"),this.connectionManager.abort(L.unknownChannelErr)}};c.mergeTo=function(a,b){var c=!1,d;if(a.channel==b.channel&&(d=a.action)==b.action)switch(d){case l.MESSAGE:for(c=0;c<b.messages.length;c++)a.messages.push(b.messages[c]);c=!0;break;case l.PRESENCE:for(c=
0;c<b.presence.length;c++)a.presence.push(b.presence[c]);c=!0}return c};c.prototype.setAttached=function(b){e.logAction(e.LOG_MINOR,"RealtimeChannel.setAttached","activating channel; name = "+this.name+"; message flags = "+b.flags);this.clearStateTimer();b.presence&&this.presence.setPresence(b.presence,!1);if("attaching"==this.state){this.state="attached";var c=this.pendingEvents,d=c.length;if(d){this.pendingEvents=[];var m=u.fromValues({action:l.MESSAGE,channel:this.name,messages:[]}),f=S();e.logAction(e.LOG_MICRO,
"RealtimeChannel.setAttached","sending "+d+" queued messages");for(var p=0;p<d;p++){var w=c[p];Array.prototype.push.apply(m.messages,w.messages);f.push(w.callback)}this.sendMessage(m,f)}0<(b.flags&1<<a.HAS_PRESENCE)&&this.presence.awaitSync();this.presence.setAttached();this.emit("attached")}};c.prototype.setDetached=function(a){this.clearStateTimer();(a=a.error)?(this.state="failed",a={statusCode:a.statusCode,code:a.code,message:a.message},this.failPendingMessages(a),this.emit("failed",a)):(this.failPendingMessages({statusCode:404,
code:90001,message:"Channel detached"}),"detached"!==this.state&&(this.state="detached",this.emit("detached")))};c.prototype.setSuspended=function(a,b){e.logAction(e.LOG_MINOR,"RealtimeChannel.setSuspended","deactivating channel; name = "+this.name+", err "+(a?a.message:"none"));this.clearStateTimer();this.failPendingMessages(a);this.presence.setSuspended(a);b||this.emit("detached")};c.prototype.setPendingState=function(a){e.logAction(e.LOG_MINOR,"RealtimeChannel.setPendingState","name = "+this.name+
", state = "+a);this.state=a;this.clearStateTimer();if("connected"!=this.connectionManager.state.state)e.logAction(e.LOG_MINOR,"RealtimeChannel.setPendingState","not connected");else{this.checkPendingState();var b=this;this.stateTimer=setTimeout(function(){e.logAction(e.LOG_MINOR,"RealtimeChannel.setPendingState","timer expired");b.stateTimer=null;b.checkPendingState()},q.sendTimeout)}};c.prototype.checkPendingState=function(){var a=!1;switch(this.state){case "attaching":this.attachImpl();a=!0;break;
case "detaching":this.detachImpl();a=!0;break;case "attached":this.sync()}return a};c.prototype.clearStateTimer=function(){var a=this.stateTimer;a&&(clearTimeout(a),this.stateTimer=null)};c.prototype.failPendingMessages=function(a){e.logAction(e.LOG_MINOR,"RealtimeChannel.failPendingMessages","channel; name = "+this.name+", err = "+a);for(var b=0;b<this.pendingEvents.length;b++)try{this.pendingEvents[b].callback(a)}catch(c){}this.pendingEvents=[]};return c}(),ca=function(){function c(a,c){r.call(this);
this.channel=a;this.clientId=c.clientId;this.members=new l(this)}function l(a){r.call(this);this.presence=a;this.map={};this.syncInProgress=!1;this.residualMembers=null}var a=C.Action,d=["absent","present","enter","leave","update"];m.inherits(c,r);c.prototype.enter=function(a,c){c||"function"!==typeof a||(c=a,a="");if(!this.clientId)throw Error("clientId must be specified to enter a presence channel");this.enterClient(this.clientId,a,c)};c.prototype.enterClient=function(b,c,d){e.logAction(e.LOG_MICRO,
"Presence.enterClient()","entering; channel = "+this.channel.name+", client = "+b);b=C.fromValues({action:a.ENTER,clientId:b,data:c});c=this.channel;switch(c.state){case "attached":c.sendPresence(b,d);break;case "initialized":c.attach();case "attaching":this.pendingPresence={presence:b,callback:d};break;default:b=Error("Unable to enter presence channel (incompatible state)"),b.code=90001,d(b)}};c.prototype.leave=function(a,c){c||"function"!==typeof a||(c=a,a="");if(!this.clientId)throw Error("clientId must have been specified to enter or leave a presence channel");
this.leaveClient(this.clientId,a,c)};c.prototype.leaveClient=function(b,c,d){e.logAction(e.LOG_MICRO,"Presence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+b);b=C.fromValues({action:a.LEAVE,clientId:b,data:c});c=this.channel;switch(c.state){case "attached":c.sendPresence(b,d);break;case "attaching":this.pendingPresence={presence:b,callback:d};break;case "initialized":this.pendingPresence=null;b=Error("Unable to enter presence channel (incompatible state)");b.code=90001;d(b);
break;default:this.pendingPresence=null,d(L.failed)}};c.prototype.get=function(){var a=Array.prototype.slice.call(arguments);1==a.length&&"function"==typeof a[0]&&a.unshift(null);var c=a[0],d=a[1]||noop,e=this.members;e.waitSync(function(){d(null,c?e.getClient(c):e.values())})};c.prototype.setPresence=function(b,c,h){e.logAction(e.LOG_MICRO,"Presence.setPresence()","received presence for "+b.length+" participants; syncChannelSerial = "+h);var k,l,f=this.members;h&&(l=h.match(/^\w+:(.*)$/))&&(k=l[1])&&
this.members.startSync();for(h=0;h<b.length;h++)switch(l=b[h],l.action){case a.LEAVE:c&=f.remove(l);break;case a.UPDATE:case a.ENTER:l=C.fromValues(l),l.action=a.PRESENT;case a.PRESENT:c&=f.put(l)}k||f.endSync();if(c)for(h=0;h<b.length;h++)l=b[h],this.emit(d[l.action],l)};c.prototype.setAttached=function(){var a=this.pendingPresence;if(a){var c=a.presence,a=a.callback;e.logAction(e.LOG_MICRO,"Presence.setAttached","sending queued presence; action = "+c.action);this.channel.sendPresence(c,a);this.pendingPresence=
null}};c.prototype.setSuspended=function(a){var c=this.pendingPresence;c&&(c.callback(a),this.pendingPresence=null)};c.prototype.awaitSync=function(){e.logAction(e.LOG_MINOR,"PresenceMap.awaitSync(); channel = "+this.channel.name);this.members.startSync()};m.inherits(l,r);l.prototype.get=function(a){return this.map[a]};l.prototype.getClient=function(b){var c=this.map,d=[],e;for(e in c){var l=c[e];l.clientId==b&&l.action!=a.ABSENT&&d.push(l)}return d};l.prototype.put=function(a){var c=this.map,d=a.clientId+
":"+a.connectionId;this.residualMembers&&delete this.residualMembers[d];var e=c[d];if(e&&a.timestamp<e.timestamp)return!1;c[d]=a;return!0};l.prototype.values=function(){var b=this.map,c=[],d;for(d in b){var e=b[d];e.action!=a.ABSENT&&c.push(e)}return c};l.prototype.remove=function(a){var c=this.map;a=a.clientId+":"+a.connectionId;var d=c[a];return d&&(delete c[a],d.action==C.Action.ABSENT)?!1:!0};l.prototype.startSync=function(){var a=this.map;e.logAction(e.LOG_MINOR,"PresenceMap.startSync(); channel = "+
this.presence.channel.name+"; syncInProgress = "+this.syncInProgress);this.syncInProgress||(this.residualMembers=m.copy(a),this.syncInProgress=!0)};l.prototype.endSync=function(){var b=this.map,c=this.syncInProgress;e.logAction(e.LOG_MINOR,"PresenceMap.endSync(); channel = "+this.presence.channel.name+"; syncInProgress = "+c);if(c){for(var d in b)b[d].action==a.ABSENT&&delete b[d];for(d in this.residualMembers)delete b[d];this.residualMembers=null;this.syncInProgress=!1}this.emit("sync")};l.prototype.waitSync=
function(a){if(this.syncInProgress)this.once("sync",a);else a()};return c}();(function(){function c(a,b,c){c.stream=!1;O.call(this,a,b,c)}function l(a,c,d,e,g,h){r.call(this);void 0===a&&(a=b++);this.id=a;this.uri=c;this.params=e||{};this.body=g;this.requestMode=h;this.requestComplete=!1}var a=function(){},d=window.Ably._=function(b){return d[b]||a},b=1,g=document.getElementsByTagName("head")[0];m.inherits(c,O);c.isAvailable=function(){return!0};y.httpTransports.jsonp=y.transports.jsonp=c;var h=null;
c.checkConnectivity=function(a){h?h.push(a):(h=[a],n("http://internet-up.ably.io.s3-website-us-east-1.amazonaws.com/is-the-internet-up.js",null,null,null,!1,function(a,b){for(var c=!a&&b,d=0;d<h.length;d++)h[d](null,c);h=null}))};c.tryConnect=function(a,b,d,g){var h=new c(a,b,d),k=function(a){g(a)};h.on("error",k);h.on("preconnect",function(){e.logAction(e.LOG_MINOR,"JSONPTransport.tryConnect()","viable transport "+h);h.off("error",k);g(null,h)});h.connect()};c.prototype.toString=function(){return"JSONPTransport; uri="+
this.baseUri+"; isConnected="+this.isConnected};var k=c.prototype.createRequest=function(a,b,c,d,e){return new l(void 0,a,b,c,d,e)};m.inherits(l,r);l.prototype.exec=function(){var a=this.id,b=this.body,c=this.uri,e=this.params,h=this;e.callback="Ably._("+a+")";b?e.body=b:delete e.body;b=this.script=document.createElement("script");b.src=c+m.toQueryString(e);b.async=!0;b.type="text/javascript";b.charset="UTF-8";b.onerror=function(a){a.code=8E4;h.complete(a)};d[a]=function(a){h.complete(null,a)};this.timer=
setTimeout(function(){h.abort()},this.requestMode==O.REQ_SEND?q.sendTimeout:q.recvTimeout);g.insertBefore(b,g.firstChild)};l.prototype.complete=function(a,b){this.requestComplete||(this.requestComplete=!0,b&&this.emit("data",b),this.emit("complete",a,b,!0),this.dispose())};l.prototype.abort=function(){this.dispose()};l.prototype.dispose=function(){var a=this.timer;a&&(clearTimeout(a),this.timer=null);a=this.script;a.parentNode&&a.parentNode.removeChild(a);delete d[this.id]};var n=s.Request=function(a,
b,c,d,e){a=k(a,b,c,d,O.REQ_SEND);a.once("complete",e);a.exec();return a};return c})();var Z=function(){function c(){for(var a in h)h[a].dispose()}function l(){return window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest?n=!0:k&&document.domain&&"https:"==window.location.protocol?!0:!1}function a(a,b,c,d,e){r.call(this);c=c||{};c.rnd=String(Math.random()).substr(2);this.uri=a+m.toQueryString(c);this.headers=b||{};this.body=d;this.requestMode=e;this.requestComplete=!1;h[this.id=String(++g)]=
this}function d(b,c,d,e,f){d.ua="xdr";a.call(this,b,c,d,e,f)}var b=function(){},g=0,h={},k=window.XDomainRequest,n;m.inherits(a,r);a.isAvailable=l;var f=a.createRequest=function(b,c,e,f,g){return n?new a(b,c,e,f,g):new d(b,c,e,f,g)};a.prototype.complete=function(a,b,c,d){this.requestComplete||(this.requestComplete=!0,b&&this.emit("data",b),this.emit("complete",a,b,c,d),this.dispose())};a.prototype.abort=function(){this.dispose()};a.prototype.exec=function(){function a(){E=g.responseText;for(var b=
E.length-1,c,d;u<b&&-1<(c=E.indexOf("\n",u));){d=E.slice(u,c);u=c+1;a:{try{d=JSON.parse(d)}catch(e){d=Error("Malformed response body from server: "+e.message);d.statusCode=400;h.complete(d);break a}h.emit("data",d)}}}function b(){a();h.streamComplete=!0;m.nextTick(function(){h.complete()})}var c=this.timer=setTimeout(function(){g.abort()},0==this.requestMode?q.sendTimeout:q.recvTimeout),d=this.body,e=d?"POST":"GET",f=this.headers,g=this.xhr=new XMLHttpRequest,h=this,k=f.accept,l="text";k?"application/json"!=
k&&(l="arraybuffer"):f.accept="application/json";d&&"application/json"==(f["content-type"]||(f["content-type"]="application/json"))&&"string"!=typeof d&&(d=JSON.stringify(d));g.open(e,this.uri,!0);g.responseType=l;g.withCredentials="true";for(var n in f)g.setRequestHeader(n,f[n]);var t=g.onerror=function(a){a.code=8E4;h.complete(a)};g.onabort=function(){var a=Error("Request cancelled");a.statusCode=400;t(a)};g.ontimeout=function(){var a=Error("Request timed out");a.statusCode=408;t(a)};var r,s,E,
V,u=0,v=!1;g.onreadystatechange=function(){var d=g.readyState;if(!(3>d)&&0!==g.status)if(void 0===s&&(s=g.status,1223===s&&(s=204),clearTimeout(c),V=400>s,204==s?h.complete():r=3==h.requestMode&&V),3==d&&r)a();else if(4==d)if(r)b();else a:{try{var e=g.getResponseHeader&&g.getResponseHeader("Content-Type"),f=e?"application/json"==e:"text"==g.responseType;E=f?g.responseText:g.response;if(!E){204!=status&&(l=Error("Incomplete response body from server"),l.statusCode=400,h.complete(l));break a}f&&(E=
JSON.parse(String(E)),v=!0)}catch(k){var l=Error("Malformed response body from server: "+k.message);l.statusCode=400;h.complete(l);break a}V?h.complete(null,E,e&&{"Content-Type":e},v):(l=E.error,l||(l=Error("Error response received from server: "+s),l.statusCode=s),h.complete(l))}};g.send(d)};a.prototype.dispose=function(){var a=this.xhr;if(a){a.onreadystatechange=a.onerror=a.onabort=a.ontimeout=b;this.xhr=null;var c=this.timer;c&&(clearTimeout(c),this.timer=null);this.requestComplete||a.abort()}delete h[this.id]};
m.inherits(d,a);d.prototype.exec=function(){function a(){clearTimeout(d);if(t=h.responseText){var b=t.length-1;if("\n"==t[b]||(b=-1<t.indexOf("\n"))){var c=t.slice(0,b);try{var c=JSON.parse(c),e=c.error;if(e)s=e.statusCode||500,k.complete(e);else if(s=t?201:200,n=3==k.requestMode)r=b,m.isEmpty(c)||k.emit("data",c)}catch(f){e=Error("Malformed response body from server: "+f.message),e.statusCode=400,k.complete(e)}}}}function b(){t=h.responseText;for(var a=t.length-1,c,d;r<a&&-1<(c=t.indexOf("\n",r));){d=
t.slice(r,c);r=c+1;a:{try{d=JSON.parse(d)}catch(e){err=Error("Malformed response body from server: "+e.message);err.statusCode=400;k.complete(err);break a}k.emit("data",d)}}}function c(){b();k.streamComplete=!0;m.nextTick(function(){k.complete()})}var d=this.timer=setTimeout(function(){h.abort()},0==this.requestMode?q.sendTimeout:q.recvTimeout),f=this.body,g=f?"POST":"GET",h=this.xhr=new XDomainRequest,k=this;f&&"object"==typeof f&&(f=JSON.stringify(f));var l=h.onerror=function(){e.logAction(e.LOG_ERROR,
"Request.onerror()","");var a=Error("Error response");a.statusCode=400;a.code=8E4;k.complete(a)};h.onabort=function(){e.logAction(e.LOG_ERROR,"Request.onabort()","");var a=Error("Request cancelled");a.statusCode=400;l(a)};h.ontimeout=function(){e.logAction(e.LOG_ERROR,"Request.timeout()","");var a=Error("Request timed out");a.statusCode=408;l(a)};var n,s,t,r=0;h.onprogress=function(){void 0===s?a():n&&b()};h.onload=function(){if(void 0===s&&(a(),k.requestComplete))return;if(n)c();else a:{try{t=h.responseText;
if(!t||!t.length){204!=status&&(d=Error("Incomplete response body from server"),d.statusCode=400,k.complete(d));break a}t=JSON.parse(String(t))}catch(b){var d=Error("Malformed response body from server: "+b.message);d.statusCode=400;k.complete(d);break a}k.complete(null,t,{"Content-Type":"application/json"},!0)}};try{h.open(g,this.uri),h.send(f)}catch(u){e.logAction(e.LOG_ERROR,"Request.onStreamEnd()","Unexpected send exception; err = "+u),l(u)}};d.prototype.dispose=function(){var a=this.xhr;if(a){a.onprogress=
a.onload=a.onerror=a.onabort=a.ontimeout=b;this.xhr=null;var c=this.timer;c&&(clearTimeout(c),this.timer=null);this.requestComplete||a.abort()}delete h[this.id]};if(l=a.isAvailable())N.addUnloadListener(c),"undefined"!==typeof s&&(s.supportsAuthHeaders=n,s.Request=function(a,b,c,d,e){a=f(a,b,c,d,0);a.once("complete",e);a.exec();return a});return a}();(function(){function c(c,a,d){O.call(this,c,a,d)}m.inherits(c,O);c.isAvailable=Z.isAvailable;c.checkConnectivity=function(c){s.Request("http://internet-up.ably.io.s3-website-us-east-1.amazonaws.com/is-the-internet-up.txt",
null,null,null,function(a,d){c(null,!a&&"yes"==d)})};c.tryConnect=function(l,a,d,b){var g=new c(l,a,d),h=function(a){b(a)};g.on("error",h);g.on("preconnect",function(){e.logAction(e.LOG_MINOR,"XHRTransport.tryConnect()","viable transport "+g);g.off("error",h);b(null,g)});g.connect()};c.prototype.toString=function(){return"XHRTransport; uri="+this.baseUri+"; isConnected="+this.isConnected};c.prototype.createRequest=Z.createRequest;"undefined"!==typeof y&&c.isAvailable()&&(y.httpTransports.xhr=y.transports.xhr=
c);return c})();(function(){function c(a,c,b){b.binary=!1;D.call(this,a,c,b);this.destOrigin=this.destWindow=this.wrapWindow=this.wrapIframe=null}var l=location.origin||location.protocol+"//"+location.hostname+(location.port?":"+location.port:"");m.inherits(c,D);c.isAvailable=function(){return void 0!==window.postMessage};c.isAvailable()&&(y.httpTransports.iframe=y.transports.iframe=c);c.tryConnect=function(a,d,b,g){var h=new c(a,d,b);h.on("iferror",g);h.on("ifopen",function(){e.logAction(e.LOG_MINOR,
"IframeTransport.tryConnect()","viable transport "+h);h.off("iferror",g);g(null,h)});h.connect()};c.prototype.toString=function(){return"IframeTransport; uri="+this.uri};c.prototype.connect=function(){e.logAction(e.LOG_MINOR,"IframeTransport.connect()","starting");D.prototype.connect.call(this);var a=this;this.auth.getAuthParams(function(c,b){if(c)a.abort(c);else{var e=a.params.getConnectParams(b);e.origin=l;a.createIframe(e,function(b){b?a.emit("iferror",b):a.emit("ifopen")})}})};c.prototype.send=
function(a){var c=this.destWindow;c&&c.postMessage(JSON.stringify(a),this.destOrigin)};c.prototype.createIframe=function(a,c){function b(){p.dispose()}function g(a){p.onData(a.data)}var h=this.wrapIframe=document.createElement("iframe"),k=this.params.options,k=(this.destOrigin="https://"+q.getHost(k)+":"+q.getPort(k,!0))+"/static/iframe.html"+m.toQueryString(a),l=!1,f=null,p=this;e.logAction(e.LOG_MINOR,"IframeTransport.createIframe()","destUri: "+k);N.addUnloadListener(b);h.style.display="none";
h.style.position="absolute";h.onerror=function(a){b();l||(l=!0,a=a||Error("Unknown error loading iframe"),c(a))};N.addListener(h,"load",p.onloadListener=function(){var a=a||this.contentWindow||this.contentDocument.parentWindow;if(p.destWindow=a.destWindow)N.addMessageListener(a,p.messageListener=g),l=!0,c(null,h)});document.body.appendChild(h);f=p.wrapWindow=h.contentWindow;f=f.document;f.open();f.write('<!DOCTYPE html>\n<html>\n  <head>\n    <script type="text/javascript">\n    var destWindow;\n    function onIframeLoaded() {\n      destWindow = document.getElementById("dest").contentWindow;\n    }\n    \x3c/script>\n  </head>\n  <body>\n    <iframe id="dest" src="'+
k+'" onload="onIframeLoaded();">\n    </iframe>\n  </body>\n</html>\n');f.close()};c.prototype.onData=function(a){e.logAction(e.LOG_MICRO,"IframeTransport.onData()","length = "+a.length);try{var c=JSON.parse(String(a));if(c&&c.length)for(a=0;a<c.length;a++)this.onChannelMessage(c[a])}catch(b){e.logAction(e.LOG_ERROR,"IframeTransport.onData()","Unexpected exception handing channel event: "+b)}};c.prototype.dispose=function(){e.logAction(e.LOG_MICRO,"IframeTransport.dispose()","");var a=this.messageListener;
a&&(N.removeMessageListener(this.wrapWindow,a),this.messageListener=null);var c=this.wrapIframe;c&&((a=this.onloadListener)&&N.removeListener(c,"load",a),this.wrapIframe=c.onerror=null,setTimeout(function(){c.parentNode.removeChild(c)},0))};return c})();"undefined"!==typeof J&&(W.Rest=I,W.Realtime=J,J.ConnectionManager=y,J.BufferUtils=I.BufferUtils=x,"undefined"!==typeof Crypto&&(J.Crypto=I.Crypto=Crypto),J.Message=I.Message=B,J.PresenceMessage=I.PresenceMessage=C,J.ProtocolMessage=I.ProtocolMessage=
u)}).call({});
