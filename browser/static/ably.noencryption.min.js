/*
 Copyright 2015, Ably

 Ably JavaScript Library v0.8.8
 https://github.com/ably/ably-js

 Ably Realtime Messaging
 https://www.ably.io

 Released under the Apache Licence v2.0
*/
(function(){var X=window.Ably=this,F=F||function(e,a){var c={},b=c.lib={},g=b.Base=function(){function d(){}return{extend:function(k){d.prototype=this;var n=new d;k&&n.mixIn(k);n.hasOwnProperty("init")||(n.init=function(){n.$super.init.apply(this,arguments)});n.init.prototype=n;n.$super=this;return n},create:function(){var d=this.extend();d.init.apply(d,arguments);return d},init:function(){},mixIn:function(d){for(var k in d)d.hasOwnProperty(k)&&(this[k]=d[k]);d.hasOwnProperty("toString")&&(this.toString=
d.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),d=b.WordArray=g.extend({init:function(d,k){d=this.words=d||[];this.sigBytes=k!=a?k:4*d.length},toString:function(d){return(d||m).stringify(this)},concat:function(d){var k=this.words,n=d.words,c=this.sigBytes;d=d.sigBytes;this.clamp();if(c%4)for(var b=0;b<d;b++)k[c+b>>>2]|=(n[b>>>2]>>>24-b%4*8&255)<<24-(c+b)%4*8;else if(65535<n.length)for(b=0;b<d;b+=4)k[c+b>>>2]=n[b>>>2];else k.push.apply(k,n);this.sigBytes+=d;return this},
clamp:function(){var d=this.words,k=this.sigBytes;d[k>>>2]&=4294967295<<32-k%4*8;d.length=e.ceil(k/4)},clone:function(){var d=g.clone.call(this);d.words=this.words.slice(0);return d},random:function(k){for(var n=[],c=function(d){var k=987654321;return function(){k=36969*(k&65535)+(k>>16)&4294967295;d=18E3*(d&65535)+(d>>16)&4294967295;var n=(k<<16)+d&4294967295,n=n/4294967296+.5;return n*(.5<e.random()?1:-1)}},b=0,g;b<k;b+=4){var h=c(4294967296*(g||e.random()));g=987654071*h();n.push(4294967296*h()|
0)}return new d.init(n,k)}}),h=c.enc={},m=h.Hex={stringify:function(d){var k=d.words;d=d.sigBytes;for(var n=[],b=0;b<d;b++){var c=k[b>>>2]>>>24-b%4*8&255;n.push((c>>>4).toString(16));n.push((c&15).toString(16))}return n.join("")},parse:function(k){for(var n=k.length,b=[],c=0;c<n;c+=2)b[c>>>3]|=parseInt(k.substr(c,2),16)<<24-c%8*4;return new d.init(b,n/2)}},p=h.Latin1={stringify:function(d){var k=d.words;d=d.sigBytes;for(var n=[],c=0;c<d;c++)n.push(String.fromCharCode(k[c>>>2]>>>24-c%4*8&255));return n.join("")},
parse:function(k){for(var n=k.length,c=[],b=0;b<n;b++)c[b>>>2]|=(k.charCodeAt(b)&255)<<24-b%4*8;return new d.init(c,n)}},k=h.Utf8={stringify:function(d){try{return decodeURIComponent(escape(p.stringify(d)))}catch(k){throw Error("Malformed UTF-8 data");}},parse:function(d){return p.parse(unescape(encodeURIComponent(d)))}},n=b.BufferedBlockAlgorithm=g.extend({reset:function(){this._data=new d.init;this._nDataBytes=0},_append:function(d){"string"==typeof d&&(d=k.parse(d));this._data.concat(d);this._nDataBytes+=
d.sigBytes},_process:function(k){var n=this._data,c=n.words,b=n.sigBytes,g=this.blockSize,h=b/(4*g),h=k?e.ceil(h):e.max((h|0)-this._minBufferSize,0);k=h*g;b=e.min(4*k,b);if(k){for(var w=0;w<k;w+=g)this._doProcessBlock(c,w);w=c.splice(0,k);n.sigBytes-=b}return new d.init(w,b)},clone:function(){var d=g.clone.call(this);d._data=this._data.clone();return d},_minBufferSize:0});b.Hasher=n.extend({cfg:g.extend(),init:function(d){this.cfg=this.cfg.extend(d);this.reset()},reset:function(){n.reset.call(this);
this._doReset()},update:function(d){this._append(d);this._process();return this},finalize:function(d){d&&this._append(d);return this._doFinalize()},blockSize:16,_createHelper:function(d){return function(k,n){return(new d.init(n)).finalize(k)}},_createHmacHelper:function(d){return function(k,n){return(new w.HMAC.init(d,n)).finalize(k)}}});var w=c.algo={};return c}(Math);(function(e){var a=F,c=a.lib,b=c.WordArray,g=c.Hasher,c=a.algo,d=[],h=[];(function(){function b(d){for(var k=e.sqrt(d),n=2;n<=k;n++)if(!(d%
n))return!1;return!0}function k(d){return 4294967296*(d-(d|0))|0}for(var n=2,c=0;64>c;)b(n)&&(8>c&&(d[c]=k(e.pow(n,.5))),h[c]=k(e.pow(n,1/3)),c++),n++})();var m=[],c=c.SHA256=g.extend({_doReset:function(){this._hash=new b.init(d.slice(0))},_doProcessBlock:function(d,k){for(var n=this._hash.words,c=n[0],b=n[1],g=n[2],e=n[3],a=n[4],f=n[5],l=n[6],q=n[7],D=0;64>D;D++){if(16>D)m[D]=d[k+D]|0;else{var I=m[D-15],J=m[D-2];m[D]=((I<<25|I>>>7)^(I<<14|I>>>18)^I>>>3)+m[D-7]+((J<<15|J>>>17)^(J<<13|J>>>19)^J>>>
10)+m[D-16]}I=q+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&f^~a&l)+h[D]+m[D];J=((c<<30|c>>>2)^(c<<19|c>>>13)^(c<<10|c>>>22))+(c&b^c&g^b&g);q=l;l=f;f=a;a=e+I|0;e=g;g=b;b=c;c=I+J|0}n[0]=n[0]+c|0;n[1]=n[1]+b|0;n[2]=n[2]+g|0;n[3]=n[3]+e|0;n[4]=n[4]+a|0;n[5]=n[5]+f|0;n[6]=n[6]+l|0;n[7]=n[7]+q|0},_doFinalize:function(){var d=this._data,k=d.words,n=8*this._nDataBytes,c=8*d.sigBytes;k[c>>>5]|=128<<24-c%32;k[(c+64>>>9<<4)+14]=e.floor(n/4294967296);k[(c+64>>>9<<4)+15]=n;d.sigBytes=4*k.length;this._process();
return this._hash},clone:function(){var d=g.clone.call(this);d._hash=this._hash.clone();return d}});a.SHA256=g._createHelper(c);a.HmacSHA256=g._createHmacHelper(c)})(Math);(function(){var e=F,a=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(c,b){c=this._hasher=new c.init;"string"==typeof b&&(b=a.parse(b));var g=c.blockSize,d=4*g;b.sigBytes>d&&(b=c.finalize(b));b.clamp();for(var h=this._oKey=b.clone(),e=this._iKey=b.clone(),p=h.words,k=e.words,n=0;n<g;n++)p[n]^=1549556828,k[n]^=909522486;
h.sigBytes=e.sigBytes=d;this.reset()},reset:function(){var c=this._hasher;c.reset();c.update(this._iKey)},update:function(c){this._hasher.update(c);return this},finalize:function(c){var b=this._hasher;c=b.finalize(c);b.reset();return b.finalize(this._oKey.clone().concat(c))}})})();(function(){var e=F,a=e.lib.WordArray;e.enc.Base64={stringify:function(c){var b=c.words,g=c.sigBytes,d=this._map;c.clamp();c=[];for(var h=0;h<g;h+=3)for(var e=(b[h>>>2]>>>24-h%4*8&255)<<16|(b[h+1>>>2]>>>24-(h+1)%4*8&255)<<
8|b[h+2>>>2]>>>24-(h+2)%4*8&255,a=0;4>a&&h+.75*a<g;a++)c.push(d.charAt(e>>>6*(3-a)&63));if(b=d.charAt(64))for(;c.length%4;)c.push(b);return c.join("")},parse:function(c){var b=c.length,g=this._map,d=g.charAt(64);d&&(d=c.indexOf(d),-1!=d&&(b=d));for(var d=[],h=0,e=0;e<b;e++)if(e%4){var p=g.indexOf(c.charAt(e-1))<<e%4*2,k=g.indexOf(c.charAt(e))>>>6-e%4*2;d[h>>>2]|=(p|k)<<24-h%4*8;h++}return a.create(d,h)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}})();var q={internetUpUrlWithoutExtension:"https://internet-up.ably-realtime.com/is-the-internet-up",
httpTransports:["xhr","iframe","jsonp"],transports:["web_socket","xhr","iframe","jsonp"],minified:!function(){}.name},v=function(){function e(d){return null!==d&&void 0!==d&&void 0!==d.sigBytes}function a(d){return null!==d&&void 0!==d&&d.constructor===g}function c(){}var b=F.lib.WordArray,g=window.ArrayBuffer;c.supportsBinary=!!window.TextDecoder;c.isBuffer=function(d){return a(d)||e(d)};c.toArrayBuffer=function(d){if(!g)throw Error("Can't convert to ArrayBuffer: ArrayBuffer not supported");if(a(d))return d;
if(e(d)){for(var c=new g(d.sigBytes),b=new Uint8Array(c),p=0;p<d.sigBytes;p++)b[p]=d.words[p>>>2]>>>24-p%4*8&255;return c}throw Error("BufferUtils.toArrayBuffer expected a buffer");};c.toWordArray=function(d){return e(d)?d:b.create(d)};c.base64Encode=function(d){if(a(d)){var c="";d=new Uint8Array(d);for(var b=d.byteLength,g=b%3,b=b-g,k,n,w,s,y=0;y<b;y+=3)s=d[y]<<16|d[y+1]<<8|d[y+2],k=(s&16515072)>>18,n=(s&258048)>>12,w=(s&4032)>>6,s&=63,c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[k]+
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[n]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[w]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[s];1==g?(s=d[b],c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(s&252)>>2]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(s&3)<<4]+"=="):2==g&&(s=d[b]<<8|d[b+1],c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(s&64512)>>10]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(s&
1008)>>4]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(s&15)<<2]+"=");return c}if(e(d))return F.enc.Base64.stringify(d)};c.base64Decode=function(d){if(g){d=window.atob(d);for(var c=d.length,b=new Uint8Array(c),e=0;e<c;e++){var k=d.charCodeAt(e);b[e]=k}return b.buffer}return F.enc.Base64.parse(d)};c.utf8Encode=function(d){return F.enc.Utf8.parse(d)};c.utf8Decode=function(d){a(d)&&(d=c.toWordArray(d));if(e(d))return F.enc.Utf8.stringify(d);throw Error("Expected input of utf8Decode to be a buffer or CryptoJS WordArray");
};c.bufferCompare=function(d,b){if(!d)return-1;if(!b)return 1;d=c.toWordArray(d);b=c.toWordArray(b);d.clamp();b.clamp();var g=d.sigBytes-b.sigBytes;if(0!=g)return g;d=d.words;b=b.words;for(var e=0;e<d.length;e++)if(g=d[e]-b[e],0!=g)return g;return 0};return c}(),L=function(){function e(){}"object"==typeof window&&(e.create=function(e,c,b){var g="";b&&(g=new Date,g.setTime(g.getTime()+b),g="; expires="+g.toGMTString());document.cookie=e+"="+c+g+"; path=/"},e.read=function(e){e+="=";for(var c=document.cookie.split(";"),
b=0;b<c.length;b++){for(var g=c[b];" "==g.charAt(0);)g=g.substring(1,g.length);if(0==g.indexOf(e))return g.substring(e.length,g.length)}return null},e.erase=function(a){e.create(a,"",-36E5)});return e}(),x=function(){function e(){}var a=function(){};e.get=function(c,b,g,d,h){h=h||a;var m="function"==typeof b?b:function(d){return c.baseUri(d)+b},p,k=c.connection;p=k&&"connected"==k.state?[k.connectionManager.host]:q.getHosts(c.options);1==p.length?e.getUri(c,m(p[0]),g,d,h):e.getUri(c,m(p.shift()),
g,d,function(k){if(k){var b=k.code;if("ENETUNREACH"==b||"EHOSTUNREACH"==b||"EHOSTDOWN"==b){e.getUri(c,m(p.shift()),g,d,h);return}}h.apply(null,arguments)})};e.getUri=function(c,b,g,d,h){e.Request(b,g,d,null,h||a)};e.post=function(c,b,g,d,h,m){m=m||a;var p="function"==typeof b?b:function(d){return c.baseUri(d)+b},k,n=c.connection;k=n&&"connected"==n.state?[n.connectionManager.host]:q.getHosts(c.options);1==k.length?e.postUri(c,p(k[0]),g,d,h,m):e.postUri(c,p(k.shift()),g,d,h,function(b){if(b){var n=
b.code;if("ENETUNREACH"==n||"EHOSTUNREACH"==n||"EHOSTDOWN"==n){e.postUri(c,p(k.shift()),g,d,h,m);return}}m.apply(null,arguments)})};e.postUri=function(c,b,g,d,h,m){e.Request(b,g,h,d,m||a)};e.supportsAuthHeaders=!1;e.supportsLinkHeaders=!1;return e}(),ca=function(){function e(){this.buffer=[]}function a(c){this._input=c;this._index=-1;this._buffer=[]}function c(c){this._input=c;this._index=-1;this._buffer=[]}e.prototype.append=function(c){this.buffer.push(c);return this};e.prototype.toString=function(){return this.buffer.join("")};
var b={codex:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(c){var d=new e,h=b.codex;for(c=new a(c);c.moveNext();){var m=c.current;c.moveNext();var p=c.current;c.moveNext();var k=c.current,n=m>>2,m=(m&3)<<4|p>>4,w=(p&15)<<2|k>>6,s=k&63;isNaN(p)?w=s=64:isNaN(k)&&(s=64);d.append(h.charAt(n)+h.charAt(m)+h.charAt(w)+h.charAt(s))}return d.toString()},decode:function(b){var d=new e;for(b=new c(b);b.moveNext();){var a=b.current;if(128>a)d.append(String.fromCharCode(a));
else if(191<a&&224>a){b.moveNext();var m=b.current;d.append(String.fromCharCode((a&31)<<6|m&63))}else b.moveNext(),m=b.current,b.moveNext(),d.append(String.fromCharCode((a&15)<<12|(m&63)<<6|b.current&63))}return d.toString()}};a.prototype={current:Number.NaN,moveNext:function(){if(0<this._buffer.length)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return this.current=Number.NaN,!1;var c=this._input.charCodeAt(++this._index);13==c&&10==this._input.charCodeAt(this._index+
1)&&(c=10,this._index+=2);128>c?this.current=c:(127<c&&2048>c?this.current=c>>6|192:(this.current=c>>12|224,this._buffer.push(c>>6&63|128)),this._buffer.push(c&63|128));return!0}};c.prototype={current:64,moveNext:function(){if(0<this._buffer.length)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return this.current=64,!1;var c=b.codex.indexOf(this._input.charAt(++this._index)),d=b.codex.indexOf(this._input.charAt(++this._index)),e=b.codex.indexOf(this._input.charAt(++this._index)),
a=b.codex.indexOf(this._input.charAt(++this._index)),f=(e&3)<<6|a;this.current=c<<2|d>>4;64!=e&&this._buffer.push((d&15)<<4|e>>2);64!=a&&this._buffer.push(f);return!0}};return b}(),M=function(){function e(){}e.addListener=function(e,c,b){e.addEventListener?e.addEventListener(c,b,!1):e.attachEvent("on"+c,function(){b.apply(e,arguments)})};e.removeListener=function(e,c,b){e.removeEventListener?e.removeEventListener(c,b,!1):e.detachEvent("on"+c,function(){b.apply(e,arguments)})};e.addMessageListener=
function(a,c){e.addListener(a,"message",c)};e.removeMessageListener=function(a,c){e.removeListener(a,"message",c)};e.addUnloadListener=function(a){e.addListener(window,"unload",a)};return e}();(function(e){this.msgpack=e()}).call(this,function(){function e(d,c,b){for(var e=0,g=b.length;e<g;e++){var a=b.charCodeAt(e);if(128>a)d.setUint8(c++,a>>>0&127|0);else if(2048>a)d.setUint8(c++,a>>>6&31|192),d.setUint8(c++,a>>>0&63|128);else if(65536>a)d.setUint8(c++,a>>>12&15|224),d.setUint8(c++,a>>>6&63|128),
d.setUint8(c++,a>>>0&63|128);else if(1114112>a)d.setUint8(c++,a>>>18&7|240),d.setUint8(c++,a>>>12&63|128),d.setUint8(c++,a>>>6&63|128),d.setUint8(c++,a>>>0&63|128);else throw Error("bad codepoint "+a);}}function a(d,c,b){var e="",g=c;for(c+=b;g<c;g++)if(b=d.getUint8(g),0===(b&128))e+=String.fromCharCode(b);else if(192===(b&224))e+=String.fromCharCode((b&15)<<6|d.getUint8(++g)&63);else if(224===(b&240))e+=String.fromCharCode((b&15)<<12|(d.getUint8(++g)&63)<<6|(d.getUint8(++g)&63)<<0);else if(240===
(b&248))e+=String.fromCharCode((b&7)<<18|(d.getUint8(++g)&63)<<12|(d.getUint8(++g)&63)<<6|(d.getUint8(++g)&63)<<0);else throw Error("Invalid byte "+b.toString(16));return e}function c(d){for(var c=0,b=0,e=d.length;b<e;b++){var g=d.charCodeAt(b);if(128>g)c+=1;else if(2048>g)c+=2;else if(65536>g)c+=3;else if(1114112>g)c+=4;else throw Error("bad codepoint "+g);}return c}function b(d,c){this.offset=c||0;this.view=d}function g(d,c){return Object.keys(d).filter(function(b){b=d[b];return(!c||void 0!==b&&
null!==b)&&("function"!==typeof b||!!b.toJSON)})}function d(k,b,a,h){var m=typeof k;if("string"===m){var f=c(k);if(32>f)return b.setUint8(a,f|160),e(b,a+1,k),1+f;if(256>f)return b.setUint8(a,217),b.setUint8(a+1,f),e(b,a+2,k),2+f;if(65536>f)return b.setUint8(a,218),b.setUint16(a+1,f),e(b,a+3,k),3+f;if(4294967296>f)return b.setUint8(a,219),b.setUint32(a+1,f),e(b,a+5,k),5+f}if(k instanceof ArrayBuffer){f=k.byteLength;if(256>f)return b.setUint8(a,196),b.setUint8(a+1,f),(new Uint8Array(b.buffer)).set(new Uint8Array(k),
a+2),2+f;if(65536>f)return b.setUint8(a,197),b.setUint16(a+1,f),(new Uint8Array(b.buffer)).set(new Uint8Array(k),a+3),3+f;if(4294967296>f)return b.setUint8(a,198),b.setUint32(a+1,f),(new Uint8Array(b.buffer)).set(new Uint8Array(k),a+5),5+f}if("number"===m){if(Math.floor(k)!==k)return b.setUint8(a,203),b.setFloat64(a+1,k),9;if(0<=k){if(128>k)return b.setUint8(a,k),1;if(256>k)return b.setUint8(a,204),b.setUint8(a+1,k),2;if(65536>k)return b.setUint8(a,205),b.setUint16(a+1,k),3;if(4294967296>k)return b.setUint8(a,
206),b.setUint32(a+1,k),5;if(1.8446744073709552E19>k)return b.setUint8(a,207),a+=1,1.8446744073709552E19>k?(b.setUint32(a,Math.floor(k*p)),b.setInt32(a+4,k&-1)):(b.setUint32(a,4294967295),b.setUint32(a+4,4294967295)),9;throw Error("Number too big 0x"+k.toString(16));}if(-32<=k)return b.setInt8(a,k),1;if(-128<=k)return b.setUint8(a,208),b.setInt8(a+1,k),2;if(-32768<=k)return b.setUint8(a,209),b.setInt16(a+1,k),3;if(-2147483648<=k)return b.setUint8(a,210),b.setInt32(a+1,k),5;if(-9223372036854775808<=
k)return b.setUint8(a,211),a+=1,0x7fffffffffffffff>k?(b.setInt32(a,Math.floor(k*p)),b.setInt32(a+4,k&-1)):(b.setUint32(a,2147483647),b.setUint32(a+4,2147483647)),9;throw Error("Number too small -0x"+(-k).toString(16).substr(1));}if("undefined"===m){if(h)return 0;b.setUint8(a,212);b.setUint8(a+1,0);b.setUint8(a+2,0);return 3}if(null===k){if(h)return 0;b.setUint8(a,192);return 1}if("boolean"===m)return b.setUint8(a,k?195:194),1;if("function"===typeof k.toJSON)return d(k.toJSON(),b,a,h);if("object"===
m){var m=0,l=Array.isArray(k);if(l)f=k.length;else var O=g(k,h),f=O.length;16>f?(b.setUint8(a,f|(l?144:128)),m=1):65536>f?(b.setUint8(a,l?220:222),b.setUint16(a+1,f),m=3):4294967296>f&&(b.setUint8(a,l?221:223),b.setUint32(a+1,f),m=5);if(l)for(l=0;l<f;l++)m+=d(k[l],b,a+m,h);else for(l=0;l<f;l++)var P=O[l],m=m+d(P,b,a+m),m=m+d(k[P],b,a+m,h);return m}if("function"===m)return 0;throw Error("Unknown type "+m);}function h(d,b){var a=typeof d;if("string"===a){var e=c(d);if(32>e)return 1+e;if(256>e)return 2+
e;if(65536>e)return 3+e;if(4294967296>e)return 5+e}if(d instanceof ArrayBuffer){e=d.byteLength;if(256>e)return 2+e;if(65536>e)return 3+e;if(4294967296>e)return 5+e}if("number"===a){if(Math.floor(d)!==d)return 9;if(0<=d){if(128>d)return 1;if(256>d)return 2;if(65536>d)return 3;if(4294967296>d)return 5;if(1.8446744073709552E19>d)return 9;throw Error("Number too big 0x"+d.toString(16));}if(-32<=d)return 1;if(-128<=d)return 2;if(-32768<=d)return 3;if(-2147483648<=d)return 5;if(-9223372036854775808<=d)return 9;
throw Error("Number too small -0x"+d.toString(16).substr(1));}if("boolean"===a)return 1;if(null===d)return b?0:1;if(void 0===d)return b?0:3;if("function"===typeof d.toJSON)return h(d.toJSON(),b);if("object"===a){a=0;if(Array.isArray(d))for(var e=d.length,m=0;m<e;m++)a+=h(d[m],b);else for(var f=g(d,b),e=f.length,m=0;m<e;m++)var p=f[m],a=a+(h(p)+h(d[p],b));if(16>e)return 1+a;if(65536>e)return 3+a;if(4294967296>e)return 5+a;throw Error("Array or object too long 0x"+e.toString(16));}if("function"===a)return 0;
throw Error("Unknown type "+a);}var m={inspect:function(d){if(void 0===d)return"undefined";var b,c;d instanceof ArrayBuffer?(c="ArrayBuffer",b=new DataView(d)):d instanceof DataView&&(c="DataView",b=d);if(!b)return JSON.stringify(d);for(var a=[],e=0;e<d.byteLength;e++){if(20<e){a.push("...");break}var g=b.getUint8(e).toString(16);1===g.length&&(g="0"+g);a.push(g)}return"<"+c+" "+a.join(" ")+">"}};m.utf8Write=e;m.utf8Read=a;m.utf8ByteCount=c;m.encode=function(b,c){var a=h(b,c);if(0!=a){var a=new ArrayBuffer(a),
e=new DataView(a);d(b,e,0,c);return a}};m.decode=function(d){var c=new DataView(d),c=new b(c),a=c.parse();if(c.offset!==d.byteLength)throw Error(d.byteLength-c.offset+" trailing bytes");return a};var p=1/4294967296;b.prototype.map=function(d){for(var b={},c=0;c<d;c++){var a=this.parse();b[a]=this.parse()}return b};b.prototype.bin=b.prototype.buf=function(d){var b=new ArrayBuffer(d);(new Uint8Array(b)).set(new Uint8Array(this.view.buffer,this.offset,d),0);this.offset+=d;return b};b.prototype.str=function(d){var b=
a(this.view,this.offset,d);this.offset+=d;return b};b.prototype.array=function(d){for(var b=Array(d),c=0;c<d;c++)b[c]=this.parse();return b};b.prototype.ext=function(d){var b={};b.type=this.view.getInt8(this.offset);this.offset++;b.data=this.buf(d);this.offset+=d;return b};b.prototype.parse=function(){var d=this.view.getUint8(this.offset);if(0===(d&128))return this.offset++,d;if(128===(d&240))return this.offset++,this.map(d&15);if(144===(d&240))return this.offset++,this.array(d&15);if(160===(d&224))return this.offset++,
this.str(d&31);if(224===(d&224))return d=this.view.getInt8(this.offset),this.offset++,d;switch(d){case 192:return this.offset++,null;case 193:this.offset++;return;case 194:return this.offset++,!1;case 195:return this.offset++,!0;case 196:return d=this.view.getUint8(this.offset+1),this.offset+=2,this.bin(d);case 197:return d=this.view.getUint16(this.offset+1),this.offset+=3,this.bin(d);case 198:return d=this.view.getUint32(this.offset+1),this.offset+=5,this.bin(d);case 199:return d=this.view.getUint8(this.offset+
1),this.offset+=2,this.ext(d);case 200:return d=this.view.getUint16(this.offset+1),this.offset+=3,this.ext(d);case 201:return d=this.view.getUint32(this.offset+1),this.offset+=5,this.ext(d);case 202:return d=this.view.getFloat32(this.offset+1),this.offset+=5,d;case 203:return d=this.view.getFloat64(this.offset+1),this.offset+=9,d;case 204:return d=this.view.getUint8(this.offset+1),this.offset+=2,d;case 205:return d=this.view.getUint16(this.offset+1),this.offset+=3,d;case 206:return d=this.view.getUint32(this.offset+
1),this.offset+=5,d;case 207:var d=this.view,b=this.offset+1,b=b||0,d=4294967296*d.getUint32(b)+d.getUint32(b+4);this.offset+=9;return d;case 208:return d=this.view.getInt8(this.offset+1),this.offset+=2,d;case 209:return d=this.view.getInt16(this.offset+1),this.offset+=3,d;case 210:return d=this.view.getInt32(this.offset+1),this.offset+=5,d;case 211:return d=this.view,b=(b=this.offset+1)||0,d=4294967296*d.getInt32(b)+d.getUint32(b+4),this.offset+=9,d;case 212:return this.offset++,this.ext(1);case 213:return this.offset++,
this.ext(2);case 214:return this.offset++,this.ext(4);case 215:return this.offset++,this.ext(8);case 216:return this.offset++,this.ext(16);case 217:return d=this.view.getUint8(this.offset+1),this.offset+=2,this.str(d);case 218:return d=this.view.getUint16(this.offset+1),this.offset+=3,this.str(d);case 219:return d=this.view.getUint32(this.offset+1),this.offset+=5,this.str(d);case 220:return d=this.view.getUint16(this.offset+1),this.offset+=3,this.array(d);case 221:return d=this.view.getUint32(this.offset+
1),this.offset+=5,this.array(d);case 222:return d=this.view.getUint16(this.offset+1),this.offset+=3,this.map(d);case 223:return d=this.view.getUint32(this.offset+1),this.offset+=5,this.map(d)}throw Error("Unknown type 0x"+d.toString(16));};return m});q.protocolVersion=1;q.ENVIRONMENT="";q.HOST="rest.ably.io";q.WS_HOST="realtime.ably.io";q.FALLBACK_HOSTS=["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"];q.PORT=80;q.TLS_PORT=443;q.TIMEOUTS=
{disconnectedRetryTimeout:15E3,suspendedRetryTimeout:3E4,httpRequestTimeout:15E3,connectionStateTtl:6E4,realtimeRequestTimeout:1E4,recvTimeout:9E4,connectionPersistTimeout:15E3};q.httpMaxRetryCount=3;q.version="0.8.8";q.getHost=function(a,f,c){return f=c?f==a.host&&a.wsHost||f||a.wsHost:f||a.host};q.getPort=function(a,f){return f||a.tls?a.tlsPort:a.port};q.getHttpScheme=function(a){return a.tls?"https://":"http://"};q.getHosts=function(a){var f=[a.host],c=a.fallbackHosts;a="undefined"!==typeof a.httpMaxRetryCount?
a.httpMaxRetryCount:q.httpMaxRetryCount;c&&(f=f.concat(c.slice(0,a)));return f};q.normaliseOptions=function(a){if(a.host)a.wsHost=a.wsHost||a.host;else{var f=a.environment&&String(a.environment).toLowerCase()||q.ENVIRONMENT,c=!f||"production"===f;a.host=c?q.HOST:f+"-"+q.HOST;a.wsHost=c?q.WS_HOST:f+"-"+q.WS_HOST;a.fallbackHosts=c?q.FALLBACK_HOSTS:a.fallbackHosts}a.port=a.port||q.PORT;a.tlsPort=a.tlsPort||q.TLS_PORT;"tls"in a||(a.tls=!0);a.timeouts={};for(var b in q.TIMEOUTS)a.timeouts[b]=a[b]||q.TIMEOUTS[b];
return a};var t=function(){function e(){this.any=[];this.events={};this.anyOnce=[];this.eventsOnce={}}e.prototype.on=function(a,c){1==arguments.length&&"function"==typeof a?this.any.push(a):null===a?this.any.push(c):(this.events[a]||(this.events[a]=[])).push(c)};e.prototype.off=function(a,c){if(0==arguments.length)this.any=[],this.events={},this.anyOnce=[],this.eventsOnce={};else{1==arguments.length&&"function"==typeof a&&(c=a,a=null);var b,e=-1;if(null===a)if(c){if(!(b=this.any)||-1==(e=l.arrIndexOf(b,
c)))if(b=this.anyOnce)e=l.arrIndexOf(b,c);-1<e&&b.splice(e,1)}else this.any=[],this.anyOnce=[];else if(c){e=-1;if(!(b=this.events[a])||-1==(e=l.arrIndexOf(b,c)))if(b=this.eventsOnce[a])e=l.arrIndexOf(b,c);-1<e&&b.splice(e,1)}else delete this.events[a],delete this.eventsOnce[a]}};e.prototype.listeners=function(a){if(a){var c=this.events[a]||[];this.eventsOnce[a]&&Array.prototype.push.apply(c,this.eventsOnce[a]);return c.length?c:null}return this.any.length?this.any:null};e.prototype.emit=function(e){function c(d){try{d.apply(g,
b)}catch(c){throw a.logAction(a.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+c+"; stack = "+c.stack),c;}}var b=Array.prototype.slice.call(arguments,1),g={event:e};if(this.anyOnce.length){var d=this.anyOnce;this.anyOnce=[];for(var h=0;h<d.length;h++)c(d[h])}for(h=0;h<this.any.length;h++)this.any[h].apply(g,b);if(d=this.eventsOnce[e])for(delete this.eventsOnce[e],h=0;h<d.length;h++)c(d[h]);if(d=this.events[e])for(h=0;h<d.length;h++)c(d[h])};e.prototype.once=function(a,c){1==arguments.length&&
"function"==typeof a?this.anyOnce.push(a):null===a?this.anyOnce.push(c):(this.eventsOnce[a]||(this.eventsOnce[a]=[])).push(c)};return e}(),a=function(){function a(b){}var f=2,c=console&&function(){console.log.apply(console,arguments)};a.LOG_NONE=0;a.LOG_ERROR=1;a.LOG_MAJOR=2;a.LOG_MINOR=3;a.LOG_MICRO=4;a.LOG_DEFAULT=2;a.LOG_DEBUG=4;a.logAction=function(b,g,d){a.shouldLog(b)&&c("Ably: "+g+": "+d)};a.shouldLog=function(b){return b<=f};a.setLog=function(b,a){void 0!==b&&(f=b);void 0!==a&&(c=a)};return a}(),
l=function(){function a(){}var f="object"==typeof window;a.mixin=function(b,a){for(var d in a)a.hasOwnProperty(d)&&(b[d]=a[d]);return b};a.copy=function(b){return a.mixin({},b)};a.isArray=function(b){return"[object Array]"==Object.prototype.toString.call(b)};a.isObject=function(b){return"[object Object]"==Object.prototype.toString.call(b)};a.isEmpty=function(b){for(var a in b)return!1;return!0};a.shallowClone=function(b){var a={},d;for(d in b)a[d]=b[d];return a};a.prototypicalClone=function(b,c){function d(){}
d.prototype=b;var h=new d;c&&a.mixin(h,c);return h};a.inherits=function(b,c){b.super_=c;b.prototype=a.prototypicalClone(c.prototype,{constructor:b})};a.containsValue=function(b,a){for(var d in b)if(b[d]==a)return!0;return!1};a.intersect=function(b,c){return a.isArray(c)?a.arrIntersect(b,c):a.arrIntersectOb(b,c)};a.isArray=Array.isArray?Array.isArray:function(b){return"[object Array]"===Object.prototype.toString.call(b)};a.arrIntersect=function(b,c){for(var d=[],h=0;h<b.length;h++){var m=b[h];-1!=
a.arrIndexOf(c,m)&&d.push(m)}return d};a.arrIntersectOb=function(b,a){for(var d=[],c=0;c<b.length;c++){var e=b[c];e in a&&d.push(e)}return d};a.arrSubtract=function(b,c){for(var d=[],h=0;h<b.length;h++){var m=b[h];-1==a.arrIndexOf(c,m)&&d.push(m)}return d};a.arrIndexOf=Array.prototype.indexOf?function(a,c,d){return a.indexOf(c,d)}:function(a,c,d){d=d||0;for(var e=a.length;d<e;d++)if(a[d]===c)return d;return-1};a.arrIn=function(b,c){return-1!==a.arrIndexOf(b,c)};a.arrDeleteValue=function(b,c){var d=
a.arrIndexOf(b,c),h=-1!=d;h&&b.splice(d,1);return h};a.keysArray=function(a,c){var d=[],e;for(e in a)c&&!a.hasOwnProperty(e)||d.push(e);return d.length?d:void 0};a.valuesArray=function(a,c){var d=[],e;for(e in a)c&&!a.hasOwnProperty(e)||d.push(a[e]);return d.length?d:void 0};a.nextTick=f?function(a){setTimeout(a,0)}:process.nextTick;var c={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};a.defaultGetHeaders=function(a){a=
a||"json";return{accept:"json"===a?c.json:c[a]+","+c.json}};a.defaultPostHeaders=function(a){a=a||"json";return{accept:"json"===a?c.json:c[a]+","+c.json,"content-type":"json"===a?c.json:c[a]}};a.arrRandomElement=function(a){return a.splice(Math.floor(Math.random()*a.length))};a.toQueryString=function(a){var c=[];if(a)for(var d in a)c.push(encodeURIComponent(d)+"="+encodeURIComponent(a[d]));return c.length?"?"+c.join("&"):""};a.parseQueryString=function(a){for(var c,d=/([^?&=]+)=?([^&]*)/g,e={};c=
d.exec(a);)e[decodeURIComponent(c[1])]=decodeURIComponent(c[2]);return e};a.inspect=function(a){return JSON.stringify(a)};a.inspectError=function(c){return c&&"ErrorInfo"==c.constructor.name?c.toString():a.inspect(c)};return a}(),U=function(){return function(a){a=a||[];var f=function(){for(var c=0;c<a.length;c++){var b=a[c];try{b.apply(null,arguments)}catch(g){}}};f.push=function(){Array.prototype.push.apply(a,arguments)};return f}}(),u=function(){function a(e,c,b){this.message=e;this.code=c;this.statusCode=
b}a.prototype.toString=function(){var a="["+this.constructor.name;this.message&&(a+=": "+this.message);this.statusCode&&(a+="; statusCode="+this.statusCode);this.code&&(a+="; code="+this.code);return a+"]"};a.fromValues=function(f){return l.mixin(new a,f)};return a}(),B=function(){function e(){this.encoding=this.data=this.connectionKey=this.connectionId=this.clientId=this.timestamp=this.id=this.name=void 0}var f="object"==typeof window?window.Ably.msgpack:(void 0)("msgpack-js");e.prototype.toJSON=
function(){var a={name:this.name,clientId:this.clientId,connectionId:this.connectionId,connectionKey:this.connectionKey,encoding:this.encoding},b=this.data;if(b&&v.isBuffer(b))if(0<arguments.length){var e=this.encoding;a.encoding=e?e+"/base64":"base64";b=v.base64Encode(b)}else b=v.toArrayBuffer(b);a.data=b;return a};e.prototype.toString=function(){var a="[Message";this.name&&(a+="; name="+this.name);this.id&&(a+="; id="+this.id);this.timestamp&&(a+="; timestamp="+this.timestamp);this.clientId&&(a+=
"; clientId="+this.clientId);this.connectionId&&(a+="; connectionId="+this.connectionId);this.encoding&&(a+="; encoding="+this.encoding);this.data&&(a="string"==typeof data?a+("; data="+this.data):v.isBuffer(this.data)?a+("; data (buffer)="+v.base64Encode(this.data)):a+("; data (json)="+JSON.stringify(this.data)));return a+"]"};e.encrypt=function(a,b){var e=a.data,d=a.encoding,h=b.cipher,d=d?d+"/":"";v.isBuffer(e)||(e=v.utf8Encode(String(e)),d+="utf-8/");a.data=h.encrypt(e);a.encoding=d+"cipher+"+
h.algorithm};e.encode=function(a,b){var g=a.data,d;if("string"!=typeof g&&!v.isBuffer(g)&&null!==g&&void 0!==g)if(l.isObject(g)||l.isArray(g))a.data=JSON.stringify(g),a.encoding=(d=a.encoding)?d+"/json":"json";else throw new u("Data type is unsupported",40013,400);null!=b&&b.encrypted&&e.encrypt(a,b)};e.toRequestBody=function(a,b,g){for(var d=0;d<a.length;d++)e.encode(a[d],b);return"msgpack"==g?f.encode(a,!0):JSON.stringify(a)};e.decode=function(a,b){var e=a.encoding;if(e){var e=e.split("/"),d,h=
e.length,m=a.data;try{for(;0<(d=h);){var f=e[--h].match(/([\-\w]+)(\+([\w\-]+))?/);if(!f)break;var k=f[1];switch(k){case "base64":m=v.base64Decode(String(m));continue;case "utf-8":m=v.utf8Decode(m);continue;case "json":m=JSON.parse(m);continue;case "cipher":if(null!=b&&b.encrypted){var n=b.cipher;if(f[3]!=n.algorithm)throw Error("Unable to decrypt message with given cipher; incompatible cipher params");m=n.decrypt(m);continue}else throw Error("Unable to decrypt message; not an encrypted channel");
default:throw Error("Unknown encoding");}}}catch(w){throw new u("Error processing the "+k+" encoding, decoder returned \u2018"+w.message+"\u2019",40013,400);}finally{a.encoding=0>=d?null:e.slice(0,d).join("/"),a.data=m}}};e.fromResponseBody=function(c,b,g,d){g&&(c="msgpack"==g?f.decode(c):JSON.parse(String(c)));for(g=0;g<c.length;g++){var h=c[g]=e.fromDecoded(c[g]);try{e.decode(h,b)}catch(m){a.logAction(a.LOG_ERROR,"Message.fromResponseBody()",m.toString()),d.emit("error",m)}}return c};e.fromDecoded=
function(a){return l.mixin(new e,a)};e.fromValues=function(a){return l.mixin(new e,a)};e.fromValuesArray=function(a){for(var b=a.length,g=Array(b),d=0;d<b;d++)g[d]=e.fromValues(a[d]);return g};return e}(),C=function(){function e(){this.encoding=this.data=this.connectionId=this.clientId=this.timestamp=this.id=this.action=void 0}var f="object"==typeof window?window.Ably.msgpack:(void 0)("msgpack-js");e.Action={ABSENT:0,PRESENT:1,ENTER:2,LEAVE:3,UPDATE:4};e.prototype.toJSON=function(){var a={clientId:this.clientId,
action:this.action,encoding:this.encoding},b=this.data;if(b&&v.isBuffer(b))if(0<arguments.length){var e=this.encoding;a.encoding=e?e+"/base64":"base64";b=v.base64Encode(b)}else b=v.toArrayBuffer(b);a.data=b;return a};e.prototype.toString=function(){var a;a="[PresenceMessage; action="+this.action;this.id&&(a+="; id="+this.id);this.timestamp&&(a+="; timestamp="+this.timestamp);this.clientId&&(a+="; clientId="+this.clientId);this.connectionId&&(a+="; connectionId="+this.connectionId);this.encoding&&
(a+="; encoding="+this.encoding);this.data&&(a="string"==typeof data?a+("; data="+this.data):v.isBuffer(this.data)?a+("; data (buffer)="+v.base64Encode(this.data)):a+("; data (json)="+JSON.stringify(this.data)));return a+"]"};e.encode=B.encode;e.decode=B.decode;e.fromResponseBody=function(c,b,g,d){g&&(c="msgpack"==g?f.decode(c):JSON.parse(String(c)));for(g=0;g<c.length;g++){var h=c[g]=e.fromDecoded(c[g]);try{e.decode(h,b)}catch(m){a.logAction(a.LOG_ERROR,"PresenceMessage.fromResponseBody()",m.toString()),
d.emit("error",m)}}return c};e.fromDecoded=function(a){return l.mixin(new e,a)};e.fromValues=function(a){return l.mixin(new e,a)};e.fromValuesArray=function(a){for(var b=a.length,g=Array(b),d=0;d<b;d++)g[d]=e.fromValues(a[d]);return g};return e}(),r=function(){function a(){this.presence=this.messages=this.msgSerial=this.channelSerial=this.channel=this.connectionSerial=this.connectionKey=this.connectionId=this.error=this.count=this.timestamp=this.id=this.flags=this.action=void 0}function f(a){var d=
[];if(a)for(var b=0;b<a.length;b++)d.push(a[b].toString());return"[ "+d.join(", ")+" ]"}var c="object"==typeof window?window.Ably.msgpack:(void 0)("msgpack-js");a.Action={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16};a.ActionName=[];Object.keys(a.Action).forEach(function(b){a.ActionName[a.Action[b]]=b});a.Flag={HAS_PRESENCE:0,HAS_BACKLOG:1};a.encode=function(a,d){return"msgpack"==
d?c.encode(a,!0):JSON.stringify(a)};a.decode=function(b,d){var h="msgpack"==d?c.decode(b):JSON.parse(String(b));return a.fromDecoded(h)};a.fromDecoded=function(b){var d=b.error;d&&(b.error=u.fromValues(d));var c=b.messages;if(c)for(d=0;d<c.length;d++)c[d]=B.fromDecoded(c[d]);if(c=b.presence)for(d=0;d<c.length;d++)c[d]=C.fromDecoded(c[d]);return l.mixin(new a,b)};a.fromValues=function(b){return l.mixin(new a,b)};var b="id channel channelSerial connectionId connectionKey connectionSerial count flags messageSerial timestamp".split(" ");
a.stringify=function(c){var d="[ProtocolMessage";void 0!==c.action&&(d+="; action="+a.ActionName[c.action]||c.action);for(var h,m=0;m<b.length;m++)h=b[m],void 0!==c[h]&&(d+="; "+h+"="+c[h]);c.messages&&(d+="; messages="+f(B.fromValuesArray(c.messages)));c.presence&&(d+="; presence="+f(C.fromValuesArray(c.presence)));c.error&&(d+="; error="+u.fromValues(c.error).toString());return d+"]"};return a}(),da=function(){function a(d){this.count=d&&d.count||0;this.data=d&&d.data||0}function f(a){this.peak=
a&&a.peak||0;this.min=a&&a.min||0;this.mean=a&&a.mean||0;this.opened=a&&a.opened||0;this.refused=a&&a.refused||0}function c(a){this.succeeded=a&&a.succeeded||0;this.failed=a&&a.failed||0;this.refused=a&&a.refused||0}function b(a){this.plain=new f(a&&a.plain);this.tls=new f(a&&a.tls);this.all=new f(a&&a.all)}function g(d){this.messages=new a(d&&d.messages);this.presence=new a(d&&d.presence);this.all=new a(d&&d.all)}function d(a){this.realtime=new g(a&&a.realtime);this.rest=new g(a&&a.rest);this.webhook=
new g(a&&a.webhook);this.all=new g(a&&a.all)}function h(a){this.all=new g(a&&a.all);this.inbound=new d(a&&a.inbound);this.outbound=new d(a&&a.outbound);this.persisted=new g(a&&a.persisted);this.connections=new b(a&&a.connections);this.channels=new f(a&&a.channels);this.apiRequests=new c(a&&a.apiRequests);this.tokenRequests=new c(a&&a.tokenRequests);this.inProgress=a&&a.inProgress||void 0;this.unit=a&&a.unit||void 0;this.intervalId=a&&a.intervalId||void 0}h.fromValues=function(a){return new h(a)};
return h}(),K={disconnected:{statusCode:408,code:80003,message:"Connection to server temporarily unavailable"},suspended:{statusCode:408,code:80002,message:"Connection to server unavailable"},failed:{statusCode:408,code:8E4,message:"Connection failed or disconnected by server"},closed:{statusCode:408,code:80017,message:"Connection closed"},unknownConnectionErr:{statusCode:500,code:50002,message:"Internal connection error"},unknownChannelErr:{statusCode:500,code:50001,message:"Internal channel error"}},
Z=function(){function e(){t.call(this);this.messages=[]}l.inherits(e,t);e.prototype.count=function(){return this.messages.length};e.prototype.push=function(a){this.messages.push(a)};e.prototype.shift=function(){return this.messages.shift()};e.prototype.last=function(){return this.messages[this.messages.length-1]};e.prototype.copyAll=function(){return this.messages.slice()};e.prototype.append=function(a){this.messages.push.apply(this.messages,a.messages)};e.prototype.prepend=function(a){this.messages.unshift.apply(this.messages,
a.messages)};e.prototype.completeMessages=function(e,c,b){a.logAction(a.LOG_MICRO,"MessageQueue.completeMessages()","serial = "+e+"; count = "+c);b=b||null;var g=this.messages,d=g[0];if(d){d=d.message.msgSerial;e+=c;if(e>d)for(e=g.splice(0,e-d),c=0;c<e.length;c++)e[c].callback(b);0==g.length&&this.emit("idle")}};return e}(),$=function(){function e(a){t.call(this);this.transport=a;this.messageQueue=new Z;var b=this;a.on("ack",function(a,d){b.onAck(a,d)});a.on("nack",function(a,d,c){b.onNack(a,d,c)})}
var f=r.Action;l.inherits(e,t);e.prototype.onAck=function(c,b){a.logAction(a.LOG_MICRO,"Protocol.onAck()","serial = "+c+"; count = "+b);this.messageQueue.completeMessages(c,b)};e.prototype.onNack=function(c,b,e){a.logAction(a.LOG_ERROR,"Protocol.onNack()","serial = "+c+"; count = "+b+"; err = "+l.inspectError(e));e||(e=Error("Unknown error"),e.statusCode=500,e.code=50001,e.message="Unable to send message; channel not responding");this.messageQueue.completeMessages(c,b,e)};e.prototype.onceIdle=function(a){var b=
this.messageQueue;if(0===b.count())a();else b.once("idle",a)};e.prototype.send=function(c,b){c.ackRequired&&this.messageQueue.push(c);a.shouldLog(a.LOG_MICRO)&&a.logAction(a.LOG_MICRO,"Protocol.send()","sending msg; "+r.stringify(c.message));this.transport.send(c.message,b)};e.prototype.getTransport=function(){return this.transport};e.prototype.getPendingMessages=function(){return this.messageQueue.copyAll()};e.prototype.finish=function(){var a=this.transport;this.onceIdle(function(){a.disconnect()})};
e.PendingMessage=function(a,b){this.message=a;this.callback=b;this.merged=!1;var e=a.action;this.ackRequired=e==f.MESSAGE||e==f.PRESENCE};return e}(),A=function(){function e(a,d,b,c,e){this.options=a;this.host=d;this.mode=b;this.connectionKey=c;this.connectionSerial=e;this.format=a.useBinaryProtocol?"msgpack":"json";a.transportParams&&void 0!==a.transportParams.stream&&(this.stream=a.transportParams.stream)}function f(d,c){t.call(this);this.realtime=d;this.options=c;var e=c.timeouts;this.states={initialized:{state:"initialized",
terminal:!1,queueEvents:!0,sendEvents:!1},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:e.realtimeRequestTimeout,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},synchronizing:{state:"connected",terminal:!1,queueEvents:!0,sendEvents:!1},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:e.disconnectedRetryTimeout},suspended:{state:"suspended",terminal:!1,
queueEvents:!1,sendEvents:!1,retryDelay:e.suspendedRetryTimeout},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:e.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1}};this.state=this.states.initialized;this.error=null;this.queuedMessages=new Z;this.msgSerial=0;this.connectionSerial=this.connectionKey=this.connectionId=void 0;this.httpTransports=l.intersect(c.transports||
q.httpTransports,f.httpTransports);this.transports=l.intersect(c.transports||q.transports,f.transports);this.upgradeTransports=l.arrSubtract(this.transports,this.httpTransports);this.httpHosts=q.getHosts(c);this.activeProtocol=null;this.pendingTransports=[];this.host=null;a.logAction(a.LOG_MINOR,"Realtime.ConnectionManager()","started");a.logAction(a.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(c.transports||q.transports)+"]");a.logAction(a.LOG_MICRO,"Realtime.ConnectionManager()",
"available http transports = ["+this.httpTransports+"]");a.logAction(a.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]");a.logAction(a.LOG_MICRO,"Realtime.ConnectionManager()","http hosts = ["+this.httpHosts+"]");if(!this.transports.length)throw a.logAction(a.LOG_ERROR,"realtime.ConnectionManager()","no requested transports available"),Error("no requested transports available");b&&!0===c.recover&&window.addEventListener&&window.addEventListener("beforeunload",
this.persistConnection.bind(this));if("object"===typeof window&&window.addEventListener){var h=this;window.addEventListener("online",function(){if(h.state==h.states.disconnected||h.state==h.states.suspended)a.logAction(a.LOG_MINOR,"ConnectionManager caught browser \u2018online\u2019 event","reattempting connection"),h.requestState({state:"connecting"})});window.addEventListener("offline",function(){h.state==h.states.connected&&(a.logAction(a.LOG_MINOR,"ConnectionManager caught browser \u2018offline\u2019 event",
"disconnecting active transport"),h.disconnectAllTransports())})}}var c="undefined"!==typeof L&&L.read,b="undefined"!==typeof L&&L.create,g="undefined"!==typeof L&&L.erase,d=r.Action,h=$.PendingMessage,m=function(){},p=function(a){var d=[40140],b=[80015,80017,80030];return a.code?l.arrIn(d,a.code)?!1:l.arrIn(b,a.code)?!0:4E4<=a.code&&5E4>a.code:500>a.statusCode};e.prototype.getConnectParams=function(a){a=a?l.prototypicalClone(a):{};var d=this.options;switch(this.mode){case "upgrade":a.upgrade=this.connectionKey;
break;case "resume":a.resume=this.connectionKey;void 0!==this.connectionSerial&&(a.connection_serial=this.connectionSerial);break;case "recover":if(!0===d.recover){var b=c("ably-connection-key"),e=c("ably-connection-serial");null!==b&&null!==e&&(a.recover=b,a.connection_serial=e)}else if(b=d.recover.match(/^(\w+):(\w+)$/))a.recover=b[1],a.connection_serial=b[2]}void 0!==d.clientId&&(a.clientId=d.clientId);!1===d.echoMessages&&(a.echo="false");void 0!==this.format&&(a.format=this.format);void 0!==
this.stream&&(a.stream=this.stream);return a};l.inherits(f,t);f.httpTransports={};f.transports={};f.prototype.chooseTransport=function(d){a.logAction(a.LOG_MAJOR,"ConnectionManager.chooseTransport()","");if(this.activeProtocol)a.logAction(a.LOG_MINOR,"ConnectionManager.chooseTransport()","Transport already established"),d(null);else{var b=this.connectionKey?"resume":this.options.recover?"recover":"clean",c=new e(this.options,null,b,this.connectionKey,this.connectionSerial);a.logAction(a.LOG_MINOR,
"ConnectionManager.chooseTransport()","Transport recovery mode = "+b+("clean"==b?"":"; connectionKey = "+this.connectionKey+"; connectionSerial = "+this.connectionSerial));var h=this;this.httpTransports.length?this.chooseHttpTransport(c,function(b,n){if(b)a.logAction(a.LOG_ERROR,"ConnectionManager.chooseTransport()","Unexpected error establishing transport; err = "+l.inspectError(b)),d(b);else if(a.logAction(a.LOG_MINOR,"ConnectionManager.chooseTransport()","Establishing http transport: "+n),d(null,
n),h.upgradeTransports.length)n.once("connected",function(d,b){l.nextTick(function(){a.logAction(a.LOG_MAJOR,"ConnectionManager.chooseTransport()","upgrading ... connectionKey = "+b);c=new e(h.options,c.host,"upgrade",b);h.chooseTransportForHost(c,h.upgradeTransports.slice(),m)})})}):(c.host=this.httpHosts[0],a.logAction(a.LOG_MINOR,"ConnectionManager.chooseTransport()","No http transports available; ignoring fallback hosts"),this.chooseTransportForHost(c,h.transports.slice(),d))}};f.prototype.chooseTransportForHost=
function(d,b,c){var e=b.shift();if(e){var h=this;a.logAction(a.LOG_MICRO,"ConnectionManager.chooseTransportForHost()","trying "+e);f.transports[e].tryConnect(this,this.realtime.auth,d,function(g,f){var m=h.state;m==h.states.closing||m==h.states.closed||m==h.states.failed?(a.logAction(a.LOG_MINOR,"ConnectionManager.chooseTransportForHost()","connection closing"),f&&(a.logAction(a.LOG_MINOR,"ConnectionManager.chooseTransportForHost()","closing transport = "+f),f.close()),g=new u("Connection already closed",
400,80017),c(g)):g?p(g)?c(g):h.chooseTransportForHost(d,b,c):(a.logAction(a.LOG_MICRO,"ConnectionManager.chooseTransportForHost()","transport "+e+" connecting"),h.setTransportPending(f,d.mode),c(null,f))})}else{var g=Error("Unable to connect (no available transport)");g.statusCode=404;g.code=8E4;c(g)}};f.prototype.chooseHttpTransport=function(a,d){function b(){if(c.length)f.httpTransports[h.httpTransports[0]].checkConnectivity(function(e,g){e?d(e):g?(a.host=l.arrRandomElement(c),h.chooseTransportForHost(a,
h.httpTransports.slice(),function(a,c){a?p(a)?d(a):b():d(null,c)})):(e=Error("Unable to connect (network unreachable)"),e.statusCode=404,e.code=8E4,d(e))});else{var e=Error("Unable to connect (no available host)");e.statusCode=404;e.code=8E4;d(e)}}var c=this.httpHosts.slice(),e=c.shift();if(e){a.host=e;var h=this;this.chooseTransportForHost(a,this.httpTransports.slice(),function(a,c){a?p(a)?d(a):b():d(null,c)})}else e=Error("Unable to connect (no available host)"),e.statusCode=404,e.code=8E4,d(e)};
f.prototype.setTransportPending=function(d,b){a.logAction(a.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+d+"; mode = "+b);this.pendingTransports.push(d);var c=this;d.on("connected",function(a,e,h,g,f){"upgrade"==b&&c.activeProtocol?c.scheduleTransportActivation(d):c.activateTransport(d,e,h,g,f)});for(var e=function(a){return function(b){c.deactivateTransport(d,a,b)}},h=["disconnected","closed","failed"],g=0;g<h.length;g++){var f=h[g];d.on(f,e(f))}this.emit("transport.pending",
d)};f.prototype.scheduleTransportActivation=function(d){var b=this;a.logAction(a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Scheduling transport; transport = "+d);this.realtime.channels.onceNopending(function(c){c?a.logAction(a.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Unable to activate transport; transport = "+d+"; err = "+c):(b.state=b.states.synchronizing,a.logAction(a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Activating transport; transport = "+
d),b.activateTransport(d,b.connectionKey,b.connectionSerial,b.connectionId),a.logAction(a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Syncing transport; transport = "+d),b.sync(d,function(c,e,h){c?a.logAction(a.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Unexpected error attempting to sync transport; transport = "+d+"; err = "+c):(a.logAction(a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","sync successful upgraded transport; transport = "+d+"; connectionSerial = "+
e+"; connectionId = "+h),a.logAction(a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Sending queued messages on upgraded transport; transport = "+d),b.state=b.states.connected,b.sendQueuedMessages())}))})};f.prototype.activateTransport=function(d,b,c,e,h){a.logAction(a.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+d);b&&a.logAction(a.LOG_MICRO,"ConnectionManager.activateTransport()","connectionKey =  "+b);void 0!==c&&a.logAction(a.LOG_MICRO,"ConnectionManager.activateTransport()",
"connectionSerial =  "+c);e&&a.logAction(a.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+e);h&&a.logAction(a.LOG_MICRO,"ConnectionManager.activateTransport()","clientId =  "+h);var g=this.state;if(g!=this.states.closing&&g!=this.states.closed){l.arrDeleteValue(this.pendingTransports,d);var f=this.activeProtocol;this.activeProtocol=new $(d);this.host=d.params.host;b&&this.connectionKey!=b&&this.setConnection(e,b,c);c=this.realtime.auth;if(h){if(c.clientId&&c.clientId!=h){b=new u("Unexpected mismatch between expected and received clientId",
40102,401);a.logAction(a.LOG_ERROR,"ConnectionManager.activateTransport()","Unexpected mismatch between expected and received clientId");d.abort(b);return}c.clientId=h}this.emit("transport.active",d,b,d.params);g!==this.states.connected&&this.notifyState({state:"connected"});f&&f.finish();for(d=0;d<this.pendingTransports.length;d++)this.pendingTransports[d].disconnect()}};f.prototype.deactivateTransport=function(d,b,c){a.logAction(a.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+
d);a.logAction(a.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+b);c&&c.message&&a.logAction(a.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+c.message);var e=this.activeProtocol&&this.activeProtocol.getTransport()===d,h=l.arrDeleteValue(this.pendingTransports,d);e&&(this.queuePendingMessages(this.activeProtocol.getPendingMessages()),this.activeProtocol=this.host=null);this.emit("transport.inactive",d);if(e||h&&0===this.pendingTransports.length)"failed"===b&&c&&!p(c)&&
(b="disconnected"),this.notifyState({state:b,error:c})};f.prototype.sync=function(b,c){if(!b.isConnected)throw new u("Unable to sync connection; not connected",4E4);var e=r.fromValues({action:d.SYNC,connectionKey:this.connectionKey,connectionSerial:this.connectionSerial});b.send(e,function(d){d&&a.logAction(a.LOG_ERROR,"ConnectionManager.sync()","Unexpected error sending sync message; err = "+u.fromValues(d).toString())});b.once("sync",function(a,d){c(null,a,d)})};f.prototype.setConnection=function(a,
d,b){this.realtime.connection.id=this.connectionId=a;this.realtime.connection.key=this.connectionKey=d;this.realtime.connection.serial=this.connectionSerial=void 0===b?-1:b;this.msgSerial=0;!0===this.options.recover&&this.persistConnection()};f.prototype.clearConnection=function(){this.realtime.connection.id=this.connectionId=void 0;this.realtime.connection.key=this.connectionKey=void 0;this.realtime.connection.serial=this.connectionSerial=void 0;this.msgSerial=0;this.unpersistConnection()};f.prototype.persistConnection=
function(){b&&this.connectionKey&&void 0!==this.connectionSerial&&(b("ably-connection-key",this.connectionKey,this.options.timeouts.connectionPersistTimeout),b("ably-connection-serial",this.connectionSerial,this.options.timeouts.connectionPersistTimeout))};f.prototype.unpersistConnection=function(){g&&(g("ably-connection-key"),g("ably-connection-serial"))};f.prototype.getStateError=function(){return K[this.state.state]};f.activeState=function(a){return a.queueEvents||a.sendEvents};f.prototype.enactStateChange=
function(d){a.logAction(a.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+d.current+"; reason = "+(d.reason&&d.reason.message));(this.state=this.states[d.current]).terminal&&(this.error=d.reason,this.clearConnection());this.emit("connectionstate",d)};f.prototype.startTransitionTimer=function(d){a.logAction(a.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+d.state);this.transitionTimer&&(a.logAction(a.LOG_MINOR,"ConnectionManager.startTransitionTimer()",
"clearing already-running timer"),clearTimeout(this.transitionTimer));var b=this;this.transitionTimer=setTimeout(function(){b.transitionTimer&&(b.transitionTimer=null,a.logAction(a.LOG_MINOR,"ConnectionManager connect timer expired","requesting new state: "+b.states.connecting.failState),b.notifyState({state:d.failState}))},d.retryDelay)};f.prototype.cancelTransitionTimer=function(){a.logAction(a.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()","");this.transitionTimer&&(clearTimeout(this.transitionTimer),
this.transitionTimer=null)};f.prototype.startSuspendTimer=function(){var d=this;this.suspendTimer||(this.suspendTimer=setTimeout(function(){d.suspendTimer&&(d.suspendTimer=null,a.logAction(a.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),d.states.connecting.failState="suspended",d.states.connecting.queueEvents=!1,d.notifyState({state:"suspended"}))},this.options.timeouts.connectionStateTtl))};f.prototype.checkSuspendTimer=function(a){"disconnected"!==a&&"suspended"!==
a&&"connecting"!==a&&this.cancelSuspendTimer()};f.prototype.cancelSuspendTimer=function(){this.states.connecting.failState="disconnected";this.states.connecting.queueEvents=!0;this.suspendTimer&&(clearTimeout(this.suspendTimer),this.suspendTimer=null)};f.prototype.startRetryTimer=function(d){var b=this;this.retryTimer=setTimeout(function(){a.logAction(a.LOG_MINOR,"ConnectionManager retry timer expired","retrying");b.retryTimer=null;b.requestState({state:"connecting"})},d)};f.prototype.cancelRetryTimer=
function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)};f.prototype.notifyState=function(d){var b=d.state,c=this;a.logAction(a.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+b);if(b!=this.state.state&&(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(d.state),!this.state.terminal)){var e=this.states[d.state];d=new V(this.state.state,e.state,e.retryDelay,d.error||K[e.state]);this.state===this.states.connected&&"disconnected"===b?l.nextTick(function(){c.requestState({state:"connecting"})}):
e.retryDelay&&this.startRetryTimer(e.retryDelay);this.enactStateChange(d);this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents||this.realtime.channels.setSuspended(d.reason)}};f.prototype.requestState=function(d){var b=d.state,c=this;a.logAction(a.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+b);if(b!=this.state.state){this.cancelTransitionTimer();this.cancelRetryTimer();this.checkSuspendTimer(b);if("connecting"==b){if("connected"==this.state.state)return;l.nextTick(function(){c.connectImpl()})}else if("closing"==
b){if("closed"==this.state.state)return;l.nextTick(function(){c.closeImpl()})}b=this.states[b];d=new V(this.state.state,b.state,b.retryIn,d.error||K[b.state]);this.enactStateChange(d)}};f.prototype.connectImpl=function(){var d=this.state;if(d==this.states.closing||d==this.states.closed||d==this.states.failed)a.logAction(a.LOG_MINOR,"ConnectionManager.connectImpl()","abandoning connection attempt; state = "+d.state);else{a.logAction(a.LOG_MINOR,"ConnectionManager.connectImpl()","starting connection");
this.startSuspendTimer();this.startTransitionTimer(this.states.connecting);var b=this,c=this.realtime.auth,e=function(d){a.logAction(a.LOG_ERROR,"ConnectionManager.connectImpl()","Connection attempt failed with error; err = "+u.fromValues(d).toString());var h=b.state;h!=b.states.closing&&h!=b.states.closed&&h!=b.states.failed&&(40140==d.code?c.authorise(null,null,function(a){a?e(a):b.connectImpl()}):d.code&&p(d)?b.notifyState({state:"failed",error:d}):b.notifyState({state:b.states.connecting.failState,
error:d}))},h=function(){b.chooseTransport(function(a){a&&e(a)})};"basic"==c.method?h():c.authorise(null,null,function(a){a?e(a):h()})}};f.prototype.closeImpl=function(){function d(b){a.logAction(a.LOG_MINOR,"ConnectionManager.closeImpl()","closing transport: "+b);if(b)try{a.logAction(a.LOG_MINOR,"ConnectionManager.closeImpl()","closing transport: "+b),b.close()}catch(c){var e="Unexpected exception attempting to close transport; e = "+c;a.logAction(a.LOG_ERROR,"ConnectionManager.closeImpl()",e);e=
new u(e,5E4,500);b.abort(e)}}a.logAction(a.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection");this.cancelSuspendTimer();this.startTransitionTimer(this.states.closing);for(var b=0;b<this.pendingTransports.length;b++)d(this.pendingTransports[b]);d(this.activeProtocol&&this.activeProtocol.getTransport());this.notifyState({state:"closed"})};f.prototype.disconnectAllTransports=function(){function d(b){if(b)try{a.logAction(a.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","disconnecting transport: "+
b),b.disconnect()}catch(c){var e="Unexpected exception attempting to disconnect transport; e = "+c;a.logAction(a.LOG_ERROR,"ConnectionManager.disconnectAllTransports()",e);e=new u(e,5E4,500);b.abort(e)}}a.logAction(a.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","disconnecting all transports");for(var b=0;b<this.pendingTransports.length;b++)d(this.pendingTransports[b]);d(this.activeProtocol&&this.activeProtocol.getTransport())};f.prototype.send=function(d,b,c){c=c||m;var e=this.state;e.sendEvents?
(a.logAction(a.LOG_MICRO,"ConnectionManager.send()","sending event"),this.sendImpl(new h(d,c))):e.queueEvents&&(e==this.states.synchronizing||b?(a.shouldLog(a.LOG_MICRO)&&a.logAction(a.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+r.stringify(d)),this.queue(d,c)):(a.logAction(a.LOG_MICRO,"ConnectionManager.send()","rejecting event; state = "+e.state),c(this.error)))};f.prototype.sendImpl=function(d){var b=d.message;d.ackRequired&&(b.msgSerial=this.msgSerial++);try{this.activeProtocol.send(d,
function(a){})}catch(c){a.logAction(a.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+c.stack)}};f.prototype.queue=function(d,b){a.logAction(a.LOG_MICRO,"ConnectionManager.queue()","queueing event");var c=this.queuedMessages.last();c&&aa.mergeTo(c.message,d)?(c.merged||(c.callback=U([c.callback]),c.merged=!0),c.callback.push(b)):this.queuedMessages.push(new h(d,b))};f.prototype.sendQueuedMessages=function(){a.logAction(a.LOG_MICRO,"ConnectionManager.sendQueuedMessages()",
"sending "+this.queuedMessages.count()+" queued messages");for(var d;d=this.queuedMessages.shift();)this.sendImpl(d)};f.prototype.queuePendingMessages=function(d){d&&d.length&&(a.logAction(a.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+d.length+" pending messages"),this.queuedMessages.prepend(d))};f.prototype.onChannelMessage=function(b,c){if(this.activeProtocol&&c===this.activeProtocol.getTransport()){var e=b.connectionSerial;e<=this.connectionSerial?a.logAction(a.LOG_MICRO,"ConnectionManager.onChannelMessage() received message with connectionSerial "+
e+", but current connectionSerial is "+this.connectionSerial+"; assuming message is a duplicate and discarding it"):(void 0!==e&&(this.realtime.connection.serial=this.connectionSerial=e),this.realtime.channels.onChannelMessage(b))}else if(-1<l.arrIndexOf([d.ACK,d.NACK,d.ERROR],b.action))this.realtime.channels.onChannelMessage(b);else a.logAction(a.LOG_MICRO,"ConnectionManager.onChannelMessage()","received message "+JSON.stringify(b)+"on defunct transport; discarding")};f.prototype.ping=function(d,
b){a.logAction(a.LOG_MINOR,"ConnectionManager.ping()","transport = "+d);if(d){var c=Date.now(),e=function(){clearTimeout(h);var d=Date.now()-c;b(null,d)},h=setTimeout(function(){d.off("heartbeat",e);b(new u("Timedout waiting for heartbeat response",5E4,500))},this.options.timeouts.realtimeRequestTimeout);d.once("heartbeat",e);d.ping()}else if("connected"!==this.state.state)b(new u("Unable to ping service; not connected",4E4,400));else{var g=!1,f=this,m=function(){g||(g=!0,l.nextTick(function(){f.ping(null,
b)}))};this.on("transport.active",m);this.ping(this.activeProtocol.getTransport(),function(d,a){f.off("transport.active",m);g||(g=!0,b(d,a))})}};f.prototype.abort=function(d){this.activeProtocol.getTransport().abort(d)};return f}(),E=function(){function e(a,d,b){t.call(this);this.connectionManager=a;this.auth=d;this.params=b;this.timeouts=b.options.timeouts;this.format=b.format;this.isConnected=!1}var f=r.Action,c=r.fromValues({action:f.CLOSE}),b=function(){};l.inherits(e,t);e.prototype.connect=function(){};
e.prototype.close=function(){this.isConnected&&this.sendClose();this.emit("closed");this.dispose()};e.prototype.disconnect=function(){this.isConnected&&(this.isConnected=!1,this.emit("disconnected",K.disconnected),this.dispose())};e.prototype.abort=function(a){this.isConnected&&(this.isConnected=!1,this.sendClose());this.emit("failed",a);this.dispose()};e.prototype.onProtocolMessage=function(b){a.shouldLog(a.LOG_MICRO)&&a.logAction(a.LOG_MICRO,"Transport.onProtocolMessage()","received; "+r.stringify(b));
switch(b.action){case f.HEARTBEAT:a.logAction(a.LOG_MICRO,"Transport.onProtocolMessage()","heartbeat; connectionKey = "+this.connectionManager.connectionKey);this.emit("heartbeat");break;case f.CONNECTED:this.onConnect(b);this.emit("connected",null,b.connectionDetails?b.connectionDetails.connectionKey:b.connectionKey,b.connectionSerial,b.connectionId,b.connectionDetails?b.connectionDetails.clientId:null);break;case f.CLOSED:this.isConnected=!1;this.onClose(b);break;case f.DISCONNECTED:this.isConnected=
!1;this.onDisconnect(b);break;case f.ACK:this.emit("ack",b.msgSerial,b.count);break;case f.NACK:this.emit("nack",b.msgSerial,b.count,b.error);break;case f.SYNC:if(void 0!==b.connectionId){this.emit("sync",b.connectionSerial,b.connectionId);break}this.connectionManager.onChannelMessage(b,this);break;case f.ERROR:var d=b.error;a.logAction(a.LOG_ERROR,"Transport.onProtocolMessage()","error; connectionKey = "+this.connectionManager.connectionKey+"; err = "+JSON.stringify(d));if(void 0===b.channel){this.abort({statusCode:d.statusCode,
code:d.code,message:d.message});break}this.connectionManager.onChannelMessage(b,this);break;default:this.connectionManager.onChannelMessage(b,this)}};e.prototype.onConnect=function(a){var d=a.connectionKey.match(/^(?:[\w\-]+\!)?([^!]+)$/),d=a.connectionKey=d&&d[1];a=a.error;var b=this.connectionManager;a&&d!==b.connectionKey&&b.realtime.channels.setSuspended(a);this.connectionKey=d;this.isConnected=!0};e.prototype.onDisconnect=function(b){this.isConnected=!1;b=b&&b.error;a.logAction(a.LOG_MINOR,"Transport.onDisconnect()",
"err = "+l.inspectError(b));this.emit("disconnected",b)};e.prototype.onClose=function(b){this.isConnected=!1;b=b&&b.error;a.logAction(a.LOG_MINOR,"Transport.onClose()","err = "+l.inspectError(b));this.emit("closed",b)};e.prototype.sendClose=function(){a.logAction(a.LOG_MINOR,"Transport.sendClose()","");this.send(c,b)};e.prototype.ping=function(a){this.send(r.fromValues({action:r.Action.HEARTBEAT}),a||b)};e.prototype.dispose=function(){a.logAction(a.LOG_MINOR,"Transport.dispose()","");this.off()};
return e}();(function(){function e(a,b,e){E.call(this,a,b,e);this.wsHost=q.getHost(e.options,e.host,!0)}var f="object"==typeof window?window.WebSocket||window.MozWebSocket:(void 0)("ws");l.inherits(e,E);e.isAvailable=function(){return!!f};e.isAvailable()&&(A.transports.web_socket=e);e.tryConnect=function(c,b,g,d){var h=new e(c,b,g),f=function(a){d(a)};h.on("wserror",f);h.on("wsopen",function(){a.logAction(a.LOG_MINOR,"WebSocketTransport.tryConnect()","viable transport "+h);h.off("wserror",f);h.cancelConnectTimeout();
d(null,h)});h.startConnectTimeout();h.connect()};e.prototype.createWebSocket=function(a,b){var e=0;if(b)for(var d in b)a+=(e++?"&":"?")+d+"="+b[d];this.uri=a;return new f(a)};e.prototype.toString=function(){return"WebSocketTransport; uri="+this.uri};e.prototype.connect=function(){a.logAction(a.LOG_MINOR,"WebSocketTransport.connect()","starting");E.prototype.connect.call(this);var c=this,b=this.params,e=b.options,d=(e.tls?"wss://":"ws://")+this.wsHost+":"+q.getPort(e)+"/";a.logAction(a.LOG_MINOR,"WebSocketTransport.connect()",
"uri: "+d);this.auth.getAuthParams(function(e,g){var f="",k;for(k in g)f+=" "+k+": "+g[k]+";";a.logAction(a.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+f);if(e)c.abort(e);else{f=b.getConnectParams(g);try{var n=c.wsConnection=c.createWebSocket(d,f);n.binaryType="arraybuffer";n.onopen=function(){c.onWsOpen()};n.onclose=function(a){c.onWsClose(a)};n.onmessage=function(a){c.onWsData(a.data)};n.onerror=function(a){c.onWsError(a)}}catch(w){a.logAction(a.LOG_ERROR,"WebSocketTransport.connect()",
"Unexpected exception creating websocket: err = "+(w.stack||w.message)),c.onWsError(w)}}})};e.prototype.send=function(a,b){var e=this.wsConnection;e?(e.send(r.encode(a,this.params.format)),b&&b(null)):b&&b(new u("No socket connection"))};e.prototype.onWsData=function(c){a.logAction(a.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+c.length+"; type = "+typeof c);try{this.onProtocolMessage(r.decode(c,this.format))}catch(b){a.logAction(a.LOG_ERROR,"WebSocketTransport.onWsData()",
"Unexpected exception handing channel message: "+b.stack)}};e.prototype.onWsOpen=function(){a.logAction(a.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket");this.emit("wsopen")};e.prototype.onWsClose=function(c){var b;"object"==typeof c?(b=c.wasClean,c=c.code):b=1E3==c;a.logAction(a.LOG_MINOR,"WebSocketTransport.onWsClose()","closed WebSocket; wasClean = "+b+"; code = "+c);delete this.wsConnection;b=b?null:new u("Unclean disconnection of websocket",80003);E.prototype.onDisconnect.call(this,
b);this.emit("disposed")};e.prototype.onWsError=function(c){a.logAction(a.LOG_ERROR,"WebSocketTransport.onError()","Unexpected error from WebSocket: "+c.message);this.emit("wserror",c);this.abort()};e.prototype.dispose=function(){a.logAction(a.LOG_MINOR,"WebSocketTransport.dispose()","");var c=this.wsConnection;c&&(delete this.wsConnection,l.nextTick(function(){a.logAction(a.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket");c.close()}))};e.prototype.startConnectTimeout=function(){a.logAction(a.LOG_MICRO,
"WebSocketTransport.startConnectTimeout()");var c=this;this.connectTimeout=setTimeout(function(){a.logAction(a.LOG_MICRO,"WebSocketTransport.startConnectTimeout()","Websocket failed to open after connectTimeout expired; disposing");c.dispose()},this.timeouts.realtimeRequestTimeout)};e.prototype.cancelConnectTimeout=function(){this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=null)};return e})();var N=function(){function e(a,c,b){b.format=void 0;E.call(this,a,c,b);this.stream=
"stream"in b?b.stream:!0;this.pendingItems=this.pendingCallback=this.recvRequest=this.sendRequest=null;this.disposed=!1}l.inherits(e,E);e.REQ_SEND=0;e.REQ_RECV=1;e.REQ_RECV_POLL=2;e.REQ_RECV_STREAM=3;e.prototype.connect=function(){a.logAction(a.LOG_MINOR,"CometTransport.connect()","starting");E.prototype.connect.call(this);var e=this,c=this.params,b=c.options,c=q.getHost(b,c.host),g=q.getPort(b);this.baseUri=(b.tls?"https://":"http://")+c+":"+g+"/comet/";var d=this.baseUri+"connect";a.logAction(a.LOG_MINOR,
"CometTransport.connect()","uri: "+d);this.auth.getAuthParams(function(b,c){if(b)e.abort(b);else{e.authParams=c;var g=e.params.getConnectParams(c);a.logAction(a.LOG_MINOR,"CometTransport.connect()","connectParams:"+l.toQueryString(g));var k=!1,g=e.recvRequest=e.createRequest(d,null,g,null,e.stream?3:1);g.on("data",function(a){e.recvRequest&&(k||(k=!0,e.emit("preconnect")),e.onData(a))});g.on("complete",function(a){e.recvRequest||(a=a||new u("Request cancelled",400,8E4));e.recvRequest=null;a&&(e.emit("error",
a),e.dispose())});g.exec()}})};e.prototype.disconnect=function(){a.logAction(a.LOG_MINOR,"CometTransport.disconnect()","");this.requestClose(!1);this.emit("disconnected");this.dispose()};e.prototype.close=function(){a.logAction(a.LOG_MINOR,"CometTransport.close()","");this.requestClose(!0);this.emit("closed");this.dispose()};e.prototype.abort=function(e){a.logAction(a.LOG_MINOR,"CometTransport.abort()","err: "+e);this.requestClose(!0);this.emit("failed",e);this.dispose()};e.prototype.requestClose=
function(e){a.logAction(a.LOG_MINOR,"CometTransport.requestClose()","closing = "+e);var c=this.closeUri;if(c){var b=this;e=this.createRequest(c(e),null,this.authParams,null,0);e.on("complete",function(a){a&&b.emit("error",a)});e.exec()}};e.prototype.dispose=function(){a.logAction(a.LOG_MINOR,"CometTransport.dispose()","");if(!this.disposed){this.disposed=!0;this.recvRequest&&(a.logAction(a.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null);
E.prototype.onDisconnect.call(this);var e=this;l.nextTick(function(){e.emit("disposed")})}};e.prototype.onConnect=function(e){if(!this.disposed){var c=e.connectionKey;E.prototype.onConnect.call(this,e);var b=this.baseUri+c;a.logAction(a.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+b+"; connectionKey = "+e.connectionKey);this.sendUri=b+"/send";this.recvUri=b+"/recv";this.closeUri=function(a){return b+(a?"/close":"/disconnect")};var g=this;l.nextTick(function(){g.recv()})}};e.prototype.send=
function(a,c){if(this.sendRequest)this.pendingItems=this.pendingItems||[],this.pendingItems.push(a),c&&(this.pendingCallback=this.pendingCallback||U(),this.pendingCallback.push(c));else{var b=this.pendingItems||[];b.push(a);this.pendingItems=null;var e=this.pendingCallback;e&&(c&&e.push(c),c=e,this.pendingCallback=null);this.sendItems(b,c)}};e.prototype.sendItems=function(e,c){var b=this,g=this.sendRequest=b.createRequest(b.sendUri,null,b.authParams,this.encodeRequest(e),0);g.on("complete",function(d,
e){d&&a.logAction(a.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+JSON.stringify(d));b.sendRequest=null;if(e)b.onData(e);else d&&d.code&&(b.onData([r.fromValues({action:r.Action.ERROR,error:d})]),d=null);var g=b.pendingItems;if(g){b.pendingItems=null;var f=b.pendingCallback;b.pendingCallback=null;l.nextTick(function(){b.sendItems(g,f)})}c&&c(d)});g.exec()};e.prototype.recv=function(){if(!this.recvRequest&&this.isConnected){var a=this,c=this.recvRequest=this.createRequest(this.recvUri,
null,this.authParams,null,a.stream?3:2);c.on("data",function(b){a.onData(b)});c.on("complete",function(b){a.recvRequest=null;b?a.emit("error",b):l.nextTick(function(){a.recv()})});c.exec()}};e.prototype.onData=function(e){try{var c=this.decodeResponse(e);if(c&&c.length)for(e=0;e<c.length;e++)this.onProtocolMessage(r.fromDecoded(c[e]))}catch(b){a.logAction(a.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+b.stack)}};e.prototype.encodeRequest=function(a){return JSON.stringify(a)};
e.prototype.decodeResponse=function(a){"string"==typeof a&&(a=JSON.parse(a));return a};return e}(),R=function(){function e(a){this.channel=a;this.basePath=a.basePath+"/presence"}l.inherits(e,t);e.prototype.get=function(e,c){a.logAction(a.LOG_MICRO,"Presence.get()","channel = "+this.channel.name);void 0===c&&("function"==typeof e?(c=e,e=null):c=noop);var b=this.channel.rest,g=b.options.useBinaryProtocol?"msgpack":"json",d=x.supportsLinkHeaders?void 0:g,h=l.copy(l.defaultGetHeaders(g)),m=this.channel.options;
b.options.headers&&l.mixin(h,b.options.headers);(new Q(b,this.basePath,h,d,function(a,d,b){return C.fromResponseBody(a,m,!b&&g)})).get(e,c)};e.prototype.history=function(e,c){a.logAction(a.LOG_MICRO,"Presence.history()","channel = "+this.channel.name);this._history(e,c)};e.prototype._history=function(a,c){void 0===c&&("function"==typeof a?(c=a,a=null):c=noop);var b=this.channel.rest,e=b.options.useBinaryProtocol?"msgpack":"json",d=x.supportsLinkHeaders?void 0:e,h=l.copy(l.defaultGetHeaders(e)),m=
this.channel.options,p=this.channel;b.options.headers&&l.mixin(h,b.options.headers);(new Q(b,this.basePath+"/history",h,d,function(a,d,b){return C.fromResponseBody(a,m,!b&&e,p)})).get(a,c)};return e}(),W=function(){function e(){}function f(a,d,b,c,e){x.supportsAuthHeaders?a.auth.getAuthHeaders(function(a,h){a?c(a):e(l.mixin(h,d),b)}):a.auth.getAuthParams(function(a,h){a?c(a):e(d,l.mixin(h,b))})}function c(a,b){return function(c,e,g,f){if(c)a(c);else{if(!f)try{e="msgpack"==b?d.decode(e):JSON.parse(e)}catch(l){a(l);
return}void 0===e.statusCode?a(c,e,g,!0):(f=e.statusCode,c=e.response,g=e.headers,200>f||300<=f?(c=c&&c.error,c||(c=Error(String(res)),c.statusCode=f),a(c)):a(null,c,g,!0))}}}function b(a){var d=[];if(a)for(var b in a)d.push(b+"="+a[b]);return d.join("&")}function g(d,c,e,g){return function(n,f,l,y){n?a.logAction(a.LOG_MICRO,"Resource."+c+"()","Received Error; "+(e+(g?"?":"")+b(g))+"; Error: "+JSON.stringify(n)):a.logAction(a.LOG_MICRO,"Resource."+c+"()","Received; "+(e+(g?"?":"")+b(g))+"; Headers: "+
b(l)+"; Body: "+(v.isBuffer(f)?f.toString():f));d&&d(n,f,l,y)}}var d="object"==typeof window?window.Ably.msgpack:(void 0)("msgpack-js");e.get=function(d,e,p,k,n,l){function s(c,g){a.shouldLog(a.LOG_MICRO)&&a.logAction(a.LOG_MICRO,"Resource.get()","Sending; "+(e+(g?"?":"")+b(g)));x.get(d,e,c,g,function(a,b,c,e){a&&40140==a.code?d.auth.authorise(null,{force:!0},function(a){a?l(a):f(d,p,k,l,s)}):l(a,b,c,e)})}a.shouldLog(a.LOG_MICRO)&&(l=g(l,"get",e,k));n&&(l=l&&c(l,n),(k=k||{}).envelope=n);f(d,p,k,l,
s)};e.post=function(e,m,p,k,n,l,s){function y(c,g){if(a.shouldLog(a.LOG_MICRO)){var l=p;if(0<(c["content-type"]||"").indexOf("msgpack"))try{p=d.decode(p)}catch(w){a.logAction(a.LOG_MICRO,"Resource.post()","Sending MsgPack Decoding Error: "+JSON.stringify(w))}a.logAction(a.LOG_MICRO,"Resource.post()","Sending; "+(m+(g?"?":"")+b(g))+"; Body: "+l)}x.post(e,m,c,p,g,function(a,d,b,c){a&&40140==a.code?e.auth.authorise(null,{force:!0},function(a){a?s(a):f(e,k,n,s,y)}):s(a,d,b,c)})}a.shouldLog(a.LOG_MICRO)&&
(s=g(s,"post",m,n));l&&(s=c(s,l),n.envelope=l);f(e,k,n,s,y)};return e}(),Q=function(){function e(a,b,e,d,h){this.rest=a;this.path=b;this.headers=e;this.envelope=d;this.bodyHandler=h}function f(a,b,e){this.resource=a;this.items=b;var d=this;"first"in e&&(this.first=function(a){d.get(e.first,a)});"current"in e&&(this.current=function(a){d.get(e.current,a)});"next"in e&&(this.next=function(a){d.get(e.next,a)})}e.prototype.get=function(a,b){var e=this;W.get(e.rest,e.path,e.headers,a,e.envelope,function(a,
c,f,p){e.handlePage(a,c,f,p,b)})};e.prototype.handlePage=function(c,b,e,d,h){if(c)a.logAction(a.LOG_ERROR,"PaginatedResource.get()","Unexpected error getting resource: err = "+JSON.stringify(c)),h(c);else{var m,p,k;try{m=this.bodyHandler(b,e,d)}catch(n){h(n);return}if(e&&(p=e.Link||e.link)){c=p;"string"==typeof c&&(c=c.split(","));b={};for(e=0;e<c.length;e++)(d=c[e].match(/^\s*<(.+)>;\s*rel="(\w+)"$/))&&(p=(p=d[1].match(/^\.\/(\w+)\?(.*)$/))&&l.parseQueryString(p[2]))&&(b[d[2]]=p);k=b}h(null,new f(this,
m,k))}};f.prototype.get=function(a,b){var e=this.resource;W.get(e.rest,e.path,e.headers,a,e.envelope,function(a,c,f,p){e.handlePage(a,c,f,p,b)})};return e}(),ea=function(){function e(){}function f(a){if(!a)return"";"string"==typeof a&&(a=JSON.parse(a));var d={},b=l.keysArray(a,!0);if(!b)return"";b.sort();for(var c=0;c<b.length;c++)d[b[c]]=a[b[c]].sort();return JSON.stringify(d)}function c(d,b){this.rest=d;this.tokenParams={};this.clientId=b.clientId;var c=b.key;if(c){if(!b.clientId&&!b.useTokenAuth){a.logAction(a.LOG_MINOR,
"Auth()","anonymous, using basic auth");this.method="basic";this.key=c;this.basicKey=m(c);return}if(!h)throw c="client-side token request signing not supported",a.logAction(a.LOG_ERROR,"Auth()",c),Error(c);}if("useTokenAuth"in b&&!b.useTokenAuth)throw c="option useTokenAuth was falsey, but basic auth cannot be used"+(b.clientId?" as a clientId implies token auth":b.key?"":" as a key was not given"),a.logAction(a.LOG_ERROR,"Auth()",c),Error(c);this.method="token";b.token&&(b.tokenDetails="string"===
typeof b.token?{token:b.token}:b.token);this.tokenDetails=b.tokenDetails;this.tokenParams.clientId=b.clientId;if(b.authCallback)a.logAction(a.LOG_MINOR,"Auth()","using token auth with authCallback");else if(b.authUrl)a.logAction(a.LOG_MINOR,"Auth()","using token auth with authUrl");else if(b.keySecret)a.logAction(a.LOG_MINOR,"Auth()","using token auth with client-side signing");else if(b.tokenDetails)a.logAction(a.LOG_MINOR,"Auth()","using token auth with supplied token only");else throw c="options must include valid authentication parameters",
a.logAction(a.LOG_ERROR,"Auth()",c),Error(c);}var b="object"==typeof window,g=b?null:(void 0)("crypto"),d=b?window.Ably.msgpack:(void 0)("msgpack-js"),h,m;b?(m=ca.encode,h=function(a,d){return F.HmacSHA256(a,d).toString(F.enc.Base64)}):(m=function(a){return(new Buffer(a,"ascii")).toString("base64")},h=function(a,d){var b=g.createHmac("SHA256",d);b.update(a);return b.digest("base64")});c.prototype.authorise=function(d,b,c){var e=this.tokenDetails;if(e){if(this.clientId&&e.clientId&&this.clientId!==
e.clientId){c(new u("ClientId in token was "+e.clientId+", but library was instantiated with clientId "+this.clientId,40102,401));return}if(void 0===e.expires||e.expires>this.getTimestamp()){if(!b||!b.force){a.logAction(a.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+e.expires);c(null,e);return}}else a.logAction(a.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}var h=this;this.requestToken(d,b,function(a,d){a?c(a):c(null,h.tokenDetails=d)})};c.prototype.requestToken=
function(b,c,h){"function"!=typeof b||h?"function"!=typeof c||h||(h=c,c=null):(h=b,c=b=null);c=l.mixin(l.copy(this.rest.options),c);b=b||l.copy(this.tokenParams);h=h||e;var g=c.format||"json",m,y=this.rest;if(c.authCallback)a.logAction(a.LOG_MINOR,"Auth.requestToken()","using token auth with auth_callback"),m=c.authCallback;else if(c.authUrl)a.logAction(a.LOG_MINOR,"Auth.requestToken()","using token auth with auth_url"),c.authParams||(m=c.authUrl.indexOf("?"),-1<m&&(c.authParams=l.parseQueryString(c.authUrl.slice(m)),
c.authUrl=c.authUrl.slice(0,m))),m=function(d,b){var e=l.mixin({accept:"application/json"},c.authHeaders),h=l.mixin(d,c.authParams);a.logAction(a.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Sending; "+c.authUrl+"; Params: "+JSON.stringify(h));x.getUri(y,c.authUrl,e||{},h,function(d,c,e,h){d?a.logAction(a.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error; "+JSON.stringify(d)):a.logAction(a.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; body: "+(v.isBuffer(c)?
c.toString():c));if(d||h)return b(d,c);v.isBuffer(c)&&(c=c.toString());if(e["content-type"]&&-1<e["content-type"].indexOf("application/json"))try{c=JSON.parse(c)}catch(g){b(new u("Unexpected error processing authURL response; err = "+g.message,4E4,400));return}b(null,c)})};else if(c.key){var q=this;a.logAction(a.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing");m=function(a,d){q.createTokenRequest(a,c,d)}}else throw Error("Auth.requestToken(): authOptions must include valid authentication parameters");
"capability"in b&&(b.capability=f(b.capability));var y=this.rest,T=function(b,e){var h,f=b.keyName,m=function(a){return y.baseUri(a)+"/keys/"+f+"/requestToken"};x.post?(h=l.defaultPostHeaders(g),c.requestHeaders&&l.mixin(h,c.requestHeaders),a.logAction(a.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST; "+m+"; Token params: "+JSON.stringify(b)),b="msgpack"==g?d.encode(b,!0):JSON.stringify(b),x.post(y,m,h,b,null,e)):(h=l.defaultGetHeaders(),c.requestHeaders&&l.mixin(h,c.requestHeaders),a.logAction(a.LOG_MICRO,
"Auth.requestToken().requestToken","Sending GET; "+m+"; Token params: "+JSON.stringify(b)),x.get(y,m,h,b,e))};m(b,function(b,c){b?(a.logAction(a.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+l.inspectError(b)),"code"in b||(b.code=40170),"statusCode"in b||(b.statusCode=401),h(b)):"string"===typeof c?h(null,{token:c}):"issued"in c?h(null,c):T(c,function(b,c,e,m){b?(a.logAction(a.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+l.inspectError(b)),
h(b)):(m||(c="msgpack"==g?d.decode(c):JSON.parse(c)),a.logAction(a.LOG_MINOR,"Auth.getToken()","token received"),h(null,c))})})};c.prototype.createTokenRequest=function(d,b,c){b=l.mixin(l.copy(this.rest.options),b);d=d||l.copy(this.tokenParams);var e=b.key;if(e){var e=e.split(":"),g=e[0],m=e[1];if(m)if(""===d.clientId)c(new u("clientId can\u2019t be an empty string",40012,400));else{d.capability=f(d.capability);var q=l.mixin({keyName:g},d),T=d.clientId||"",O=d.ttl||"",P=d.capability,t=this.rest,r=
this;(function(a){q.timestamp?a():b.queryTime?t.time(function(d,b){d?c(d):(q.timestamp=b,a())}):(q.timestamp=r.getTimestamp(),a())})(function(){var d=q.nonce||(q.nonce=("000000"+Math.floor(1E16*Math.random())).slice(-16)),d=q.keyName+"\n"+O+"\n"+P+"\n"+T+"\n"+q.timestamp+"\n"+d+"\n";q.mac=q.mac||h(d,m);a.logAction(a.LOG_MINOR,"Auth.getTokenRequest()","generated signed request");c(null,q)})}else c(Error("Invalid key specified"))}else c(Error("No key specified"))};c.prototype.getAuthParams=function(a){"basic"==
this.method?a(null,{key:this.key}):this.authorise(null,null,function(d,b){d?a(d):a(null,{access_token:b.token})})};c.prototype.getAuthHeaders=function(a){"basic"==this.method?a(null,{authorization:"Basic "+this.basicKey}):this.authorise(null,null,function(d,b){d?a(d):a(null,{authorization:"Bearer "+m(b.token)})})};c.prototype.getTimestamp=function(){return Date.now()+(this.rest.serverTimeOffset||0)};return c}(),G=function(){function e(b){if(!b){var c="no options provided";a.logAction(a.LOG_ERROR,
"Rest()",c);throw Error(c);}"string"==typeof b&&(b=-1==b.indexOf(":")?{token:b}:{key:b});this.options=q.normaliseOptions(b);v.supportsBinary&&!0===this.options.useBinaryProtocol||(this.options.useBinaryProtocol=!1);if(b.key){c=b.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!c)throw c="invalid key parameter",a.logAction(a.LOG_ERROR,"Rest()",c),Error(c);b.keyName=c[1];b.keySecret=c[2]}b.log&&a.setLog(b.log.level,b.log.handler);a.logAction(a.LOG_MINOR,"Rest()","started");this.serverTimeOffset=null;this.baseUri=
this.authority=function(a){return q.getHttpScheme(b)+a+":"+q.getPort(b,!1)};this.auth=new ea(this,b);this.channels=new f(this)}function f(a){this.rest=a;this.attached={}}var c=function(){};e.prototype.stats=function(a,e){void 0===e&&("function"==typeof a?(e=a,a=null):e=c);var d=l.copy(l.defaultGetHeaders()),h=x.supportsLinkHeaders?void 0:"json";this.options.headers&&l.mixin(d,this.options.headers);(new Q(this,"/stats",d,h,function(a,d,b){a=b?a:JSON.parse(a);for(d=0;d<a.length;d++)a[d]=da.fromValues(a[d]);
return a})).get(a,e)};e.prototype.time=function(a,e){void 0===e&&("function"==typeof a?(e=a,a=null):e=c);var d=l.copy(l.defaultGetHeaders());this.options.headers&&l.mixin(d,this.options.headers);var h=this;x.get(this,function(a){return h.authority(a)+"/time"},d,a,function(a,d,b,c){a?e(a):(c||(d=JSON.parse(d)),(a=d[0])?(h.serverTimeOffset=a-Date.now(),e(null,a)):(a=Error("Internal error (unexpected result type from GET /time)"),a.statusCode=500,e(a)))})};f.prototype.get=function(a){a=String(a);var c=
this.attached[a];c||(this.attached[a]=c=new S(this.rest,a));return c};return e}(),H=function(){function e(c){a.logAction(a.LOG_MINOR,"Realtime()","");G.call(this,c);this.connection=new fa(this,this.options);this.channels=new f(this);!1!==c.autoConnect&&this.connection.connect()}function f(a){t.call(this);this.realtime=a;this.all={};this.inProgress={};var b=this;a.connection.connectionManager.on("transport.active",function(a){b.onTransportActive(a)})}l.inherits(e,G);e.prototype.close=function(){a.logAction(a.LOG_MINOR,
"Realtime.close()","");this.connection.close()};l.inherits(f,t);f.prototype.onChannelMessage=function(c){var b=c.channel;if(void 0===b)a.logAction(a.LOG_ERROR,"Channels.onChannelMessage()","received event unspecified channel, action = "+c.action);else{var e=this.all[b];if(e)e.onMessage(c);else a.logAction(a.LOG_ERROR,"Channels.onChannelMessage()","received event for non-existent channel: "+b)}};f.prototype.onTransportActive=function(){for(var a in this.inProgress)this.inProgress[a].checkPendingState()};
f.prototype.setSuspended=function(a){for(var b in this.all)this.all[b].setSuspended(a)};f.prototype.get=function(a){a=String(a);var b=this.all[a];b||(b=this.all[a]=new aa(this.realtime,a,this.realtime.options));return b};f.prototype.release=function(a){this.all[a]&&delete this.all[a]};f.prototype.setInProgress=function(a,b){b?this.inProgress[a.name]=a:(delete this.inProgress[a.name],l.isEmpty(this.inProgress)&&this.emit("nopending"))};f.prototype.onceNopending=function(a){if(l.isEmpty(this.inProgress))a();
else this.once("nopending",a)};return e}(),V=function(){return function(a,f,c,b){this.previous=a;this.current=f;c&&(this.retryIn=c);b&&(this.reason=b)}}(),fa=function(){function e(a,c){t.call(this);this.ably=a;this.connectionManager=new A(a,c);this.state=this.connectionManager.state.state;this.serial=this.id=this.key=void 0;var b=this;this.connectionManager.on("connectionstate",function(a){var d=b.state=a.current;l.nextTick(function(){b.emit(d,a)})})}l.inherits(e,t);e.prototype.on=function(a,c){t.prototype.on.apply(this,
arguments);if(this.state==a&&c)try{c(new V(void 0,a))}catch(b){}};e.prototype.connect=function(){a.logAction(a.LOG_MAJOR,"Connection.connect()","");this.connectionManager.requestState({state:"connecting"})};e.prototype.ping=function(e){a.logAction(a.LOG_MINOR,"Connection.ping()","");this.connectionManager.ping(null,e||function(){})};e.prototype.close=function(){a.logAction(a.LOG_MAJOR,"Connection.close()","connectionKey = "+this.key);this.connectionManager.requestState({state:"closing"})};return e}(),
S=function(){function e(){}function f(b,c,d){a.logAction(a.LOG_MINOR,"Channel()","started; name = "+c);t.call(this);this.rest=b;this.name=c;this.basePath="/channels/"+encodeURIComponent(c);this.presence=new R(this);this.setOptions(d)}var c={};l.inherits(f,t);f.prototype.setOptions=function(a,g){g=g||e;a=this.options=l.prototypicalClone(c,a);if(a.encrypted){if(!Crypto)throw Error("Encryption not enabled; use ably.encryption.js instead");Crypto.getCipher(a,function(d,c){a.cipher=c;g(null)})}else g(null,
a.cipher=null)};f.prototype.history=function(b,c){a.logAction(a.LOG_MICRO,"Channel.history()","channel = "+this.name);void 0===c&&("function"==typeof b?(c=b,b=null):c=e);this._history(b,c)};f.prototype._history=function(a,c){var d=this.rest,e=d.options.useBinaryProtocol?"msgpack":"json",f=x.supportsLinkHeaders?void 0:e,p=l.copy(l.defaultGetHeaders(e)),k=this.options,n=this;d.options.headers&&l.mixin(p,d.options.headers);(new Q(d,this.basePath+"/messages",p,f,function(a,d,b){return B.fromResponseBody(a,
k,!b&&e,n)})).get(a,c)};f.prototype.publish=function(){var a=arguments.length,c=arguments[0],d=arguments[a-1];"function"!==typeof d&&(d=e,++a);2==a?(l.isArray(c)||(c=[c]),c=B.fromValuesArray(c)):c=[B.fromValues({name:arguments[0],data:arguments[1]})];var a=this.rest,h=a.options.useBinaryProtocol?"msgpack":"json",c=B.toRequestBody(c,this.options,h),h=l.copy(l.defaultPostHeaders(h));a.options.headers&&l.mixin(h,a.options.headers);this._publish(c,h,d)};f.prototype._publish=function(a,c,d){W.post(this.rest,
this.basePath+"/messages",a,c,null,!1,d)};return f}(),aa=function(){function e(d,b,c){a.logAction(a.LOG_MINOR,"RealtimeChannel()","started; name = "+b);S.call(this,d,b,c);this.presence=new ga(this,c);this.connectionManager=d.connection.connectionManager;this.state="initialized";this.subscriptions=new t;this.pendingEvents=[];this.attachSerial=this.syncChannelSerial=void 0;this.setOptions(c)}var f=r.Action,c=r.Flag,b=function(){},g={queueEvents:!0};l.inherits(e,S);e.invalidStateError={statusCode:400,
code:90001,message:"Channel operation failed (invalid channel state)"};e.channelDetachedErr={statusCode:409,code:90006,message:"Channel is detached"};e.prototype.setOptions=function(a,c){c=c||b;a=this.options=l.prototypicalClone(g,a);if(a.encrypted){if(!Crypto)throw Error("Encryption not enabled; use ably.encryption.js instead");Crypto.getCipher(a,function(b,e){a.cipher=e;c(null)})}else c(null,a.cipher=null)};e.prototype.publish=function(){var a=arguments.length,c=arguments[0],e=arguments[a-1],f=
this.options;"function"!==typeof e&&(e=b,++a);var g=this.connectionManager;if(A.activeState(g.state)){2==a?(l.isArray(c)||(c=[c]),c=B.fromValuesArray(c)):c=[B.fromValues({name:arguments[0],data:arguments[1]})];for(a=0;a<c.length;a++)B.encode(c[a],f);this._publish(c,e)}else e(g.getStateError())};e.prototype._publish=function(d,b){a.logAction(a.LOG_MICRO,"RealtimeChannel.publish()","message count = "+d.length);switch(this.state){case "attached":a.logAction(a.LOG_MICRO,"RealtimeChannel.publish()","sending message");
var c=new r;c.action=f.MESSAGE;c.channel=this.name;c.messages=d;this.sendMessage(c,b);break;default:this.attach();case "attaching":a.logAction(a.LOG_MICRO,"RealtimeChannel.publish()","queueing message"),this.pendingEvents.push({messages:d,callback:b})}};e.prototype.onEvent=function(d){a.logAction(a.LOG_MICRO,"RealtimeChannel.onEvent()","received message");for(var b=this.subscriptions,c=0;c<d.length;c++){var e=d[c];b.emit(e.name,e)}};e.prototype.attach=function(a){a=a||b;var c=this.connectionManager;
if(A.activeState(c.state))switch(this.state){case "attached":a();break;default:this.setPendingState("attaching");case "attaching":this.once(function(b){switch(this.event){case "attached":a();break;case "detached":case "failed":a(b||c.getStateError())}})}else a(c.getStateError())};e.prototype.attachImpl=function(d){a.logAction(a.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message");var c=r.fromValues({action:f.ATTACH,channel:this.name});this.sendMessage(c,d||b)};e.prototype.detach=function(a){a=
a||b;var c=this.connectionManager;if(A.activeState(c.state)){switch(this.state){case "detached":case "failed":a();break;default:this.setPendingState("detaching");case "detaching":this.once(function(b){switch(this.event){case "detached":a();break;case "failed":a(b||c.getStateError());break;default:a(K.unknownChannelErr)}})}this.setSuspended(e.channelDetachedErr,!0)}else a(c.getStateError())};e.prototype.detachImpl=function(d){a.logAction(a.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message");
var c=r.fromValues({action:f.DETACH,channel:this.name});this.sendMessage(c,d||b)};e.prototype.subscribe=function(){var a=Array.prototype.slice.call(arguments);1==a.length&&"function"==typeof a[0]&&a.unshift(null);var c=a[0],e=a[1],a=a[2]||(a[2]=b),f=this.subscriptions;if(null!==c&&l.isArray(c))for(var g=0;g<c.length;g++)f.on(c[g],e);else f.on(c,e);this.attach(a)};e.prototype.unsubscribe=function(){var a=Array.prototype.slice.call(arguments);1==a.length&&"function"==typeof a[0]&&a.unshift(null);var b=
a[0],a=a[1],c=this.subscriptions;if(null!==b&&l.isArray(b))for(var e=0;e<b.length;e++)c.off(b[e],a);else c.off(b,a)};e.prototype.sync=function(){switch(this.state){case "initialised":case "detaching":case "detached":throw new u("Unable to sync to channel; not attached",4E4);}var a=this.connectionManager;if(!A.activeState(a.state))throw a.getStateError();var b=r.fromValues({action:f.SYNC,channel:this.name});b.channelSerial=this.syncChannelSerial;a.send(b)};e.prototype.sendMessage=function(a,b){this.connectionManager.send(a,
this.options.queueEvents,b)};e.prototype.sendPresence=function(a,b){var c=r.fromValues({action:f.PRESENCE,channel:this.name,presence:[C.fromValues(a)]});this.sendMessage(c,b)};e.prototype.onMessage=function(d){var b;switch(d.action){case f.ATTACHED:this.setAttached(d);break;case f.DETACHED:this.setDetached(d);break;case f.SYNC:if(b=this.syncChannelSerial=d.channelSerial,!d.presence)break;case f.PRESENCE:var c=d.presence,e=d.id,g=d.connectionId;d=d.timestamp;for(var n=this.options,l=0;l<c.length;l++){try{var s=
c[l];C.decode(s,n)}catch(q){a.logAction(a.LOG_ERROR,"RealtimeChannel.onMessage()",q.toString()),this.emit("error",q)}s.connectionId||(s.connectionId=g);s.timestamp||(s.timestamp=d);s.id||(s.id=e+":"+l)}this.presence.setPresence(c,!0,b);break;case f.MESSAGE:b=d.messages;e=d.id;g=d.connectionId;d=d.timestamp;n=this.options;for(l=0;l<b.length;l++){try{c=b[l],B.decode(c,n)}catch(Y){a.logAction(a.LOG_ERROR,"RealtimeChannel.onMessage()",Y.toString()),this.emit("error",Y)}c.connectionId||(c.connectionId=
g);c.timestamp||(c.timestamp=d);c.id||(c.id=e+":"+l)}this.onEvent(b);break;case f.ERROR:(e=d.error)&&80016==e.code?this.checkPendingState():this.setDetached(d);break;default:a.logAction(a.LOG_ERROR,"RealtimeChannel.onMessage()","Fatal protocol error: unrecognised action ("+d.action+")"),this.connectionManager.abort(K.unknownChannelErr)}};e.mergeTo=function(a,b){var c=!1,e;if(a.channel==b.channel&&(e=a.action)==b.action)switch(e){case f.MESSAGE:for(c=0;c<b.messages.length;c++)a.messages.push(b.messages[c]);
c=!0;break;case f.PRESENCE:for(c=0;c<b.presence.length;c++)a.presence.push(b.presence[c]);c=!0}return c};e.prototype.setAttached=function(d){a.logAction(a.LOG_MINOR,"RealtimeChannel.setAttached","activating channel; name = "+this.name+"; message flags = "+d.flags);this.clearStateTimer();this.attachSerial=d.channelSerial;d.presence&&this.presence.setPresence(d.presence,!1);if("attaching"==this.state){var b=this.pendingEvents,e=b.length;if(e){this.pendingEvents=[];var g=r.fromValues({action:f.MESSAGE,
channel:this.name,messages:[]}),k=U();a.logAction(a.LOG_MICRO,"RealtimeChannel.setAttached","sending "+e+" queued messages");for(var n=0;n<e;n++){var l=b[n];Array.prototype.push.apply(g.messages,l.messages);k.push(l.callback)}this.sendMessage(g,k)}(d=0<(d.flags&1<<c.HAS_PRESENCE))&&this.presence.awaitSync();this.presence.setAttached();this.setState("attached",null,d)}};e.prototype.setDetached=function(a){this.clearStateTimer();(a=a.error)?(a={statusCode:a.statusCode,code:a.code,message:a.message},
this.failPendingMessages(a),this.setState("failed",a)):(this.failPendingMessages({statusCode:404,code:90001,message:"Channel detached"}),"detached"!==this.state&&this.setState("detached"))};e.prototype.setSuspended=function(d,b){a.logAction(a.LOG_MINOR,"RealtimeChannel.setSuspended","deactivating channel; name = "+this.name+", err "+(d?d.message:"none"));this.clearStateTimer();this.failPendingMessages(d);this.presence.setSuspended(d);b||"detached"===this.state||this.setState("detached")};e.prototype.setState=
function(a,b,c){this.state=a;this.setInProgress(c);this.emit(a,b)};e.prototype.setPendingState=function(d){a.logAction(a.LOG_MINOR,"RealtimeChannel.setPendingState","name = "+this.name+", state = "+d);this.clearStateTimer();this.setState(d,null,!0);if("connected"!=this.connectionManager.state.state)a.logAction(a.LOG_MINOR,"RealtimeChannel.setPendingState","not connected");else{this.checkPendingState();var b=this;this.stateTimer=setTimeout(function(){a.logAction(a.LOG_MINOR,"RealtimeChannel.setPendingState",
"timer expired");b.stateTimer=null;b.checkPendingState()},this.options.timeouts.realtimeRequestTimeout)}};e.prototype.checkPendingState=function(){var a=!1;switch(this.state){case "attaching":this.attachImpl();a=!0;break;case "detaching":this.detachImpl();a=!0;break;case "attached":this.sync()}return a};e.prototype.clearStateTimer=function(){var a=this.stateTimer;a&&(clearTimeout(a),this.stateTimer=null)};e.prototype.setInProgress=function(a){this.rest.channels.setInProgress(this,a)};e.prototype.failPendingMessages=
function(d){a.logAction(a.LOG_MINOR,"RealtimeChannel.failPendingMessages","channel; name = "+this.name+", err = "+l.inspectError(d));for(var b=0;b<this.pendingEvents.length;b++)try{this.pendingEvents[b].callback(d)}catch(c){}this.pendingEvents=[]};e.prototype.history=function(d,c){a.logAction(a.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name);void 0===c&&("function"==typeof d?(c=d,d=null):c=b);if(d&&d.untilAttach)if("attached"===this.state)delete d.untilAttach,d.from_serial=this.attachSerial;
else throw new u("option untilAttach requires the channel to be attached",4E4,400);S.prototype._history.call(this,d,c)};return e}(),ga=function(){function e(a,b){t.call(this);R.call(this,a);this.clientId=b.clientId;this.members=new f(this)}function f(a){t.call(this);this.presence=a;this.map={};this.syncInProgress=!1;this.residualMembers=null}var c=C.Action,b=["absent","present","enter","leave","update"],g=function(){};l.inherits(e,R);e.prototype.enter=function(a,b){if(!this.clientId)throw Error("clientId must be specified to enter a presence channel");
this._enterOrUpdateClient(void 0,a,b,"enter")};e.prototype.update=function(a,b){if(!this.clientId)throw Error("clientId must be specified to update presence data");this._enterOrUpdateClient(void 0,a,b,"update")};e.prototype.enterClient=function(a,b,c){this._enterOrUpdateClient(a,b,c,"enter")};e.prototype.updateClient=function(a,b,c){this._enterOrUpdateClient(a,b,c,"update")};e.prototype._enterOrUpdateClient=function(d,b,e,f){e||("function"===typeof b?(e=b,b=null):e=g);a.logAction(a.LOG_MICRO,"RealtimePresence."+
f+"Client()",f+"ing; channel = "+this.channel.name+", client = "+d||"(implicit) "+this.clientId);b=C.fromValues({action:c[f.toUpperCase()],data:b});d&&(b.clientId=d);d=this.channel;switch(d.state){case "attached":d.sendPresence(b,e);break;case "initialized":case "detached":var k=this;d.attach(function(a){a&&(k.pendingPresence=null,e(a))});case "attaching":this.pendingPresence={presence:b,callback:e};break;default:f=Error("Unable to "+f+" presence channel (incompatible state)"),f.code=90001,e(f)}};
e.prototype.leave=function(a,b){b||"function"!==typeof a||(b=a,a="");if(!this.clientId)throw Error("clientId must have been specified to enter or leave a presence channel");this.leaveClient(void 0,a,b)};e.prototype.leaveClient=function(b,e,f){a.logAction(a.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+b);e=C.fromValues({action:c.LEAVE,data:e});b&&(e[b]=b);b=this.channel;switch(b.state){case "attached":b.sendPresence(e,f);break;case "attaching":this.pendingPresence=
{presence:e,callback:f};break;case "initialized":this.pendingPresence=null;b=Error("Unable to leave presence channel (incompatible state)");b.code=90001;f(b);break;default:this.pendingPresence=null,f(K.failed)}};e.prototype.get=function(){var a=Array.prototype.slice.call(arguments);1==a.length&&"function"==typeof a[0]&&a.unshift(null);var b=a[0],c=a[1]||g,e=this.members;e.waitSync(function(){c(null,b?e.list(b):e.values())})};e.prototype.history=function(b,c){a.logAction(a.LOG_MICRO,"RealtimePresence.history()",
"channel = "+this.name);void 0===c&&("function"==typeof b?(c=b,b=null):c=g);if(b&&b.untilAttach)if("attached"===this.channel.state)delete b.untilAttach,b.from_serial=this.channel.attachSerial;else throw new u("option untilAttach requires the channel to be attached, was: "+this.channel.state,4E4,400);R.prototype._history.call(this,b,c)};e.prototype.setPresence=function(d,e,f){a.logAction(a.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+d.length+" participants; syncChannelSerial = "+
f);var g,k;e=this.members;var n=[];f&&(k=f.match(/^\w+:(.*)$/))&&(g=k[1])&&this.members.startSync();for(f=0;f<d.length;f++)switch(k=C.fromValues(d[f]),k.action){case c.LEAVE:e.remove(k)&&n.push(k);break;case c.UPDATE:case c.ENTER:case c.PRESENT:e.put(k)&&n.push(k)}g||(e.endSync(),this.channel.setInProgress(!1));for(f=0;f<n.length;f++)k=n[f],this.emit(b[k.action],k)};e.prototype.setAttached=function(){var b=this.pendingPresence;if(b){var c=b.presence,b=b.callback;a.logAction(a.LOG_MICRO,"RealtimePresence.setAttached",
"sending queued presence; action = "+c.action);this.channel.sendPresence(c,b);this.pendingPresence=null}};e.prototype.setSuspended=function(a){var b=this.pendingPresence;b&&(b.callback(a),this.pendingPresence=null)};e.prototype.awaitSync=function(){a.logAction(a.LOG_MINOR,"PresenceMap.awaitSync(); channel = "+this.channel.name);this.members.startSync()};l.inherits(f,t);f.prototype.get=function(a){return this.map[a]};f.prototype.getClient=function(a){var b=this.map,e=[],f;for(f in b){var g=b[f];g.clientId==
a&&g.action!=c.ABSENT&&e.push(g)}return e};f.prototype.list=function(a){var b=this.map,e=a&&a.clientId;a=a&&a.connectionId;var f=[],g;for(g in b){var n=b[g];n.action!=c.ABSENT&&(e&&e!=n.clientId||a&&a!=n.connectionId||f.push(n))}return f};f.prototype.put=function(a){if(a.action===c.ENTER||a.action===c.UPDATE)a=C.fromValues(a),a.action=c.PRESENT;var b=this.map,e=a.clientId+":"+a.connectionId;this.residualMembers&&delete this.residualMembers[e];var f=b[e];if(f&&a.id<=f.id)return!1;b[e]=a;return!0};
f.prototype.values=function(){var a=this.map,b=[],e;for(e in a){var f=a[e];f.action!=c.ABSENT&&b.push(f)}return b};f.prototype.remove=function(a){var b=this.map;a=a.clientId+":"+a.connectionId;var c=b[a];return c&&(delete b[a],c.action==C.Action.ABSENT)?!1:!0};f.prototype.startSync=function(){var b=this.map;a.logAction(a.LOG_MINOR,"PresenceMap.startSync(); channel = "+this.presence.channel.name+"; syncInProgress = "+this.syncInProgress);this.syncInProgress||(this.residualMembers=l.copy(b),this.syncInProgress=
!0)};f.prototype.endSync=function(){var b=this.map,e=this.syncInProgress;a.logAction(a.LOG_MINOR,"PresenceMap.endSync(); channel = "+this.presence.channel.name+"; syncInProgress = "+e);if(e){for(var f in b)b[f].action==c.ABSENT&&delete b[f];for(f in this.residualMembers)delete b[f];this.residualMembers=null;this.syncInProgress=!1}this.emit("sync")};f.prototype.waitSync=function(a){if(this.syncInProgress)this.once("sync",a);else a()};return e}();(function(){function e(a,b,c){c.stream=!1;N.call(this,
a,b,c)}function f(a,b,c,d,e,f,h){t.call(this);void 0===a&&(a=g++);this.id=a;this.uri=b;this.params=d||{};this.body=e;this.requestMode=f;this.timeouts=h;this.requestComplete=!1}var c=function(){},b=window.Ably._=function(a){return b[a]||c},g=1,d=document.getElementsByTagName("head")[0];l.inherits(e,N);e.isAvailable=function(){return!0};A.httpTransports.jsonp=A.transports.jsonp=e;var h=null;e.checkConnectivity=function(b){var c=q.internetUpUrlWithoutExtension+".js";h?h.push(b):(h=[b],a.logAction(a.LOG_MICRO,
"JSONPTransport.checkConnectivity()","Sending; "+c),p(c,null,null,null,!1,function(b,c){var d=!b&&c;a.logAction(a.LOG_MICRO,"JSONPTransport.checkConnectivity()","Result: "+d);for(var e=0;e<h.length;e++)h[e](null,d);h=null}))};e.tryConnect=function(b,c,d,f){var g=new e(b,c,d),h=function(a){f(a)};g.on("error",h);g.on("preconnect",function(){a.logAction(a.LOG_MINOR,"JSONPTransport.tryConnect()","viable transport "+g);g.off("error",h);f(null,g)});g.connect()};e.prototype.toString=function(){return"JSONPTransport; uri="+
this.baseUri+"; isConnected="+this.isConnected};var m=e.prototype.createRequest=function(a,b,c,d,e){return new f(void 0,a,b,c,d,e,this.timeouts)};l.inherits(f,t);f.prototype.exec=function(){var a=this.id,c=this.body,e=this.uri,f=this.params,g=this;f.callback="Ably._("+a+")";f.envelope="jsonp";c?f.body=c:delete f.body;c=this.script=document.createElement("script");c.src=e+l.toQueryString(f);c.async=!0;c.type="text/javascript";c.charset="UTF-8";c.onerror=function(a){a.code=8E4;g.complete(a)};b[a]=function(a){var b=
400>a.statusCode,c=a.response;c?b?g.complete(null,c):(a=c.error||new u("Error response received from server",5E4,a.statusCode),g.complete(a)):g.complete(new u("Invalid server response: no envelope detected",5E4,500))};this.timer=setTimeout(function(){g.abort()},this.requestMode==N.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout);d.insertBefore(c,d.firstChild)};f.prototype.complete=function(a,b){if(!this.requestComplete){this.requestComplete=!0;var c;b&&(c="string"==typeof b?"text/plain":
"application/json",this.emit("data",b));this.emit("complete",a,b,c&&{"content-type":c},!0);this.dispose()}};f.prototype.abort=function(){this.dispose()};f.prototype.dispose=function(){var a=this.timer;a&&(clearTimeout(a),this.timer=null);a=this.script;a.parentNode&&a.parentNode.removeChild(a);delete b[this.id];this.emit("disposed")};var p=x.Request=function(a,b,c,d,e){a=m(a,b,c,d,N.REQ_SEND);a.once("complete",e);a.exec();return a};return e})();var ba=function(){function e(){for(var a in h)h[a].dispose()}
function f(){return window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest?p=!0:m&&document.domain&&"https:"==window.location.protocol?!0:!1}function c(a,b,c,e,f,g){t.call(this);c=c||{};c.rnd=String(Math.random()).substr(2);var k,p;if(p=m)p=k=(k=navigator.userAgent.toString().match(/MSIE\s([\d.]+)/))&&Number(k[1]);p&&10===k&&!c.envelope&&(c.envelope="json");this.uri=a+l.toQueryString(c);this.headers=b||{};this.body=e;this.requestMode=f;this.timeouts=g;this.requestComplete=!1;h[this.id=String(++d)]=
this}function b(a,b,d,e,f,g){d.ua="xdr";c.call(this,a,b,d,e,f,g)}var g=function(){},d=0,h={},m=window.XDomainRequest,p;l.inherits(c,t);c.isAvailable=f;var k=c.createRequest=function(a,d,e,f,g){var h=this&&this.timeouts?this.timeouts:q.TIMEOUTS;return p?new c(a,d,e,f,g,h):new b(a,d,e,f,g,h)};c.prototype.complete=function(a,b,c,d){this.requestComplete||(this.requestComplete=!0,b&&this.emit("data",b),this.emit("complete",a,b,c,d),this.dispose())};c.prototype.abort=function(){this.dispose()};c.prototype.exec=
function(){function a(){z=g.responseText;for(var b=z.length-1,c,d;v<b&&-1<(c=z.indexOf("\n",v));){d=z.slice(v,c);v=c+1;a:{try{d=JSON.parse(d)}catch(e){d=Error("Malformed response body from server: "+e.message);d.statusCode=400;h.complete(d);break a}h.emit("data",d)}}}function b(){a();h.streamComplete=!0;l.nextTick(function(){h.complete()})}var c=this.timer=setTimeout(function(){g.abort()},0==this.requestMode?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout),d=this.body,e=d?"POST":"GET",
f=this.headers,g=this.xhr=new XMLHttpRequest,h=this,k=f.accept,m="text";k?"application/json"!=k&&(m="arraybuffer"):f.accept="application/json";d&&"application/json"==(f["content-type"]||(f["content-type"]="application/json"))&&"string"!=typeof d&&(d=JSON.stringify(d));g.open(e,this.uri,!0);g.responseType=m;"authorization"in f&&(g.withCredentials="true");for(var p in f)g.setRequestHeader(p,f[p]);var q=g.onerror=function(a){a.code=8E4;h.complete(a)};g.onabort=function(){var a=Error("Request cancelled");
a.statusCode=400;q(a)};g.ontimeout=function(){var a=Error("Request timed out");a.statusCode=408;q(a)};var t,r,z,u,v=0,x=!1;g.onreadystatechange=function(){var d=g.readyState;if(!(3>d)&&0!==g.status){if(void 0===r)if(r=g.status,1223===r&&(r=204),clearTimeout(c),u=400>r,204==r)h.complete();else{var e;if(e=3==h.requestMode&&u)e=g,e=e.getResponseHeader&&e.getResponseHeader("transfer-encoding")&&!e.getResponseHeader("content-length");t=e}if(3==d&&t)a();else if(4==d)if(t)b();else a:{try{var f=g.getResponseHeader&&
g.getResponseHeader("content-type"),d=null,k=f?"application/json"==f:"text"==g.responseType;z=k?g.responseText:g.response;if(!z){204!=status&&(m=Error("Incomplete response body from server"),m.statusCode=400,h.complete(m));break a}k&&(z=JSON.parse(String(z)),x=!0);void 0!==z.response&&(r=z.statusCode,u=400>r,d=z.headers,z=z.response)}catch(l){var m=Error("Malformed response body from server: "+l.message);m.statusCode=400;h.complete(m);break a}u?h.complete(null,z,d||f&&{"content-type":f},x):(m=z.error,
m||(m=Error("Error response received from server: "+r),m.statusCode=r),h.complete(m))}}};g.send(d)};c.prototype.dispose=function(){var a=this.xhr;if(a){a.onreadystatechange=a.onerror=a.onabort=a.ontimeout=g;this.xhr=null;var b=this.timer;b&&(clearTimeout(b),this.timer=null);this.requestComplete||a.abort()}delete h[this.id]};l.inherits(b,c);b.prototype.exec=function(){function b(){clearTimeout(e);if(r=h.responseText){var a=r.length-1;if("\n"==r[a]||(a=-1<r.indexOf("\n"))){var c=r.slice(0,a);try{var c=
JSON.parse(c),d=c.error;if(d)q=d.statusCode||500,k.complete(d);else if(q=r?201:200,p=3==k.requestMode)t=a,l.isEmpty(c)||k.emit("data",c)}catch(f){d=Error("Malformed response body from server: "+f.message),d.statusCode=400,k.complete(d)}}}}function c(){r=h.responseText;for(var a=r.length-1,b,d;t<a&&-1<(b=r.indexOf("\n",t));){d=r.slice(t,b);t=b+1;a:{try{d=JSON.parse(d)}catch(e){d=Error("Malformed response body from server: "+e.message);d.statusCode=400;k.complete(d);break a}k.emit("data",d)}}}function d(){c();
k.streamComplete=!0;l.nextTick(function(){k.complete()})}var e=this.timer=setTimeout(function(){h.abort()},0==this.requestMode?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout),f=this.body,g=f?"POST":"GET",h=this.xhr=new XDomainRequest,k=this;f&&"object"==typeof f&&(f=JSON.stringify(f));var m=h.onerror=function(){a.logAction(a.LOG_ERROR,"Request.onerror()","");var b=Error("Error response");b.statusCode=400;b.code=8E4;k.complete(b)};h.onabort=function(){a.logAction(a.LOG_ERROR,"Request.onabort()",
"");var b=Error("Request cancelled");b.statusCode=400;m(b)};h.ontimeout=function(){a.logAction(a.LOG_ERROR,"Request.timeout()","");var b=Error("Request timed out");b.statusCode=408;m(b)};var p,q,r,t=0;h.onprogress=function(){void 0===q?b():p&&c()};h.onload=function(){if(void 0===q&&(b(),k.requestComplete))return;if(p)d();else a:{try{r=h.responseText;if(!r||!r.length){204!=status&&(c=Error("Incomplete response body from server"),c.statusCode=400,k.complete(c));break a}r=JSON.parse(String(r))}catch(a){var c=
Error("Malformed response body from server: "+a.message);c.statusCode=400;k.complete(c);break a}k.complete(null,r,{"content-type":"application/json"},!0)}};try{h.open(g,this.uri),h.send(f)}catch(u){a.logAction(a.LOG_ERROR,"Request.onStreamEnd()","Unexpected send exception; err = "+u),m(u)}};b.prototype.dispose=function(){var a=this.xhr;if(a){a.onprogress=a.onload=a.onerror=a.onabort=a.ontimeout=g;this.xhr=null;var b=this.timer;b&&(clearTimeout(b),this.timer=null);this.requestComplete||a.abort()}delete h[this.id]};
if(f=c.isAvailable())M.addUnloadListener(e),"undefined"!==typeof x&&(x.supportsAuthHeaders=p,x.Request=function(a,b,c,d,e){a=k(a,b,c,d,0);a.once("complete",e);a.exec();return a});return c}();(function(){function e(a,c,b){N.call(this,a,c,b)}l.inherits(e,N);e.isAvailable=ba.isAvailable;e.checkConnectivity=function(e){var c=q.internetUpUrlWithoutExtension+".txt";a.logAction(a.LOG_MICRO,"XHRTransport.checkConnectivity()","Sending; "+c);x.Request(c,null,null,null,function(b,c){var d=!b&&"yes"==c;a.logAction(a.LOG_MICRO,
"XHRTransport.checkConnectivity()","Result: "+d);e(null,d)})};e.tryConnect=function(f,c,b,g){var d=new e(f,c,b),h=function(a){g(a)};d.on("error",h);d.on("preconnect",function(){a.logAction(a.LOG_MINOR,"XHRTransport.tryConnect()","viable transport "+d);d.off("error",h);g(null,d)});d.connect()};e.prototype.toString=function(){return"XHRTransport; uri="+this.baseUri+"; isConnected="+this.isConnected};e.prototype.createRequest=ba.createRequest;"undefined"!==typeof A&&e.isAvailable()&&(A.httpTransports.xhr=
A.transports.xhr=e);return e})();(function(){function e(a,b,e){e.binary=!1;E.call(this,a,b,e);this.destOrigin=this.destWindow=this.wrapWindow=this.wrapIframe=null}var f=location.origin||location.protocol+"//"+location.hostname+(location.port?":"+location.port:"");if("null"===f||"file://"===f)f="*";l.inherits(e,E);e.isAvailable=function(){return void 0!==window.postMessage};e.isAvailable()&&(A.httpTransports.iframe=A.transports.iframe=e);e.tryConnect=function(c,b,f,d){var h=new e(c,b,f);h.on("iferror",
d);h.on("ifopen",function(){a.logAction(a.LOG_MINOR,"IframeTransport.tryConnect()","viable transport "+h);h.off("iferror",d);d(null,h)});h.connect()};e.prototype.toString=function(){return"IframeTransport; uri="+this.uri};e.prototype.connect=function(){a.logAction(a.LOG_MINOR,"IframeTransport.connect()","starting");E.prototype.connect.call(this);var c=this;this.auth.getAuthParams(function(a,e){if(a)c.abort(a);else{var d=c.params.getConnectParams(e);d.origin=f;c.createIframe(d,function(a){a?c.emit("iferror",
a):c.emit("ifopen")})}})};e.prototype.send=function(a){var b=this.destWindow;b&&b.postMessage(JSON.stringify(a),this.destOrigin)};e.prototype.createIframe=function(c,b){function e(){n.dispose()}function d(a){n.onData(a.data)}var f=this.wrapIframe=document.createElement("iframe"),m=this.params.options,m=(this.destOrigin="https://"+q.getHost(m)+":"+q.getPort(m,!0))+"/static/iframe"+(q.minified?".min":"")+(q.version?"-"+q.version:"")+".html"+l.toQueryString(c),p=!1,k=null,n=this;a.logAction(a.LOG_MINOR,
"IframeTransport.createIframe()","destUri: "+m);M.addUnloadListener(e);f.style.display="none";f.style.position="absolute";f.onerror=function(a){e();p||(p=!0,a=a||Error("Unknown error loading iframe"),b(a))};M.addListener(f,"load",n.onloadListener=function(){var a=a||this.contentWindow||this.contentDocument.parentWindow;if(n.destWindow=a.destWindow)M.addMessageListener(a,n.messageListener=d),p=!0,b(null,f)});document.body.appendChild(f);k=n.wrapWindow=f.contentWindow;k=k.document;k.open();k.write('<!DOCTYPE html>\n<html>\n  <head>\n    <script type="text/javascript">\n    var destWindow;\n    function onIframeLoaded() {\n      destWindow = document.getElementById("dest").contentWindow;\n    }\n    \x3c/script>\n  </head>\n  <body>\n    <iframe id="dest" src="'+
m+'" onload="onIframeLoaded();">\n    </iframe>\n  </body>\n</html>\n');k.close()};e.prototype.onData=function(c){a.logAction(a.LOG_MICRO,"IframeTransport.onData()","length = "+c.length);try{var b=JSON.parse(String(c));if(b&&b.length)for(c=0;c<b.length;c++)this.onProtocolMessage(b[c])}catch(e){a.logAction(a.LOG_ERROR,"IframeTransport.onData()","Unexpected exception handing channel event: "+e)}};e.prototype.dispose=function(){a.logAction(a.LOG_MICRO,"IframeTransport.dispose()","");var c=this.messageListener;
c&&(M.removeMessageListener(this.wrapWindow,c),this.messageListener=null);var b=this.wrapIframe;b&&((c=this.onloadListener)&&M.removeListener(b,"load",c),this.wrapIframe=b.onerror=null,setTimeout(function(){b.parentNode.removeChild(b)},0));this.emit("disposed")};return e})();"undefined"!==typeof H&&(X.Rest=G,X.Realtime=H,H.ConnectionManager=A,H.BufferUtils=G.BufferUtils=v,"undefined"!==typeof Crypto&&(H.Crypto=G.Crypto=Crypto),H.Defaults=G.Defaults=q,H.Message=G.Message=B,H.PresenceMessage=G.PresenceMessage=
C,H.ProtocolMessage=G.ProtocolMessage=r)}).call({});
